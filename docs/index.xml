<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>RDKit blog</title>
<link>https://greglandrum.github.io/rdkit-blog/</link>
<atom:link href="https://greglandrum.github.io/rdkit-blog/index.xml" rel="self" type="application/rss+xml"/>
<description>RDKit experiments, tips, and tutorials</description>
<generator>quarto-1.6.43</generator>
<lastBuildDate>Sat, 20 Dec 2025 23:00:00 GMT</lastBuildDate>
<item>
  <title>About tetrahedral chirality in the RDKit</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-12-21-Chiral-atoms.html</link>
  <description><![CDATA[ 




<p>This week, to try and find inspiration for a short, or at least quick, blog post, I did an “AI Search” and asked for some frequently un-answered RDKit questions. One of those was related to understanding stereochemistry. Then, this morning, I noticed a question in GitHub Discussions asking why the chirality on a tertiary amine wasn’t being preserved. My post topic was clear!</p>
<p>The contents of this post will end up, in an edited form, in the <a href="https://www.rdkit.org/docs/RDKit_Book.html">RDKit Book</a></p>
<div id="bc25d8a8-88c1-4cc7-bf29-cb01006f0f43" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-3">IPythonConsole.molSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span></span></code></pre></div>
</div>
<section id="intro" class="level1">
<h1>Intro</h1>
<p>In this post I am going to focus solely on stereochemistry/chirality around tetrahedral atoms. I am aware that there are non-tetrahedral forms of stereochemistry for three- and four-coordinate atoms (and the RDKit supports some of them). Non-tetrahedral stereochemistry, double-bond stereochemistry, and atropisomerism are topics for a possible future post.</p>
</section>
<section id="what-can-be-chiral" class="level1">
<h1>What can be chiral?</h1>
<p>I will borrow the language used in the <a href="https://www.inchi-trust.org/download/104/InChI_TechMan.pdf">InChI technical manual</a> and use the term “stereogenic” to refer to atoms which can be chiral if all of their substituents are different. The RDKit uses the same conditions to determine which atoms can be involved in ring stereochemistry (see below).</p>
<p>If you ever want to go straight to the source to see what could be a potential stereocenter, the function to look for is <a href="">isAtomPotentialChiralCenter()</a> .</p>
<p>In general, the following conditions have to be met for an atom to be considered a potential stereocenter: - It must have a total nonzero-degree of three or four. I.e. three or four neighbors not connected via zero-order bonds. - It cannot have two attached hydrogen atoms (explicit or implicit). For the purposes of this count, only H atoms with unspecified isotopes count. - Three coordinate atoms cannot have an H atom attached, except for phosphines, arsines, S and Se with an explicit valence of four, and S+ and Se+ with an explicit valence of three. - Degree three N atoms cannot have an H atom attached and must be involved in either a three-membered ring or be a bridgehead</p>
<p>Because arbitrary decisions have to be made when dealing with this topic - for example, are tertiary amines stereogenic? - we choose to (try and) follow InChI and use Table 8 from the <a href="https://www.inchi-trust.org/download/104/InChI_TechMan.pdf">InChI technical manual</a> here. If an element is not present in that InChI table, we use the general rules above. One notable exception for main-group atoms is that the RDKit allows trivalent N atoms that are in a bridgehead to be chiral centers.</p>
<p>An example chiral phosphine (invented):</p>
<div id="9adb5d8a-55f2-45de-b1e1-313623ce1af6" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C12C[N@](C)C(C2)C[P@H]1'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-21-Chiral-atoms_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>That really should have the <code>[H]</code> drawn as a separate atom</p>
</blockquote>
<p>Notice that, though the chirality on the N was specified in the input, it was removed when the molecule was parsed: the N is neither in a three-membered ring nor a bridgehead.</p>
<p>Here’s an example of a ChEMBL molecule with a chiral bridgehead N:</p>
<div id="e67eb19b-e39b-4fe4-bab5-19452f532eec" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COC(=O)[C@@H]1C[N@@]2CCC[C@@H]1C2'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-21-Chiral-atoms_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-rdkits-representation-of-atomic-stereochemistry" class="level1">
<h1>The RDKit’s representation of atomic stereochemistry</h1>
<div id="356bb9e8-7649-46d2-9c02-c1f5a21c7c9f" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">IPythonConsole.drawOptions.addAtomIndices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb4-2">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C[C@](C(=O)O)(CCC)CC'</span>)</span>
<span id="cb4-3">m</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-21-Chiral-atoms_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see the internal representation in the output of <code>Debug()</code> for the chiral center, atom 1:</p>
<div id="aa58cc35-f803-42be-b7d8-1410902c12ad" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">m.Debug()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Atoms:
    0 6 C chg: 0  deg: 1 exp: 1 imp: 3 hyb: SP3
    1 6 C chg: 0  deg: 4 exp: 4 imp: 0 hyb: SP3 chi: CCW nbrs:[0 2 5 8]
    2 6 C chg: 0  deg: 3 exp: 4 imp: 0 hyb: SP2
    3 8 O chg: 0  deg: 1 exp: 2 imp: 0 hyb: SP2
    4 8 O chg: 0  deg: 1 exp: 1 imp: 1 hyb: SP2
    5 6 C chg: 0  deg: 2 exp: 2 imp: 2 hyb: SP3
    6 6 C chg: 0  deg: 2 exp: 2 imp: 2 hyb: SP3
    7 6 C chg: 0  deg: 1 exp: 1 imp: 3 hyb: SP3
    8 6 C chg: 0  deg: 2 exp: 2 imp: 2 hyb: SP3
    9 6 C chg: 0  deg: 1 exp: 1 imp: 3 hyb: SP3
Bonds:
    0 0-&gt;1 order: 1
    1 1-&gt;2 order: 1
    2 2-&gt;3 order: 2 conj?: 1
    3 2-&gt;4 order: 1 conj?: 1
    4 1-&gt;5 order: 1
    5 5-&gt;6 order: 1
    6 6-&gt;7 order: 1
    7 1-&gt;8 order: 1
    8 8-&gt;9 order: 1</code></pre>
</div>
</div>
<p>The important information here is <code>chi</code> and <code>nbrs</code>, which tell us that if we look from atom 0 to atom 1, we need to rotate counter-clockwise to go from atom 2 to atom 5 (or from atom 5 to atom 8).</p>


</section>

 ]]></description>
  <category>tutorial</category>
  <category>documentation</category>
  <category>stereochemistry</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-12-21-Chiral-atoms.html</guid>
  <pubDate>Sat, 20 Dec 2025 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Building synthon spaces with combinatorial reactions</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons.html</link>
  <description><![CDATA[ 




<p>Last week’s <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-12-07-BRICS-synthons.html">blog post</a> looked at using <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial.html">BRICS</a> to build a <a href="https://www.rdkit.org/docs/GettingStartedInPython.html#searching-synthon-spaces">synthon search space</a>. This post builds on that and creates a search space using some combichem reactions from a set published by <a href="http://pubs.acs.org/doi/abs/10.1021/ci200379p">Hartenfeller et al</a>.</p>
<div id="872abcd6-8e5b-44ee-8e83-33b9d77adcd2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdChemReactions</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdSynthonSpaceSearch</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb1-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.09.3</code></pre>
</div>
</div>
<p>I’m going to use a set of Enamine building blocks that I have on my machine. I loaded these into a <a href="https://greglandrum.github.io/rdkit-blog/posts/2021-12-20-substructlibrary-search-order.html">SubstructLibrary</a> to make them fast and easy to search.</p>
<div id="b0cacab6" class="cell" data-execution_count="251">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdSubstructLibrary</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pickle</span>
<span id="cb3-3">sslib <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pickle.load(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/scratch/Data/Enamine/real_reagents.sslib.pkl'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rb'</span>))</span></code></pre></div>
</div>
<section id="the-first-reaction" class="level1">
<h1>The first reaction</h1>
<p>I’ll start with the Pictet-Spengler reaction from the <a href="http://pubs.acs.org/doi/abs/10.1021/ci200379p">Hartenfeller paper</a>. It’s the first reaction in the SI for that paper and there’s something the name that I really like.</p>
<p>Here’s the definition of the reaction from the paper</p>
<div id="60d638fc" class="cell" data-execution_count="207">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">sma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[cH1:1]1:[c:2](-[CH2:7]-[CH2:8]-[NH2:9]):[c:3]:[c:4]:[c:5]:[c:6]:1.[#6:11]-[CH1;R0:10]=[OD1]&gt;&gt;[c:1]12:[c:2](-[CH2:7]-[CH2:8]-[NH1:9]-[C:10]-2(-[#6:11])):[c:3]:[c:4]:[c:5]:[c:6]:1'</span></span>
<span id="cb4-2"></span>
<span id="cb4-3">rxn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(sma)</span>
<span id="cb4-4">rxn</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="207">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>These are the two prototype educts from the SI:</p>
<div id="02076fd2" class="cell" data-scrolled="true" data-execution_count="208">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">r1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1cc(CCN)ccc1'</span>)</span>
<span id="cb5-2">r2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC(=O)'</span>)</span>
<span id="cb5-3">Draw.MolsToGridImage((r1,r2))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="208">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>To make what’s going on in the reaction a bit easier to identify, here I add the atom map numbers from the reaction to the sample educts:</p>
<div id="e392add8" class="cell" data-execution_count="209">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">r_queries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rxn.GetReactantTemplate(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(rxn.GetNumReactantTemplates())]</span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r,q <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>([r1,r2],r_queries):</span>
<span id="cb6-4">    match <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r.GetSubstructMatch(q)</span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> match</span>
<span id="cb6-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,midx <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(match):</span>
<span id="cb6-7">        mnum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q.GetAtomWithIdx(i).GetAtomMapNum()</span>
<span id="cb6-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mnum:</span>
<span id="cb6-9">            r.GetAtomWithIdx(midx).SetAtomMapNum(mnum)</span>
<span id="cb6-10">Draw.MolsToGridImage((r1,r2))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="209">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="4865d47c" class="cell" data-execution_count="206">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">r</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="206">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>I’m going to encode the reaction as three synthons: a core and two “sidechains”</p>
<div id="c91b7376" class="cell" data-scrolled="true" data-execution_count="195">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">core <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[7*]CCNC([11*])[1*]'</span>)</span>
<span id="cb8-2">core</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="195">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here’s what I get for the two sample educts:</p>
<div id="53a79ef2" class="cell" data-execution_count="196">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">chains <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromSmiles(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[7*]c1ccccc1[1*]'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C[11*]'</span>)]</span>
<span id="cb9-2">Draw.MolsToGridImage([core,chains[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],chains[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]],legends<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'core'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'educt1'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'educt2'</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="196">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can put these together using molzip (which is what the sython search code uses) to get the product:</p>
<div id="883f16e5" class="cell" data-execution_count="197">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">tm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RWMol(core)</span>
<span id="cb10-2">tm.InsertMol(chains[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb10-3">tm.InsertMol(chains[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb10-4"></span>
<span id="cb10-5">ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolzipParams()</span>
<span id="cb10-6">ps.label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolzipLabel.Isotope</span>
<span id="cb10-7">tm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.molzip(tm,ps)</span>
<span id="cb10-8">tm</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="197">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now we need reactions that transform the building blocks that you would find in a chemical catalog into the synthons we need for the two educts.</p>
<p>I will do this using reactions.</p>
<div id="e8142722" class="cell" data-execution_count="198">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">r1_prep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[cH1:1]1:[c:2](-[CH2:7]-[CH2:8]-[NH2:9]):[c:3]:[c:4]:[c:5]:[c:6]:1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb11-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;[1*]-[c:1]1:[c:2](-[7*])[c:3]:[c:4]:[c:5]:[c:6]1'</span>)</span>
<span id="cb11-3">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r1_prep.RunReactant(r1,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[15:59:19] mapped atoms in the reactants were not mapped in the products.
  unmapped numbers are: 7 8 9 </code></pre>
</div>
</div>
<div id="eadce555" class="cell" data-execution_count="199">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">Draw.MolsToGridImage([r1,p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]],legends<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'building block'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synthon'</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="199">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="2ceebe11" class="cell" data-execution_count="200">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">r2_prep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[#6:11]-[CH1;R0:10]=[OD1]&gt;&gt;[#6:11]-[11*]'</span>)</span>
<span id="cb14-2">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r2_prep.RunReactant(r2,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb14-3"></span>
<span id="cb14-4">Draw.MolsToGridImage([r2,p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]],legends<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'building block'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synthon'</span>])</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[15:59:41] mapped atoms in the reactants were not mapped in the products.
  unmapped numbers are: 10 </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="200">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>More complex reactions (see the next example) may have multiple cores. I want to try and have the code for creating the space be reasonably generic, so I’ll put the preparation reactions and core into a list:</p>
<div id="a9799540" class="cell" data-execution_count="215">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">r_queries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rxn.GetReactantTemplate(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(rxn.GetNumReactantTemplates())]</span>
<span id="cb16-2">possibles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(core,(r1_prep,r2_prep))]</span></code></pre></div>
</div>
<div id="6a98280b" class="cell" data-execution_count="220">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> enumerate_synthons(possibles,outf,writeHeader<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,startIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,nWritten<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb17-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> writeHeader:</span>
<span id="cb17-3">        outf.write(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SMILES'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synton_id'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synton#'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'reaction_id'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'release'</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb17-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> rxnidx,poss <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(possibles,start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>startIdx):</span>
<span id="cb17-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the core and preparation reactions</span></span>
<span id="cb17-6">        core,preps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> poss</span>
<span id="cb17-7">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write out the core:</span></span>
<span id="cb17-8">        outf.write(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>Chem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>MolToSmiles(core)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>nWritten<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">r</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rxnidx<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb17-9"></span>
<span id="cb17-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># now prepare each of the sidechain synthons:</span></span>
<span id="cb17-11">        nWritten <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb17-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ridx,prep <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(preps):</span>
<span id="cb17-13">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> prep.GetNumProductTemplates():</span>
<span id="cb17-14">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb17-15">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find possible building blocks that could work here:</span></span>
<span id="cb17-16">            poss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sslib.GetMatches(r_queries[ridx],maxResults<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>)</span>
<span id="cb17-17">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rxnidx,ridx,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(poss),nWritten)</span>
<span id="cb17-18">            seen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb17-19">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># now loop over those, prepare them, and write them to the output:</span></span>
<span id="cb17-20">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> (sslib.GetMol(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> poss):</span>
<span id="cb17-21">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we use an R0 primitive in the query, so make sure</span></span>
<span id="cb17-22">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we have ring presence</span></span>
<span id="cb17-23">                Chem.FastFindRings(mol)</span>
<span id="cb17-24">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># run our prep reaction:</span></span>
<span id="cb17-25">                ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prep.RunReactant(mol,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb17-26">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write each product (in case there's more than one)</span></span>
<span id="cb17-27">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ps:</span>
<span id="cb17-28">                    smi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolToSmiles(p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb17-29">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># don't write duplicates:</span></span>
<span id="cb17-30">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> smi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> seen:</span>
<span id="cb17-31">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb17-32">                    outf.write(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>smi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>nWritten<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ridx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">r</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rxnidx<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb17-33">                    seen.add(smi)</span>
<span id="cb17-34">                    nWritten <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb17-35">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>,nWritten)</span>
<span id="cb17-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> rxnidx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,nWritten</span>
<span id="cb17-37"></span>
<span id="cb17-38"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./space1.txt'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w+'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> outf:</span>
<span id="cb17-39">    nextRxn,nextIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> enumerate_synthons(possibles,outf)</span>
<span id="cb17-40">            </span>
<span id="cb17-41">                </span>
<span id="cb17-42"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head space1.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 0 264 2
     333
1 1 4456 333
     4778
SMILES  synton_id   synton# reaction_id release
[1*]C([11*])NCC[7*] 1   1   r1  1
[1*]c1ccccc1[7*]    2   2   r1  1
[1*]c1cc(OC)ccc1[7*]    3   2   r1  1
[1*]c1cc(S(N)(=O)=O)ccc1[7*]    4   2   r1  1
[1*]c1cc(Cl)ccc1[7*]    5   2   r1  1
[1*]c1cc(OC)c(OC)cc1[7*]    6   2   r1  1
[1*]c1c([7*])ccc(OC)c1OC    7   2   r1  1
[1*]c1cc(Cl)cc(Cl)c1[7*]    8   2   r1  1
[1*]c1cc(F)ccc1[7*] 9   2   r1  1</code></pre>
</div>
</div>
<div id="915fca67" class="cell" data-execution_count="213">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">spc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpace()</span>
<span id="cb19-2">spc.ReadTextFile(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'space1.txt'</span>)</span>
<span id="cb19-3">spc.GetNumProducts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="213">
<pre><code>1471295</code></pre>
</div>
</div>
<div id="7666a191" class="cell" data-scrolled="false" data-execution_count="214">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">q2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb21-2">q1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1cccc(C(F)(F)F)c1C'</span>)</span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#q = Chem.MolFromSmarts('O=c1ncncc1')</span></span>
<span id="cb21-4"></span>
<span id="cb21-5">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpaceSearchParams()</span>
<span id="cb21-6">params.randomSample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb21-7">params.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span></span>
<span id="cb21-8"></span>
<span id="cb21-9">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spc.SubstructureSearch(q1,params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>params)</span>
<span id="cb21-10">resMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(res.GetHitMolecules(),key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:x.GetNumHeavyAtoms()))</span>
<span id="cb21-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># resMols = res.GetHitMolecules()</span></span>
<span id="cb21-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> results'</span>)</span>
<span id="cb21-13">Draw.MolsToGridImage(resMols[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="214">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-17-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="second-reaction" class="level1">
<h1>Second reaction</h1>
<p>The second reaction is <code>Niementowski_quinazoline</code>, also from the <a href="http://pubs.acs.org/doi/abs/10.1021/ci200379p">Hartenfeller paper</a>. I’ve used this reaction before in a <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-06-12-using-reaction-info.html">blog post showing how to extract information from reaction products</a>.</p>
<p>This one is a bit trickier to encode.</p>
<p>Start with the reaction definition:</p>
<div id="cccd2e00" class="cell" data-execution_count="252">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">sma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[c:1](-[C;$(C-c1ccccc1):2](=[OD1:3])-[OH1]):[c:4](-[NH2:5]).[N;!H0;!$(N-N);!$(N-C=N);!$(N(-C=O)-C=O):6]-[C;H1,$(C-[#6]):7]=[OD1]&gt;&gt;[c:4]2:[c:1]-[C:2](=[O:3])-[N:6]-[C:7]=[N:5]-2'</span></span>
<span id="cb23-2"></span>
<span id="cb23-3">rxn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(sma)</span>
<span id="cb23-4">rxn</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="252">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>These are the two educts from the SI:</p>
<div id="6a8c623d" class="cell" data-scrolled="true" data-execution_count="253">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">r1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1c(C(=O)O)c(N)ccc1'</span>)</span>
<span id="cb24-2">r2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C(=O)N'</span>)</span>
<span id="cb24-3">Draw.MolsToGridImage((r1,r2))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="253">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here are the educts with atom map info:</p>
<div id="c495cb86" class="cell" data-execution_count="254">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">r_queries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rxn.GetReactantTemplate(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(rxn.GetNumReactantTemplates())]</span>
<span id="cb25-2"></span>
<span id="cb25-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r,q <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>([r1,r2],r_queries):</span>
<span id="cb25-4">    match <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r.GetSubstructMatch(q)</span>
<span id="cb25-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> match</span>
<span id="cb25-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,midx <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(match):</span>
<span id="cb25-7">        mnum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q.GetAtomWithIdx(i).GetAtomMapNum()</span>
<span id="cb25-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mnum:</span>
<span id="cb25-9">            r.GetAtomWithIdx(midx).SetAtomMapNum(mnum)</span>
<span id="cb25-10">Draw.MolsToGridImage((r1,r2))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="254">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="f13e33ba" class="cell" data-execution_count="288">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-----</span></span>
<span id="cb26-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Educt 2 is a primary amine</span></span>
<span id="cb26-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   core1: no substituent on educt 2 carbon</span></span>
<span id="cb26-4">core1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O=C1-N-C=N-C([1*]):C1[2*]'</span>,sanitize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb26-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   core3: educt2 has a substituent on the carbon</span></span>
<span id="cb26-6">core3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O=C1-N-C([3*])=N-C([1*]):C1[2*]'</span>,sanitize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb26-7"></span>
<span id="cb26-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Educt 2 is a secondary amine</span></span>
<span id="cb26-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   core2: no substituent on educt 2 carbon</span></span>
<span id="cb26-10">core2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O=C1-N([4*])-C=N-C([1*]):C1[2*]'</span>,sanitize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb26-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   core4: educt2 has a substituent on the carbon</span></span>
<span id="cb26-12">core4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O=C1-N([4*])-C([3*])=N-C([1*]):C1[2*]'</span>,sanitize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb26-13"></span>
<span id="cb26-14">Draw.MolsToGridImage([core1,core2,core3,core4],legends<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'core1'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'core2'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'core3'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'core4'</span>],molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="288">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="01c2c2b3" class="cell" data-execution_count="257">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">r1_prep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[c:1]1(-[C:2](=[OD1:3])-[OH1]):[c:4](-[NH2:5])[c:6][c:7][c:8][c:9]1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb27-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;[2*][c:6][c:7][c:8][c:9][1*]'</span>)</span>
<span id="cb27-3">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r1_prep.RunReactant(r1,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[05:23:12] mapped atoms in the reactants were not mapped in the products.
  unmapped numbers are: 1 2 3 4 5 </code></pre>
</div>
</div>
<div id="1a50ccad" class="cell" data-execution_count="258">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="258">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Make sure we form the correct ring:</p>
<div id="ffef8551" class="cell" data-execution_count="227">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolzipParams()</span>
<span id="cb30-2">ps.label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolzipLabel.Isotope</span>
<span id="cb30-3">tm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.molzip(core1,p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],ps)</span>
<span id="cb30-4">tm</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="227">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now do the preparation reactions for R2, taking the four scenarios into account:</p>
<div id="ef7e7721" class="cell" data-execution_count="294">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">r2_prep1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[NH2;!$(N-N);!$(N-C=N);!$(N(-C=O)-C=O):6]-[CH1:7]=[OD1]</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb31-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;'</span>)</span>
<span id="cb31-3">r2_prep3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[NH2;!$(N-N);!$(N-C=N);!$(N(-C=O)-C=O):6]-[C:7](-[#6:3])=[OD1]</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb31-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;[3*][#6:3]'</span>)</span>
<span id="cb31-5">r2_prep2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[*:8][NH1;!$(N-N);!$(N-C=N);!$(N(-C=O)-C=O):6]-[CH1:7]=[OD1]</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb31-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;[4*][*:8]'</span>)</span>
<span id="cb31-7">r2_prep4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[*:8][NH1;!$(N-N);!$(N-C=N);!$(N(-C=O)-C=O):6]-[C;R0:7](-[#6:3])=[OD1]</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb31-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;([4*][*:8].[3*][*:7])'</span>)</span></code></pre></div>
</div>
<div id="9ea7b4fa" class="cell" data-execution_count="295">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">possibles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(core1,(r1_prep,r2_prep1)),(core2,(r1_prep,r2_prep2)),</span>
<span id="cb32-2">             (core3,(r1_prep,r2_prep3)),(core4,(r1_prep,r2_prep4))]</span></code></pre></div>
</div>
<p>Create the synthon space:</p>
<div id="737d10c1" class="cell" data-execution_count="296">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./space2.txt'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w+'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> outf:</span>
<span id="cb33-2">    nextRxn,nextIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> enumerate_synthons(possibles,outf)</span>
<span id="cb33-3">            </span>
<span id="cb33-4">                </span>
<span id="cb33-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head space2.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 0 189 2
     188
2 0 189 189
     375
2 1 8173 375</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[05:38:56] mapped atoms in the reactants were not mapped in the products.
  unmapped numbers are: 6 7 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>     383
3 0 189 384
     570
3 1 8173 570</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[05:38:57] mapped atoms in the reactants were not mapped in the products.
  unmapped numbers are: 6 7 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>     1690
4 0 189 1691
     1877
4 1 8173 1877</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[05:38:57] mapped atoms in the reactants were not mapped in the products.
  unmapped numbers are: 6 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>     3769
SMILES  synton_id   synton# reaction_id release
[1*]c1nc[nH]c(=O)c1[2*] 1   1   r1  1
[1*]ccc1c([2*])C(=O)c2ccccc2C1=O    2   2   r1  1
[1*]cc(Cl)cc([2*])Cl    3   2   r1  1
[1*]ccc(c[2*])C(F)(F)F  4   2   r1  1
[1*]ccc(Cl)c[2*]    5   2   r1  1
[1*]cc1ccccc1c[2*]  6   2   r1  1
[1*]cc(OC)c(c[2*])OC    7   2   r1  1
[1*]cc(cc[2*])S(=O)(=O)Nc1ccccc1OC  8   2   r1  1
[1*]cc(cc[2*])S(=O)(=O)Nc1ccc(OC)cc1    9   2   r1  1</code></pre>
</div>
</div>
<p>Read it in</p>
<div id="8c666ccf" class="cell" data-scrolled="true" data-execution_count="297">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">spc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpace()</span>
<span id="cb41-2">spc.ReadTextFile(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'space2.txt'</span>)</span>
<span id="cb41-3">spc.GetNumProducts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="297">
<pre><code>561906</code></pre>
</div>
</div>
<p>Search</p>
<div id="96ca2242" class="cell" data-execution_count="286">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">q2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cC(F)(F)F'</span>)</span>
<span id="cb43-2">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpaceSearchParams()</span>
<span id="cb43-3">params.randomSample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb43-4">params.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span></span>
<span id="cb43-5"></span>
<span id="cb43-6">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spc.SubstructureSearch(q2,params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>params)</span>
<span id="cb43-7">resMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(res.GetHitMolecules(),key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:x.GetNumHeavyAtoms()))</span>
<span id="cb43-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># resMols = res.GetHitMolecules()</span></span>
<span id="cb43-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> results'</span>)</span>
<span id="cb43-10">Draw.MolsToGridImage(resMols[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="286">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-31-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We have results here for cores 2-4, but none for core 1. Let’s confirm that there are core1 results in the set</p>
<div id="604129de" class="cell" data-execution_count="298">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">q2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[#6](=O)@[#7H1]@[#6H1]@[#7]'</span>)</span>
<span id="cb45-2">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpaceSearchParams()</span>
<span id="cb45-3">params.randomSample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb45-4">params.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span></span>
<span id="cb45-5"></span>
<span id="cb45-6">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spc.SubstructureSearch(q2,params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>params)</span>
<span id="cb45-7">resMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(res.GetHitMolecules(),key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:x.GetNumHeavyAtoms()))</span>
<span id="cb45-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># resMols = res.GetHitMolecules()</span></span>
<span id="cb45-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> results'</span>)</span>
<span id="cb45-10">Draw.MolsToGridImage(resMols[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[05:41:48] Complex queries can be slow.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>186 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="298">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-32-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="combine-the-two-reaction-spaces" class="level1">
<h1>Combine the two reaction spaces</h1>
<p>We now add these synthons to the other space. We could do this by sequentially enumerating the spaces into the same output file, but it’s quicker to re-enumerate the second space onto the bottom of the output file from the first one:</p>
<div id="a6bc6a51" class="cell" data-execution_count="289">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>cp space1.txt combined.txt</span>
<span id="cb48-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>tail combined.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[11*]c1ccnn1-c1cccnc1   4768    3   r1  1
[11*]C1CC2(C1)CC(OC)C2  4769    3   r1  1
[11*]c1c(Cl)cnc(F)c1Cl  4770    3   r1  1
[11*]c1cc(Cl)c(C(=O)O)s1    4771    3   r1  1
[11*]C1COC2CC1C2    4772    3   r1  1
[11*]C12C3CCC(CC31)C2(F)F   4773    3   r1  1
[11*]c1ccc(C(F)(F)C(F)(F)F)s1   4774    3   r1  1
[11*]C12C3CC(CC31)C2NC(=O)OC(C)(C)C 4775    3   r1  1
[11*]C1OCCOC1(C)C   4776    3   r1  1
[11*]c1cc(C)cc(C(F)F)c1 4777    3   r1  1</code></pre>
</div>
</div>
<p>Now re-enumerate the second space, start the synthon IDs at 4778 and the reaction IDs at 2:</p>
<div id="47526c7a" class="cell" data-execution_count="299">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'combined.txt'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> outf:</span>
<span id="cb50-2">    enumerate_synthons(possibles,outf,writeHeader<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,nWritten<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4778</span>,startIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb50-3">spc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpace()</span>
<span id="cb50-4">spc.ReadTextFile(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'combined.txt'</span>)</span>
<span id="cb50-5">spc.GetNumProducts()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2 0 189 4779
     4965
3 0 189 4966
     5152
3 1 8173 5152
     5160
4 0 189 5161
     5347
4 1 8173 5347
     6467
5 0 189 6468
     6654
5 1 8173 6654
     8546</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="299">
<pre><code>5965799</code></pre>
</div>
</div>
<div id="da47a957" class="cell" data-scrolled="true" data-execution_count="300">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>tail combined.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[3*]C.[4*]CC1(N)CCC1    8536    3   r5  1
[3*]C.[4*]C1CCCCC1CN    8537    3   r5  1
[3*]C.[4*]CC1(N)CCCCC1  8538    3   r5  1
[3*]C.[4*]CC1(N)CCCC1   8539    3   r5  1
[3*]C.[4*]C1CC(N)C12CCC2    8540    3   r5  1
[3*]C.[4*]C1CCOCC1N 8541    3   r5  1
[3*]C.[4*]CC(N)c1ccccc1OC   8542    3   r5  1
[3*]C.[4*]C(CN)C(C)(C)C 8543    3   r5  1
[3*]C.[4*]C1Cc2ccccc2C1N    8544    3   r5  1
[3*]C.[4*]C1CC2(C1)CC(N)C2  8545    3   r5  1</code></pre>
</div>
</div>
<p>Verify that searches return results from both spaces:</p>
<div id="495fe668" class="cell" data-execution_count="301">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1">q2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cC(F)(F)F'</span>)</span>
<span id="cb55-2">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpaceSearchParams()</span>
<span id="cb55-3">params.randomSample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb55-4">params.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span></span>
<span id="cb55-5"></span>
<span id="cb55-6">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spc.SubstructureSearch(q2,params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>params)</span>
<span id="cb55-7">resMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(res.GetHitMolecules(),key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:x.GetNumHeavyAtoms()))</span>
<span id="cb55-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># resMols = res.GetHitMolecules()</span></span>
<span id="cb55-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> results'</span>)</span>
<span id="cb55-10">Draw.MolsToGridImage(resMols[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="301">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-36-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="reaction-3" class="level1">
<h1>Reaction 3</h1>
<p>For the last example, I’ll add the reaction definition for spiro chromanone from the Hartenfeller paper. This one is fun because it forms a spiro linkage.</p>
<div id="ff4b7794" class="cell" data-execution_count="302">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1">sma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[c:1](-[C;$(C-c1ccccc1):2](=[OD1:3])-[CH3:4]):[c:5](-[OH1:6]).[C;$(C1-[CH2]-[CH2]-[N,C]-[CH2]-[CH2]-1):7](=[OD1])&gt;&gt;[O:6]1-[c:5]:[c:1]-[C:2](=[OD1:3])-[C:4]-[C:7]-1'</span></span>
<span id="cb57-2"></span>
<span id="cb57-3">rxn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(sma)</span>
<span id="cb57-4">rxn</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="302">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>These are the two educts from the SI:</p>
<div id="5197ad25" class="cell" data-scrolled="true" data-execution_count="303">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1">r1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1cc(C(=O)C)c(O)cc1'</span>)</span>
<span id="cb58-2">r2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1(=O)CCNCC1'</span>)</span>
<span id="cb58-3">Draw.MolsToGridImage((r1,r2))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="303">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here’s what the prototype product looks like:</p>
<div id="aaba9e83" class="cell" data-execution_count="304">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rxn.RunReactants([r1,r2])</span>
<span id="cb59-2">p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="304">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-40-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here are the educts with atom map info:</p>
<div id="7a4c0b4f" class="cell" data-execution_count="305">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1">r_queries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rxn.GetReactantTemplate(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(rxn.GetNumReactantTemplates())]</span>
<span id="cb60-2"></span>
<span id="cb60-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r,q <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>([r1,r2],r_queries):</span>
<span id="cb60-4">    match <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r.GetSubstructMatch(q)</span>
<span id="cb60-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> match</span>
<span id="cb60-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,midx <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(match):</span>
<span id="cb60-7">        mnum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q.GetAtomWithIdx(i).GetAtomMapNum()</span>
<span id="cb60-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mnum:</span>
<span id="cb60-9">            r.GetAtomWithIdx(midx).SetAtomMapNum(mnum)</span>
<span id="cb60-10">Draw.MolsToGridImage((r1,r2))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="305">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ae71849f" class="cell" data-execution_count="309">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1">core <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O=C(-[C][4*])c([1*]):c([5*])[O][6*]'</span>,sanitize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb61-2">core</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="309">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="962786d1" class="cell" data-execution_count="317">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1">r1_prep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[c:1]1(-[C:2](=[OD1:3])-[CH3:4]):[c:5](-[OH1:6]):[c:7]:[c:8]:[c:9]:[c:10]1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb62-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;[*1]:[c:7]:[c:8]:[c:9]:[c:10]:[5*]'</span>)</span>
<span id="cb62-3">p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r1_prep.RunReactant(r1,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb62-4">p1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[06:13:20] mapped atoms in the reactants were not mapped in the products.
  unmapped numbers are: 1 2 3 4 5 6 </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="317">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-43-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="81c1e13d" class="cell" data-execution_count="318">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'[C;$(C1-[CH2]-[CH2]-[N,C]-[CH2]-[CH2]-1):7](=[OD1])'</span></span>
<span id="cb64-2">r2_prep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O=[C:11]1-[CH2:12]-[CH2:13]-[N,C:14]-[CH2:15]-[CH2:16]-1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb64-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;&gt;[4*][C:11]1([6*])-[CH2:12]-[CH2:13]-[N,C:14]-[CH2:15]-[CH2:16]-1'</span>)</span>
<span id="cb64-4">p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r2_prep.RunReactant(r2,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb64-5">p2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="318">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-44-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Make sure we form the correct ring:</p>
<div id="b44bb490" class="cell" data-execution_count="321">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1">tm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RWMol(core)</span>
<span id="cb65-2">tm.InsertMol(p1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb65-3">tm.InsertMol(p2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb65-4">ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolzipParams()</span>
<span id="cb65-5">ps.label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolzipLabel.Isotope</span>
<span id="cb65-6">tm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.molzip(tm,ps)</span>
<span id="cb65-7">tm</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="321">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b3520b30" class="cell" data-execution_count="334">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1">Draw.MolsToGridImage([core,p1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],p2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],tm],legends<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synthon1'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synthon2'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synthon3'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'product'</span>],molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="334">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-46-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="4fecb38b" class="cell" data-execution_count="322">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1">possibles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(core,(r1_prep,r2_prep))]</span></code></pre></div>
</div>
<p>Create the synthon space:</p>
<div id="99cc6ea4" class="cell" data-execution_count="323">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./space3.txt'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w+'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> outf:</span>
<span id="cb68-2">    nextRxn,nextIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> enumerate_synthons(possibles,outf)</span>
<span id="cb68-3">            </span>
<span id="cb68-4">                </span>
<span id="cb68-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head space2.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 0 58 2
     60
1 1 241 60
     301
SMILES  synton_id   synton# reaction_id release
[1*]c1nc[nH]c(=O)c1[2*] 1   1   r1  1
[1*]ccc1c([2*])C(=O)c2ccccc2C1=O    2   2   r1  1
[1*]cc(Cl)cc([2*])Cl    3   2   r1  1
[1*]ccc(c[2*])C(F)(F)F  4   2   r1  1
[1*]ccc(Cl)c[2*]    5   2   r1  1
[1*]cc1ccccc1c[2*]  6   2   r1  1
[1*]cc(OC)c(c[2*])OC    7   2   r1  1
[1*]cc(cc[2*])S(=O)(=O)Nc1ccccc1OC  8   2   r1  1
[1*]cc(cc[2*])S(=O)(=O)Nc1ccc(OC)cc1    9   2   r1  1</code></pre>
</div>
</div>
<p>Read it in</p>
<div id="e6920d21" class="cell" data-scrolled="true" data-execution_count="324">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1">spc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpace()</span>
<span id="cb70-2">spc.ReadTextFile(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'space3.txt'</span>)</span>
<span id="cb70-3">spc.GetNumProducts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="324">
<pre><code>13978</code></pre>
</div>
</div>
<p>Search</p>
<div id="3f3ee541" class="cell" data-execution_count="325">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1">q2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cC(F)(F)F'</span>)</span>
<span id="cb72-2">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpaceSearchParams()</span>
<span id="cb72-3">params.randomSample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb72-4">params.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span></span>
<span id="cb72-5"></span>
<span id="cb72-6">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spc.SubstructureSearch(q2,params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>params)</span>
<span id="cb72-7">resMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(res.GetHitMolecules(),key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:x.GetNumHeavyAtoms()))</span>
<span id="cb72-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># resMols = res.GetHitMolecules()</span></span>
<span id="cb72-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> results'</span>)</span>
<span id="cb72-10">Draw.MolsToGridImage(resMols[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>778 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="325">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-50-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And combine it with the other two:</p>
<div id="75d1f4b5" class="cell" data-scrolled="true" data-execution_count="326">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>tail combined.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[3*]C.[4*]CC1(N)CCC1    8536    3   r5  1
[3*]C.[4*]C1CCCCC1CN    8537    3   r5  1
[3*]C.[4*]CC1(N)CCCCC1  8538    3   r5  1
[3*]C.[4*]CC1(N)CCCC1   8539    3   r5  1
[3*]C.[4*]C1CC(N)C12CCC2    8540    3   r5  1
[3*]C.[4*]C1CCOCC1N 8541    3   r5  1
[3*]C.[4*]CC(N)c1ccccc1OC   8542    3   r5  1
[3*]C.[4*]C(CN)C(C)(C)C 8543    3   r5  1
[3*]C.[4*]C1Cc2ccccc2C1N    8544    3   r5  1
[3*]C.[4*]C1CC2(C1)CC(N)C2  8545    3   r5  1</code></pre>
</div>
</div>
<div id="a25a69ca" class="cell" data-execution_count="328">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'combined.txt'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> outf:</span>
<span id="cb76-2">    enumerate_synthons(possibles,outf,writeHeader<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,nWritten<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8546</span>,startIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb76-3">spc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpace()</span>
<span id="cb76-4">spc.ReadTextFile(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'combined.txt'</span>)</span>
<span id="cb76-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(spc.GetNumProducts())</span>
<span id="cb76-6"></span>
<span id="cb76-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>tail combined.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>6 0 58 8547
     8605
6 1 241 8605
     8846
6077623
[4*]C1([6*])CCC(=C(F)F)CC1  8836    3   r6  1
[4*]C1([6*])CCN(S(=O)(=O)F)CC1  8837    3   r6  1
[4*]C1([6*])CCN(c2cc(=O)[nH]cn2)CC1 8838    3   r6  1
[4*]C1([6*])CCN(OCc2ccc(Cl)cc2)CC1  8839    3   r6  1
[4*]C1([6*])CCC(N2CCCC2)CC1 8840    3   r6  1
[4*]C1([6*])CCC(N2CCOCC2)CC1    8841    3   r6  1
[4*]C1([6*])CCN(c2cc[nH]c(=O)c2)CC1 8842    3   r6  1
[4*]C1([6*])CCC([N+](=O)[O-])CC1    8843    3   r6  1
[4*]C1([6*])CCC2(CC1)CC2C(=O)OC 8844    3   r6  1
[4*]C1([6*])CCC2(CCC(CBr)O2)CC1 8845    3   r6  1</code></pre>
</div>
</div>
<p>Do a search to be sure we get results from multiple reactions:</p>
<div id="d5be75ad" class="cell" data-execution_count="332">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1">q2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cC(=O)C'</span>)</span>
<span id="cb78-2">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpaceSearchParams()</span>
<span id="cb78-3">params.randomSample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb78-4">params.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span></span>
<span id="cb78-5"></span>
<span id="cb78-6">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spc.SubstructureSearch(q2,params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>params)</span>
<span id="cb78-7">resMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(res.GetHitMolecules(),key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:x.GetNumHeavyAtoms()))</span>
<span id="cb78-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># resMols = res.GetHitMolecules()</span></span>
<span id="cb78-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> results'</span>)</span>
<span id="cb78-10">Draw.MolsToGridImage(resMols[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="332">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons_files/figure-html/cell-53-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>There are many more reactions in the Hartenfeller paper, but I’m going to stop here.</p>


</section>

 ]]></description>
  <category>tutorial</category>
  <category>documentation</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-12-14-Reaction-synthons.html</guid>
  <pubDate>Sat, 13 Dec 2025 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/reaction-synthons-1.png" medium="image" type="image/png" height="36" width="144"/>
</item>
<item>
  <title>Building synthon spaces with BRICS fragments</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-12-07-BRICS-synthons.html</link>
  <description><![CDATA[ 




<p>Last year we added functionality to the RDKit to allow searching in synthon, or combinatorial library spaces. Dave Cosgrove <a href="https://greglandrum.github.io/rdkit-blog/posts/2024-12-03-introducing-synthon-search.html">did a blog post</a> on this a while ago and there also a <a href="https://www.rdkit.org/docs/GettingStartedInPython.html#searching-synthon-spaces">tutorial in the docs</a>.</p>
<p>I’ve been asked a few times how one can create a synthon space from either a set of compounds or a set of reactions and building blocks. This post will focus on the first use case: creating a synthon space from the fragments created by applying BRICS fragmentation to a set of ChEMBL compounds. I will try to do a post covering the other use case in the not-too-distant future.</p>
<div id="872abcd6-8e5b-44ee-8e83-33b9d77adcd2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BRICS</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdSynthonSpaceSearch</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb1-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.09.3</code></pre>
</div>
</div>
<section id="the-synthon-space-input-file" class="level1">
<h1>The synthon space input file</h1>
<p>Let’s start by looking at what the synthon space input file looks like:</p>
<div id="fed730d1-e1fb-49c2-a3ca-4c29819ad5cb" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># snipped from the freedom space input</span></span>
<span id="cb3-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./blah.txt'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w+'</span>).write(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''SMILES synton_id   synton# reaction_id release</span></span>
<span id="cb3-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Clc1ccc(-c2cnc(N[U])s2)cc1  6   1   a1  3</span></span>
<span id="cb3-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">O=[N+]([O-])c1cccc(N[U])c1O 10  1   a1  3</span></span>
<span id="cb3-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">O=C([U])c1sc2cc(Cl)ccc2c1Cl 31  2   a1  3</span></span>
<span id="cb3-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1cccc(O)c1C(=O)[U]   86  2   a1  3</span></span>
<span id="cb3-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>189</code></pre>
</div>
</div>
<p>There’s more information about the format and how searches work <a href="https://www.rdkit.org/docs/GettingStartedInPython.html#how-it-works">in the docs</a>.</p>
<p>Here’s a quick demo on using the file:</p>
<div id="a8602b25-fe60-4eec-bd4e-4f583b50f65b" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">spc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpace()</span>
<span id="cb5-2">spc.ReadTextFile(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blah.txt'</span>)</span>
<span id="cb5-3">spc.GetNumProducts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>4</code></pre>
</div>
</div>
<div id="7d981a24-bee5-4718-9129-dbf297a664f3" class="cell" data-scrolled="false" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spc.SubstructureSearch(Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CN'</span>))</span>
<span id="cb7-2">Draw.MolsToGridImage(res.GetHitMolecules())</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-07-BRICS-synthons_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="brics-decomposition" class="level1">
<h1>BRICS decomposition:</h1>
<p>I did a post earlier this year with a <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial.html">tutorial on BRICS decomposition</a>, so I won’t get into a lot of detail here.</p>
<p>Here’s a ChEMBL molecule we’ll work with:</p>
<div id="d610df36-0b11-4099-a428-f0dedfafa30d" class="cell" data-scrolled="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1=C(c2ccc(CCN3CCCCC3)cc2)C2CN(Cc3ccccc3)CC2C1 CHEMBL256225'</span>)</span>
<span id="cb8-2">m</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-07-BRICS-synthons_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And this is what we get when we do a BRICS decomposition:</p>
<div id="bd232c92-073e-412d-822e-9213bc34e22d" class="cell" data-scrolled="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">BRICS.BRICSDecompose(m)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>{'[16*]c1ccccc1',
 '[4*]CC[8*]',
 '[4*]C[8*]',
 '[5*]N1CC2CC=C(c3ccc([16*])cc3)C2C1',
 '[5*]N1CCCCC1'}</code></pre>
</div>
</div>
<p>The synthon space search code works by combining multiple building blocks to form a compound in a single “reaction” step, and it’s unhappy if you have dummy atoms/attachment points leftover after that step, So these fragments are too small to be useful in sython searching.</p>
<p>Fortunately, we can have the BRICS decomposition give us partial decomposition results along with the final results:</p>
<div id="7ec211eb" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">BRICS.BRICSDecompose(m,keepNonLeafNodes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,minFragmentSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>{'C1=C(c2ccc(CCN3CCCCC3)cc2)C2CN(Cc3ccccc3)CC2C1',
 '[16*]c1ccc(C2=CCC3CN(Cc4ccccc4)CC23)cc1',
 '[16*]c1ccccc1',
 '[4*]CC[8*]',
 '[4*]CCc1ccc(C2=CCC3CN(C[8*])CC23)cc1',
 '[4*]CCc1ccc(C2=CCC3CN(Cc4ccccc4)CC23)cc1',
 '[4*]CCc1ccc(C2=CCC3CN([5*])CC23)cc1',
 '[4*]Cc1ccccc1',
 '[5*]N1CC2CC=C(c3ccc(CCN4CCCCC4)cc3)C2C1',
 '[5*]N1CC2CC=C(c3ccc([16*])cc3)C2C1',
 '[5*]N1CCCCC1',
 '[8*]CCN1CCCCC1',
 '[8*]CN1CC2CC=C(c3ccc(CCN4CCCCC4)cc3)C2C1',
 '[8*]CN1CC2CC=C(c3ccc([16*])cc3)C2C1'}</code></pre>
</div>
</div>
<p>What we’ll do here is pick out all of the fragments that have two attachment points to use as core synthons for a reaction and then provide all the single-attachment point fragments that are compatible with those two attachment points as the other partners in a reaction.</p>
<p>So in this case one “reaction” would be around the core <code>[4*]CCc1ccc(C2=CCC3CN(C[8*])CC23)cc1</code> as synthon 1. We would we’d provide all of the single-attachment fragments that can connect to attachment point <code>[4*]</code> (in this set of fragments that’s only <code>[5*]</code>) as synthon 2, and all of the single-attachment fragnets that can connect to attachment point <code>[8*]</code> (here that’s <code>[16*]</code>) as synthon 3.</p>
<p>Because the synthon code connects attachment points with the same label, we need to transform all of the <code>[5*]</code>s into <code>[4*]</code>s and all of the <code>[16*]</code>s into <code>[8*]</code>s to give this:</p>
<pre><code>SMILES  synton_id   synton# reaction_id release
[4*]CCc1ccc(C2=CCC3CN(C[8*])CC23)cc1    1   1   r1  1
[4*]N1CCCCC1    2   2   r1  1
[4*]Cc1ccccc1   3   2   r1  1
[4*]N1CC2CC=C(c3ccc(CCN4CCCCC4)cc3)C2C1 4   2   r1  1
[4*]CCc1ccc(C2=CCC3CN(Cc4ccccc4)CC23)cc1    5   2   r1  1
[8*]c1ccc(C2=CCC3CN(Cc4ccccc4)CC23)cc1  6   3   r1  1
[8*]CN1CC2CC=C(c3ccc(CCN4CCCCC4)cc3)C2C1    7   3   r1  1
[8*]CCN1CCCCC1  8   3   r1  1
[8*]c1ccccc1    9   3   r1  1</code></pre>
<p>Automating this to handle a set of molecules doesn’t require a massive amount of code:</p>
<div id="53c93237" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> defaultdict</span>
<span id="cb14-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb14-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BRICS</span>
<span id="cb14-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> copy</span>
<span id="cb14-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb14-6"></span>
<span id="cb14-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_connectors():</span>
<span id="cb14-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">''' read all the BRICS "reaction" definitions and build a dict mapping</span></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      connector type -&gt; types it can connect to</span></span>
<span id="cb14-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    '''</span></span>
<span id="cb14-11">    connectors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>)</span>
<span id="cb14-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> defs <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> BRICS.reactionDefs:</span>
<span id="cb14-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,j,b <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> defs:</span>
<span id="cb14-14">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-'</span>:</span>
<span id="cb14-15">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb14-16">            connectors[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*'</span>].append(j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*'</span>)</span>
<span id="cb14-17">            connectors[j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*'</span>].append(i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*'</span>)</span>
<span id="cb14-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove duplicates and convert to a standard dict</span></span>
<span id="cb14-19">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb14-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k,v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> connectors.items():</span>
<span id="cb14-21">        res[k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(v))</span>
<span id="cb14-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> res</span>
<span id="cb14-23"></span>
<span id="cb14-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_synthons(mol):</span>
<span id="cb14-25">    frags <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BRICS.BRICSDecompose(mol,keepNonLeafNodes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,minFragmentSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb14-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove anything with 7 in it since those are attached with double bonds</span></span>
<span id="cb14-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and we don't handle those:</span></span>
<span id="cb14-28">    frags <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> frags <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[7*'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x]</span>
<span id="cb14-29">    cnts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(x,x.count(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*'</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> frags]</span>
<span id="cb14-30">    ones <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>([x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x,cnt <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> cnts <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> cnt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x)))</span>
<span id="cb14-31">    twos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>([x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x,cnt <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> cnts <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> cnt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x)))</span>
<span id="cb14-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> twos,ones</span>
<span id="cb14-33"></span>
<span id="cb14-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_possibles(rlabel,frags,connectors):</span>
<span id="cb14-35">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb14-36">    poss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> connectors[rlabel]</span>
<span id="cb14-37">    rlabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'['</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>rlabel</span>
<span id="cb14-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> frags:</span>
<span id="cb14-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> rlabel <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smi:</span>
<span id="cb14-40">            res.append(smi)</span>
<span id="cb14-41">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb14-42">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> lbl <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> poss:</span>
<span id="cb14-43">            lbl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'['</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>lbl</span>
<span id="cb14-44">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> lbl <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smi:</span>
<span id="cb14-45">                nsmi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> smi.replace(lbl,rlabel)</span>
<span id="cb14-46">                res.append(nsmi)</span>
<span id="cb14-47">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb14-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> res</span>
<span id="cb14-49"></span>
<span id="cb14-50"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_rs(core):</span>
<span id="cb14-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> re.findall(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'\[(.*?\*)\]'</span>,core)</span>
<span id="cb14-52"></span>
<span id="cb14-53"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_space(mols,fname):</span>
<span id="cb14-54">    connectors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_connectors()</span>
<span id="cb14-55">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(fname,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w+'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> outf:</span>
<span id="cb14-56">        nWritten <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb14-57">        nRxns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb14-58">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(mols):</span>
<span id="cb14-59">            twos,ones <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_synthons(mol)</span>
<span id="cb14-60">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(twos):</span>
<span id="cb14-61">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb14-62">            nWritten,nRxns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_reactions(outf,twos,ones,connectors,nWritten,nRxns,writeHeader<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> nWritten))</span>
<span id="cb14-63">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> nWritten,nRxns</span>
<span id="cb14-64"></span>
<span id="cb14-65"></span>
<span id="cb14-66"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_reactions(outf,allTwos,allOnes,connectors,nWritten<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,nRxns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,writeHeader<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb14-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> writeHeader:</span>
<span id="cb14-68">        outf.write(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SMILES'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synton_id'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synton#'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'reaction_id'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'release'</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb14-69">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> rs,twos <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> allTwos.items():</span>
<span id="cb14-70">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(rs)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb14-71">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do we have the same label twice?</span></span>
<span id="cb14-72">        newrs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rs[:]</span>
<span id="cb14-73">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(rs)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb14-74">            rs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(rs)</span>
<span id="cb14-75">            rlabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb14-76">            newlabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rlabel.replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'00*'</span>)</span>
<span id="cb14-77">            newrs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (newlabel,rs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb14-78">            connectors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> copy.deepcopy(connectors)</span>
<span id="cb14-79">            connectors[newlabel] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> connectors[rlabel]</span>
<span id="cb14-80">            rs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(rs)</span>
<span id="cb14-81">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> core <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> twos:</span>
<span id="cb14-82">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> newrs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> rs:</span>
<span id="cb14-83">                core <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> core.replace(rs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],newrs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-84">            outf.write(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>core<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>nWritten<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">r</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>nRxns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb14-85">            nWritten <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb14-86">        ones <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allOnes[rs]</span>
<span id="cb14-87">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j,r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(newrs):</span>
<span id="cb14-88">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> get_possibles(r,ones,connectors):</span>
<span id="cb14-89">                outf.write(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>nWritten<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>j<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">r</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>nRxns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">1</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb14-90">                nWritten <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb14-91">        nRxns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb14-92">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> nWritten,nRxns</span>
<span id="cb14-93"></span>
<span id="cb14-94"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_space(mols,fname):</span>
<span id="cb14-95">    connectors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_connectors()</span>
<span id="cb14-96">    allOnes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>)</span>
<span id="cb14-97">    allTwos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>)</span>
<span id="cb14-98">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mols:</span>
<span id="cb14-99">        twos,ones <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_synthons(mol)</span>
<span id="cb14-100">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> two <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> twos:</span>
<span id="cb14-101">            rs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(get_rs(two)))</span>
<span id="cb14-102">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(rs) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb14-103">                logger.warning(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'core </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>two<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> does not have two attachment points'</span>)</span>
<span id="cb14-104">            allTwos[rs].add(two)</span>
<span id="cb14-105">            allOnes[rs] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> allOnes[rs].union(ones)</span>
<span id="cb14-106">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(fname,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w+'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> outf:</span>
<span id="cb14-107">        nWritten,nRxns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_reactions(outf,allTwos,allOnes,connectors)</span>
<span id="cb14-108">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> nWritten,nRxns</span></code></pre></div>
</div>
<p>Try that out on two molecules:</p>
<div id="88ec3e88" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">sample1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1=C(c2ccc(CCN3CCCCC3)cc2)C2CN(Cc3ccccc3)CC2C1 CHEMBL256225'</span>)</span>
<span id="cb15-2">sample2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1=C(c2ccc(CCN3CCCCCC3)cc2)C2CN(Cc3ccccc3)CC2C1 madeup'</span>)</span>
<span id="cb15-3">nWritten,nRxns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>generate_space([sample1,sample2],<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blah2.txt'</span>)</span>
<span id="cb15-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(nWritten,nRxns)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>65 4</code></pre>
</div>
</div>
<div id="fad5d4ab" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head blah2.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SMILES  synton_id   synton# reaction_id release
[4*]CCc1ccc(C2=CCC3CN(C[8*])CC23)cc1    1   1   r1  1
[4*]CC[8*]  2   1   r1  1
[4*]N1CCCCC1    3   2   r1  1
[4*]Cc1ccccc1   4   2   r1  1
[4*]N1CC2CC=C(c3ccc(CCN4CCCCC4)cc3)C2C1 5   2   r1  1
[4*]N1CCCCCC1   6   2   r1  1
[4*]CCc1ccc(C2=CCC3CN(Cc4ccccc4)CC23)cc1    7   2   r1  1
[4*]N1CC2CC=C(c3ccc(CCN4CCCCCC4)cc3)C2C1    8   2   r1  1
[8*]CCN1CCCCC1  9   3   r1  1</code></pre>
</div>
</div>
<p>Notice in the above that we have combined the two cores that have attachment points <code>[4*]</code> and <code>[8*]</code> into a single reaction, <code>r1</code>. This makes the resulting synthon space smaller and more efficient to search.</p>
<p>Ok, let’s do more molecules. I’ll use the set of very active molecules from ChEMBL36 that I put together in an <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-10-31-how-long-does-it-take.html">earlier blog post</a>.</p>
<div id="0f7ef016" class="cell" data-scrolled="true" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">lines <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'../data/chembl36_very_active.txt'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>).readlines()</span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># header:</span></span>
<span id="cb19-3">lines.pop(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb19-4">keep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb19-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> l <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> lines:</span>
<span id="cb19-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'['</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> l:</span>
<span id="cb19-7">        keep.append(l.strip().split()[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb19-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(keep)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>3074</code></pre>
</div>
</div>
<div id="d15a2d0d" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">Draw.MolsToGridImage([Chem.MolFromSmiles(smi) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> keep[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>]],molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-07-BRICS-synthons_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Generate a synthon space for the first 300 of the ChEMBL compounds:</p>
<div id="24fb0066" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">first <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromSmiles(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> keep[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>]]</span>
<span id="cb22-2"></span>
<span id="cb22-3">fname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./results/actives_space.txt'</span></span>
<span id="cb22-4">nwritten,nrxns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_space(first,fname)</span>
<span id="cb22-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>nwritten<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> synthons in </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>nrxns<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> reactions'</span>)</span>
<span id="cb22-6"></span>
<span id="cb22-7">spc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdSynthonSpaceSearch.SynthonSpace()</span>
<span id="cb22-8">spc.ReadTextFile(fname)</span>
<span id="cb22-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rdSynthonSpaceSearch<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>FormattedIntegerString(spc.GetNumProducts())<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> products in space'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>23789 synthons in 79 reactions
253 702 889 products in space</code></pre>
</div>
</div>
<p>Here’s what the file looks like:</p>
<div id="2125691f" class="cell" data-scrolled="true" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head .<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>actives_space.txt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SMILES  synton_id   synton# reaction_id release
[500*]NC(=O)N[5*]   1   1   r1  1
[500*]NC(=O)NC1CCN(C(=O)c2ccc(C(=O)N[5*])cc2)CC1    2   1   r1  1
[500*]Nc1nc2c(nc1N1CCC(Oc3ccc(F)cc3F)CC1)C(C)N([5*])CC2 3   1   r1  1
[500*]Nc1cc2cc(C3CCN([5*])CC3)c(C)cc2cn1    4   1   r1  1
[500*]Nc1nc2c(nc1N1CCC(Oc3ccc(F)cc3F)CC1)CN([5*])C(C)C2 5   1   r1  1
[500*]NCCCN1CCN(CCCN[5*])CC1    6   1   r1  1
[500*]Nc1cccc(CCN2CCN([5*])CC2)c1   7   1   r1  1
[500*]Nc1ccc(S(=O)(=O)N[5*])cc1F    8   1   r1  1
[500*]NC(=O)c1ccc(-c2cnc3c(N[5*])cc(C(F)(F)c4cccc(F)c4)nn23)cc1C    9   1   r1  1</code></pre>
</div>
</div>
<p>Let’s do a few searches:</p>
<div id="3cfdcad3" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spc.SubstructureSearch(Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1cccs1'</span>))</span>
<span id="cb26-2">resMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.GetHitMolecules()</span>
<span id="cb26-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> results'</span>)</span>
<span id="cb26-4">Draw.MolsToGridImage(resMols[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 results</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-07-BRICS-synthons_files/figure-html/cell-16-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="287ec6ab" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spc.SubstructureSearch(Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1ncncc1'</span>))</span>
<span id="cb28-2">resMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.GetHitMolecules()</span>
<span id="cb28-3"></span>
<span id="cb28-4">Draw.MolsToGridImage(resMols[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(resMols) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-07-BRICS-synthons_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It’s nicer to sort by increasing molecular size:</p>
<div id="966e397c" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">tms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(resMols,key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:x.GetNumHeavyAtoms()))</span>
<span id="cb29-2">Draw.MolsToGridImage(tms[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(tms) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-12-07-BRICS-synthons_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we saw in the <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial.html">blog post on BRICS</a>, you can get some odd molecules by putting together BRICS fragments, but there are plenty of results in there that still look reasonable.</p>


</section>

 ]]></description>
  <category>tutorial</category>
  <category>documentation</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-12-07-BRICS-synthons.html</guid>
  <pubDate>Sat, 06 Dec 2025 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/brics-synthons-1.png" medium="image" type="image/png" height="47" width="144"/>
</item>
<item>
  <title>Thresholds for “random” with 3D similarity methods</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d.html</link>
  <description><![CDATA[ 




<section id="intro" class="level1">
<h1>Intro</h1>
<p>In this one I’m generating some reference data for 3D similarity approaches. The idea is inspired by <a href="https://greglandrum.github.io/rdkit-blog/posts/2021-05-18-fingerprint-thresholds1.html">this blog post</a>, where I figured out noise thresholds for similarity calculations with a bunch of 2D fingerprints. Here I do basically the same thing: calculating a number of different 3D similarity (or distance) metrics on random pairs of molecules in order to establish noise thresholds for those metrics.</p>
<p>I compare results from two different data sets for this: 1. 25000 random pairs of molecules with crystal structures from the LOBSTER data set. The <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-11-08-working-with-lobster-1.html">last</a> <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2.html">three</a> <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3.html">blog posts</a> have looked at LOBSTER. I used the crystal structures from the LOBSTER data set for these molecules. 2. 50000 random pairs of molecules from the ChEMBL set I used in the <a href="https://greglandrum.github.io/rdkit-blog/posts/2021-05-18-fingerprint-thresholds1.html">fingerprint thresholds post</a>. I used ETKDGv3 conformers for these molecules.</p>
<p>The first data set is considerably less diverse, the pairs are formed from only 3583 unique molecules, but the 3D structures are from crystals so I think it’s worth considering (even though we know that ETKDG does generally produce reasonable structures). For cases where the values disagree, I think it’s probably better to use the ChEMBL results since they come from a larger data set.</p>
<p>Here’s the summary of the results.</p>
<section id="alignment-based-approaches" class="level2">
<h2 class="anchored" data-anchor-id="alignment-based-approaches">Alignment based approaches</h2>
<p>Here some of the metrics are similarity based, where the thresholds are lower bounds, and some are distance based, where the thresholds are upper bounds. Rather than transform the distance into similarity, I think it’s more useful to report the values that actually come from the RDKit function. If this turns out to be wrong, I will update the blog post.</p>
<p>For example, if you do a shape-based alignment of two molecules to each other and get a shape Tanimoto score of 0.80, the LOBSTER data would say that the value is larger than 95% of the random pairs while the ChEMBL data says it’s larger (more significant) than 99% of the random pairs. Similarly, if the shape-based alignment produces a shape Tanimoto distance of 0.30, both data sets would say that the distance is smaller (more significant) than 99% of the random pairs.</p>
<section id="lobster-set" class="level3">
<h3 class="anchored" data-anchor-id="lobster-set">LOBSTER Set</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>metric</th>
<th>70%</th>
<th>80%</th>
<th>90%</th>
<th>95%</th>
<th>99%</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>baseline_ShapeTanimoto</td>
<td>&gt;0.49</td>
<td>&gt;0.54</td>
<td>&gt;0.62</td>
<td>&gt;0.69</td>
<td>&gt;0.81</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>shape_align_ShapeTanimoto</td>
<td>&gt;0.62</td>
<td>&gt;0.66</td>
<td>&gt;0.71</td>
<td>&gt;0.76</td>
<td>&gt;0.85</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>baseline_TanimotoDist</td>
<td>&lt;0.61</td>
<td>&lt;0.57</td>
<td>&lt;0.52</td>
<td>&lt;0.48</td>
<td>&lt;0.39</td>
<td>DISTANCE</td>
</tr>
<tr class="even">
<td>shape_align_TanimotoDist</td>
<td>&lt;0.53</td>
<td>&lt;0.50</td>
<td>&lt;0.46</td>
<td>&lt;0.42</td>
<td>&lt;0.34</td>
<td>DISTANCE</td>
</tr>
<tr class="odd">
<td>shape_align_noc_TanimotoDist</td>
<td>&lt;0.52</td>
<td>&lt;0.49</td>
<td>&lt;0.45</td>
<td>&lt;0.42</td>
<td>&lt;0.34</td>
<td>DISTANCE</td>
</tr>
<tr class="even">
<td>o3a_align_TanimotoDist</td>
<td>&lt;0.58</td>
<td>&lt;0.55</td>
<td>&lt;0.51</td>
<td>&lt;0.46</td>
<td>&lt;0.36</td>
<td>DISTANCE</td>
</tr>
<tr class="odd">
<td>crippeno3a_align_TanimotoDist</td>
<td>&lt;0.59</td>
<td>&lt;0.56</td>
<td>&lt;0.51</td>
<td>&lt;0.47</td>
<td>&lt;0.37</td>
<td>DISTANCE</td>
</tr>
</tbody>
</table>
</section>
<section id="chembl-set" class="level3">
<h3 class="anchored" data-anchor-id="chembl-set">ChEMBL Set</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>metric</th>
<th>70%</th>
<th>80%</th>
<th>90%</th>
<th>95%</th>
<th>99%</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>baseline_ShapeTanimoto</td>
<td>&gt;0.44</td>
<td>&gt;0.48</td>
<td>&gt;0.54</td>
<td>&gt;0.59</td>
<td>&gt;0.69</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>shape_align_ShapeTanimoto</td>
<td>&gt;0.58</td>
<td>&gt;0.61</td>
<td>&gt;0.65</td>
<td>&gt;0.69</td>
<td>&gt;0.76</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>baseline_TanimotoDist</td>
<td>&lt;0.64</td>
<td>&lt;0.61</td>
<td>&lt;0.57</td>
<td>&lt;0.54</td>
<td>&lt;0.47</td>
<td>DISTANCE</td>
</tr>
<tr class="even">
<td>shape_align_TanimotoDist</td>
<td>&lt;0.55</td>
<td>&lt;0.53</td>
<td>&lt;0.50</td>
<td>&lt;0.47</td>
<td>&lt;0.42</td>
<td>DISTANCE</td>
</tr>
<tr class="odd">
<td>shape_align_noc_TanimotoDist</td>
<td>&lt;0.55</td>
<td>&lt;0.53</td>
<td>&lt;0.50</td>
<td>&lt;0.47</td>
<td>&lt;0.41</td>
<td>DISTANCE</td>
</tr>
<tr class="even">
<td>o3a_align_TanimotoDist</td>
<td>&lt;0.61</td>
<td>&lt;0.59</td>
<td>&lt;0.55</td>
<td>&lt;0.52</td>
<td>&lt;0.46</td>
<td>DISTANCE</td>
</tr>
<tr class="odd">
<td>crippeno3a_align_TanimotoDist</td>
<td>&lt;0.61</td>
<td>&lt;0.59</td>
<td>&lt;0.55</td>
<td>&lt;0.52</td>
<td>&lt;0.46</td>
<td>DISTANCE</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="non-alignment-based-approaches" class="level2">
<h2 class="anchored" data-anchor-id="non-alignment-based-approaches">Non-alignment based approaches</h2>
<section id="lobster-set-1" class="level3">
<h3 class="anchored" data-anchor-id="lobster-set-1">LOBSTER Set</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>metric</th>
<th>70%</th>
<th>80%</th>
<th>90%</th>
<th>95%</th>
<th>99%</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>USR_score</td>
<td>&gt;0.66</td>
<td>&gt;0.71</td>
<td>&gt;0.76</td>
<td>&gt;0.80</td>
<td>&gt;0.87</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_USR_score</td>
<td>&gt;0.66</td>
<td>&gt;0.71</td>
<td>&gt;0.76</td>
<td>&gt;0.80</td>
<td>&gt;0.86</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>AP3D_DiceSimilarity</td>
<td>&gt;0.49</td>
<td>&gt;0.54</td>
<td>&gt;0.60</td>
<td>&gt;0.63</td>
<td>&gt;0.70</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_AP3D_DiceSimilarity</td>
<td>&gt;0.29</td>
<td>&gt;0.33</td>
<td>&gt;0.38</td>
<td>&gt;0.43</td>
<td>&gt;0.51</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>E3FP_DiceSimilarity</td>
<td>&gt;0.28</td>
<td>&gt;0.31</td>
<td>&gt;0.34</td>
<td>&gt;0.37</td>
<td>&gt;0.43</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_E3FP_DiceSimilarity</td>
<td>&gt;0.23</td>
<td>&gt;0.26</td>
<td>&gt;0.29</td>
<td>&gt;0.32</td>
<td>&gt;0.38</td>
<td>SIMILARITY</td>
</tr>
</tbody>
</table>
</section>
<section id="chembl-set-1" class="level3">
<h3 class="anchored" data-anchor-id="chembl-set-1">ChEMBL Set</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>metric</th>
<th>70%</th>
<th>80%</th>
<th>90%</th>
<th>95%</th>
<th>99%</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>USR_score</td>
<td>&gt;0.65</td>
<td>&gt;0.69</td>
<td>&gt;0.74</td>
<td>&gt;0.78</td>
<td>&gt;0.84</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_USR_score</td>
<td>&gt;0.65</td>
<td>&gt;0.69</td>
<td>&gt;0.74</td>
<td>&gt;0.78</td>
<td>&gt;0.84</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>AP3D_DiceSimilarity</td>
<td>&gt;0.57</td>
<td>&gt;0.60</td>
<td>&gt;0.65</td>
<td>&gt;0.68</td>
<td>&gt;0.73</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_AP3D_DiceSimilarity</td>
<td>&gt;0.34</td>
<td>&gt;0.37</td>
<td>&gt;0.42</td>
<td>&gt;0.45</td>
<td>&gt;0.51</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>E3FP_DiceSimilarity</td>
<td>&gt;0.30</td>
<td>&gt;0.33</td>
<td>&gt;0.35</td>
<td>&gt;0.38</td>
<td>&gt;0.42</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_E3FP_DiceSimilarity</td>
<td>&gt;0.26</td>
<td>&gt;0.28</td>
<td>&gt;0.30</td>
<td>&gt;0.32</td>
<td>&gt;0.36</td>
<td>SIMILARITY</td>
</tr>
</tbody>
</table>
<div id="209d81ae" class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-4">IPythonConsole.ipython_3d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-7">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tableau-colorblind10'</span>)</span>
<span id="cb1-8">plt.rcParams[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font.size'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span></span>
<span id="cb1-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext sql</span>
<span id="cb1-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>config SqlMagic.feedback<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div>
</div>
<div id="f3d421d6" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.09.3</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="getting-started" class="level1">
<h1>Getting started</h1>
<div id="dc28d683" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> lwreg</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lwreg <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> utils</span></code></pre></div>
</div>
<p>Load our lwreg configuration from the database we created before:</p>
<div id="e184d2ce" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.configure_from_database(dbname<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lobster_112024'</span>,dbtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'postgresql'</span>)</span>
<span id="cb5-2">lwreg.set_default_config(config)</span>
<span id="cb5-3"></span>
<span id="cb5-4">config</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{'dbname': 'lobster_112024',
 'dbtype': 'postgresql',
 'cacheConnection': True,
 'standardization': 'none',
 'removeHs': 1,
 'useTautomerHashv2': 0,
 'registerConformers': 1,
 'numConformerDigits': 3,
 'lwregSchema': ''}</code></pre>
</div>
</div>
</section>
<section id="random-pairs-from-lobster" class="level1">
<h1>Random pairs from LOBSTER</h1>
<p>Get a map from (nm,pdb) tuples to (molregno,confid,molblock):</p>
<div id="8ff64590" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb7-2">    select ligname,pdb,molregno,conf_id,molblock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb7-3">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.all_ligands join conformers using (molregno,conf_id)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-4">ligs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb7-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> nm,pdb,mrn,cid,mb <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d:</span>
<span id="cb7-6">    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(mb,removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb7-7">    mol_noh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(mb)</span>
<span id="cb7-8">    ligs[(mrn,cid)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (nm,pdb,mb,mol,mol_noh)</span></code></pre></div>
</div>
<p>Create a bunch of random pairs:</p>
<div id="5aab111d" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb8-2">random.seed(<span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xa100f</span>)</span>
<span id="cb8-3"></span>
<span id="cb8-4">ks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(ligs.keys())</span>
<span id="cb8-5">base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb8-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(base)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25000</span>:</span>
<span id="cb8-7">    t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ks[:]</span>
<span id="cb8-8">    random.shuffle(t)</span>
<span id="cb8-9">    base.extend(t)</span>
<span id="cb8-10">tbase <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> base[:]</span>
<span id="cb8-11">random.shuffle(tbase)</span>
<span id="cb8-12">pairs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>((<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(x,y),<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(x,y)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x,y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(base,tbase) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span>y)</span>
<span id="cb8-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(pairs)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>25029</code></pre>
</div>
</div>
<div id="41f0b1a6" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">pairs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(pairs)[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25000</span>]</span>
<span id="cb10-2">pairs[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>[((453, 453), (925, 925)),
 ((1574, 1574), (2733, 2733)),
 ((175, 175), (3247, 3247)),
 ((1719, 1719), (3118, 3118)),
 ((3054, 3054), (3458, 3458))]</code></pre>
</div>
</div>
<section id="shape-based-alignment" class="level2">
<h2 class="anchored" data-anchor-id="shape-based-alignment">Shape-based alignment</h2>
<p>Let’s see what we get when we perform shape-based alignment using the crystal conformers.</p>
<p>Start by aligning the crystal conformers.</p>
<div id="d2cc720a" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gzip,pickle</span>
<span id="cb12-2">res_accum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pickle.load(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./results/3d_random_distances.pkl'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rb'</span>))</span>
<span id="cb12-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdShapeAlign</span>
<span id="cb12-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdShapeHelpers</span>
<span id="cb12-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolTransforms</span></code></pre></div>
</div>
<div id="7f4e759e" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> defaultdict</span>
<span id="cb13-2">res_accum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>)</span></code></pre></div>
</div>
<div id="571327f7" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdShapeAlign</span>
<span id="cb14-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdShapeHelpers</span>
<span id="cb14-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolTransforms</span>
<span id="cb14-4"></span>
<span id="cb14-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb14-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1,c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairs):</span>
<span id="cb14-7">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb14-8">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb14-9">    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb14-10">    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb14-11">    </span>
<span id="cb14-12">    st,ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.AlignMol(m1,m2,opt_param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb14-13">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTanimoto'</span>].append(st)</span>
<span id="cb14-14">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ColorTanimoto'</span>].append(ct)</span>
<span id="cb14-15">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb14-16"></span>
<span id="cb14-17">    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb14-18">    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb14-19">    st,ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.AlignMol(m1,m2,opt_param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,useColors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb14-20">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_noc_ShapeTanimoto'</span>].append(st)</span>
<span id="cb14-21">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_noc_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb14-22">    </span>
<span id="cb14-23"></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████| 25000/25000 [00:47&lt;00:00, 530.84it/s]</code></pre>
</div>
</div>
</section>
<section id="open3dalign" class="level2">
<h2 class="anchored" data-anchor-id="open3dalign">Open3DAlign</h2>
<p>What about an alternative 3D alignment algorithm? Let’s try aligning with Paolo Tosco’s <a href="https://link.springer.com/article/10.1007/s10822-011-9462-9">Open3DAlign</a>:</p>
<div id="e6ecccef" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolAlign</span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1,c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairs):</span>
<span id="cb16-4">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb16-5">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb16-6">    </span>
<span id="cb16-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb16-8">        o3a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolAlign.GetO3A(m2,m1)</span>
<span id="cb16-9">        rmsd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Align()</span>
<span id="cb16-10">        score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Score()</span>
<span id="cb16-11">        res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_rmsd'</span>].append(rmsd)</span>
<span id="cb16-12">        res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_scpre'</span>].append(score)</span>
<span id="cb16-13">        res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb16-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>:</span>
<span id="cb16-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb16-16">    </span>
<span id="cb16-17"></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████| 25000/25000 [02:06&lt;00:00, 198.35it/s]</code></pre>
</div>
</div>
<p>The RDKit has a variation on Open3DAlign that uses atomic contributions to the MolLogP value instead of MMFF94 atom types</p>
<div id="6e9ee47e" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolAlign</span>
<span id="cb18-2"></span>
<span id="cb18-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1,c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairs):</span>
<span id="cb18-4">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb18-5">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb18-6">    </span>
<span id="cb18-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb18-8">        o3a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolAlign.GetCrippenO3A(m2,m1)</span>
<span id="cb18-9">        rmsd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Align()</span>
<span id="cb18-10">        score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Score()</span>
<span id="cb18-11">        res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_rmsd'</span>].append(rmsd)</span>
<span id="cb18-12">        res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_scpre'</span>].append(score)</span>
<span id="cb18-13">        res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb18-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>:</span>
<span id="cb18-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████| 25000/25000 [01:08&lt;00:00, 366.77it/s]</code></pre>
</div>
</div>
</section>
<section id="baseline-canonical-alignment" class="level2">
<h2 class="anchored" data-anchor-id="baseline-canonical-alignment">Baseline: canonical alignment</h2>
<p>Just put the molecules in their principle-axis frame</p>
<div id="4b2bfa9f" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb20-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb20-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1,c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairs):</span>
<span id="cb20-4">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb20-5">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb20-6">    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb20-7">    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb20-8">    </span>
<span id="cb20-9">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████████████████████████████████| 25000/25000 [00:07&lt;00:00, 3483.93it/s]</code></pre>
</div>
</div>
</section>
<section id="baseline-tanimoto-shape-score-in-the-canonical-alignment" class="level2">
<h2 class="anchored" data-anchor-id="baseline-tanimoto-shape-score-in-the-canonical-alignment">Baseline: tanimoto shape score in the canonical alignment</h2>
<p>In the v2025.09.3 RDKit release (released the day before I wrote this post), Dave Cosgrove added a function allowing two molecules to be scored using the Pubchem shape alignment code without doing the alignment first. This gives a score that is directly comparable to what you get when you do an alignment.</p>
<div id="c3454219" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_ShapeTanimoto'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb22-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb22-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1,c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairs):</span>
<span id="cb22-4">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb22-5">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb22-6">    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb22-7">    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb22-8">    opts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.ShapeInputOptions()</span>
<span id="cb22-9">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_ShapeTanimoto'</span>].append(rdShapeAlign.ScoreMol(m1,m2,opts,opts))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████████████████████████████████| 25000/25000 [00:05&lt;00:00, 4227.54it/s]</code></pre>
</div>
</div>
<div id="252a2d60" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pickle</span>
<span id="cb24-2">pickle.dump(res_accum,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./results/3d_random_distances.pkl'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'wb+'</span>))</span></code></pre></div>
</div>
<div id="2c65c817" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb25-2">plt.hist([[x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_ShapeTanimoto'</span>]],res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTanimoto'</span>]],</span>
<span id="cb25-3">         bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aligned'</span>])</span>
<span id="cb25-4">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape tanimoto score'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-5">plt.legend()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="d915aac5" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb26-2">plt.hist([res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>],],bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline'</span>,])</span>
<span id="cb26-3">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape tanimoto distance'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb26-4">plt.legend()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b32d77cc" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb27-2">plt.hist([res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>],res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_TanimotoDist'</span>],res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_noc_TanimotoDist'</span>]],bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'no color'</span>])</span>
<span id="cb27-3">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape tanimoto distance'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-4">plt.legend()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="97253f37" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb28-2">plt.hist([res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>],res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_TanimotoDist'</span>],res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_TanimotoDist'</span>]],</span>
<span id="cb28-3">         bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A'</span>])</span>
<span id="cb28-4">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape tanimoto distance'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb28-5">plt.legend()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="non-alignment-methods" class="level2">
<h2 class="anchored" data-anchor-id="non-alignment-methods">Non-alignment methods</h2>
<div id="9264b870" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolDescriptors</span>
<span id="cb29-2">res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR_score'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb29-3">res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_USR_score'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb29-4"></span>
<span id="cb29-5"></span>
<span id="cb29-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1,c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairs):</span>
<span id="cb29-7">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb29-8">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb29-9">    usr1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb29-10">    usr2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb29-11">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR_score'</span>].append(rdMolDescriptors.GetUSRScore(usr1,usr2))</span>
<span id="cb29-12">    </span>
<span id="cb29-13">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb29-14">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb29-15">    usr1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb29-16">    usr2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb29-17">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_USR_score'</span>].append(rdMolDescriptors.GetUSRScore(usr1,usr2))</span>
<span id="cb29-18">   </span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████████████████████████████████| 25000/25000 [00:03&lt;00:00, 6754.96it/s]</code></pre>
</div>
</div>
<div id="89177da4" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">fpg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdFingerprintGenerator.GetAtomPairGenerator(use2D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb31-2">res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_DiceSimilarity'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb31-3">res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_AP3D_DiceSimilarity'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb31-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1,c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairs):</span>
<span id="cb31-5">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb31-6">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb31-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m1.GetNumConformers() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m2.GetNumConformers():</span>
<span id="cb31-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb31-9">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb31-10">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb31-11">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span>
<span id="cb31-12"></span>
<span id="cb31-13">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb31-14">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb31-15">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb31-16">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb31-17">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_AP3D_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████████████████████████████████| 25000/25000 [00:21&lt;00:00, 1148.58it/s]</code></pre>
</div>
</div>
<div id="73fd7228" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb33-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> e3fp.pipeline <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fprints_from_mol</span>
<span id="cb33-3">logging.disable(logging.INFO)</span>
<span id="cb33-4"></span>
<span id="cb33-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_fp(m):</span>
<span id="cb33-6">    fp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fprints_from_mol(m,fprint_params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'counts'</span>:<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>})[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb33-7">    rdkfp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataStructs.ULongSparseIntVect(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb33-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k,v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> fp.counts.items():</span>
<span id="cb33-9">        rdkfp[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(k)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v </span>
<span id="cb33-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> rdkfp</span>
<span id="cb33-11"></span>
<span id="cb33-12">res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP_DiceSimilarity'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb33-13">res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_E3FP_DiceSimilarity'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb33-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c1,c2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairs):</span>
<span id="cb33-15">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb33-16">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb33-17">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m1)</span>
<span id="cb33-18">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m2)</span>
<span id="cb33-19">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span>
<span id="cb33-20">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c1][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb33-21">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[c2][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb33-22">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m1)</span>
<span id="cb33-23">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m2)</span>
<span id="cb33-24">    res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_E3FP_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|████████████████████████████████████████████████████████████████████████| 25000/25000 [39:01&lt;00:00, 10.68it/s]</code></pre>
</div>
</div>
<div id="08bd0098" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pickle</span>
<span id="cb35-2">pickle.dump(res_accum,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./results/3d_random_distances.pkl'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'wb+'</span>))</span></code></pre></div>
</div>
</section>
</section>
<section id="random-chembl-molecules" class="level1">
<h1>Random ChEMBL molecules</h1>
<p>Using the pairs of random molecules I used for the <a href="https://greglandrum.github.io/rdkit-blog/posts/2021-05-18-fingerprint-thresholds1.html">fingerprint thresholds post</a> and other blog posts about similarity.</p>
<div id="15a5f21b" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gzip</span>
<span id="cb36-2">ind <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">b'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> gzip.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'../data/chembl35_50K.mfp0.pairs.txt.gz'</span>)]</span>
<span id="cb36-3">ms1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb36-4">ms2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb36-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(ind):</span>
<span id="cb36-6">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.AddHs(Chem.MolFromSmiles(row[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]))</span>
<span id="cb36-7">    ms1.append(m1)</span>
<span id="cb36-8">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.AddHs(Chem.MolFromSmiles(row[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]))</span>
<span id="cb36-9">    ms2.append(m2)</span></code></pre></div>
</div>
<div id="3ddc180e" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span>)</span>
<span id="cb37-2">random.shuffle(ms2)</span></code></pre></div>
</div>
<div id="e6b792b6" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ms1)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>50000</code></pre>
</div>
</div>
<div id="97814a24" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb40-2">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ipyparallel <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ipp</span>
<span id="cb40-3">    rc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ipp.Client()</span>
<span id="cb40-4">    dview <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rc[:]</span>
<span id="cb40-5">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from rdkit import Chem'</span>)</span>
<span id="cb40-6">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from rdkit.Chem import rdDistGeom'</span>)</span>
<span id="cb40-7">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from rdkit.Chem import rdMolAlign'</span>)</span>
<span id="cb40-8">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from rdkit.Chem import rdMolTransforms'</span>)</span>
<span id="cb40-9">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from rdkit.Chem import rdShapeHelpers'</span>)</span>
<span id="cb40-10">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from rdkit.Chem import rdShapeAlign'</span>)</span>
<span id="cb40-11">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from rdkit.Chem import rdFingerprintGenerator'</span>)</span>
<span id="cb40-12">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from rdkit import DataStructs'</span>)</span>
<span id="cb40-13">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from e3fp.pipeline import fprints_from_mol'</span>)</span>
<span id="cb40-14">    dview.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'import logging;logging.disable(logging.INFO)'</span>)</span>
<span id="cb40-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb40-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"could not use ipyparallel"</span>)</span>
<span id="cb40-17">    dview <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
</div>
<p>Generate one ETKDGv3 conformer per molecule:</p>
<div id="09612e14" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdDistGeom</span>
<span id="cb41-2">ms1c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:(rdDistGeom.EmbedMolecule(x,randomSeed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span>),x), ms1)</span>
<span id="cb41-3">ms2c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dview.map_sync(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:(rdDistGeom.EmbedMolecule(x,randomSeed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span>),x), ms2)</span></code></pre></div>
</div>
<div id="480e2214" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pickle</span>
<span id="cb42-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gzip</span>
<span id="cb42-3">pickle.dump((ms1c,ms2c),gzip.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./results/random_pairs_confs.pkl.gz'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'wb+'</span>))</span></code></pre></div>
</div>
<div id="a2eaed5b" class="cell">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">res_accum2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>)</span>
<span id="cb43-2"></span>
<span id="cb43-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m1,m2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(ms1c,ms2c)):</span>
<span id="cb43-4">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb43-5">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb43-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m1.GetNumConformers() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m2.GetNumConformers():</span>
<span id="cb43-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb43-8">    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb43-9">    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb43-10"></span>
<span id="cb43-11">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb43-12"></span>
<span id="cb43-13">    st,ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.AlignMol(m1,m2,opt_param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb43-14">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTanimoto'</span>].append(st)</span>
<span id="cb43-15">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ColorTanimoto'</span>].append(ct)</span>
<span id="cb43-16">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb43-17"></span>
<span id="cb43-18">    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb43-19">    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb43-20">    st,ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.AlignMol(m1,m2,opt_param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,useColors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb43-21">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_noc_ShapeTanimoto'</span>].append(st)</span>
<span id="cb43-22">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_noc_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span></code></pre></div>
</div>
<div id="889e9ec8" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">res_accum2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pickle.load(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./results/3d_random_distances2.pkl'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rb'</span>))</span></code></pre></div>
</div>
<div id="69359a87" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_ShapeTanimoto'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb45-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m1,m2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(ms1c,ms2c)):</span>
<span id="cb45-3">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb45-4">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb45-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m1.GetNumConformers() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m2.GetNumConformers():</span>
<span id="cb45-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb45-7">    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb45-8">    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb45-9">    opts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.ShapeInputOptions()</span>
<span id="cb45-10">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_ShapeTanimoto'</span>].append(rdShapeAlign.ScoreMol(m1,m2,opts,opts))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [00:12, 3934.62it/s]</code></pre>
</div>
</div>
<div id="867c11c6" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m1,m2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(ms1c,ms2c)):</span>
<span id="cb47-2">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb47-3">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb47-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m1.GetNumConformers() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m2.GetNumConformers():</span>
<span id="cb47-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb47-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb47-7">        o3a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolAlign.GetO3A(m2,m1)</span>
<span id="cb47-8">        rmsd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Align()</span>
<span id="cb47-9">        score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Score()</span>
<span id="cb47-10">        res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_rmsd'</span>].append(rmsd)</span>
<span id="cb47-11">        res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_scpre'</span>].append(score)</span>
<span id="cb47-12">        res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb47-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>:</span>
<span id="cb47-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [07:06, 117.30it/s]</code></pre>
</div>
</div>
<div id="8f4235e4" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m1,m2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(ms1c,ms2c)):</span>
<span id="cb49-2">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb49-3">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb49-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m1.GetNumConformers() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m2.GetNumConformers():</span>
<span id="cb49-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb49-6">    </span>
<span id="cb49-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb49-8">        o3a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolAlign.GetCrippenO3A(m2,m1)</span>
<span id="cb49-9">        rmsd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Align()</span>
<span id="cb49-10">        score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Score()</span>
<span id="cb49-11">        res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_rmsd'</span>].append(rmsd)</span>
<span id="cb49-12">        res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_scpre'</span>].append(score)</span>
<span id="cb49-13">        res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))   </span>
<span id="cb49-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>:</span>
<span id="cb49-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [03:43, 223.62it/s]</code></pre>
</div>
</div>
<div id="3dfabd2e" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolDescriptors</span>
<span id="cb51-2"></span>
<span id="cb51-3">res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR_score'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb51-4">res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_USR_score'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb51-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m1,m2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(ms1c,ms2c)):</span>
<span id="cb51-6">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb51-7">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb51-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m1.GetNumConformers() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m2.GetNumConformers():</span>
<span id="cb51-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb51-10">    </span>
<span id="cb51-11">    usr1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb51-12">    usr2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb51-13">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR_score'</span>].append(rdMolDescriptors.GetUSRScore(usr1,usr2))</span>
<span id="cb51-14">    </span>
<span id="cb51-15">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RemoveHs(m1)</span>
<span id="cb51-16">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RemoveHs(m2)</span>
<span id="cb51-17">    usr1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb51-18">    usr2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb51-19">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_USR_score'</span>].append(rdMolDescriptors.GetUSRScore(usr1,usr2))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [00:18, 2744.31it/s]</code></pre>
</div>
</div>
<div id="bbcda974" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1">fpg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdFingerprintGenerator.GetAtomPairGenerator(use2D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb53-2"></span>
<span id="cb53-3">res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_DiceSimilarity'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb53-4">res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_AP3D_DiceSimilarity'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb53-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m1,m2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(ms1c,ms2c)):</span>
<span id="cb53-6">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb53-7">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb53-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m1.GetNumConformers() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m2.GetNumConformers():</span>
<span id="cb53-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb53-10">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb53-11">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb53-12">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span>
<span id="cb53-13"></span>
<span id="cb53-14">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RemoveHs(m1)</span>
<span id="cb53-15">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RemoveHs(m2)</span>
<span id="cb53-16">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb53-17">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb53-18">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_AP3D_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [01:12, 688.09it/s]</code></pre>
</div>
</div>
<div id="d5b1beec" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1">res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP_DiceSimilarity'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb55-2">res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_E3FP_DiceSimilarity'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb55-3"></span>
<span id="cb55-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m1,m2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(ms1c,ms2c)):</span>
<span id="cb55-5">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb55-6">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb55-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m1.GetNumConformers() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> m2.GetNumConformers():</span>
<span id="cb55-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb55-9">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m1)</span>
<span id="cb55-10">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m2)</span>
<span id="cb55-11">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span>
<span id="cb55-12"></span>
<span id="cb55-13">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RemoveHs(m1)</span>
<span id="cb55-14">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RemoveHs(m2)</span>
<span id="cb55-15">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m1)</span>
<span id="cb55-16">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m2)</span>
<span id="cb55-17">    res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_E3FP_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [1:49:13,  7.63it/s]</code></pre>
</div>
</div>
<div id="05eb636b" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pickle</span>
<span id="cb57-2">pickle.dump(res_accum2,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./results/3d_random_distances2.pkl'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'wb+'</span>))</span></code></pre></div>
</div>
<div id="0118af31" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb58-2">plt.hist([[x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_ShapeTanimoto'</span>]],res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTanimoto'</span>]],</span>
<span id="cb58-3">         bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aligned'</span>])</span>
<span id="cb58-4">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape tanimoto score'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb58-5">plt.legend()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d_files/figure-html/cell-40-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="bacc03dc" class="cell" data-scrolled="false" data-execution_count="99">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb59-2">plt.hist([res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>],res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_TanimotoDist'</span>],res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_noc_TanimotoDist'</span>]],bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'no color'</span>])</span>
<span id="cb59-3">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape tanimoto distance'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb59-4">plt.legend()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="87d00871" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb60-2">plt.hist([res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>],res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_TanimotoDist'</span>],res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_TanimotoDist'</span>]],</span>
<span id="cb60-3">         bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A'</span>])</span>
<span id="cb60-4">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape tanimoto distance'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb60-5">plt.legend()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b1724537" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1">res_accum2.keys()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>dict_keys(['baseline_TanimotoDist', 'shape_align_ShapeTanimoto', 'shape_align_ColorTanimoto', 'shape_align_TanimotoDist', 'shape_align_noc_ShapeTanimoto', 'shape_align_noc_TanimotoDist', 'o3a_align_rmsd', 'o3a_align_scpre', 'o3a_align_TanimotoDist', 'crippeno3a_align_rmsd', 'crippeno3a_align_scpre', 'crippeno3a_align_TanimotoDist', 'USR_score', 'noh_USR_score', 'AP3D_DiceSimilarity', 'noh_AP3D_DiceSimilarity', 'E3FP_DiceSimilarity', 'noh_E3FP_DiceSimilarity', 'baseline_ShapeTanimoto'])</code></pre>
</div>
</div>
<div id="24eda1e0" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb63-2">plt.hist([res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_scpre'</span>],res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_scpre'</span>],],</span>
<span id="cb63-3">         bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A'</span>])</span>
<span id="cb63-4">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alignment score'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb63-5">plt.legend()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d_files/figure-html/cell-44-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="summary-stats" class="level1">
<h1>Summary stats</h1>
<div id="bbf8c974" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span></code></pre></div>
</div>
<div id="b1863315" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'****   LOBSTER Set ****'</span>)</span>
<span id="cb65-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'| baseline_ShapeTanimoto</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">|'</span>,</span>
<span id="cb65-3">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' | '</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> np.quantile([x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_ShapeTanimoto'</span>]],[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>])]),</span>
<span id="cb65-4">     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">| SIMILARITY |'</span>)</span>
<span id="cb65-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'| shape_align_ShapeTanimoto</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">|'</span>,</span>
<span id="cb65-6">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' | '</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> np.quantile([x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> res_accum[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTanimoto'</span>]],[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>])]),</span>
<span id="cb65-7">     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">| SIMILARITY |'</span>)</span>
<span id="cb65-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_TanimotoDist'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_noc_TanimotoDist'</span>,</span>
<span id="cb65-9">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_TanimotoDist'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_TanimotoDist'</span>]:</span>
<span id="cb65-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'| </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>k<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">|'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' | '</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> np.quantile(res_accum[k],[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>])]),</span>
<span id="cb65-11">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">| DISTANCE |'</span>)</span>
<span id="cb65-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'****   ChEMBL Set ****'</span>)</span>
<span id="cb65-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'| baseline_ShapeTanimoto</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">|'</span>,</span>
<span id="cb65-14">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' | '</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> np.quantile([x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_ShapeTanimoto'</span>]],[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>])]),</span>
<span id="cb65-15">     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">| SIMILARITY |'</span>)</span>
<span id="cb65-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'| shape_align_ShapeTanimoto</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">|'</span>,</span>
<span id="cb65-17">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' | '</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> np.quantile([x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> res_accum2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTanimoto'</span>]],[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>])]),</span>
<span id="cb65-18">     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">| SIMILARITY |'</span>)</span>
<span id="cb65-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_TanimotoDist'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_TanimotoDist'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_noc_TanimotoDist'</span>,</span>
<span id="cb65-20">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o3a_align_TanimotoDist'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crippeno3a_align_TanimotoDist'</span>]:</span>
<span id="cb65-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'| </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>k<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">|'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' | '</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> np.quantile(res_accum2[k],[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>])]),</span>
<span id="cb65-22">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">| DISTANCE |'</span>)</span>
<span id="cb65-23"></span>
<span id="cb65-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> ------------------   No alignment  --------------------'</span>)</span>
<span id="cb65-25"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'****   LOBSTER Set ****'</span>)</span>
<span id="cb65-26"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR_score'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_USR_score'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_DiceSimilarity'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_AP3D_DiceSimilarity'</span>,</span>
<span id="cb65-27">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP_DiceSimilarity'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_E3FP_DiceSimilarity'</span>]:</span>
<span id="cb65-28">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'| </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>k<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">|'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' | '</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> np.quantile(res_accum[k],[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>])]),</span>
<span id="cb65-29">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">| SIMILARITY |'</span>)</span>
<span id="cb65-30">    </span>
<span id="cb65-31"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'****   ChEMBL Set ****'</span>)</span>
<span id="cb65-32"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR_score'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_USR_score'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_DiceSimilarity'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_AP3D_DiceSimilarity'</span>,</span>
<span id="cb65-33">          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP_DiceSimilarity'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'noh_E3FP_DiceSimilarity'</span>]:</span>
<span id="cb65-34">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'| </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>k<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">|'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' | '</span>.join([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> np.quantile(res_accum2[k],[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>])]),</span>
<span id="cb65-35">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">| SIMILARITY |'</span>)</span>
<span id="cb65-36">    </span>
<span id="cb65-37">    </span>
<span id="cb65-38">    </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>****   LOBSTER Set ****
| baseline_ShapeTanimoto    | &gt;0.49 | &gt;0.54 | &gt;0.62 | &gt;0.69 | &gt;0.81     | SIMILARITY |
| shape_align_ShapeTanimoto | &gt;0.62 | &gt;0.66 | &gt;0.71 | &gt;0.76 | &gt;0.85     | SIMILARITY |
| baseline_TanimotoDist | &lt;0.61 | &lt;0.57 | &lt;0.52 | &lt;0.48 | &lt;0.39     | DISTANCE |
| shape_align_TanimotoDist  | &lt;0.53 | &lt;0.50 | &lt;0.46 | &lt;0.42 | &lt;0.34     | DISTANCE |
| shape_align_noc_TanimotoDist  | &lt;0.52 | &lt;0.49 | &lt;0.45 | &lt;0.42 | &lt;0.34     | DISTANCE |
| o3a_align_TanimotoDist    | &lt;0.58 | &lt;0.55 | &lt;0.51 | &lt;0.46 | &lt;0.36     | DISTANCE |
| crippeno3a_align_TanimotoDist | &lt;0.59 | &lt;0.56 | &lt;0.51 | &lt;0.47 | &lt;0.37     | DISTANCE |
****   ChEMBL Set ****
| baseline_ShapeTanimoto    | &gt;0.44 | &gt;0.48 | &gt;0.54 | &gt;0.59 | &gt;0.69     | SIMILARITY |
| shape_align_ShapeTanimoto | &gt;0.58 | &gt;0.61 | &gt;0.65 | &gt;0.69 | &gt;0.76     | SIMILARITY |
| baseline_TanimotoDist | &lt;0.64 | &lt;0.61 | &lt;0.57 | &lt;0.54 | &lt;0.47     | DISTANCE |
| shape_align_TanimotoDist  | &lt;0.55 | &lt;0.53 | &lt;0.50 | &lt;0.47 | &lt;0.42     | DISTANCE |
| shape_align_noc_TanimotoDist  | &lt;0.55 | &lt;0.53 | &lt;0.50 | &lt;0.47 | &lt;0.41     | DISTANCE |
| o3a_align_TanimotoDist    | &lt;0.61 | &lt;0.59 | &lt;0.55 | &lt;0.52 | &lt;0.46     | DISTANCE |
| crippeno3a_align_TanimotoDist | &lt;0.61 | &lt;0.59 | &lt;0.55 | &lt;0.52 | &lt;0.46     | DISTANCE |



 ------------------   No alignment  --------------------
****   LOBSTER Set ****
| USR_score | &gt;0.66 | &gt;0.71 | &gt;0.76 | &gt;0.80 | &gt;0.87     | SIMILARITY |
| noh_USR_score | &gt;0.66 | &gt;0.71 | &gt;0.76 | &gt;0.80 | &gt;0.86     | SIMILARITY |
| AP3D_DiceSimilarity   | &gt;0.49 | &gt;0.54 | &gt;0.60 | &gt;0.63 | &gt;0.70     | SIMILARITY |
| noh_AP3D_DiceSimilarity   | &gt;0.29 | &gt;0.33 | &gt;0.38 | &gt;0.43 | &gt;0.51     | SIMILARITY |
| E3FP_DiceSimilarity   | &gt;0.28 | &gt;0.31 | &gt;0.34 | &gt;0.37 | &gt;0.43     | SIMILARITY |
| noh_E3FP_DiceSimilarity   | &gt;0.23 | &gt;0.26 | &gt;0.29 | &gt;0.32 | &gt;0.38     | SIMILARITY |
****   ChEMBL Set ****
| USR_score | &gt;0.65 | &gt;0.69 | &gt;0.74 | &gt;0.78 | &gt;0.84     | SIMILARITY |
| noh_USR_score | &gt;0.65 | &gt;0.69 | &gt;0.74 | &gt;0.78 | &gt;0.84     | SIMILARITY |
| AP3D_DiceSimilarity   | &gt;0.57 | &gt;0.60 | &gt;0.65 | &gt;0.68 | &gt;0.73     | SIMILARITY |
| noh_AP3D_DiceSimilarity   | &gt;0.34 | &gt;0.37 | &gt;0.42 | &gt;0.45 | &gt;0.51     | SIMILARITY |
| E3FP_DiceSimilarity   | &gt;0.30 | &gt;0.33 | &gt;0.35 | &gt;0.38 | &gt;0.42     | SIMILARITY |
| noh_E3FP_DiceSimilarity   | &gt;0.26 | &gt;0.28 | &gt;0.30 | &gt;0.32 | &gt;0.36     | SIMILARITY |</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>datasets</category>
  <category>3d</category>
  <category>reference</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-11-30-thresholds-for-random-3d.html</guid>
  <pubDate>Sat, 29 Nov 2025 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/thresholds-for-random-3D-1.png" medium="image" type="image/png" height="102" width="144"/>
</item>
<item>
  <title>Working with the LOBSTER Data set III</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3.html</link>
  <description><![CDATA[ 




<p>This is my third post looking at the LOBSTER data set <a href="https://doi.org/10.1007/s10822-024-00581-1">published last year</a> by the Rarey and BioSolveIT group. Here are links for <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-11-08-working-with-lobster-1.html">Part 1</a> and <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2.html">Part 2</a>.</p>
<p>This time I look at applying the different 3D alignment algorithms the RDKit includes to the data.</p>
<div id="209d81ae" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-4">IPythonConsole.ipython_3d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-7">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tableau-colorblind10'</span>)</span>
<span id="cb1-8">plt.rcParams[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font.size'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span></span>
<span id="cb1-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext sql</span>
<span id="cb1-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>config SqlMagic.feedback<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div>
</div>
<div id="f3d421d6" class="cell" data-scrolled="true" data-execution_count="10">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.09.2</code></pre>
</div>
</div>
<section id="getting-started" class="level1">
<h1>Getting started</h1>
<div id="dc28d683" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> lwreg</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lwreg <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> utils</span></code></pre></div>
</div>
<p>Load our lwreg configuration from the database we created before:</p>
<div id="e184d2ce" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.configure_from_database(dbname<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lobster_112024'</span>,dbtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'postgresql'</span>)</span>
<span id="cb5-2">lwreg.set_default_config(config)</span>
<span id="cb5-3"></span>
<span id="cb5-4">config</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>{'dbname': 'lobster_112024',
 'dbtype': 'postgresql',
 'cacheConnection': True,
 'standardization': 'none',
 'removeHs': 1,
 'useTautomerHashv2': 0,
 'registerConformers': 1,
 'numConformerDigits': 3,
 'lwregSchema': ''}</code></pre>
</div>
</div>
<p>Get a map from (nm,pdb) tuples to (molregno,confid,molblock):</p>
<div id="8ff64590" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb7-2">    select ligname,pdb,molregno,conf_id,molblock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb7-3">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.all_ligands join conformers using (molregno,conf_id)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-4">ligs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb7-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> nm,pdb,mrn,cid,mb <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d:</span>
<span id="cb7-6">    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(mb,removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb7-7">    mol_noh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(mb)</span>
<span id="cb7-8">    ligs[(nm,pdb.lower())] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (mrn,cid,mb,mol,mol_noh)</span></code></pre></div>
</div>
<div id="be748ca6" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">pairstats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb8-2">    select <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.pair_stats</span>
<span id="cb8-3">pairstats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(pairstats.dicts())</span></code></pre></div>
</div>
<div id="b00099e2" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span>
<span id="cb9-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> comparison_plot(pairstats,metric1,metric2,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,includeLine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb9-3">    x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x[metric1] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats]</span>
<span id="cb9-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> invert1:</span>
<span id="cb9-5">        x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x1]</span>
<span id="cb9-6">        metric1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'1-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>metric1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb9-7">    x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x[metric2] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats]</span>
<span id="cb9-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> invert2:</span>
<span id="cb9-9">        x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x2]</span>
<span id="cb9-10">        metric2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'1-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>metric2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb9-11">    r,_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.spearmanr(x1,x2)</span>
<span id="cb9-12">    tau,_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.kendalltau(x1,x2)</span>
<span id="cb9-13"></span>
<span id="cb9-14">    plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb9-15">    plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-16">    plt.scatter(x1,x2,alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb9-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> includeLine:</span>
<span id="cb9-18">        plt.plot((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k-'</span>)</span>
<span id="cb9-19">    plt.xlabel(metric1)</span>
<span id="cb9-20">    plt.ylabel(metric2)</span>
<span id="cb9-21">    plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'rho=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, tau=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tau<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-22">    plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb9-23">    plt.hexbin(x1,x2,cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Blues'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-24">    plt.tight_layout()</span></code></pre></div>
</div>
</section>
<section id="comparing-shape-similarity-metrics-in-the-lobster-data-set" class="level1">
<h1>Comparing shape-similarity metrics in the LOBSTER data set</h1>
<p>First let’s look at the metrics in the LOBSTER data set:</p>
<div id="40fd7306" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tanimoto_distance'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,includeLine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In the LOBSTER paper they use an asymmetric definition of the Tversky metric to detect how much of the template is covered by the probe. This yield small Tversky distances (large Tversky index values) when a small template is completely covered by a large probe. The Tanimoto distance, on the other hand, is symmetric, so it’s always greater than 1-Tversky here.</p>
<p>And now the protrude distance, which looks at how much of the larger shape is <em>not</em> overlapping the smaller shape.</p>
<div id="152edde9" class="cell" data-scrolled="false" data-execution_count="35">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_protrude_distance'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,includeLine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The protrude distance is, by default, symmetric: it is the fraction of the smaller of the two shapes that protrudes outside the larger of the two.</p>
</section>
<section id="shape-based-alignment" class="level1">
<h1>Shape-based alignment</h1>
<p>Let’s see what we get when we perform shape-based alignment using the crystal conformers.</p>
<p>Start by aligning the crystal conformers.</p>
<div id="571327f7" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdShapeAlign</span>
<span id="cb12-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdShapeHelpers</span>
<span id="cb12-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolTransforms</span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb12-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairstats):</span>
<span id="cb12-7">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb12-8">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb12-9">    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb12-10">    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb12-11">    </span>
<span id="cb12-12">    st,ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.AlignMol(m1,m2,opt_param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb12-13">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTanimoto'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st</span>
<span id="cb12-14">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ColorTanimoto'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ct</span>
<span id="cb12-15">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTversky'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m1,m2,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb12-16">    </span>
<span id="cb12-17"></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████| 72592/72592 [01:15&lt;00:00, 964.83it/s]</code></pre>
</div>
</div>
<div id="421db64b" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb14-2">                includeLine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Look at examples where the ShapeTversky in the shape alignment is significantly lower than that in the crystal alignment:</p>
<div id="32327c0b" class="cell" data-scrolled="false" data-execution_count="39">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">pruned <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [r <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTversky'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>]</span>
<span id="cb15-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(pruned)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>79</code></pre>
</div>
</div>
<div id="9c6ad641" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pruned[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb17-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>((d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>]),(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>]))</span>
<span id="cb17-3">m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb17-4">m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb17-5">m1c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1)</span>
<span id="cb17-6">m2c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2)</span>
<span id="cb17-7">rdMolTransforms.CanonicalizeConformer(m1c.GetConformer())</span>
<span id="cb17-8">rdMolTransforms.CanonicalizeConformer(m2c.GetConformer())</span>
<span id="cb17-9">st,ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.AlignMol(m1c,m2c,opt_param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb17-10">tversky <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m1c,m2c,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-11"></span>
<span id="cb17-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(st,ct)</span>
<span id="cb17-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>],tversky)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('1D1_A_401', '4i5p') ('11G_A_401', '4i6b')
0.6968245697702556 0.11721759959746417
0.951 0.7622862091361766</code></pre>
</div>
</div>
<div id="740e66da" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">IPythonConsole.drawMols3D([m1,m2])</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_17638177524668813" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_17638177524668813" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_17638177524668813 = null;
var warn = document.getElementById("3dmolwarning_17638177524668813");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_17638177524668813 = $3Dmol.createViewer(document.getElementById("3dmolviewer_17638177524668813"),{backgroundColor:"white"});
viewer_17638177524668813.zoomTo();
    viewer_17638177524668813.addModel("1D1_A_401\n     RDKit          3D\n\n 47 50  0  0  0  0  0  0  0  0999 V2000\n   13.6199    4.3394   10.4996 O   0  0  0  0  0  0  0  0  0  0  0  0\n    7.7618    4.8606    9.8156 N   0  0  0  0  0  0  0  0  0  0  0  0\n    6.3944    8.1554   10.4865 N   0  0  0  0  0  0  0  0  0  0  0  0\n    8.8228    6.9055   10.3637 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.3439    4.1903   10.1704 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.1937    7.0400   10.7008 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.4418    2.7500    9.8990 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5846    6.7088    8.1521 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.1305    8.6178   10.3300 C   0  0  0  0  0  0  0  0  0  0  0  0\n    8.9115    4.1784    9.8385 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.2854    6.9331    9.4894 C   0  0  0  0  0  0  0  0  0  0  0  0\n    4.3546    7.6253    9.7593 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.2442   10.8146   10.4451 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.0524   10.5627   11.7193 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.1599    6.5268    9.5477 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.9220    9.4513    9.8291 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.1073    9.0549   11.9258 C   0  0  0  0  0  0  0  0  0  0  0  0\n    7.7087    6.1931   10.0763 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5167    4.9218   10.4741 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0267    6.3014   10.4072 C   0  0  0  0  0  0  0  0  0  0  0  0\n    6.4005    6.8977   10.0241 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.0272    8.4858   10.9997 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0969    4.8441   10.1252 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5146    6.3877   10.7066 C   0  0  2  0  0  0  0  0  0  0  0  0\n    7.1705    8.6548   10.8716 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.5316    2.3851    9.7034 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.0380    2.5991    9.1105 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.8225    2.2853   10.6985 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.1437    7.0883    7.4150 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.4572    5.7282    8.0029 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.6937    7.1629    8.1623 H   0  0  0  0  0  0  0  0  0  0  0  0\n    4.8102    9.5299   10.5859 H   0  0  0  0  0  0  0  0  0  0  0  0\n    8.9181    3.1963    9.6508 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4138    7.9169    9.6149 H   0  0  0  0  0  0  0  0  0  0  0  0\n   14.1773    6.4822    9.4555 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.3815    7.6927    9.5391 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.7810   11.3615    9.8026 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.3974   11.2977   10.6676 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.6061   10.9996   12.5002 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.9774   10.9285   11.6164 H   0  0  0  0  0  0  0  0  0  0  0  0\n    4.9014    5.6518    9.1383 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.5827    9.2183    9.1156 H   0  0  0  0  0  0  0  0  0  0  0  0\n    9.9991    9.4442    9.4441 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.9105    8.8236   12.8786 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0076    8.6988   11.6755 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.1653    8.5658   11.5006 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0038    6.6046   11.5513 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 19  2  0\n  2 10  2  0\n  2 18  1  0\n  3  9  1  0\n  3 21  1  0\n  4 18  2  0\n  4 20  1  0\n  5  7  1  0\n  5 19  1  0\n  5 23  1  0\n  6 20  1  0\n  6 22  1  0\n  6 24  1  0\n  8 11  1  0\n  9 12  2  0\n 10 23  1  0\n 11 24  1  0\n 12 15  1  0\n 13 14  1  0\n 13 16  1  0\n 14 17  1  0\n 15 21  2  0\n 16 22  1  0\n 17 22  1  0\n 18 21  1  0\n 19 24  1  0\n 20 23  2  0\n  3 25  1  0\n  7 26  1  0\n  7 27  1  0\n  7 28  1  0\n  8 29  1  0\n  8 30  1  0\n  8 31  1  0\n  9 32  1  0\n 10 33  1  0\n 11 34  1  0\n 11 35  1  0\n 12 36  1  0\n 13 37  1  0\n 13 38  1  0\n 14 39  1  0\n 14 40  1  0\n 15 41  1  0\n 16 42  1  0\n 16 43  1  0\n 17 44  1  0\n 17 45  1  0\n 22 46  1  0\n 24 47  1  1\nM  END\n","sdf");
    viewer_17638177524668813.setStyle({"stick": {}});
    viewer_17638177524668813.addModel("11G_A_401\n     RDKit          3D\n\n 39 41  0  0  0  0  0  0  0  0999 V2000\n   13.7894    4.4428   10.3494 O   0  0  0  0  0  0  0  0  0  0  0  0\n    7.8726    4.6211    9.8263 N   0  0  0  0  0  0  0  0  0  0  0  0\n    8.8273    6.7054   10.3791 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.5066    4.1352   10.0896 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.2049    6.9725   10.6578 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.6873    2.7043    9.7926 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.4405    6.6667    7.9974 C   0  0  0  0  0  0  0  0  0  0  0  0\n    7.7641    5.9335   10.1031 C   0  0  0  0  0  0  0  0  0  0  0  0\n    9.0581    3.9966    9.8132 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.1998    6.9634    9.3043 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.1166   10.7637   10.5685 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.0115   10.4860   11.7845 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.8537    9.4217    9.8798 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.0927    8.9675   11.9237 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.6406    4.9395   10.3645 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0728    6.1742   10.3871 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.0071    8.4100   10.9985 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.2189    4.7262   10.0771 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5553    6.3954   10.5958 C   0  0  2  0  0  0  0  0  0  0  0  0\n   10.7960    2.2839    9.6229 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.2638    2.6024    8.9819 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.1249    2.2549   10.5714 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.9324    7.0719    7.2267 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.3745    5.6773    7.8675 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.5218    7.0581    8.0493 H   0  0  0  0  0  0  0  0  0  0  0  0\n    6.8552    6.3505   10.1032 H   0  0  0  0  0  0  0  0  0  0  0  0\n    9.1110    3.0176    9.6163 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.2651    7.9563    9.4038 H   0  0  0  0  0  0  0  0  0  0  0  0\n   14.1178    6.5756    9.2220 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.5797   11.3868    9.9381 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.2528   11.1709   10.8653 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.6104   10.8876   12.6078 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.9235   10.8688   11.6371 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.5217    9.2559    9.1544 H   0  0  0  0  0  0  0  0  0  0  0  0\n    9.9307    9.3923    9.4960 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.9191    8.6940   12.8698 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.9941    8.6388   11.6417 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.1559    8.4512   11.5217 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0882    6.6568   11.4007 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 15  2  0\n  2  8  2  0\n  2  9  1  0\n  3  8  1  0\n  3 16  2  0\n  4  6  1  0\n  4 15  1  0\n  4 18  1  0\n  5 16  1  0\n  5 17  1  0\n  5 19  1  0\n  7 10  1  0\n  9 18  2  0\n 10 19  1  0\n 11 12  1  0\n 11 13  1  0\n 12 14  1  0\n 13 17  1  0\n 14 17  1  0\n 15 19  1  0\n 16 18  1  0\n  6 20  1  0\n  6 21  1  0\n  6 22  1  0\n  7 23  1  0\n  7 24  1  0\n  7 25  1  0\n  8 26  1  0\n  9 27  1  0\n 10 28  1  0\n 10 29  1  0\n 11 30  1  0\n 11 31  1  0\n 12 32  1  0\n 12 33  1  0\n 13 34  1  0\n 13 35  1  0\n 14 36  1  0\n 14 37  1  0\n 17 38  1  0\n 19 39  1  1\nM  END\n","sdf");
    viewer_17638177524668813.setStyle({"stick": {}});
    viewer_17638177524668813.setStyle({"model": 0},{"stick": {"colorscheme": "cyanCarbon"}});
    viewer_17638177524668813.setStyle({"model": 1},{"stick": {"colorscheme": "redCarbon"}});
    viewer_17638177524668813.setBackgroundColor("0xeeeeee");
    viewer_17638177524668813.zoomTo();
viewer_17638177524668813.render();
});
</script>
</div>
</div>
<div id="4b78264b" class="cell" data-scrolled="false" data-execution_count="24">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">IPythonConsole.drawMols3D([m1c,m2c])</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_17638177652198553" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_17638177652198553" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_17638177652198553 = null;
var warn = document.getElementById("3dmolwarning_17638177652198553");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_17638177652198553 = $3Dmol.createViewer(document.getElementById("3dmolviewer_17638177652198553"),{backgroundColor:"white"});
viewer_17638177652198553.zoomTo();
    viewer_17638177652198553.addModel("1D1_A_401\n     RDKit          3D\n\n 47 50  0  0  0  0  0  0  0  0999 V2000\n    4.0527    1.8957   -0.3913 O   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.8480    2.2030   -0.0118 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.5993   -0.9673   -0.2516 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.0374   -0.0165   -0.1681 N   0  0  0  0  0  0  0  0  0  0  0  0\n    1.8029    2.3697   -0.2356 N   0  0  0  0  0  0  0  0  0  0  0  0\n    1.3087   -0.4889   -0.3277 N   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0742    3.8124   -0.1844 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6170    0.0789    2.2230 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.9181   -1.2423   -0.1069 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.6198    2.7287   -0.0662 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.3412   -0.4413    0.9841 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.5835   -0.0843    0.2526 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.8590   -4.1509    0.5110 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.7484   -4.2074   -0.7324 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.6529    0.9285    0.3431 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6891   -2.6772    0.8870 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0070   -2.7705   -1.1655 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.0615    0.8622   -0.0663 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.8834    1.4626   -0.3468 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.2353    0.4228   -0.2272 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.4509    0.3385    0.0102 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.9698   -1.9332   -0.4096 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.4810    1.8872   -0.1699 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7019   -0.0105   -0.3496 C   0  0  2  0  0  0  0  0  0  0  0  0\n   -2.8782   -1.6123   -0.5044 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2112    4.3113   -0.1063 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6496    4.0155    0.6079 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.5468    4.0926   -1.0201 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.0892   -0.2414    3.0442 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6111    1.0788    2.2104 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.6761   -0.2600    2.2260 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.3421   -2.1383   -0.2387 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.4945    3.7201   -0.0325 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.3466   -1.4407    1.0207 H   0  0  0  0  0  0  0  0  0  0  0  0\n    4.2815   -0.1019    1.0050 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -6.5659    0.0027    0.4178 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2916   -4.6477    1.2634 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0326   -4.5577    0.3120 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2842   -4.7075   -1.4633 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6128   -4.6608   -0.5151 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.8138    1.8828    0.5949 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.3422   -2.4136    1.5967 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.2412   -2.4967    1.2063 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.8840   -2.6740   -2.1532 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.9339   -2.4901   -0.9160 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.1278   -1.9883   -0.9463 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.1957   -0.4183   -1.1175 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 19  2  0\n  2 10  2  0\n  2 18  1  0\n  3  9  1  0\n  3 21  1  0\n  4 18  2  0\n  4 20  1  0\n  5  7  1  0\n  5 19  1  0\n  5 23  1  0\n  6 20  1  0\n  6 22  1  0\n  6 24  1  0\n  8 11  1  0\n  9 12  2  0\n 10 23  1  0\n 11 24  1  0\n 12 15  1  0\n 13 14  1  0\n 13 16  1  0\n 14 17  1  0\n 15 21  2  0\n 16 22  1  0\n 17 22  1  0\n 18 21  1  0\n 19 24  1  0\n 20 23  2  0\n  3 25  1  0\n  7 26  1  0\n  7 27  1  0\n  7 28  1  0\n  8 29  1  0\n  8 30  1  0\n  8 31  1  0\n  9 32  1  0\n 10 33  1  0\n 11 34  1  0\n 11 35  1  0\n 12 36  1  0\n 13 37  1  0\n 13 38  1  0\n 14 39  1  0\n 14 40  1  0\n 15 41  1  0\n 16 42  1  0\n 16 43  1  0\n 17 44  1  0\n 17 45  1  0\n 22 46  1  0\n 24 47  1  6\nM  END\n","sdf");
    viewer_17638177652198553.setStyle({"stick": {}});
    viewer_17638177652198553.addModel("11G_A_401\n     RDKit          3D\n\n 39 41  0  0  0  0  0  0  0  0999 V2000\n    1.2908    3.3626   -0.0826 O   0  0  0  0  0  0  0  0  0  0  0  0\n    2.1667   -2.5110   -0.2996 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.1004   -1.9105   -0.0530 N   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0042    1.1592   -0.1788 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7924    0.3938    0.0616 N   0  0  0  0  0  0  0  0  0  0  0  0\n    3.4111    1.5729   -0.3120 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.3606    1.5738   -2.6066 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.8662   -2.8340   -0.1762 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.5819   -1.2370   -0.3026 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.9431    2.3142   -1.3879 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.4736   -0.3472   -0.4755 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.5054    0.6223    0.7143 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.0300   -0.3987   -0.9834 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.0517    0.9677    1.0295 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.9942    2.1467   -0.0644 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.2109   -0.5927   -0.0495 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.2084   -0.0364    0.2382 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.6419   -0.2106   -0.1916 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.4447    1.8204   -0.0045 C   0  0  2  0  0  0  0  0  0  0  0  0\n    3.9919    0.7619   -0.3813 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.5179    2.1309   -1.1349 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.6788    2.1070    0.4899 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7406    1.9627   -3.4459 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6344    1.6744   -2.6134 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.5972    0.6038   -2.5518 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6096   -3.8005   -0.1764 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.5555   -1.0233   -0.3836 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.9375    2.2113   -1.4116 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7060    3.2819   -1.4732 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.0797   -0.0194   -1.2002 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.7659   -1.2577   -0.1828 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.9361    0.1859    1.5043 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.0126    1.4495    0.4727 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.8867    0.2632   -1.7191 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.7990   -1.3152   -1.3100 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.8757    0.8754    2.0096 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.8443    1.9022    0.7401 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.1737   -0.8640    0.7984 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.8912    2.3272    0.7330 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 15  2  0\n  2  8  2  0\n  2  9  1  0\n  3  8  1  0\n  3 16  2  0\n  4  6  1  0\n  4 15  1  0\n  4 18  1  0\n  5 16  1  0\n  5 17  1  0\n  5 19  1  0\n  7 10  1  0\n  9 18  2  0\n 10 19  1  0\n 11 12  1  0\n 11 13  1  0\n 12 14  1  0\n 13 17  1  0\n 14 17  1  0\n 15 19  1  0\n 16 18  1  0\n  6 20  1  0\n  6 21  1  0\n  6 22  1  0\n  7 23  1  0\n  7 24  1  0\n  7 25  1  0\n  8 26  1  0\n  9 27  1  0\n 10 28  1  0\n 10 29  1  0\n 11 30  1  0\n 11 31  1  0\n 12 32  1  0\n 12 33  1  0\n 13 34  1  0\n 13 35  1  0\n 14 36  1  0\n 14 37  1  0\n 17 38  1  0\n 19 39  1  1\nM  END\n","sdf");
    viewer_17638177652198553.setStyle({"stick": {}});
    viewer_17638177652198553.setStyle({"model": 0},{"stick": {"colorscheme": "cyanCarbon"}});
    viewer_17638177652198553.setStyle({"model": 1},{"stick": {"colorscheme": "redCarbon"}});
    viewer_17638177652198553.setBackgroundColor("0xeeeeee");
    viewer_17638177652198553.zoomTo();
viewer_17638177652198553.render();
});
</script>
</div>
</div>
<p>This is a case where the asymmetry of the Tversky Index used in the Lobster paper shows. Here in the crystal alignment the second of the two molecules is more or less completely contained within the first one; that leads to a very high Tversky index that drops significantly if we re-order the molecules:</p>
<div id="9b8ce793" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">tversky12 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m1,m2,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb21-2">tversky21 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m2,m1,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb21-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tversky12<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> -&gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tversky21<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.95 -&gt; 0.76</code></pre>
</div>
</div>
<p>The shape alignment is symmetrical because it maximizes the overall overlap:</p>
<div id="11c56455" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">m1c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1)</span>
<span id="cb23-2">m2c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2)</span>
<span id="cb23-3">rdMolTransforms.CanonicalizeConformer(m1c.GetConformer())</span>
<span id="cb23-4">rdMolTransforms.CanonicalizeConformer(m2c.GetConformer())</span>
<span id="cb23-5">st2,ct2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.AlignMol(m2c,m1c,opt_param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb23-6">tversky2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m1c,m2c,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb23-7"></span>
<span id="cb23-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tversky<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> -&gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tversky2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.76 -&gt; 0.76</code></pre>
</div>
</div>
<p>What about molecules with a very low crystal Tversky index and a high one from the shape alignment?</p>
<div id="fbd00cf0" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">pruned <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [r <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTversky'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>]</span>
<span id="cb25-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(pruned)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>42</code></pre>
</div>
</div>
<div id="c16d6901" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pruned[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb27-2">m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb27-3">m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb27-4">m1c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1)</span>
<span id="cb27-5">m2c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2)</span>
<span id="cb27-6">rdMolTransforms.CanonicalizeConformer(m1c.GetConformer())</span>
<span id="cb27-7">rdMolTransforms.CanonicalizeConformer(m2c.GetConformer())</span>
<span id="cb27-8">st,ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.AlignMol(m1c,m2c,opt_param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb27-9">tversky <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m1c,m2c,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb27-10"></span>
<span id="cb27-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(st,ct)</span>
<span id="cb27-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>],tversky)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.3489983628032094 0.08050058859625212
0.0 0.8264984227129337</code></pre>
</div>
</div>
<div id="b871c795" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">IPythonConsole.drawMols3D([m1,m2])</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_17638185210383122" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_17638185210383122" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_17638185210383122 = null;
var warn = document.getElementById("3dmolwarning_17638185210383122");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_17638185210383122 = $3Dmol.createViewer(document.getElementById("3dmolviewer_17638185210383122"),{backgroundColor:"white"});
viewer_17638185210383122.zoomTo();
    viewer_17638185210383122.addModel("N4Z_A_401\n     RDKit          3D\n\n 72 77  0  0  0  0  0  0  0  0999 V2000\n   36.2199  -10.7081    9.0552 Cl  0  0  0  0  0  0  0  0  0  0  0  0\n   27.3817  -12.6095    9.7595 S   0  0  0  0  0  0  0  0  0  0  0  0\n   35.4096   -9.2060    5.5168 F   0  0  0  0  0  0  0  0  0  0  0  0\n   33.4858   -9.8570    4.9932 F   0  0  0  0  0  0  0  0  0  0  0  0\n   26.8175  -13.1097   10.9746 O   0  0  0  0  0  0  0  0  0  0  0  0\n   27.7227  -13.5288    8.7055 O   0  0  0  0  0  0  0  0  0  0  0  0\n   28.5512  -13.5624   15.4356 O   0  0  0  0  0  0  0  0  0  0  0  0\n   33.6681   -7.6959    5.6877 O   0  0  0  0  0  0  0  0  0  0  0  0\n   33.8898   -9.5898    7.1939 O   0  0  0  0  0  0  0  0  0  0  0  0\n   32.4974   -9.3694   19.4636 N   0  0  0  0  0  0  0  0  0  0  0  0\n   34.7262   -8.5287   12.0676 N   0  0  0  0  0  0  0  0  0  0  0  0\n   29.5461  -11.7556   14.1966 N   0  0  0  0  0  0  0  0  0  0  0  0\n   29.4388  -11.6124   16.4996 N   0  0  0  0  0  0  0  0  0  0  0  0\n   30.4059   -9.8858   15.2888 N   0  0  0  0  0  0  0  0  0  0  0  0\n   30.5112   -9.9849   12.9555 N   0  0  0  0  0  0  0  0  0  0  0  0\n   32.4252   -9.8165   11.0866 N   0  0  0  0  0  0  0  0  0  0  0  0\n   30.3391   -9.7008   17.6449 N   0  0  0  0  0  0  0  0  0  0  0  0\n   26.3454  -11.2645    9.1219 C   0  0  0  0  0  0  0  0  0  0  0  0\n   28.0008  -14.1448   14.2300 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.3985   -8.5488   18.2092 C   0  0  0  0  0  0  0  0  0  0  0  0\n   31.5894  -10.5531   19.6096 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.8361   -8.1651   12.7555 C   0  0  0  0  0  0  0  0  0  0  0  0\n   30.9414   -8.3582   17.6650 C   0  0  0  0  0  0  0  0  0  0  0  0\n   30.1756  -10.3268   18.9836 C   0  0  0  0  0  0  0  0  0  0  0  0\n   37.1187   -8.5879   12.3401 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.6687   -5.9855    8.8089 C   0  0  0  0  0  0  0  0  0  0  0  0\n   37.2349   -9.4037   11.2013 C   0  0  0  0  0  0  0  0  0  0  0  0\n   29.8827  -11.6054    9.1608 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.9026   -6.1187    7.4330 C   0  0  0  0  0  0  0  0  0  0  0  0\n   31.0569  -10.9011    9.4315 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.8124   -7.0968    9.6774 C   0  0  0  0  0  0  0  0  0  0  0  0\n   29.0776  -11.2062   11.4192 C   0  0  0  0  0  0  0  0  0  0  0  0\n   36.0740   -9.7303   10.4899 C   0  0  0  0  0  0  0  0  0  0  0  0\n   28.8826  -11.7375   10.1374 C   0  0  0  0  0  0  0  0  0  0  0  0\n   29.1554  -12.2946   15.3639 C   0  0  0  0  0  0  0  0  0  0  0  0\n   30.1514  -10.5453   14.1417 C   0  0  0  0  0  0  0  0  0  0  0  0\n   30.0348  -10.3797   16.4910 C   0  0  0  0  0  0  0  0  0  0  0  0\n   33.3050   -7.3953    6.9916 C   0  0  0  0  0  0  0  0  0  0  0  0\n   31.2771  -10.4141   10.7348 C   0  0  0  0  0  0  0  0  0  0  0  0\n   30.2939  -10.5517   11.7267 C   0  0  0  0  0  0  0  0  0  0  0  0\n   33.5115   -8.4444    7.8586 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.7981   -9.2932   10.9450 C   0  0  0  0  0  0  0  0  0  0  0  0\n   33.5115   -9.5735   10.1572 C   0  0  2  0  0  0  0  0  0  0  0  0\n   33.2926   -8.3469    9.2417 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.1336   -9.0653    5.8659 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.3134   -8.7579   20.2331 H   0  0  0  0  0  0  0  0  0  0  0  0\n   30.9670   -9.0953   12.9819 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.5376   -9.5242   12.0363 H   0  0  0  0  0  0  0  0  0  0  0  0\n   26.7395  -10.9142    8.2722 H   0  0  0  0  0  0  0  0  0  0  0  0\n   25.4236  -11.6093    8.9446 H   0  0  0  0  0  0  0  0  0  0  0  0\n   26.3018  -10.5284    9.7974 H   0  0  0  0  0  0  0  0  0  0  0  0\n   27.6093  -15.0404   14.4412 H   0  0  0  0  0  0  0  0  0  0  0  0\n   27.2869  -13.5463   13.8666 H   0  0  0  0  0  0  0  0  0  0  0  0\n   28.7259  -14.2500   13.5495 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.9399   -8.9989   17.4990 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.7816   -7.6445   18.3974 H   0  0  0  0  0  0  0  0  0  0  0  0\n   31.4776  -10.7495   20.5837 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.0148  -11.3374   19.1581 H   0  0  0  0  0  0  0  0  0  0  0  0\n   35.7459   -7.5895   13.5683 H   0  0  0  0  0  0  0  0  0  0  0  0\n   30.4215   -7.7528   18.2676 H   0  0  0  0  0  0  0  0  0  0  0  0\n   30.9623   -7.9726   16.7425 H   0  0  0  0  0  0  0  0  0  0  0  0\n   29.7054  -11.2043   18.8891 H   0  0  0  0  0  0  0  0  0  0  0  0\n   29.6395   -9.7231   19.5736 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.9332   -8.3104   12.8496 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.3978   -5.0978    9.1814 H   0  0  0  0  0  0  0  0  0  0  0  0\n   38.1276   -9.7436   10.9056 H   0  0  0  0  0  0  0  0  0  0  0  0\n   29.7521  -12.0208    8.2606 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.7904   -5.3520    6.8010 H   0  0  0  0  0  0  0  0  0  0  0  0\n   31.7322  -10.7446    8.7107 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.5624   -6.9885   10.6395 H   0  0  0  0  0  0  0  0  0  0  0  0\n   28.3617  -11.2891   12.1124 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.6452  -10.3861    9.5899 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 33  1  0\n  2  5  2  0\n  2  6  2  0\n  2 18  1  0\n  2 34  1  0\n  3 45  1  0\n  4 45  1  0\n  7 19  1  0\n  7 35  1  0\n  8 38  1  0\n  8 45  1  0\n  9 41  1  0\n  9 45  1  0\n 10 20  1  0\n 10 21  1  0\n 11 22  2  0\n 11 42  1  0\n 12 35  2  0\n 12 36  1  0\n 13 35  1  0\n 13 37  2  0\n 14 36  2  0\n 14 37  1  0\n 15 36  1  0\n 15 40  1  0\n 16 39  1  0\n 16 43  1  0\n 17 23  1  0\n 17 24  1  0\n 17 37  1  0\n 20 23  1  0\n 21 24  1  0\n 22 25  1  0\n 25 27  2  0\n 26 29  1  0\n 26 31  2  0\n 27 33  1  0\n 28 30  2  0\n 28 34  1  0\n 29 38  2  0\n 30 39  1  0\n 31 44  1  0\n 32 34  2  0\n 32 40  1  0\n 33 42  2  0\n 38 41  1  0\n 39 40  2  0\n 41 44  2  0\n 42 43  1  0\n 43 44  1  0\n 10 46  1  0\n 15 47  1  0\n 16 48  1  0\n 18 49  1  0\n 18 50  1  0\n 18 51  1  0\n 19 52  1  0\n 19 53  1  0\n 19 54  1  0\n 20 55  1  0\n 20 56  1  0\n 21 57  1  0\n 21 58  1  0\n 22 59  1  0\n 23 60  1  0\n 23 61  1  0\n 24 62  1  0\n 24 63  1  0\n 25 64  1  0\n 26 65  1  0\n 27 66  1  0\n 28 67  1  0\n 29 68  1  0\n 30 69  1  0\n 31 70  1  0\n 32 71  1  0\n 43 72  1  6\nM  END\n","sdf");
    viewer_17638185210383122.setStyle({"stick": {}});
    viewer_17638185210383122.addModel("5JT_A_402\n     RDKit          3D\n\n 31 33  0  0  0  0  0  0  0  0999 V2000\n   36.5041   -2.1215   21.0296 N   0  0  0  0  0  0  0  0  0  0  0  0\n   35.9148    4.4231   18.2923 N   0  0  0  0  0  0  0  0  0  0  0  0\n   36.3566    2.1132   18.3739 N   0  0  0  0  0  0  0  0  0  0  0  0\n   33.6253    5.0470   18.9094 N   0  0  0  0  0  0  0  0  0  0  0  0\n   34.7689    0.4709   18.9206 N   0  0  0  0  0  0  0  0  0  0  0  0\n   36.7684    3.3861   18.1191 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.5188    4.4301   19.2432 C   0  0  0  0  0  0  0  0  0  0  0  0\n   33.4106   -0.0916   18.8718 C   0  0  0  0  0  0  0  0  0  0  0  0\n   33.0467   -0.4305   20.3537 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.8246   -0.4775   19.3067 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.7306    3.1059   19.2582 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.0678   -1.4666   20.9262 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.5583   -1.0136   20.7452 C   0  0  1  0  0  0  0  0  0  0  0  0\n   34.6301    4.1847   18.6654 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.0755    1.7912   18.7220 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.1793    2.8845   18.8800 C   0  0  0  0  0  0  0  0  0  0  0  0\n   36.3397   -2.4717   21.9518 H   0  0  0  0  0  0  0  0  0  0  0  0\n   36.3669   -2.8559   20.3649 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.7132    6.0410   18.8436 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.7022    3.5552   17.8038 H   0  0  0  0  0  0  0  0  0  0  0  0\n   31.6499    4.8778   19.4544 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.3947   -0.9187   18.3099 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.7683    0.5776   18.4982 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.1255   -0.8180   20.3890 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.0782    0.4048   20.9026 H   0  0  0  0  0  0  0  0  0  0  0  0\n   36.7105   -0.0140   19.2847 H   0  0  0  0  0  0  0  0  0  0  0  0\n   35.8331   -1.2435   18.6640 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.0586    2.3987   19.4777 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.9388   -2.3378   20.4525 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.8869   -1.5879   21.9022 H   0  0  0  0  0  0  0  0  0  0  0  0\n   35.7404   -0.2737   21.3928 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 13  1  0\n  2  6  2  0\n  2 14  1  0\n  3  6  1  0\n  3 15  2  0\n  4  7  1  0\n  4 14  1  0\n  5  8  1  0\n  5 10  1  0\n  5 15  1  0\n  7 11  2  0\n  8  9  1  0\n  9 12  1  0\n 10 13  1  0\n 11 16  1  0\n 12 13  1  0\n 14 16  2  0\n 15 16  1  0\n  1 17  1  0\n  1 18  1  0\n  4 19  1  0\n  6 20  1  0\n  7 21  1  0\n  8 22  1  0\n  8 23  1  0\n  9 24  1  0\n  9 25  1  0\n 10 26  1  0\n 10 27  1  0\n 11 28  1  0\n 12 29  1  0\n 12 30  1  0\n 13 31  1  1\nM  END\n","sdf");
    viewer_17638185210383122.setStyle({"stick": {}});
    viewer_17638185210383122.setStyle({"model": 0},{"stick": {"colorscheme": "cyanCarbon"}});
    viewer_17638185210383122.setStyle({"model": 1},{"stick": {"colorscheme": "redCarbon"}});
    viewer_17638185210383122.setBackgroundColor("0xeeeeee");
    viewer_17638185210383122.zoomTo();
viewer_17638185210383122.render();
});
</script>
</div>
</div>
<div id="5ff7da55" class="cell" data-scrolled="false" data-execution_count="32">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">IPythonConsole.drawMols3D([m1c,m2c])</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_1763818529126895" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_1763818529126895" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_1763818529126895 = null;
var warn = document.getElementById("3dmolwarning_1763818529126895");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_1763818529126895 = $3Dmol.createViewer(document.getElementById("3dmolviewer_1763818529126895"),{backgroundColor:"white"});
viewer_1763818529126895.zoomTo();
    viewer_1763818529126895.addModel("N4Z_A_401\n     RDKit          3D\n\n 72 77  0  0  0  0  0  0  0  0999 V2000\n    3.9440   -2.0052   -2.7857 Cl  0  0  0  0  0  0  0  0  0  0  0  0\n   -0.4775    5.4335   -0.0762 S   0  0  0  0  0  0  0  0  0  0  0  0\n    7.1313   -0.4980   -1.0531 F   0  0  0  0  0  0  0  0  0  0  0  0\n    6.7279    1.5232   -0.6644 F   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.8918    5.5663   -0.2413 O   0  0  0  0  0  0  0  0  0  0  0  0\n    0.4079    6.0394   -1.0360 O   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.3343    2.4658   -1.5248 O   0  0  0  0  0  0  0  0  0  0  0  0\n    6.6275    0.1107    1.1190 O   0  0  0  0  0  0  0  0  0  0  0  0\n    4.9597    0.1264   -0.6482 O   0  0  0  0  0  0  0  0  0  0  0  0\n   -6.5625   -4.2497    0.1401 N   0  0  0  0  0  0  0  0  0  0  0  0\n    1.1203   -3.1315   -0.1754 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.4587    1.4230   -0.4366 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.5410    0.4359   -0.2762 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.7183   -0.5617    0.7559 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.6003    0.4205    0.6350 N   0  0  0  0  0  0  0  0  0  0  0  0\n    0.8497   -0.3312   -0.1505 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.8240   -1.6223    0.9321 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0186    5.9192    1.6099 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.5835    3.6828   -1.7501 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.2998   -3.9912    0.9117 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -7.2908   -3.0756   -0.4413 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.0036   -4.4609   -0.4130 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.3289   -2.7016    1.8015 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -7.2222   -1.8000    0.4588 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.7800   -5.0909   -1.4113 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.7969   -1.2391    3.0765 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6772   -4.3188   -2.1694 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2308    3.2947   -0.4348 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.0959   -0.7605    2.8554 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.5856    1.9451   -0.4048 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.8372   -1.2338    2.0329 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.0250    2.7570    0.2933 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.8033   -2.9559   -1.8743 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0587    3.7072   -0.0627 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.7716    1.4587   -0.7208 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.9229    0.4334    0.3168 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.0456   -0.5768    0.5009 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.3788   -0.3105    1.5500 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6003    0.9857   -0.1000 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.6976    1.3808    0.2589 C   0  0  0  0  0  0  0  0  0  0  0  0\n    4.4577   -0.3814    0.5295 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.9967   -2.3549   -0.8672 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.1531   -0.8812   -0.4692 C   0  0  2  0  0  0  0  0  0  0  0  0\n    3.1504   -0.8588    0.7121 C   0  0  0  0  0  0  0  0  0  0  0  0\n    6.3578    0.2821   -0.3028 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -7.1965   -4.7160    0.7569 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.2623   -0.3446    1.1830 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.1001   -0.9648    0.0410 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.9703    5.8265    1.7260 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.2850    6.8702    1.7670 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.4881    5.3287    2.2663 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.1118    4.2966   -2.3368 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.4045    4.1310   -0.8743 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.7156    3.4616   -2.1949 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.5481   -3.9018    0.2581 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.1320   -4.7769    1.5071 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -8.2510   -3.3263   -0.5641 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -6.8865   -2.8593   -1.3300 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.3590   -5.0033    0.1259 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.9429   -2.8302    2.5802 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.4102   -2.4871    2.1332 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -7.5020   -0.9993   -0.0710 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -7.8314   -1.9097    1.2441 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.6924   -6.0733   -1.5763 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.5446   -1.5876    3.9793 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.2139   -4.7340   -2.9038 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.9030    3.9759   -0.7247 H   0  0  0  0  0  0  0  0  0  0  0  0\n    5.7825   -0.7396    3.5820 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.5256    1.6633   -0.5972 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.8989   -1.5078    2.2435 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.9403    3.0496    0.5698 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.5437   -0.3740   -1.2374 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 33  1  0\n  2  5  2  0\n  2  6  2  0\n  2 18  1  0\n  2 34  1  0\n  3 45  1  0\n  4 45  1  0\n  7 19  1  0\n  7 35  1  0\n  8 38  1  0\n  8 45  1  0\n  9 41  1  0\n  9 45  1  0\n 10 20  1  0\n 10 21  1  0\n 11 22  2  0\n 11 42  1  0\n 12 35  2  0\n 12 36  1  0\n 13 35  1  0\n 13 37  2  0\n 14 36  2  0\n 14 37  1  0\n 15 36  1  0\n 15 40  1  0\n 16 39  1  0\n 16 43  1  0\n 17 23  1  0\n 17 24  1  0\n 17 37  1  0\n 20 23  1  0\n 21 24  1  0\n 22 25  1  0\n 25 27  2  0\n 26 29  1  0\n 26 31  2  0\n 27 33  1  0\n 28 30  2  0\n 28 34  1  0\n 29 38  2  0\n 30 39  1  0\n 31 44  1  0\n 32 34  2  0\n 32 40  1  0\n 33 42  2  0\n 38 41  1  0\n 39 40  2  0\n 41 44  2  0\n 42 43  1  0\n 43 44  1  0\n 10 46  1  0\n 15 47  1  0\n 16 48  1  0\n 18 49  1  0\n 18 50  1  0\n 18 51  1  0\n 19 52  1  0\n 19 53  1  0\n 19 54  1  0\n 20 55  1  0\n 20 56  1  0\n 21 57  1  0\n 21 58  1  0\n 22 59  1  0\n 23 60  1  0\n 23 61  1  0\n 24 62  1  0\n 24 63  1  0\n 25 64  1  0\n 26 65  1  0\n 27 66  1  0\n 28 67  1  0\n 29 68  1  0\n 30 69  1  0\n 31 70  1  0\n 32 71  1  0\n 43 72  1  6\nM  END\n","sdf");
    viewer_1763818529126895.setStyle({"stick": {}});
    viewer_1763818529126895.addModel("5JT_A_402\n     RDKit          3D\n\n 31 33  0  0  0  0  0  0  0  0999 V2000\n   -5.4331    2.2314   -1.0580 N   0  0  0  0  0  0  0  0  0  0  0  0\n    1.6630    2.2681   -0.4957 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.5778    2.7858    0.0029 N   0  0  0  0  0  0  0  0  0  0  0  0\n    2.1975   -0.1239   -0.4281 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.2104    1.2054    0.5976 N   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6837    3.1864   -0.3180 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.5744   -1.2392   -0.1380 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.6467   -0.0132    1.2966 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.4114   -0.8565    0.2255 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.2936    2.1098    0.1831 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.3024   -0.9700    0.1905 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.6341   -0.0451   -0.3135 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.2374    1.3844   -0.8221 C   0  0  1  0  0  0  0  0  0  0  0  0\n    1.3969    0.9505   -0.2964 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.9154    1.4852    0.2493 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.1246    0.5292    0.0824 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -6.0447    1.7726   -1.7027 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.9120    2.3805   -0.1929 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.1547   -0.0762   -0.7137 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.8870    4.1599   -0.4227 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.9844   -2.1511   -0.1584 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.2529    0.2183    2.0574 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.8568   -0.5199    1.6420 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.7345   -1.7068    0.6412 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.7943   -1.0694   -0.5320 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.9006    2.9180   -0.2557 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.8180    2.3891    0.9874 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.3964   -1.6340    0.4564 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.3031    0.0522    0.4235 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.0448   -0.5516   -1.0717 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.7506    1.2829   -1.6898 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 13  1  0\n  2  6  2  0\n  2 14  1  0\n  3  6  1  0\n  3 15  2  0\n  4  7  1  0\n  4 14  1  0\n  5  8  1  0\n  5 10  1  0\n  5 15  1  0\n  7 11  2  0\n  8  9  1  0\n  9 12  1  0\n 10 13  1  0\n 11 16  1  0\n 12 13  1  0\n 14 16  2  0\n 15 16  1  0\n  1 17  1  0\n  1 18  1  0\n  4 19  1  0\n  6 20  1  0\n  7 21  1  0\n  8 22  1  0\n  8 23  1  0\n  9 24  1  0\n  9 25  1  0\n 10 26  1  0\n 10 27  1  0\n 11 28  1  0\n 12 29  1  0\n 12 30  1  0\n 13 31  1  6\nM  END\n","sdf");
    viewer_1763818529126895.setStyle({"stick": {}});
    viewer_1763818529126895.setStyle({"model": 0},{"stick": {"colorscheme": "cyanCarbon"}});
    viewer_1763818529126895.setStyle({"model": 1},{"stick": {"colorscheme": "redCarbon"}});
    viewer_1763818529126895.setBackgroundColor("0xeeeeee");
    viewer_1763818529126895.zoomTo();
viewer_1763818529126895.render();
});
</script>
</div>
</div>
<p>This is a situation described in the LOBSTER paper: the crystal ligands are in very different parts of the pocket that was identified by SIENA.</p>
<p>We can figure out what’s going on by looking at the PDB entries:</p>
<div id="253da19a" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">d</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>{'ligname1': 'N4Z_A_401',
 'pdb1': '6tel',
 'ligname2': '5JT_A_402',
 'pdb2': '5mw3',
 'ensemble': '5JU_A_401-5mw4',
 'morgan_fp_tanimoto': 0.115,
 'gobbi_2d_pharmacophore_fp_tanimoto': 0.102,
 'hac_difference': 29,
 'shape_tversky_index': 0.0,
 'shape_tanimoto_distance': 1.0,
 'shape_protrude_distance': 1.0,
 'shape_align_ShapeTanimoto': 0.3489983628032094,
 'shape_align_ColorTanimoto': 0.08050058859625212,
 'shape_align_ShapeTversky': 0.8264984227129337,
 'O3A_RMSD': 0.18706387903535077,
 'O3A_score': 99.22402124958128,
 'O3A_ShapeTversky': 0.6229205175600739,
 'CrippenO3A_RMSD': 0.3775024004623698,
 'CrippenO3A_score': 64.29333441352107,
 'CrippenO3A_ShapeTversky': 0.7638085218306154}</code></pre>
</div>
</div>
<p>From looking at the PDBe pages for <a href="https://www.ebi.ac.uk/pdbe/entry/pdb/6tel?activeTab=ligands&amp;id=N4Z">ligand N4Z in 6tel</a> and <a href="https://www.ebi.ac.uk/pdbe/entry/pdb/5mw3?activeTab=ligands&amp;id=5JT">ligand 5JT in 5mw3</a> it looks like the automatic curation procedure for LOBSTER may have picked the wrong ligand for 5mw3 (which has two bound ligands), <a href="https://www.ebi.ac.uk/pdbe/entry/pdb/5mw3?activeTab=ligands&amp;id=5JJ">ligand 5JJ</a> looks like it may be a more similar pocket (or part of the pocket) to ligand N4Z.</p>
</section>
<section id="open3dalign" class="level1">
<h1>Open3DAlign</h1>
<p>What about an alternative 3D alignment algorithm? Let’s try aligning with Paolo Tosco’s <a href="https://link.springer.com/article/10.1007/s10822-011-9462-9">Open3DAlign</a>:</p>
<div id="e6ecccef" class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolAlign</span>
<span id="cb33-2"></span>
<span id="cb33-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb33-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairstats):</span>
<span id="cb33-5">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb33-6">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb33-7">    </span>
<span id="cb33-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb33-9">        o3a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolAlign.GetO3A(m2,m1)</span>
<span id="cb33-10">        rmsd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Align()</span>
<span id="cb33-11">        score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Score()</span>
<span id="cb33-12">        tversky <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m1,m2,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb33-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>:</span>
<span id="cb33-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we get failures for molecules that don't have MMFF94 parameters.</span></span>
<span id="cb33-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the results for those to zero</span></span>
<span id="cb33-16">        rmsd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb33-17">        score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb33-18">        tversky <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb33-19">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A_RMSD'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rmsd</span>
<span id="cb33-20">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A_score'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> score</span>
<span id="cb33-21">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A_ShapeTversky'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tversky</span>
<span id="cb33-22">    </span>
<span id="cb33-23"></span></code></pre></div>
</div>
<div id="c69a2fbc" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb34-2">                includeLine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Ignoring the cases where Open3DAlign didn’t have parameters, that’s pretty similar to what we saw with the shape alignment, though there are points with a high Tversky index in the crystal structure and low Open3D align result.</p>
<div id="56c89664" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">ligname1,pdb1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'1D1_A_401'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'4i5p'</span>) </span>
<span id="cb35-2">ligname2,pdb2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'11G_A_401'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'4i6b'</span>)</span>
<span id="cb35-3">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pruned[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb35-4">m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(ligname1,pdb1)][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb35-5">m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(ligname2,pdb2)][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb35-6">m1c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1)</span>
<span id="cb35-7">m2c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2)</span>
<span id="cb35-8">rdMolTransforms.CanonicalizeConformer(m1c.GetConformer())</span>
<span id="cb35-9">rdMolTransforms.CanonicalizeConformer(m2c.GetConformer())</span>
<span id="cb35-10">st,ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeAlign.AlignMol(m1c,m2c,opt_param<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb35-11">stversky <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m1c,m2c,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb35-12"></span>
<span id="cb35-13">m1c2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m1)</span>
<span id="cb35-14">m2c2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(m2)</span>
<span id="cb35-15">o3a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolAlign.GetO3A(m2c2,m1c2)</span>
<span id="cb35-16">rmsd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Align()</span>
<span id="cb35-17">o3atversky <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m1c2,m2c2,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb35-18"></span>
<span id="cb35-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(stversky,o3atversky)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.7622862091361766 0.9846320346320346</code></pre>
</div>
</div>
<p>The shape-based alignment (we saw this above):</p>
<div id="3bbc7999" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">IPythonConsole.drawMols3D([m1c,m2c])</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_17638734672885962" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_17638734672885962" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_17638734672885962 = null;
var warn = document.getElementById("3dmolwarning_17638734672885962");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_17638734672885962 = $3Dmol.createViewer(document.getElementById("3dmolviewer_17638734672885962"),{backgroundColor:"white"});
viewer_17638734672885962.zoomTo();
    viewer_17638734672885962.addModel("1D1_A_401\n     RDKit          3D\n\n 47 50  0  0  0  0  0  0  0  0999 V2000\n    4.0527    1.8957   -0.3913 O   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.8480    2.2030   -0.0118 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.5993   -0.9673   -0.2516 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.0374   -0.0165   -0.1681 N   0  0  0  0  0  0  0  0  0  0  0  0\n    1.8029    2.3697   -0.2356 N   0  0  0  0  0  0  0  0  0  0  0  0\n    1.3087   -0.4889   -0.3277 N   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0742    3.8124   -0.1844 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6170    0.0789    2.2230 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.9181   -1.2423   -0.1069 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.6198    2.7287   -0.0662 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.3412   -0.4413    0.9841 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.5835   -0.0843    0.2526 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.8590   -4.1509    0.5110 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.7484   -4.2074   -0.7324 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.6529    0.9285    0.3431 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6891   -2.6772    0.8870 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0070   -2.7705   -1.1655 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.0615    0.8622   -0.0663 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.8834    1.4626   -0.3468 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.2353    0.4228   -0.2272 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.4509    0.3385    0.0102 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.9698   -1.9332   -0.4096 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.4810    1.8872   -0.1699 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7019   -0.0105   -0.3496 C   0  0  2  0  0  0  0  0  0  0  0  0\n   -2.8782   -1.6123   -0.5044 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2112    4.3113   -0.1063 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6496    4.0155    0.6079 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.5468    4.0926   -1.0201 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.0892   -0.2414    3.0442 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6111    1.0788    2.2104 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.6761   -0.2600    2.2260 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.3421   -2.1383   -0.2387 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.4945    3.7201   -0.0325 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.3466   -1.4407    1.0207 H   0  0  0  0  0  0  0  0  0  0  0  0\n    4.2815   -0.1019    1.0050 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -6.5659    0.0027    0.4178 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2916   -4.6477    1.2634 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0326   -4.5577    0.3120 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2842   -4.7075   -1.4633 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6128   -4.6608   -0.5151 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.8138    1.8828    0.5949 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.3422   -2.4136    1.5967 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.2412   -2.4967    1.2063 H   0  0  0  0  0  0  0  0  0  0  0  0\n    1.8840   -2.6740   -2.1532 H   0  0  0  0  0  0  0  0  0  0  0  0\n    2.9339   -2.4901   -0.9160 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.1278   -1.9883   -0.9463 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.1957   -0.4183   -1.1175 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 19  2  0\n  2 10  2  0\n  2 18  1  0\n  3  9  1  0\n  3 21  1  0\n  4 18  2  0\n  4 20  1  0\n  5  7  1  0\n  5 19  1  0\n  5 23  1  0\n  6 20  1  0\n  6 22  1  0\n  6 24  1  0\n  8 11  1  0\n  9 12  2  0\n 10 23  1  0\n 11 24  1  0\n 12 15  1  0\n 13 14  1  0\n 13 16  1  0\n 14 17  1  0\n 15 21  2  0\n 16 22  1  0\n 17 22  1  0\n 18 21  1  0\n 19 24  1  0\n 20 23  2  0\n  3 25  1  0\n  7 26  1  0\n  7 27  1  0\n  7 28  1  0\n  8 29  1  0\n  8 30  1  0\n  8 31  1  0\n  9 32  1  0\n 10 33  1  0\n 11 34  1  0\n 11 35  1  0\n 12 36  1  0\n 13 37  1  0\n 13 38  1  0\n 14 39  1  0\n 14 40  1  0\n 15 41  1  0\n 16 42  1  0\n 16 43  1  0\n 17 44  1  0\n 17 45  1  0\n 22 46  1  0\n 24 47  1  6\nM  END\n","sdf");
    viewer_17638734672885962.setStyle({"stick": {}});
    viewer_17638734672885962.addModel("11G_A_401\n     RDKit          3D\n\n 39 41  0  0  0  0  0  0  0  0999 V2000\n    1.2908    3.3626   -0.0826 O   0  0  0  0  0  0  0  0  0  0  0  0\n    2.1667   -2.5110   -0.2996 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.1004   -1.9105   -0.0530 N   0  0  0  0  0  0  0  0  0  0  0  0\n    2.0042    1.1592   -0.1788 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7924    0.3938    0.0616 N   0  0  0  0  0  0  0  0  0  0  0  0\n    3.4111    1.5729   -0.3120 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.3606    1.5738   -2.6066 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.8662   -2.8340   -0.1762 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.5819   -1.2370   -0.3026 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.9431    2.3142   -1.3879 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.4736   -0.3472   -0.4755 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.5054    0.6223    0.7143 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.0300   -0.3987   -0.9834 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -3.0517    0.9677    1.0295 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.9942    2.1467   -0.0644 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.2109   -0.5927   -0.0495 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.2084   -0.0364    0.2382 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.6419   -0.2106   -0.1916 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.4447    1.8204   -0.0045 C   0  0  2  0  0  0  0  0  0  0  0  0\n    3.9919    0.7619   -0.3813 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.5179    2.1309   -1.1349 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.6788    2.1070    0.4899 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7406    1.9627   -3.4459 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6344    1.6744   -2.6134 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.5972    0.6038   -2.5518 H   0  0  0  0  0  0  0  0  0  0  0  0\n    0.6096   -3.8005   -0.1764 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.5555   -1.0233   -0.3836 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.9375    2.2113   -1.4116 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7060    3.2819   -1.4732 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.0797   -0.0194   -1.2002 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.7659   -1.2577   -0.1828 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -4.9361    0.1859    1.5043 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -5.0126    1.4495    0.4727 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.8867    0.2632   -1.7191 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.7990   -1.3152   -1.3100 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.8757    0.8754    2.0096 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.8443    1.9022    0.7401 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.1737   -0.8640    0.7984 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.8912    2.3272    0.7330 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 15  2  0\n  2  8  2  0\n  2  9  1  0\n  3  8  1  0\n  3 16  2  0\n  4  6  1  0\n  4 15  1  0\n  4 18  1  0\n  5 16  1  0\n  5 17  1  0\n  5 19  1  0\n  7 10  1  0\n  9 18  2  0\n 10 19  1  0\n 11 12  1  0\n 11 13  1  0\n 12 14  1  0\n 13 17  1  0\n 14 17  1  0\n 15 19  1  0\n 16 18  1  0\n  6 20  1  0\n  6 21  1  0\n  6 22  1  0\n  7 23  1  0\n  7 24  1  0\n  7 25  1  0\n  8 26  1  0\n  9 27  1  0\n 10 28  1  0\n 10 29  1  0\n 11 30  1  0\n 11 31  1  0\n 12 32  1  0\n 12 33  1  0\n 13 34  1  0\n 13 35  1  0\n 14 36  1  0\n 14 37  1  0\n 17 38  1  0\n 19 39  1  1\nM  END\n","sdf");
    viewer_17638734672885962.setStyle({"stick": {}});
    viewer_17638734672885962.setStyle({"model": 0},{"stick": {"colorscheme": "cyanCarbon"}});
    viewer_17638734672885962.setStyle({"model": 1},{"stick": {"colorscheme": "redCarbon"}});
    viewer_17638734672885962.setBackgroundColor("0xeeeeee");
    viewer_17638734672885962.zoomTo();
viewer_17638734672885962.render();
});
</script>
</div>
</div>
<p>And the Open3D alignment:</p>
<div id="9db2e901" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">IPythonConsole.drawMols3D([m1c2,m2c2])</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_17638734790354753" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_17638734790354753" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_17638734790354753 = null;
var warn = document.getElementById("3dmolwarning_17638734790354753");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_17638734790354753 = $3Dmol.createViewer(document.getElementById("3dmolviewer_17638734790354753"),{backgroundColor:"white"});
viewer_17638734790354753.zoomTo();
    viewer_17638734790354753.addModel("1D1_A_401\n     RDKit          3D\n\n 47 50  0  0  0  0  0  0  0  0999 V2000\n   13.6199    4.3394   10.4996 O   0  0  0  0  0  0  0  0  0  0  0  0\n    7.7618    4.8606    9.8156 N   0  0  0  0  0  0  0  0  0  0  0  0\n    6.3944    8.1554   10.4865 N   0  0  0  0  0  0  0  0  0  0  0  0\n    8.8228    6.9055   10.3637 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.3439    4.1903   10.1704 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.1937    7.0400   10.7008 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.4418    2.7500    9.8990 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5846    6.7088    8.1521 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.1305    8.6178   10.3300 C   0  0  0  0  0  0  0  0  0  0  0  0\n    8.9115    4.1784    9.8385 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.2854    6.9331    9.4894 C   0  0  0  0  0  0  0  0  0  0  0  0\n    4.3546    7.6253    9.7593 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.2442   10.8146   10.4451 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.0524   10.5627   11.7193 C   0  0  0  0  0  0  0  0  0  0  0  0\n    5.1599    6.5268    9.5477 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.9220    9.4513    9.8291 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.1073    9.0549   11.9258 C   0  0  0  0  0  0  0  0  0  0  0  0\n    7.7087    6.1931   10.0763 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5167    4.9218   10.4741 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0267    6.3014   10.4072 C   0  0  0  0  0  0  0  0  0  0  0  0\n    6.4005    6.8977   10.0241 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.0272    8.4858   10.9997 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0969    4.8441   10.1252 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5146    6.3877   10.7066 C   0  0  2  0  0  0  0  0  0  0  0  0\n    7.1705    8.6548   10.8716 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.5316    2.3851    9.7034 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.0380    2.5991    9.1105 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.8225    2.2853   10.6985 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.1437    7.0883    7.4150 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.4572    5.7282    8.0029 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.6937    7.1629    8.1623 H   0  0  0  0  0  0  0  0  0  0  0  0\n    4.8102    9.5299   10.5859 H   0  0  0  0  0  0  0  0  0  0  0  0\n    8.9181    3.1963    9.6508 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4138    7.9169    9.6149 H   0  0  0  0  0  0  0  0  0  0  0  0\n   14.1773    6.4822    9.4555 H   0  0  0  0  0  0  0  0  0  0  0  0\n    3.3815    7.6927    9.5391 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.7810   11.3615    9.8026 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.3974   11.2977   10.6676 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.6061   10.9996   12.5002 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.9774   10.9285   11.6164 H   0  0  0  0  0  0  0  0  0  0  0  0\n    4.9014    5.6518    9.1383 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.5827    9.2183    9.1156 H   0  0  0  0  0  0  0  0  0  0  0  0\n    9.9991    9.4442    9.4441 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.9105    8.8236   12.8786 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0076    8.6988   11.6755 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.1653    8.5658   11.5006 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0038    6.6046   11.5513 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 19  2  0\n  2 10  2  0\n  2 18  1  0\n  3  9  1  0\n  3 21  1  0\n  4 18  2  0\n  4 20  1  0\n  5  7  1  0\n  5 19  1  0\n  5 23  1  0\n  6 20  1  0\n  6 22  1  0\n  6 24  1  0\n  8 11  1  0\n  9 12  2  0\n 10 23  1  0\n 11 24  1  0\n 12 15  1  0\n 13 14  1  0\n 13 16  1  0\n 14 17  1  0\n 15 21  2  0\n 16 22  1  0\n 17 22  1  0\n 18 21  1  0\n 19 24  1  0\n 20 23  2  0\n  3 25  1  0\n  7 26  1  0\n  7 27  1  0\n  7 28  1  0\n  8 29  1  0\n  8 30  1  0\n  8 31  1  0\n  9 32  1  0\n 10 33  1  0\n 11 34  1  0\n 11 35  1  0\n 12 36  1  0\n 13 37  1  0\n 13 38  1  0\n 14 39  1  0\n 14 40  1  0\n 15 41  1  0\n 16 42  1  0\n 16 43  1  0\n 17 44  1  0\n 17 45  1  0\n 22 46  1  0\n 24 47  1  1\nM  END\n","sdf");
    viewer_17638734790354753.setStyle({"stick": {}});
    viewer_17638734790354753.addModel("11G_A_401\n     RDKit          3D\n\n 39 41  0  0  0  0  0  0  0  0999 V2000\n   13.6387    4.3854   10.5227 O   0  0  0  0  0  0  0  0  0  0  0  0\n    7.7586    4.8504    9.8003 N   0  0  0  0  0  0  0  0  0  0  0  0\n    8.8004    6.8956   10.3415 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.3526    4.1877   10.1938 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.1784    7.0485   10.6933 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.4693    2.7433    9.9324 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.4814    6.6218    8.0821 C   0  0  0  0  0  0  0  0  0  0  0  0\n    7.7085    6.1724   10.0463 C   0  0  0  0  0  0  0  0  0  0  0  0\n    8.9104    4.1667    9.8393 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.2126    6.9087    9.4071 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.2871   10.8364   10.5232 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.1272   10.5410   11.7736 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.9781    9.4945    9.8539 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.1261    9.0238   11.9466 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.5169    4.9397   10.4895 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0162    6.3026   10.4017 C   0  0  0  0  0  0  0  0  0  0  0  0\n   11.0436    8.5014   10.9976 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0979    4.8425   10.1265 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.4988    6.4028   10.6879 C   0  0  2  0  0  0  0  0  0  0  0  0\n   10.5636    2.3647    9.7419 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.0655    2.5944    9.1435 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.8582    2.2898   10.7344 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0179    6.9844    7.3200 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.3691    5.6343    7.9705 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.5828    7.0601    8.0955 H   0  0  0  0  0  0  0  0  0  0  0  0\n    6.8226    6.6347   10.0077 H   0  0  0  0  0  0  0  0  0  0  0  0\n    8.9194    3.1822    9.6644 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.3254    7.8990    9.4883 H   0  0  0  0  0  0  0  0  0  0  0  0\n   14.1117    6.4734    9.3633 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.8015   11.4212    9.8958 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.4362   11.2932   10.7828 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.7210   10.9805   12.5748 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0619   10.8739   11.6487 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.6597    9.2791    9.1546 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0676    9.5032    9.4404 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.9085    8.7805   12.8919 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0181    8.6439   11.7015 H   0  0  0  0  0  0  0  0  0  0  0  0\n   10.1793    8.5971   11.4914 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.0183    6.6548   11.5045 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 15  2  0\n  2  8  2  0\n  2  9  1  0\n  3  8  1  0\n  3 16  2  0\n  4  6  1  0\n  4 15  1  0\n  4 18  1  0\n  5 16  1  0\n  5 17  1  0\n  5 19  1  0\n  7 10  1  0\n  9 18  2  0\n 10 19  1  0\n 11 12  1  0\n 11 13  1  0\n 12 14  1  0\n 13 17  1  0\n 14 17  1  0\n 15 19  1  0\n 16 18  1  0\n  6 20  1  0\n  6 21  1  0\n  6 22  1  0\n  7 23  1  0\n  7 24  1  0\n  7 25  1  0\n  8 26  1  0\n  9 27  1  0\n 10 28  1  0\n 10 29  1  0\n 11 30  1  0\n 11 31  1  0\n 12 32  1  0\n 12 33  1  0\n 13 34  1  0\n 13 35  1  0\n 14 36  1  0\n 14 37  1  0\n 17 38  1  0\n 19 39  1  1\nM  END\n","sdf");
    viewer_17638734790354753.setStyle({"stick": {}});
    viewer_17638734790354753.setStyle({"model": 0},{"stick": {"colorscheme": "cyanCarbon"}});
    viewer_17638734790354753.setStyle({"model": 1},{"stick": {"colorscheme": "redCarbon"}});
    viewer_17638734790354753.setBackgroundColor("0xeeeeee");
    viewer_17638734790354753.zoomTo();
viewer_17638734790354753.render();
});
</script>
</div>
</div>
<p>Here we can see that Open3DAlign can quite happily align a smaller molecule to a larger one.</p>
<p>Directly compare the O3A results to the shape alignment results:</p>
<div id="45b81c1f" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTversky'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb39-2">                includeLine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>There’s a reasonable number of pairs with high O3A similarities and low shape-align similarities. These are probably cases like we just saw: alignments of a small ligand to a larger one where there’s a good feature overlap between the small and large structures.</p>
<p>Aside from the alignments that didn’t work due to missing parameters (where the O3A Tversky is 0), the correlation is quite good</p>
<p>The RDKit has a variation on Open3DAlign that uses atomic contributions to the MolLogP value instead of MMFF94 atom types</p>
<div id="6e9ee47e" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolAlign</span>
<span id="cb40-2"></span>
<span id="cb40-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb40-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(pairstats):</span>
<span id="cb40-5">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb40-6">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb40-7">    </span>
<span id="cb40-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb40-9">        o3a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolAlign.GetCrippenO3A(m2,m1)</span>
<span id="cb40-10">        rmsd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Align()</span>
<span id="cb40-11">        score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o3a.Score()</span>
<span id="cb40-12">        tversky <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdShapeHelpers.ShapeTverskyIndex(m1,m2,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb40-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>:</span>
<span id="cb40-14">        rmsd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb40-15">        score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb40-16">        tversky <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb40-17">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A_RMSD'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rmsd</span>
<span id="cb40-18">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A_score'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> score</span>
<span id="cb40-19">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A_ShapeTversky'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tversky</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████| 72592/72592 [04:25&lt;00:00, 273.70it/s]</code></pre>
</div>
</div>
<p>It took a while to get here, so save the results:</p>
<div id="252a2d60" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pickle</span>
<span id="cb42-2">pickle.dump(pairstats,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./results/pairstats.pkl'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'wb+'</span>))</span></code></pre></div>
</div>
<p>Compare the Crippen alignment to the shape one</p>
<div id="d29a1236" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTversky'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb43-2">                includeLine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This looks quite similar to the last results, but this time we don’t have failed alignments due to missing atom types.</p>
<p>Compare the two different Open3DAlign results to each other:</p>
<div id="971ac0b6" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A_ShapeTversky'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb44-2">                includeLine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And, finally, compare the Crippen O3A results to the crystal alignments:</p>
<div id="63bc738b" class="cell" data-scrolled="false" data-execution_count="16">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb45-2">                includeLine<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-34-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparing-performance-on-easy-cases" class="level1">
<h1>Comparing performance on “easy” cases</h1>
<p>The LOBSTER paper suggests that ligand pairs that have a Tversky overlap of 0.9 or higher are good starting points for studying superposition algorithms.</p>
<p>Let’s see how well the three alignment approaches we applied here do:</p>
<div id="7802e015" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1">pruned <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [r <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>]</span>
<span id="cb46-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(pruned)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>2653</code></pre>
</div>
</div>
<div id="ccad849e" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">comparison_plot(pruned,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_align_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="7297e2a6" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">comparison_plot(pruned,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CrippenO3A_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Make the same plot with the default O3A alignments that did not fail due to missing parameters:</p>
<div id="a28f98b7" class="cell" data-scrolled="false" data-execution_count="51">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">comparison_plot([x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pruned <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A_ShapeTversky'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here’s what that looks like with the failed alignments included:</p>
<div id="aa9a03bb" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1">comparison_plot(pruned,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape_tversky_index'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O3A_ShapeTversky'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Based on this simple analysis, it looks like the Open3DAlign methods are doing better than the shape-based alignment. Given the differences in size between some of the ligands, this isn’t terribly surprising.</p>
<p>To really dig into alignment quality, we’d probably also want to look beyond just shape overlap and considere things like how far the aligned poses are from what is observed in the crystal using some kind of RMSD measure, but that’s for a possible future post.</p>


</section>

 ]]></description>
  <category>datasets</category>
  <category>3d</category>
  <category>superposition</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3.html</guid>
  <pubDate>Sat, 22 Nov 2025 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/working-with-lobster-3.png" medium="image" type="image/png" height="57" width="144"/>
</item>
<item>
  <title>Working with the LOBSTER Data set II</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2.html</link>
  <description><![CDATA[ 




<p>This post builds on the <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-11-08-working-with-lobster-1.html">last post</a> and does a little bit of work with the LOBSTER data set.</p>
<p>I had planned something a bit more ambitious for this post, but while writing it I discovered a bug in the conformer generator that it took me a while to track down (it’s still not fixed) and that ate up all the time I had set aside for working on the blog this week. I’ll do another post soon.</p>
<div id="209d81ae" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-4">IPythonConsole.ipython_3d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-7">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tableau-colorblind10'</span>)</span>
<span id="cb1-8">plt.rcParams[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font.size'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'16'</span></span>
<span id="cb1-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext sql</span>
<span id="cb1-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>config SqlMagic.feedback<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div>
</div>
<section id="generating-conformers-for-the-lobster-compounds" class="level1">
<h1>Generating conformers for the LOBSTER compounds</h1>
<div id="dc28d683" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> lwreg</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lwreg <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> utils</span></code></pre></div>
</div>
<p>Load our lwreg configuration from the database we created before:</p>
<div id="e184d2ce" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.configure_from_database(dbname<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lobster_112024'</span>,dbtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'postgresql'</span>)</span>
<span id="cb3-2">lwreg.set_default_config(config)</span>
<span id="cb3-3"></span>
<span id="cb3-4">config</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>{'dbname': 'lobster_112024',
 'dbtype': 'postgresql',
 'cacheConnection': True,
 'standardization': 'none',
 'removeHs': 1,
 'useTautomerHashv2': 0,
 'registerConformers': 1,
 'numConformerDigits': 3,
 'lwregSchema': ''}</code></pre>
</div>
</div>
<div id="62550701" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb5-2">    select molregno,ntabs <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdk.descriptors where ntabs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-3">mrns,ntabs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d)</span>
<span id="cb5-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(mrns)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>2226</code></pre>
</div>
</div>
<div id="02756259" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">cn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&lt; lwreg provides a convenience function to get a database connection</span></span>
<span id="cb7-2">curs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cn.cursor()</span>
<span id="cb7-3"></span>
<span id="cb7-4">curs.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'create schema generated_data'</span>)</span>
<span id="cb7-5">curs.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''create table generated_data.confgen</span></span>
<span id="cb7-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">   (molregno integer references hashes, </span></span>
<span id="cb7-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    conf_id integer references conformers,</span></span>
<span id="cb7-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    method text)'''</span>)</span>
<span id="cb7-9">cn.commit()</span></code></pre></div>
</div>
<div id="acf187f4" class="cell" data-scrolled="true" data-execution_count="19">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">mbs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.retrieve(ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mrns)</span></code></pre></div>
</div>
<div id="848420d2" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdDistGeom</span>
<span id="cb9-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdBase</span></code></pre></div>
</div>
<p>Generate and store conformers</p>
<div id="74aaaffd" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">cn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&lt; lwreg provides a convenience function to get a database connection</span></span>
<span id="cb10-2">curs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cn.cursor()</span>
<span id="cb10-3"></span>
<span id="cb10-4">ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdDistGeom.ETKDGv3()</span>
<span id="cb10-5">ps.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span></span>
<span id="cb10-6">ps.pruneRmsThresh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb10-7">ps.numThreads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb10-8"></span>
<span id="cb10-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> mrn,nt <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(mrns,ntabs)):</span>
<span id="cb10-10">    mb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mbs[mrn][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb10-11">    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(mb,removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb10-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> mol:</span>
<span id="cb10-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(mrn)</span>
<span id="cb10-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb10-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> rdBase.BlockLogs():</span>
<span id="cb10-16">        cids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdDistGeom.EmbedMultipleConfs(mol,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>nt,ps)</span>
<span id="cb10-17">    reg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.register_multiple_conformers(mol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mol,fail_on_duplicate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb10-18">    </span>
<span id="cb10-19">    rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(x,y,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ETKDGv3'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x,y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> reg]</span>
<span id="cb10-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> rows:</span>
<span id="cb10-21">        curs.executemany(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into generated_data.confgen values (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)'</span>,rows)</span>
<span id="cb10-22">        cn.commit()</span>
<span id="cb10-23">    </span>
<span id="cb10-24">    </span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2226it [21:11,  1.75it/s]</code></pre>
</div>
</div>
<div id="0ca393d2" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-2">    select molregno,nconfs,ntabs <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-3">    (select molregno, count(conf_id) nconfs <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> generated_data.confgen group by (molregno)) t1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-4">      join rdk.descriptors using (molregno) where ntabs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</div>
<p>Number of conformers generated per compound:</p>
<div id="99620489" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">plt.Figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb13-2">plt.hist([x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d],bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&lt; it's -1 because we also have the crystal conformer</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#plt.plot((0,1000),(0,1000),'k-');</span></span>
<span id="cb13-4">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nConfs generated'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>nTABS is designed to be an upper limit on the number of conformers; let’s check to confirm that this works:</p>
<div id="b1b792fa" class="cell" data-scrolled="false" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">plt.Figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb14-2">plt.scatter([x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d],[x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-3">plt.plot((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>),(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k-'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-4">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nTABS'</span>)</span>
<span id="cb14-5">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nConfs generated'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>That works quite well in general, but let’s look at the two outliers</p>
<div id="bd8b3c8f" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-2">    select molregno,canonical_smiles,nconfs,ntabs <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-3">    (select molregno, count(conf_id) nconfs <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> generated_data.confgen group by (molregno)) t1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-4">      join rdk.descriptors using (molregno) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-5">      join hashes using (molregno) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-6">    where ntabs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> ntabs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> nconfs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>ntabs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</div>
<div id="594d9ad2" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(d)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>2</code></pre>
</div>
</div>
<div id="b4dceef7" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">Draw.MolsToGridImage([Chem.MolFromSmiles(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d],subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>),</span>
<span id="cb18-2">                    legends<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'mrn:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The underestimate of the number of conformers for compound 2980 are due to the triple bond. This is a known limitation of the TABS algorithm that was discussed in the paper and that we’re planning on working on.</p>
<p>The “extra” conformers observed in compound 298 are due to a bug in the conformer generation code that leads to non-physical conformers, I hope to have this one fixed in a future RDKit release.</p>
<p>Actually retrieve all of the conformers to see how we did at finding the crystal conformer in our conformer ensembles:</p>
<div id="cfc50fae" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb19-2">    select molregno,conf_id,molblock <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> conformers order by (molregno,conf_id) asc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</div>
<p>Find the conformer for each molecule that’s closest to the crystal structure using RMSD as the metric:</p>
<div id="02367079" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolAlign</span>
<span id="cb20-2">accums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb20-3">r_mrn,r_cid,r_mb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d.pop(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-4">r_mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(r_mb)</span>
<span id="cb20-5">best <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e8</span></span>
<span id="cb20-6">best_cid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb20-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (mrn,cid,mb) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(d):</span>
<span id="cb20-8">    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(mb)</span>
<span id="cb20-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mrn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span>r_mrn:</span>
<span id="cb20-10">        rms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolAlign.GetBestRMS(r_mol,mol)</span>
<span id="cb20-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> rms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>best:</span>
<span id="cb20-12">            best <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rms</span>
<span id="cb20-13">            best_cid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cid</span>
<span id="cb20-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb20-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> best_cid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb20-16">            accums[r_mrn] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (best,best_cid)</span>
<span id="cb20-17">        r_mrn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mrn</span>
<span id="cb20-18">        r_cid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cid</span>
<span id="cb20-19">        r_mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mol</span>
<span id="cb20-20">        best <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e8</span></span>
<span id="cb20-21">        best_cid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|████████████████████████████████████████████████████████████████████████████████████████████████████████| 81315/81315 [00:14&lt;00:00, 5507.62it/s]</code></pre>
</div>
</div>
<div id="2c917233" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb22-2">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb22-3">plt.hist([x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> accums.values()],bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-4">plt.plot((<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k--'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-5">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RMSD ($</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">AA$)'</span>)</span>
<span id="cb22-6">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>)</span>
<span id="cb22-7">ax2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.twinx()</span>
<span id="cb22-8">ax2.ecdf([x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> accums.values()],c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-9">ax2.grid()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="3c671ff6" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb23-2">np.quantile([x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> accums.values()],[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>array([0.50160024, 0.69941346, 0.88421735])</code></pre>
</div>
</div>
<p>60% of molecules are within 0.50A of the crystal structure, 80% are within 0.70A, and 90% are within 0.88A. That’s pretty good.</p>
</section>
<section id="comparing-shape-similarity-approaches" class="level1">
<h1>Comparing shape-similarity approaches</h1>
<p>The RDKit has a couple of built-in methods for doing shape similarity. Let’s compare those to each other on this data set:</p>
<p>Get a map from (nm,pdb) tuples to (molregno,confid,molblock):</p>
<div id="8ff64590" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb25-2">    select ligname,pdb,molregno,conf_id,molblock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb25-3">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.all_ligands join conformers using (molregno,conf_id)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb25-4">ligs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb25-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> nm,pdb,mrn,cid,mb <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d:</span>
<span id="cb25-6">    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(mb,removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb25-7">    mol_noh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(mb)</span>
<span id="cb25-8">    ligs[(nm,pdb.lower())] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (mrn,cid,mb,mol,mol_noh)</span></code></pre></div>
</div>
<div id="be748ca6" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">pairstats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb26-2">    select <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.pair_stats</span>
<span id="cb26-3">pairstats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(pairstats.dicts())</span></code></pre></div>
</div>
<p>Note that the scores for the ligand pairs in the LOBSTER data set are each present twice: 1. Ligand1 as reference, Ligand2 as probe 1. Ligand2 as reference, Ligand1 as probe</p>
<p>We can see this here:</p>
<div id="d5aea725" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(pairstats)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>72592</code></pre>
</div>
</div>
<div id="aa61ea56" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb29-2">    select count(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.pair_stats where (ligname1,pdb1)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(ligname2,pdb2)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>36296</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="b3a94c7d" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span></code></pre></div>
</div>
<div id="b00099e2" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> comparison_plot(pairstats,metric1,metric2,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb31-2">    x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x[metric1] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats]</span>
<span id="cb31-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> invert1:</span>
<span id="cb31-4">        x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x1]</span>
<span id="cb31-5">        metric1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'1-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>metric1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb31-6">    x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x[metric2] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats]</span>
<span id="cb31-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> invert2:</span>
<span id="cb31-8">        x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x2]</span>
<span id="cb31-9">        metric2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'1-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>metric2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb31-10">    r,_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.spearmanr(x1,x2)</span>
<span id="cb31-11">    tau,_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.kendalltau(x1,x2)</span>
<span id="cb31-12"></span>
<span id="cb31-13">    plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb31-14">    plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb31-15">    plt.scatter(x1,x2,alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb31-16">    plt.xlabel(metric1)</span>
<span id="cb31-17">    plt.ylabel(metric2)</span>
<span id="cb31-18">    plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'rho=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, tau=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tau<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb31-19">    plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb31-20">    plt.hexbin(x1,x2,cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Blues'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb31-21">    plt.tight_layout()</span></code></pre></div>
</div>
<p>Calculate USR scores:</p>
<div id="57f86f7a" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdMolDescriptors</span>
<span id="cb32-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats:</span>
<span id="cb32-3">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb32-4">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb32-5">    usr1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb32-6">    usr2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb32-7">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSRScore(usr1,usr2)</span>
<span id="cb32-8">    </span>
<span id="cb32-9">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb32-10">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb32-11">    usr1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb32-12">    usr2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb32-13">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR_noh'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdMolDescriptors.GetUSRScore(usr1,usr2)    </span></code></pre></div>
</div>
<p>Calculate atom pair fingerprints using 3D distances instead of topological distances:</p>
<div id="569d51cd" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdFingerprintGenerator</span>
<span id="cb33-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DataStructs</span>
<span id="cb33-3">fpg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdFingerprintGenerator.GetAtomPairGenerator(use2D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb33-4"></span>
<span id="cb33-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats:</span>
<span id="cb33-6">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb33-7">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb33-8">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb33-9">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb33-10">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataStructs.DiceSimilarity(fp1,fp2,returnDistance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb33-11">    </span>
<span id="cb33-12">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb33-13">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb33-14">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb33-15">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb33-16">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_noh'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataStructs.DiceSimilarity(fp1,fp2,returnDistance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb33-17"> </span></code></pre></div>
</div>
<div id="da819c48" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5ecb15b9" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR_noh'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_noh'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Finally, try the E3FP fingerprint (a 3D analog of the Morgan fingerprint) from <a href="http://dx.doi.org/10.1021/acs.jmedchem.7b00696">this paper</a>. The code is easily pip installable directly from <a href="https://github.com/keiserlab/e3fp">the github repo</a>. Thanks to the Keiser lab team for making this so easy!</p>
<p>It takes a while to run this one:</p>
<div id="28aa5fd3" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb36-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> e3fp.pipeline <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fprints_from_mol</span>
<span id="cb36-3">logging.disable(logging.INFO)</span>
<span id="cb36-4"></span>
<span id="cb36-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_fp(m):</span>
<span id="cb36-6">    fp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fprints_from_mol(m,fprint_params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'counts'</span>:<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>})[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb36-7">    rdkfp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataStructs.ULongSparseIntVect(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb36-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k,v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> fp.counts.items():</span>
<span id="cb36-9">        rdkfp[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(k)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> v </span>
<span id="cb36-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> rdkfp</span>
<span id="cb36-11"></span>
<span id="cb36-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats:</span>
<span id="cb36-13">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb36-14">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb36-15">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m1)</span>
<span id="cb36-16">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m2)</span>
<span id="cb36-17">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataStructs.DiceSimilarity(fp1,fp2,returnDistance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb36-18">    </span>
<span id="cb36-19">    m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb36-20">    m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ligs[(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>])][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb36-21">    fp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m1)</span>
<span id="cb36-22">    fp2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_fp(m2)</span>
<span id="cb36-23">    d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP_noh'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataStructs.DiceSimilarity(fp1,fp2,returnDistance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb36-24"> </span></code></pre></div>
</div>
<div id="e05e84c5" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="9a6071d9" class="cell" data-scrolled="false" data-execution_count="97">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">comparison_plot(pairstats,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_noh'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP_noh'</span>,invert1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,invert2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Save the results in the database so that we can work with them later:</p>
<div id="e2a924fc" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">cn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&lt; lwreg provides a convenience function to get a database connection</span></span>
<span id="cb39-2">curs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cn.cursor()</span>
<span id="cb39-3"></span>
<span id="cb39-4">curs.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'create schema if not exists results'</span>)</span>
<span id="cb39-5">curs.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'create table if not exists results.shape_scores </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb39-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  (ligname1 text, pdb1 text, ligname2 text, pdb2 text,</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb39-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">   USR float, USR_noh float, AP3D float, AP3D_noh float, E3P float, E3P_noh float)'</span>)</span>
<span id="cb39-8">curs.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'delete from results.shape_scores'</span>)</span>
<span id="cb39-9">rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname1'</span>],r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb1'</span>],r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ligname2'</span>],r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb2'</span>],<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb39-10">         r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR'</span>],r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USR_noh'</span>],r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D'</span>],r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP3D_noh'</span>],r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP'</span>],r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E3FP_noh'</span>]] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pairstats]</span>
<span id="cb39-11">curs.executemany(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into results.shape_scores values (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)'</span>,rows)</span>
<span id="cb39-12">cn.commit()</span></code></pre></div>
</div>
<p>That’s it for this week</p>


</section>

 ]]></description>
  <category>datasets</category>
  <category>3d</category>
  <category>similarity</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2.html</guid>
  <pubDate>Sat, 15 Nov 2025 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/working-with-lobster-2.png" medium="image" type="image/png" height="70" width="144"/>
</item>
<item>
  <title>Working with the LOBSTER Data set I</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-11-08-working-with-lobster-1.html</link>
  <description><![CDATA[ 




<p>Last year the Rarey and BioSolveIT groups published <a href="https://doi.org/10.1007/s10822-024-00581-1">a paper</a> describing LOBSTER, a data set of small molecule overlays drawn from the PDB. The carefully curated and constructed data set is intended to be a new benchmarking set for testing molecular alignment (superposition) tools. I’m really happy to have an up-to-date replacement for the older <a href="https://doi.org/10.1021/ci400020a">“AZ set”</a>, which is what I’ve previously always used when looking at alignment. The well-written paper (as one expects from the Rarey group!) is definitely worth reading in order to understand the decisions made in the curation workflow. The code used for the curation is available in GitHub and the data set itself can be downloaded from Zenodo. There are links in the (open access) paper to both places.</p>
<p>I have a number of ideas for experiments to do using the LOBSTER set, so I wanted to get it loaded up into a database I could use for those experiments. This blog post demonstrates how I did that.</p>
<p>I’m using our <a href="https://pubs.acs.org/doi/full/10.1021/acs.jcim.4c01133">lwreg</a> tool to handle registering the compound structures and to provide the basic schema for the database. You can <code>pip install</code> it from our <a href="https://github.com/rinikerlab/lightweight-registration">github repo</a> I’ve blogged about <a href="https://greglandrum.github.io/rdkit-blog/posts/2024-10-31-lwreg-and-the-cartridge.html">using lwreg together with the RDKit PostgreSQL cartridge</a> before.</p>
<div id="209d81ae" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-4">IPythonConsole.ipython_3d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext sql</span>
<span id="cb1-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>config SqlMagic.feedback<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The sql extension is already loaded. To reload it, use:
  %reload_ext sql</code></pre>
</div>
</div>
<section id="registering-the-structures-and-populating-the-data-base" class="level1">
<h1>Registering the structures and populating the data base</h1>
<div id="dc28d683" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> lwreg</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lwreg <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> utils</span></code></pre></div>
</div>
<p>At the command line I created the postgres database:</p>
<pre><code>% createdb lobster_112024</code></pre>
<div id="e184d2ce" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.defaultConfig()</span>
<span id="cb5-2">config</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>{'dbname': './testdb.sqlt',
 'dbtype': 'sqlite3',
 'standardization': 'fragment',
 'removeHs': 1,
 'useTautomerHashv2': 0,
 'registerConformers': 0,
 'numConformerDigits': 3,
 'lwregSchema': '',
 'cacheConnection': True}</code></pre>
</div>
</div>
<p>Configure lwreg to work with the database I created. We’ll turn off standardization and switch in to “registerConformers” mode.</p>
<div id="ef4d901f" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">config[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dbtype'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'postgresql'</span></span>
<span id="cb7-2">config[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dbname'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lobster_112024'</span></span>
<span id="cb7-3">config[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'standardization'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'none'</span></span>
<span id="cb7-4">config[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'registerConformers'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-5">lwreg.set_default_config(config)</span></code></pre></div>
</div>
<div id="6257a1dd" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">lwreg.initdb()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>This will destroy any existing information in the registration database.
  are you sure? [yes/no]: yes</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>True</code></pre>
</div>
</div>
<p>I downloaded the LOBSTER data from zenodo and extracted the zipfile locally.</p>
<p>Read in the SDFs containing the ligand structures and registering each 3D structure in lwreg:</p>
<div id="c6220795" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> glob</span>
<span id="cb11-2">sdfs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> glob.glob(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/scratch/Data/LOBSTER_112024/all_ligands/*.sdf'</span>)</span>
<span id="cb11-3">registered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb11-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> sdf <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sdfs:</span>
<span id="cb11-5">    ms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Chem.SDMolSupplier(sdf,removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb11-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ms)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-7">    m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb11-8">    ligname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.GetProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_Name'</span>)</span>
<span id="cb11-9">    ligpdb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.GetProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pdb_id'</span>)</span>
<span id="cb11-10">    naomi_smis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.GetProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'usmiles'</span>)</span>
<span id="cb11-11">    mrn,confid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lwreg.register(mol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m)</span>
<span id="cb11-12">    registered.append(((mrn,confid),ligname,ligpdb,naomi_smis,sdf))</span></code></pre></div>
</div>
<p>Let’s store the additional information from the LOBSTER data set in a separate table in the database:</p>
<div id="97af31fd" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">cn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&lt; lwreg provides a convenience function to get a database connection</span></span>
<span id="cb12-2">curs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cn.cursor()</span>
<span id="cb12-3"></span>
<span id="cb12-4">curs.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'create schema lobster_data'</span>)</span>
<span id="cb12-5">curs.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''create table lobster_data.all_ligands</span></span>
<span id="cb12-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">   (molregno integer references hashes, </span></span>
<span id="cb12-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    conf_id integer references conformers,</span></span>
<span id="cb12-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ligname text, pdb text, naomi_smiles text, filename text)'''</span>)</span>
<span id="cb12-9">rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> registered]</span>
<span id="cb12-10">curs.executemany(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into lobster_data.all_ligands values (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)'</span>,rows)</span>
<span id="cb12-11">cn.commit()</span></code></pre></div>
</div>
<div id="c005775f" class="cell" data-scrolled="true" data-execution_count="61">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb13-2">    select count(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.all_ligands<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 rows affected.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3583</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Install the RDKit catridge, load the molecules, and create an index on the molecule column so that we can do efficient substructure searching. More information about that in <a href="https://greglandrum.github.io/rdkit-blog/posts/2024-10-31-lwreg-and-the-cartridge.html">this blog post</a></p>
<div id="e12e9ba8" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-2">  create extension <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> exists rdkit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-3">    create schema <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> exists rdk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-4">    drop table <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> exists rdk.mols cascade<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;\</span></span>
<span id="cb15-5">    select molregno,mol_from_ctab(molblock::cstring,false) m into rdk.mols <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> molblocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;\</span></span>
<span id="cb15-6">    create index molidx on rdk.mols using gist(m)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="110">
<pre><code>[]</code></pre>
</div>
</div>
<p>Let’s add some fingerprints so that we can do similarity searches later. We’ll add both bit- and count-based Morgan fingerprints with radius 3:</p>
<div id="e815c231" class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb17-2">    drop table <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> exists rdk.fps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;\</span></span>
<span id="cb17-3">  select molregno,morganbv_fp(m,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mfp3, morgan_fp(m,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) cfp3 into rdk.fps <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdk.mols<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;\</span></span>
<span id="cb17-4">    create index fps_mfp3_idx on rdk.fps using gist(mfp3)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb17-5">    create index fps_cfp3_idx on rdk.fps using gist(cfp3)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>[]</code></pre>
</div>
</div>
<p>And now add some descriptors we might want to use:</p>
<div id="0f7166fa" class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb19-2">    drop table <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> exists rdk.descriptors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;\</span></span>
<span id="cb19-3">  select molregno,mol_numheavyatoms(m) nhvy, mol_amw(m) amw, mol_numrotatablebonds(m) nrot into rdk.descriptors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdk.mols<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>[]</code></pre>
</div>
</div>
<p>Add a column with nTABS, a measure of molecular flexibility developed by Jessica Braun in our lab (Jessica is also the other author/developer of lwreg). There’s <a href="https://pubs.acs.org/doi/10.1021/acs.jcim.4c01513">a paper</a> and a <a href="https://github.com/rinikerlab/TorsionAngularBinStrings">github repo</a> from which you can install the code.</p>
<div id="ee0ec1c9" class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tabs</span>
<span id="cb21-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb21-3">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb21-4">  select molregno,molblock <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> molblocks</span>
<span id="cb21-5"></span>
<span id="cb21-6">ntabs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb21-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> mrn,mb <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm.tqdm(d):</span>
<span id="cb21-8">    m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(mb,removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb21-9">    nt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tabs.GetnTABS(m)</span>
<span id="cb21-10">    ntabs.append((mrn,nt))  </span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████| 3218/3218 [00:13&lt;00:00, 245.40it/s]</code></pre>
</div>
</div>
<p>Add the nTABS values to the database:</p>
<div id="69a2b6a2" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">cn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb23-2">curs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cn.cursor()</span>
<span id="cb23-3"></span>
<span id="cb23-4">intabs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(y,x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x,y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ntabs]</span>
<span id="cb23-5">curs.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alter table rdk.descriptors add column ntabs int'</span>)</span>
<span id="cb23-6">curs.executemany(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'update rdk.descriptors set ntabs=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> where molregno=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>,intabs)</span>
<span id="cb23-7">cn.commit()</span></code></pre></div>
</div>
<p>Load data about pairs of aligned ligands from the LOBSTER data:</p>
<div id="fd406172" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">ind <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x.strip().split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">';'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/scratch/Data/LOBSTER_112024/stats/pair_stats.csv'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>)]</span>
<span id="cb24-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ind)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>72593</code></pre>
</div>
</div>
<div id="41003d68" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">ind.pop(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>['query_file',
 'query',
 'pdb',
 'template_file',
 'template',
 'template_pdb',
 'ensemble',
 'morgan_fp_tanimoto',
 'gobbi_2D_pharmacophore_fp_tanimoto',
 'hac_difference',
 'shape_tversky_index',
 'shape_tanimoto_distance',
 'shape_protrude_distance',
 '']</code></pre>
</div>
</div>
<p>And add that to the database too:</p>
<div id="f5ba4bd9" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">cn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> utils.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb28-2">curs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cn.cursor()</span>
<span id="cb28-3"></span>
<span id="cb28-4">curs.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''create table lobster_data.pair_stats</span></span>
<span id="cb28-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">   (ligname1 text, pdb1 text, ligname2 text, pdb2 text, ensemble text,</span></span>
<span id="cb28-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    morgan_fp_tanimoto float, gobbi_2D_pharmacophore_fp_tanimoto float,</span></span>
<span id="cb28-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    hac_difference int, shape_tversky_index float, shape_tanimoto_distance float,</span></span>
<span id="cb28-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    shape_protrude_distance float)'''</span>)</span>
<span id="cb28-9">rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>],x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>],<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]),<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>]),<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>])),<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]),<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb28-10">         <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>]),<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>]),) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ind]</span>
<span id="cb28-11">curs.executemany(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into lobster_data.pair_stats values (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)'</span>,rows)</span>
<span id="cb28-12">cn.commit()</span></code></pre></div>
</div>
</section>
<section id="composition-of-the-database" class="level1">
<h1>Composition of the database</h1>
<p>Now let’s look at what we’ve got:</p>
<div id="026bb964" class="cell" data-scrolled="true" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(registered)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>3583</code></pre>
</div>
</div>
<p>Number of unique molregnos:</p>
<div id="28697517" class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb31-2">  select count(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> hashes</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3218</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Number of conformers (this is the number we registered):</p>
<div id="12006a66" class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb32-2">  select count(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> conformers</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="129">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3583</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Number of pairs of aligned molecules:</p>
<div id="789394cf" class="cell" data-scrolled="true" data-execution_count="125">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb33-2">  select count(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.pair_stats</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>72592</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Number of unique naomi_smiles:</p>
<div id="577bd08f" class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb34-2">  select count(distinct naomi_smiles) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.all_ligands</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="126">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3212</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We’ll look at the mismatch between the number of naomi_smiles and the number of molecule hashes below</p>
</section>
<section id="retrieving-info-from-the-database" class="level1">
<h1>Retrieving info from the database</h1>
<p>Get all of the molecule hashes for one particular molregno using lwreg functions:</p>
<div id="1795724e" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">lwreg.retrieve(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,as_hashes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>{12: {'fullhash': '6d22ca45dd6fb8f29d263532db4f913e7da47d6a',
  'formula': 'C18H16N6',
  'canonical_smiles': 'CN(c1cnc2nc(N)nc(N)c2c1)c1cccc2ccccc12',
  'no_stereo_smiles': 'CN(c1cnc2nc(N)nc(N)c2c1)c1cccc2ccccc12',
  'tautomer_hash': 'CN([C]1[CH][N][C]2[N][C]([N])[N][C]([N])[C]2[CH]1)[C]1[CH][CH][CH][C]2[CH][CH][CH][CH][C]21_4_0',
  'no_stereo_tautomer_hash': 'CN([C]1[CH][N][C]2[N][C]([N])[N][C]([N])[C]2[CH]1)[C]1[CH][CH][CH][C]2[CH][CH][CH][CH][C]21_4_0',
  'escape': '',
  'sgroup_data': '[]'}}</code></pre>
</div>
</div>
<p>We can see here that the Hs have been removed by lwreg when calculating the hashes used for comparing 2D molecules to each other.</p>
<p>The molecules stored in the database still have their Hs. We can see this by retrieving the registered mol block for the molecule:</p>
<div id="c8a2c152" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromMolBlock(lwreg.retrieve(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb37-2">l</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_17625757959049916" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_17625757959049916" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_17625757959049916 = null;
var warn = document.getElementById("3dmolwarning_17625757959049916");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_17625757959049916 = $3Dmol.createViewer(document.getElementById("3dmolviewer_17625757959049916"),{backgroundColor:"white"});
viewer_17625757959049916.zoomTo();
    viewer_17625757959049916.removeAllModels();
    viewer_17625757959049916.addModel("33M_D_301\n     RDKit          3D\n\n 40 43  0  0  0  0  0  0  0  0999 V2000\n    9.7259   -3.2696   11.6873 N   0  0  0  0  0  0  0  0  0  0  0  0\n   10.4981    0.3535   14.5814 N   0  0  0  0  0  0  0  0  0  0  0  0\n   13.4437   -0.6379   10.9108 N   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0654   -1.4201   13.1743 N   0  0  0  0  0  0  0  0  0  0  0  0\n   11.5849   -1.9173   11.4370 N   0  0  0  0  0  0  0  0  0  0  0  0\n   14.8172    2.3874   12.4647 N   0  0  0  0  0  0  0  0  0  0  0  0\n   14.5309    3.3039   13.6379 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.2607    0.4413   11.2177 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.2482    4.2831    7.7614 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.1349    4.0651    8.6112 C   0  0  0  0  0  0  0  0  0  0  0  0\n   18.3005    2.5330   11.1357 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.2061    2.3421   12.0385 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.5568    3.9787    8.1964 C   0  0  0  0  0  0  0  0  0  0  0  0\n   18.0993    3.1132    9.8675 C   0  0  0  0  0  0  0  0  0  0  0  0\n   14.3683    3.5412    9.8793 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.8406    1.0733   13.0796 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.4450   -2.2057   12.1256 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.8450   -0.3774   13.5337 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.3603   -0.8452   11.7042 C   0  0  0  0  0  0  0  0  0  0  0  0\n   13.9843    1.3211   12.2560 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.8990    2.6320   11.6222 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.7856    3.4355    9.4819 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.0162   -0.0199   12.7773 C   0  0  0  0  0  0  0  0  0  0  0  0\n   15.6745    3.1891   10.3410 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0542   -3.8100   10.9126 H   0  0  0  0  0  0  0  0  0  0  0  0\n    8.8677   -3.5133   12.1390 H   0  0  0  0  0  0  0  0  0  0  0  0\n   11.0651    1.1287   14.8600 H   0  0  0  0  0  0  0  0  0  0  0  0\n    9.6692    0.1305   15.0943 H   0  0  0  0  0  0  0  0  0  0  0  0\n   15.2152    4.0326   13.6663 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.6209    3.7051   13.5331 H   0  0  0  0  0  0  0  0  0  0  0  0\n   14.5678    2.7786   14.4880 H   0  0  0  0  0  0  0  0  0  0  0  0\n   15.0826    0.5916   10.6682 H   0  0  0  0  0  0  0  0  0  0  0  0\n   15.1056    4.6563    6.8447 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.2070    4.2817    8.3078 H   0  0  0  0  0  0  0  0  0  0  0  0\n   19.2201    2.2507   11.4088 H   0  0  0  0  0  0  0  0  0  0  0  0\n   17.3735    2.0028   12.9641 H   0  0  0  0  0  0  0  0  0  0  0  0\n   17.3315    4.1495    7.5876 H   0  0  0  0  0  0  0  0  0  0  0  0\n   18.8710    3.2914    9.2570 H   0  0  0  0  0  0  0  0  0  0  0  0\n   13.5903    3.4055   10.4927 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.6333    1.6684   13.8560 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 17  1  0\n  2 18  1  0\n  3  8  2  0\n  3 19  1  0\n  4 17  2  0\n  4 18  1  0\n  5 17  1  0\n  5 19  2  0\n  6  7  1  0\n  6 20  1  0\n  6 21  1  0\n  8 20  1  0\n  9 10  2  0\n  9 13  1  0\n 10 15  1  0\n 11 12  1  0\n 11 14  2  0\n 12 21  2  0\n 13 22  2  0\n 14 22  1  0\n 15 24  2  0\n 16 20  2  0\n 16 23  1  0\n 18 23  2  0\n 19 23  1  0\n 21 24  1  0\n 22 24  1  0\n  1 25  1  0\n  1 26  1  0\n  2 27  1  0\n  2 28  1  0\n  7 29  1  0\n  7 30  1  0\n  7 31  1  0\n  8 32  1  0\n  9 33  1  0\n 10 34  1  0\n 11 35  1  0\n 12 36  1  0\n 13 37  1  0\n 14 38  1  0\n 15 39  1  0\n 16 40  1  0\nM  END\n","sdf");
    viewer_17625757959049916.setStyle({"stick": {}});
    viewer_17625757959049916.setBackgroundColor("0xeeeeee");
    viewer_17625757959049916.zoomTo();
viewer_17625757959049916.render();
});
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="48">

</div>
</div>
<p>Ligands that appear multiple times in the data set will have the same molregno but different confids. Let’s find those:</p>
<div id="b5873f43" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> defaultdict</span>
<span id="cb38-2"></span>
<span id="cb38-3">repeated_ligands <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> defaultdict(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>)</span>
<span id="cb38-4"></span>
<span id="cb38-5">seen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb38-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tpl <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> registered:</span>
<span id="cb38-7">    mrn,cid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tpl[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb38-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mrn <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> seen:</span>
<span id="cb38-9">        repeated_ligands[mrn].append(cid)</span>
<span id="cb38-10">    seen.add(mrn)</span>
<span id="cb38-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(repeated_ligands)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>219</code></pre>
</div>
</div>
<p>Get the molregnos for the molecules that have more than two conformers present:</p>
<div id="4956cc46" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">[k <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k,v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> repeated_ligands.items() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(v)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>[84,
 180,
 110,
 77,
 68,
 92,
 78,
 503,
 583,
 53,
 384,
 568,
 296,
 565,
 281,
 228,
 715,
 1016,
 1335,
 1123,
 795,
 454,
 936,
 1029,
 1317,
 267,
 1601]</code></pre>
</div>
</div>
<p>Each entry in the <code>repeated_ligands</code> dictionary includes the conf_ids of the conformers:</p>
<div id="932a5ea3" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">repeated_ligands[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">84</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>[207, 215, 802, 968, 2150]</code></pre>
</div>
</div>
<p>We can get the conformers themselves by calling <code>lwreg.retrieve()</code> with a list of (molregno,conf_id) tuples:</p>
<div id="997c6b8e" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">84</span></span>
<span id="cb44-2">confs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lwreg.retrieve(ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[(k,x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> repeated_ligands[k]])</span></code></pre></div>
</div>
<div id="98de086c" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">confs[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">84</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">207</span>)]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>('AZM_E_303\n     RDKit          3D\n\n  0  0  0  0  0  0  0  0  0  0999 V3000\nM  V30 BEGIN CTAB\nM  V30 COUNTS 19 19 0 0 0\nM  V30 BEGIN ATOM\nM  V30 1 S 9.311200 -40.854300 -76.602200 0\nM  V30 2 S 10.494600 -38.554800 -74.957200 0\nM  V30 3 O 9.730100 -37.268900 -74.826900 0\nM  V30 4 O 10.160500 -39.565300 -73.911800 0\nM  V30 5 O 8.149900 -43.309900 -77.530300 0\nM  V30 6 N 12.092600 -38.206500 -74.914100 0\nM  V30 7 N 10.151000 -38.844000 -77.734300 0\nM  V30 8 N 9.709100 -39.647400 -78.701300 0\nM  V30 9 N 8.662000 -41.847200 -79.186200 0\nM  V30 10 C 7.602600 -44.129200 -79.665200 0\nM  V30 11 C 10.029000 -39.323500 -76.470700 0\nM  V30 12 C 9.187000 -40.841600 -78.320400 0\nM  V30 13 C 8.151000 -43.081400 -78.698500 0\nM  V30 14 H 12.620400 -39.051600 -74.999600 0\nM  V30 15 H 12.320600 -37.593200 -75.670300 0\nM  V30 16 H 8.653100 -41.677800 -80.171700 0\nM  V30 17 H 7.673700 -43.787600 -80.602400 0\nM  V30 18 H 8.131400 -44.973300 -79.577000 0\nM  V30 19 H 6.643600 -44.312500 -79.449200 0\nM  V30 END ATOM\nM  V30 BEGIN BOND\nM  V30 1 1 1 11\nM  V30 2 1 1 12\nM  V30 3 2 2 3\nM  V30 4 2 2 4\nM  V30 5 1 2 6\nM  V30 6 1 2 11\nM  V30 7 2 5 13\nM  V30 8 1 7 8\nM  V30 9 2 7 11\nM  V30 10 2 8 12\nM  V30 11 1 9 12\nM  V30 12 1 9 13\nM  V30 13 1 10 13\nM  V30 14 1 6 14\nM  V30 15 1 6 15\nM  V30 16 1 9 16\nM  V30 17 1 10 17\nM  V30 18 1 10 18\nM  V30 19 1 10 19\nM  V30 END BOND\nM  V30 END CTAB\nM  END\n',
 'mol')</code></pre>
</div>
</div>
<p>Convert all of those mol blocks into RDKit molecules:</p>
<div id="5a7d19e1" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">conf_mols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromMolBlock(confs[x][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> confs]</span></code></pre></div>
</div>
<p>And look at the first couple:</p>
<div id="9dcf04f8" class="cell" data-scrolled="true" data-execution_count="51">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">conf_mols[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_17625759327529206" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_17625759327529206" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_17625759327529206 = null;
var warn = document.getElementById("3dmolwarning_17625759327529206");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_17625759327529206 = $3Dmol.createViewer(document.getElementById("3dmolviewer_17625759327529206"),{backgroundColor:"white"});
viewer_17625759327529206.zoomTo();
    viewer_17625759327529206.removeAllModels();
    viewer_17625759327529206.addModel("AZM_E_303\n     RDKit          3D\n\n 19 19  0  0  0  0  0  0  0  0999 V2000\n    9.3112  -40.8543  -76.6022 S   0  0  0  0  0  0  0  0  0  0  0  0\n   10.4946  -38.5548  -74.9572 S   0  0  0  0  0  0  0  0  0  0  0  0\n    9.7301  -37.2689  -74.8269 O   0  0  0  0  0  0  0  0  0  0  0  0\n   10.1605  -39.5653  -73.9118 O   0  0  0  0  0  0  0  0  0  0  0  0\n    8.1499  -43.3099  -77.5303 O   0  0  0  0  0  0  0  0  0  0  0  0\n   12.0926  -38.2065  -74.9141 N   0  0  0  0  0  0  0  0  0  0  0  0\n   10.1510  -38.8440  -77.7343 N   0  0  0  0  0  0  0  0  0  0  0  0\n    9.7091  -39.6474  -78.7013 N   0  0  0  0  0  0  0  0  0  0  0  0\n    8.6620  -41.8472  -79.1862 N   0  0  0  0  0  0  0  0  0  0  0  0\n    7.6026  -44.1292  -79.6652 C   0  0  0  0  0  0  0  0  0  0  0  0\n   10.0290  -39.3235  -76.4707 C   0  0  0  0  0  0  0  0  0  0  0  0\n    9.1870  -40.8416  -78.3204 C   0  0  0  0  0  0  0  0  0  0  0  0\n    8.1510  -43.0814  -78.6985 C   0  0  0  0  0  0  0  0  0  0  0  0\n   12.6204  -39.0516  -74.9996 H   0  0  0  0  0  0  0  0  0  0  0  0\n   12.3206  -37.5932  -75.6703 H   0  0  0  0  0  0  0  0  0  0  0  0\n    8.6531  -41.6778  -80.1717 H   0  0  0  0  0  0  0  0  0  0  0  0\n    7.6737  -43.7876  -80.6024 H   0  0  0  0  0  0  0  0  0  0  0  0\n    8.1314  -44.9733  -79.5770 H   0  0  0  0  0  0  0  0  0  0  0  0\n    6.6436  -44.3125  -79.4492 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 11  1  0\n  1 12  1  0\n  2  3  2  0\n  2  4  2  0\n  2  6  1  0\n  2 11  1  0\n  5 13  2  0\n  7  8  1  0\n  7 11  2  0\n  8 12  2  0\n  9 12  1  0\n  9 13  1  0\n 10 13  1  0\n  6 14  1  0\n  6 15  1  0\n  9 16  1  0\n 10 17  1  0\n 10 18  1  0\n 10 19  1  0\nM  END\n","sdf");
    viewer_17625759327529206.setStyle({"stick": {}});
    viewer_17625759327529206.setBackgroundColor("0xeeeeee");
    viewer_17625759327529206.zoomTo();
viewer_17625759327529206.render();
});
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="51">

</div>
</div>
<div id="bd90af6d" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">conf_mols[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_17625759407695315" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_17625759407695315" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_17625759407695315 = null;
var warn = document.getElementById("3dmolwarning_17625759407695315");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_17625759407695315 = $3Dmol.createViewer(document.getElementById("3dmolviewer_17625759407695315"),{backgroundColor:"white"});
viewer_17625759407695315.zoomTo();
    viewer_17625759407695315.removeAllModels();
    viewer_17625759407695315.addModel("AZM_A_262\n     RDKit          3D\n\n 19 19  0  0  0  0  0  0  0  0999 V2000\n    1.6042   70.8027   56.8891 S   0  0  0  0  0  0  0  0  0  0  0  0\n    3.2937   72.4472   58.7703 S   0  0  0  0  0  0  0  0  0  0  0  0\n    3.3750   71.0598   59.2463 O   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6993   73.3963   59.6063 O   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.1118   69.2710   56.3052 O   0  0  0  0  0  0  0  0  0  0  0  0\n    4.7494   72.8722   58.3430 N   0  0  0  0  0  0  0  0  0  0  0  0\n    2.3388   73.1756   56.3776 N   0  0  0  0  0  0  0  0  0  0  0  0\n    1.7295   72.7252   55.2524 N   0  0  0  0  0  0  0  0  0  0  0  0\n    0.2324   70.8034   54.6557 N   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.1568   68.8399   54.2799 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.3965   72.2531   57.2632 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2369   71.4841   55.3669 C   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.3062   69.6543   55.1481 C   0  0  0  0  0  0  0  0  0  0  0  0\n    4.7374   73.8154   58.0111 H   0  0  0  0  0  0  0  0  0  0  0  0\n    5.3614   72.8037   59.1309 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.0888   71.1666   53.7811 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -1.2236   69.2703   53.3798 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -0.7590   67.9274   54.1844 H   0  0  0  0  0  0  0  0  0  0  0  0\n   -2.0693   68.7653   54.6822 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 11  1  0\n  1 12  1  0\n  2  3  2  0\n  2  4  2  0\n  2  6  1  0\n  2 11  1  0\n  5 13  2  0\n  7  8  1  0\n  7 11  2  0\n  8 12  2  0\n  9 12  1  0\n  9 13  1  0\n 10 13  1  0\n  6 14  1  0\n  6 15  1  0\n  9 16  1  0\n 10 17  1  0\n 10 18  1  0\n 10 19  1  0\nM  END\n","sdf");
    viewer_17625759407695315.setStyle({"stick": {}});
    viewer_17625759407695315.setBackgroundColor("0xeeeeee");
    viewer_17625759407695315.zoomTo();
viewer_17625759407695315.render();
});
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="52">

</div>
</div>
<p>Let’s get all the pairs of conformers that have a shape Tversky score of between 0.8 and 0.9:</p>
<div id="3004fe51" class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql select ligname1,pdb1,ligname2,pdb2 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.pair_stats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb50-2">  where shape_tversky_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> shape_tversky_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb50-3">d[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> * postgresql://localhost/lobster_112024</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="131">
<pre><code>[('03V_A_2002', '3u3k', 'NPO_A_300', '3u3r'),
 ('NPO_A_300', '3u3r', '03V_A_2002', '3u3k'),
 ('052_A_809', '4zeg', 'O23_A_901', '3wzk'),
 ('HS4_A_0', '3f17', 'KLG_A_0', '3rts'),
 ('NGH_A_306', '5lab', 'HS3_A_0', '3f16')]</code></pre>
</div>
</div>
<div id="08d3f61f" class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1">accum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb53-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ln1,pdb1,ln2,pdb2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb53-3">    d1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb53-4">        select molregno,conf_id <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.all_ligands where <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb53-5">      ligname<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>:ln1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> upper(pdb)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>upper(:pdb1)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb53-6">    d2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb53-7">        select molregno,conf_id <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> lobster_data.all_ligands where <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb53-8">      ligname<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>:ln2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> upper(pdb)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>upper(:pdb2)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb53-9">    accum.append((<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(d1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]),<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(d2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])))</span></code></pre></div>
</div>
<p>Look at a couple of pairs:</p>
<div id="6d744b8b" class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1">confs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lwreg.retrieve(ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>accum[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb54-2">mols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromMolBlock(v[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> confs.values()]</span>
<span id="cb54-3">IPythonConsole.drawMols3D(mols)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_1762590943943505" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_1762590943943505" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_1762590943943505 = null;
var warn = document.getElementById("3dmolwarning_1762590943943505");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_1762590943943505 = $3Dmol.createViewer(document.getElementById("3dmolviewer_1762590943943505"),{backgroundColor:"white"});
viewer_1762590943943505.zoomTo();
    viewer_1762590943943505.addModel("NPO_A_300\n     RDKit          3D\n\n 15 15  0  0  0  0  0  0  0  0999 V2000\n   21.0209   -9.4413   -8.6788 O   0  0  0  0  0  0  0  0  0  0  0  0\n   19.1617  -10.3654   -8.1724 O   0  0  0  0  0  0  0  0  0  0  0  0\n   17.3203   -4.2462   -8.3844 O   0  0  0  0  0  0  0  0  0  0  0  0\n   19.7773   -9.3329   -8.4209 N   0  0  0  0  0  0  0  0  0  0  0  0\n   17.2130   -6.5832   -7.9112 C   0  0  0  0  0  0  0  0  0  0  0  0\n   19.2987   -5.6143   -8.7848 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.8074   -7.8731   -8.0839 C   0  0  0  0  0  0  0  0  0  0  0  0\n   19.9162   -6.8961   -8.8336 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.9756   -5.4596   -8.2752 C   0  0  0  0  0  0  0  0  0  0  0  0\n   19.1712   -8.0164   -8.4316 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.8291   -3.4245   -8.6412 H   0  0  0  0  0  0  0  0  0  0  0  0\n   16.2878   -6.4843   -7.5447 H   0  0  0  0  0  0  0  0  0  0  0  0\n   19.7988   -4.8125   -9.1120 H   0  0  0  0  0  0  0  0  0  0  0  0\n   17.2467   -8.6912   -7.9560 H   0  0  0  0  0  0  0  0  0  0  0  0\n   20.8603   -6.9965   -9.1474 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  4  1  0\n  2  4  2  0\n  3  9  1  0\n  4 10  1  0\n  5  7  2  0\n  5  9  1  0\n  6  8  1  0\n  6  9  2  0\n  7 10  1  0\n  8 10  2  0\n  3 11  1  0\n  5 12  1  0\n  6 13  1  0\n  7 14  1  0\n  8 15  1  0\nM  CHG  2   1  -1   4   1\nM  END\n","sdf");
    viewer_1762590943943505.setStyle({"stick": {}});
    viewer_1762590943943505.addModel("03V_A_2002\n     RDKit          3D\n\n 19 20  0  0  0  0  0  0  0  0999 V2000\n   17.5350   -4.1210   -8.5300 O   0  0  0  0  0  0  0  0  0  0  0  0\n   19.7620  -10.0480   -8.3760 C   0  0  0  0  0  0  0  0  0  0  0  0\n   20.7300   -9.2250   -8.9320 C   0  0  0  0  0  0  0  0  0  0  0  0\n   18.5460   -9.5000   -7.9700 C   0  0  0  0  0  0  0  0  0  0  0  0\n   20.5370   -7.8440   -9.0980 C   0  0  0  0  0  0  0  0  0  0  0  0\n   16.9720   -6.2430   -7.8640 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.1840   -7.6000   -7.6970 C   0  0  0  0  0  0  0  0  0  0  0  0\n   19.1320   -5.8930   -8.8520 C   0  0  0  0  0  0  0  0  0  0  0  0\n   17.9000   -5.4150   -8.4340 C   0  0  0  0  0  0  0  0  0  0  0  0\n   18.3440   -8.1490   -8.1160 C   0  0  0  0  0  0  0  0  0  0  0  0\n   19.3660   -7.2630   -8.7090 C   0  0  0  0  0  0  0  0  0  0  0  0\n   18.1600   -3.4540   -8.9355 H   0  0  0  0  0  0  0  0  0  0  0  0\n   19.9349  -11.0269   -8.2672 H   0  0  0  0  0  0  0  0  0  0  0  0\n   21.5963   -9.6295   -9.2251 H   0  0  0  0  0  0  0  0  0  0  0  0\n   17.8323  -10.0810   -7.5788 H   0  0  0  0  0  0  0  0  0  0  0  0\n   21.2605   -7.2848   -9.5027 H   0  0  0  0  0  0  0  0  0  0  0  0\n   16.1051   -5.8515   -7.5555 H   0  0  0  0  0  0  0  0  0  0  0  0\n   16.4828   -8.1702   -7.2689 H   0  0  0  0  0  0  0  0  0  0  0  0\n   19.8237   -5.2835   -9.2393 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  9  1  0\n  2  3  2  0\n  2  4  1  0\n  3  5  1  0\n  4 10  2  0\n  5 11  2  0\n  6  7  2  0\n  6  9  1  0\n  7 10  1  0\n  8  9  2  0\n  8 11  1  0\n 10 11  1  0\n  1 12  1  0\n  2 13  1  0\n  3 14  1  0\n  4 15  1  0\n  5 16  1  0\n  6 17  1  0\n  7 18  1  0\n  8 19  1  0\nM  END\n","sdf");
    viewer_1762590943943505.setStyle({"stick": {}});
    viewer_1762590943943505.setStyle({"model": 0},{"stick": {"colorscheme": "cyanCarbon"}});
    viewer_1762590943943505.setStyle({"model": 1},{"stick": {"colorscheme": "redCarbon"}});
    viewer_1762590943943505.setBackgroundColor("0xeeeeee");
    viewer_1762590943943505.zoomTo();
viewer_1762590943943505.render();
});
</script>
</div>
</div>
<div id="dd8cbae9" class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1">confs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lwreg.retrieve(ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>accum[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb55-2">mols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromMolBlock(v[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> confs.values()]</span>
<span id="cb55-3">IPythonConsole.drawMols3D(mols)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="3dmolviewer_17625909441996996" style="position: relative; width: 400px; height: 400px;">
        <p id="3dmolwarning_17625909441996996" style="background-color:#ffcccc;color:black">3Dmol.js failed to load for some reason.  Please check your browser console for error messages.<br></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    //this is to ignore the existence of requirejs amd
    var savedexports, savedmodule;
    if (typeof exports !== 'undefined') savedexports = exports;
    else exports = {}
    if (typeof module !== 'undefined') savedmodule = module;
    else module = {}

    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
        exports = savedexports;
        module = savedmodule;
        resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.0/3Dmol-min.js');
}

var viewer_17625909441996996 = null;
var warn = document.getElementById("3dmolwarning_17625909441996996");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
viewer_17625909441996996 = $3Dmol.createViewer(document.getElementById("3dmolviewer_17625909441996996"),{backgroundColor:"white"});
viewer_17625909441996996.zoomTo();
    viewer_17625909441996996.addModel("O23_A_901\n     RDKit          3D\n\n 47 51  0  0  0  0  0  0  0  0999 V2000\n   34.4176   35.0742   60.9436 S   0  0  0  0  0  0  0  0  0  0  0  0\n   40.0834   33.9291   72.5931 O   0  0  0  0  0  0  0  0  0  0  0  0\n   34.0852   36.4313   65.5407 N   0  0  0  0  0  0  0  0  0  0  0  0\n   33.4391   34.7497   64.0005 N   0  0  0  0  0  0  0  0  0  0  0  0\n   34.9217   32.7720   65.7440 N   0  0  0  0  0  0  0  0  0  0  0  0\n   38.5749   32.6195   73.5874 N   0  0  0  0  0  0  0  0  0  0  0  0\n   35.4384   34.4712   67.0663 N   0  0  0  0  0  0  0  0  0  0  0  0\n   35.3949   36.2455   60.1127 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.7420   36.7530   66.6826 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.7964   35.6924   63.1068 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.6691   32.2609   66.7518 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.4170   35.7755   67.4430 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.1946   37.4750   60.7514 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.3100   37.4823   61.8375 C   0  0  0  0  0  0  0  0  0  0  0  0\n   39.0840   31.2609   75.5992 C   0  0  0  0  0  0  0  0  0  0  0  0\n   40.2784   31.2576   74.6463 C   0  0  0  0  0  0  0  0  0  0  0  0\n   37.4502   32.2377   70.8839 C   0  0  0  0  0  0  0  0  0  0  0  0\n   38.3107   34.4396   70.3971 C   0  0  0  0  0  0  0  0  0  0  0  0\n   36.7258   32.2624   69.6846 C   0  0  0  0  0  0  0  0  0  0  0  0\n   37.5904   34.4523   69.1964 C   0  0  0  0  0  0  0  0  0  0  0  0\n   39.0261   33.3078   72.5314 C   0  0  0  0  0  0  0  0  0  0  0  0\n   33.7778   36.2210   62.0839 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.0802   35.1430   65.1216 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.7930   34.1082   65.9362 C   0  0  0  0  0  0  0  0  0  0  0  0\n   39.4129   32.5029   74.7733 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.9869   33.3386   67.5629 C   0  0  0  0  0  0  0  0  0  0  0  0\n   38.2421   33.3297   71.2433 C   0  0  0  0  0  0  0  0  0  0  0  0\n   36.7804   33.3721   68.8395 C   0  0  0  0  0  0  0  0  0  0  0  0\n   33.4065   33.7751   63.7793 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.6722   32.1899   73.5623 H   0  0  0  0  0  0  0  0  0  0  0  0\n   35.9885   36.0739   59.3264 H   0  0  0  0  0  0  0  0  0  0  0  0\n   34.7478   37.7039   66.9923 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.4366   36.4572   63.6412 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.0446   35.2339   62.6330 H   0  0  0  0  0  0  0  0  0  0  0  0\n   35.9357   31.3061   66.8828 H   0  0  0  0  0  0  0  0  0  0  0  0\n   35.8913   36.0497   68.2796 H   0  0  0  0  0  0  0  0  0  0  0  0\n   35.6597   38.3064   60.4474 H   0  0  0  0  0  0  0  0  0  0  0  0\n   34.0876   38.2975   62.3723 H   0  0  0  0  0  0  0  0  0  0  0  0\n   39.2326   31.2635   76.5881 H   0  0  0  0  0  0  0  0  0  0  0  0\n   38.2716   30.7183   75.3856 H   0  0  0  0  0  0  0  0  0  0  0  0\n   40.2483   30.7114   73.8092 H   0  0  0  0  0  0  0  0  0  0  0  0\n   41.2092   31.2566   75.0117 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.3998   31.4380   71.4822 H   0  0  0  0  0  0  0  0  0  0  0  0\n   38.8749   35.2257   70.6494 H   0  0  0  0  0  0  0  0  0  0  0  0\n   36.1630   31.4756   69.4311 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.6567   35.2432   68.5881 H   0  0  0  0  0  0  0  0  0  0  0  0\n   39.7726   33.3229   75.2184 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1  8  1  0\n  1 22  1  0\n  2 21  2  0\n  3  9  1  0\n  3 23  2  0\n  4 10  1  0\n  4 23  1  0\n  5 11  1  0\n  5 24  2  0\n  6 21  1  0\n  6 25  1  0\n  7 12  1  0\n  7 24  1  0\n  7 26  1  0\n  8 13  2  0\n  9 12  2  0\n 10 22  1  0\n 11 26  2  0\n 13 14  1  0\n 14 22  2  0\n 15 16  1  0\n 15 25  1  0\n 16 25  1  0\n 17 19  2  0\n 17 27  1  0\n 18 20  1  0\n 18 27  2  0\n 19 28  1  0\n 20 28  2  0\n 21 27  1  0\n 23 24  1  0\n 26 28  1  0\n  4 29  1  0\n  6 30  1  0\n  8 31  1  0\n  9 32  1  0\n 10 33  1  0\n 10 34  1  0\n 11 35  1  0\n 12 36  1  0\n 13 37  1  0\n 14 38  1  0\n 15 39  1  0\n 15 40  1  0\n 16 41  1  0\n 16 42  1  0\n 17 43  1  0\n 18 44  1  0\n 19 45  1  0\n 20 46  1  0\n 25 47  1  0\nM  END\n","sdf");
    viewer_17625909441996996.setStyle({"stick": {}});
    viewer_17625909441996996.addModel("052_A_809\n     RDKit          3D\n\n 70 75  0  0  0  0  0  0  0  0999 V2000\n   40.1840   33.4120   72.3030 O   0  0  0  0  0  0  0  0  0  0  0  0\n   32.8570   37.7140   58.4980 O   0  0  0  0  0  0  0  0  0  0  0  0\n   34.8520   37.7650   66.6390 O   0  0  0  0  0  0  0  0  0  0  0  0\n   34.6790   32.5550   65.6200 N   0  0  0  0  0  0  0  0  0  0  0  0\n   33.2290   34.3320   63.8290 N   0  0  0  0  0  0  0  0  0  0  0  0\n   35.4510   35.5900   67.1950 N   0  0  0  0  0  0  0  0  0  0  0  0\n   38.4820   32.4860   73.5300 N   0  0  0  0  0  0  0  0  0  0  0  0\n   34.6320   33.8980   65.7760 N   0  0  0  0  0  0  0  0  0  0  0  0\n   33.3330   36.4720   60.7720 N   0  0  0  0  0  0  0  0  0  0  0  0\n   38.6720   35.6260   70.8310 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.1170   38.0630   58.9880 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.5810   36.3280   58.3750 C   0  0  0  0  0  0  0  0  0  0  0  0\n   33.4770   34.7370   62.4590 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.3960   32.0420   66.6880 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.4600   37.2180   60.2260 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.6950   35.6310   59.7390 C   0  0  0  0  0  0  0  0  0  0  0  0\n   33.2040   36.1970   62.2350 C   0  0  0  0  0  0  0  0  0  0  0  0\n   36.5590   38.9290   70.2690 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.2080   38.6410   70.2070 C   0  0  0  0  0  0  0  0  0  0  0  0\n   37.3470   38.7880   69.1180 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.6460   38.2270   68.9970 C   0  0  0  0  0  0  0  0  0  0  0  0\n   36.7890   38.3780   67.9190 C   0  0  0  0  0  0  0  0  0  0  0  0\n   39.9940   31.0170   74.7160 C   0  0  0  0  0  0  0  0  0  0  0  0\n   38.8100   31.2260   75.5940 C   0  0  0  0  0  0  0  0  0  0  0  0\n   36.8180   31.9250   69.4390 C   0  0  0  0  0  0  0  0  0  0  0  0\n   37.5880   31.9260   70.6180 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.0810   36.1100   65.2730 C   0  0  0  0  0  0  0  0  0  0  0  0\n   37.3120   34.2390   69.2080 C   0  0  0  0  0  0  0  0  0  0  0  0\n   39.0210   33.0420   72.3450 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.8110   36.4590   66.3770 C   0  0  0  0  0  0  0  0  0  0  0  0\n   34.0050   34.7950   64.9490 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.4290   38.1090   67.8650 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.3490   34.2610   66.8460 C   0  0  0  0  0  0  0  0  0  0  0  0\n   39.2870   32.3600   74.6980 C   0  0  0  0  0  0  0  0  0  0  0  0\n   38.0660   34.2950   70.3760 C   0  0  0  0  0  0  0  0  0  0  0  0\n   36.7020   33.0700   68.7100 C   0  0  0  0  0  0  0  0  0  0  0  0\n   38.1930   33.1070   71.0920 C   0  0  0  0  0  0  0  0  0  0  0  0\n   35.8600   33.1160   67.4310 C   0  0  0  0  0  0  0  0  0  0  0  0\n   32.4776   33.6961   64.0052 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.5302   32.1798   73.5471 H   0  0  0  0  0  0  0  0  0  0  0  0\n   39.1787   35.4880   71.6820 H   0  0  0  0  0  0  0  0  0  0  0  0\n   39.2925   35.9683   70.1254 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.9405   36.2908   70.9827 H   0  0  0  0  0  0  0  0  0  0  0  0\n   34.1170   39.0310   59.2388 H   0  0  0  0  0  0  0  0  0  0  0  0\n   34.8031   37.9025   58.2784 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.2359   35.9175   57.7404 H   0  0  0  0  0  0  0  0  0  0  0  0\n   31.6535   36.2077   58.0210 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.8858   34.2033   61.8543 H   0  0  0  0  0  0  0  0  0  0  0  0\n   34.4344   34.5517   62.2377 H   0  0  0  0  0  0  0  0  0  0  0  0\n   35.5506   31.0742   66.8866 H   0  0  0  0  0  0  0  0  0  0  0  0\n   35.1743   36.5658   59.9723 H   0  0  0  0  0  0  0  0  0  0  0  0\n   34.8050   37.8301   60.9376 H   0  0  0  0  0  0  0  0  0  0  0  0\n   31.7759   35.3888   60.0497 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.2387   34.7993   59.6262 H   0  0  0  0  0  0  0  0  0  0  0  0\n   32.2788   36.4202   62.5419 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.8658   36.7479   62.7435 H   0  0  0  0  0  0  0  0  0  0  0  0\n   36.9705   39.2352   71.1274 H   0  0  0  0  0  0  0  0  0  0  0  0\n   34.6369   38.7285   71.0232 H   0  0  0  0  0  0  0  0  0  0  0  0\n   38.3261   38.9864   69.1637 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.6700   38.0145   68.9499 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.3584   38.2772   67.1032 H   0  0  0  0  0  0  0  0  0  0  0  0\n   39.9265   30.4081   73.9256 H   0  0  0  0  0  0  0  0  0  0  0  0\n   40.9057   30.9396   75.1195 H   0  0  0  0  0  0  0  0  0  0  0  0\n   38.9290   31.2896   76.5849 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.9498   30.7581   75.3909 H   0  0  0  0  0  0  0  0  0  0  0  0\n   36.3591   31.0888   69.1387 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.7075   31.0739   71.1276 H   0  0  0  0  0  0  0  0  0  0  0  0\n   33.6175   36.8038   64.7217 H   0  0  0  0  0  0  0  0  0  0  0  0\n   37.1951   35.0846   68.6871 H   0  0  0  0  0  0  0  0  0  0  0  0\n   39.7261   33.1654   75.0961 H   0  0  0  0  0  0  0  0  0  0  0  0\n  1 29  2  0\n  2 11  1  0\n  2 12  1  0\n  3 30  1  0\n  3 32  1  0\n  4  8  1  0\n  4 14  2  0\n  5 13  1  0\n  5 31  1  0\n  6 30  2  0\n  6 33  1  0\n  7 29  1  0\n  7 34  1  0\n  8 31  1  0\n  8 33  1  0\n  9 15  1  0\n  9 16  1  0\n  9 17  1  0\n 10 35  1  0\n 11 15  1  0\n 12 16  1  0\n 13 17  1  0\n 14 38  1  0\n 18 19  2  0\n 18 20  1  0\n 19 21  1  0\n 20 22  2  0\n 21 32  2  0\n 22 32  1  0\n 23 24  1  0\n 23 34  1  0\n 24 34  1  0\n 25 26  2  0\n 25 36  1  0\n 26 37  1  0\n 27 30  1  0\n 27 31  2  0\n 28 35  1  0\n 28 36  2  0\n 29 37  1  0\n 33 38  2  0\n 35 37  2  0\n 36 38  1  0\n  5 39  1  0\n  7 40  1  0\n 10 41  1  0\n 10 42  1  0\n 10 43  1  0\n 11 44  1  0\n 11 45  1  0\n 12 46  1  0\n 12 47  1  0\n 13 48  1  0\n 13 49  1  0\n 14 50  1  0\n 15 51  1  0\n 15 52  1  0\n 16 53  1  0\n 16 54  1  0\n 17 55  1  0\n 17 56  1  0\n 18 57  1  0\n 19 58  1  0\n 20 59  1  0\n 21 60  1  0\n 22 61  1  0\n 23 62  1  0\n 23 63  1  0\n 24 64  1  0\n 24 65  1  0\n 25 66  1  0\n 26 67  1  0\n 27 68  1  0\n 28 69  1  0\n 34 70  1  0\nM  END\n","sdf");
    viewer_17625909441996996.setStyle({"stick": {}});
    viewer_17625909441996996.setStyle({"model": 0},{"stick": {"colorscheme": "cyanCarbon"}});
    viewer_17625909441996996.setStyle({"model": 1},{"stick": {"colorscheme": "redCarbon"}});
    viewer_17625909441996996.setBackgroundColor("0xeeeeee");
    viewer_17625909441996996.zoomTo();
viewer_17625909441996996.render();
});
</script>
</div>
</div>
</section>
<section id="look-at-duplicate-mismatches" class="level1">
<h1>Look at duplicate mismatches</h1>
<p>According to lwreg we have 3218 unique structures, while the canonical SMILES provided with the Lobster data set (generated using the Hamburg group’s Naomi package) says we have 3212. Let’s look at the mismatches</p>
<div id="6bbc59d4" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb56-2">  select count(distinct molregno) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> hashes join lobster_data.all_ligands using (molregno)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="138">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3218</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="422f46a1" class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb57-2">  select naomi_smiles,count(distinct molregno) cnt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb57-3">     <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> hashes join lobster_data.all_ligands using (molregno)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb57-4">    group by (naomi_smiles) order by cnt desc limit <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="140">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">naomi_smiles</th>
<th data-quarto-table-cell-role="th">cnt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>S=P(OP(=O)(OP(=O)(OC[C@H]1O[C@@H](N2c3ncnc(N)c3N=C2)[C@H](O)[C@@H]1O)O)O)(O)O</td>
<td>3</td>
</tr>
<tr class="even">
<td>P(=O)(OP(=O)(O)O)(OC[C@H]1O[C@@H](N2c3ncnc(N)c3N=C2)[C@H](O)[C@@H]1O)O</td>
<td>2</td>
</tr>
<tr class="odd">
<td>P1(=O)(O[C@@H]2[C@H](O[C@@H](N3C=4N=C(NC(=O)C4N=C3)N)[C@@H]2O)CO1)O</td>
<td>2</td>
</tr>
<tr class="even">
<td>P(=O)(OP(=O)(O)O)(OCC(=O)N1[C@H](C(=O)O)CCC1)O</td>
<td>2</td>
</tr>
<tr class="odd">
<td>P(=O)(O)([C@@H](N)C)C[C@H](C(=O)N[C@H](C(=O)O)C)Cc1ccc(c2ccccc2)cc1</td>
<td>2</td>
</tr>
<tr class="even">
<td>P1(=O)(O[C@@H]2[C@H](O[C@@H](N3C=4NC(=NC(=O)C4N=C3)N)[C@@H]2O)CO1)O</td>
<td>2</td>
</tr>
<tr class="odd">
<td>Brc1c2OC(=O)C(Br)=C(c2ccc1O)C</td>
<td>1</td>
</tr>
<tr class="even">
<td>BrC=1C2=NC(=O)C(C=3Nc4c(cc(cc4)C(=O)O)C3NO)=C2C=CC1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>Brc1c2c(OC(=O)C=C2CP(=O)(O)O)cc(c1)C</td>
<td>1</td>
</tr>
<tr class="even">
<td>Brc1c(Br)c(Br)c2N(C(=Nc2c1Br)N(C)C)CC(=O)O</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="4f165de0" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>sql postgresql:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>localhost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lobster_112024 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb58-2">  select molregno,canonical_smiles,naomi_smiles <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb58-3">      (select naomi_smiles,count(distinct molregno) cnt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb58-4">         <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> hashes join lobster_data.all_ligands using (molregno)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb58-5">         group by (naomi_smiles)) downsel join lobster_data.all_ligands using (naomi_smiles) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb58-6">          join hashes using (molregno)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb58-7">    where cnt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> order by naomi_smiles asc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb58-8">d</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="145">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">molregno</th>
<th data-quarto-table-cell-role="th">canonical_smiles</th>
<th data-quarto-table-cell-role="th">naomi_smiles</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>927</td>
<td>Nc1nc2c(ncn2[C@@H]2O[C@@H]3CO[P@@](=O)(O)O[C@H]3[C@H]2O)c(=O)[nH]1</td>
<td>P1(=O)(O[C@@H]2[C@H](O[C@@H](N3C=4N=C(NC(=O)C4N=C3)N)[C@@H]2O)CO1)O</td>
</tr>
<tr class="even">
<td>1363</td>
<td>Nc1nc2c(ncn2[C@@H]2O[C@@H]3CO[P@](=O)(O)O[C@H]3[C@H]2O)c(=O)[nH]1</td>
<td>P1(=O)(O[C@@H]2[C@H](O[C@@H](N3C=4N=C(NC(=O)C4N=C3)N)[C@@H]2O)CO1)O</td>
</tr>
<tr class="odd">
<td>1363</td>
<td>Nc1nc2c(ncn2[C@@H]2O[C@@H]3CO[P@](=O)(O)O[C@H]3[C@H]2O)c(=O)[nH]1</td>
<td>P1(=O)(O[C@@H]2[C@H](O[C@@H](N3C=4N=C(NC(=O)C4N=C3)N)[C@@H]2O)CO1)O</td>
</tr>
<tr class="even">
<td>927</td>
<td>Nc1nc2c(ncn2[C@@H]2O[C@@H]3CO[P@@](=O)(O)O[C@H]3[C@H]2O)c(=O)[nH]1</td>
<td>P1(=O)(O[C@@H]2[C@H](O[C@@H](N3C=4N=C(NC(=O)C4N=C3)N)[C@@H]2O)CO1)O</td>
</tr>
<tr class="odd">
<td>2226</td>
<td>Nc1nc(=O)c2ncn([C@@H]3O[C@@H]4CO[P@](=O)(O)O[C@H]4[C@H]3O)c2[nH]1</td>
<td>P1(=O)(O[C@@H]2[C@H](O[C@@H](N3C=4NC(=NC(=O)C4N=C3)N)[C@@H]2O)CO1)O</td>
</tr>
<tr class="even">
<td>91</td>
<td>Nc1nc(=O)c2ncn([C@@H]3O[C@@H]4CO[P@@](=O)(O)O[C@H]4[C@H]3O)c2[nH]1</td>
<td>P1(=O)(O[C@@H]2[C@H](O[C@@H](N3C=4NC(=NC(=O)C4N=C3)N)[C@@H]2O)CO1)O</td>
</tr>
<tr class="odd">
<td>2558</td>
<td>C[C@H](NC(=O)[C@H](Cc1ccc(-c2ccccc2)cc1)C[P@](=O)(O)[C@H](C)N)C(=O)O</td>
<td>P(=O)(O)([C@@H](N)C)C[C@H](C(=O)N[C@H](C(=O)O)C)Cc1ccc(c2ccccc2)cc1</td>
</tr>
<tr class="even">
<td>82</td>
<td>C[C@H](NC(=O)[C@H](Cc1ccc(-c2ccccc2)cc1)C[P@@](=O)(O)[C@H](C)N)C(=O)O</td>
<td>P(=O)(O)([C@@H](N)C)C[C@H](C(=O)N[C@H](C(=O)O)C)Cc1ccc(c2ccccc2)cc1</td>
</tr>
<tr class="odd">
<td>627</td>
<td>Nc1ncnc2c1ncn2[C@@H]1O[C@H](CO[P@](=O)(O)OP(=O)(O)O)[C@@H](O)[C@H]1O</td>
<td>P(=O)(OP(=O)(O)O)(OC[C@H]1O[C@@H](N2c3ncnc(N)c3N=C2)[C@H](O)[C@@H]1O)O</td>
</tr>
<tr class="even">
<td>1957</td>
<td>Nc1ncnc2c1ncn2[C@@H]1O[C@H](CO[P@@](=O)(O)OP(=O)(O)O)[C@@H](O)[C@H]1O</td>
<td>P(=O)(OP(=O)(O)O)(OC[C@H]1O[C@@H](N2c3ncnc(N)c3N=C2)[C@H](O)[C@@H]1O)O</td>
</tr>
<tr class="odd">
<td>2256</td>
<td>O=C(O)[C@@H]1CCCN1C(=O)CO[P@@](=O)(O)OP(=O)(O)O</td>
<td>P(=O)(OP(=O)(O)O)(OCC(=O)N1[C@H](C(=O)O)CCC1)O</td>
</tr>
<tr class="even">
<td>892</td>
<td>O=C(O)[C@@H]1CCCN1C(=O)CO[P@](=O)(O)OP(=O)(O)O</td>
<td>P(=O)(OP(=O)(O)O)(OCC(=O)N1[C@H](C(=O)O)CCC1)O</td>
</tr>
<tr class="odd">
<td>2877</td>
<td>Nc1ncnc2c1ncn2[C@@H]1O[C@H](CO[P@@](=O)(O)O[P@](=O)(O)OP(O)(O)=S)[C@@H](O)[C@H]1O</td>
<td>S=P(OP(=O)(OP(=O)(OC[C@H]1O[C@@H](N2c3ncnc(N)c3N=C2)[C@H](O)[C@@H]1O)O)O)(O)O</td>
</tr>
<tr class="even">
<td>1559</td>
<td>Nc1ncnc2c1ncn2[C@@H]1O[C@H](CO[P@@](=O)(O)O[P@@](=O)(O)OP(O)(O)=S)[C@@H](O)[C@H]1O</td>
<td>S=P(OP(=O)(OP(=O)(OC[C@H]1O[C@@H](N2c3ncnc(N)c3N=C2)[C@H](O)[C@@H]1O)O)O)(O)O</td>
</tr>
<tr class="odd">
<td>1559</td>
<td>Nc1ncnc2c1ncn2[C@@H]1O[C@H](CO[P@@](=O)(O)O[P@@](=O)(O)OP(O)(O)=S)[C@@H](O)[C@H]1O</td>
<td>S=P(OP(=O)(OP(=O)(OC[C@H]1O[C@@H](N2c3ncnc(N)c3N=C2)[C@H](O)[C@@H]1O)O)O)(O)O</td>
</tr>
<tr class="even">
<td>2139</td>
<td>Nc1ncnc2c1ncn2[C@@H]1O[C@H](CO[P@](=O)(O)O[P@](=O)(O)OP(O)(O)=S)[C@@H](O)[C@H]1O</td>
<td>S=P(OP(=O)(OP(=O)(OC[C@H]1O[C@@H](N2c3ncnc(N)c3N=C2)[C@H](O)[C@@H]1O)O)O)(O)O</td>
</tr>
<tr class="odd">
<td>2877</td>
<td>Nc1ncnc2c1ncn2[C@@H]1O[C@H](CO[P@@](=O)(O)O[P@](=O)(O)OP(O)(O)=S)[C@@H](O)[C@H]1O</td>
<td>S=P(OP(=O)(OP(=O)(OC[C@H]1O[C@@H](N2c3ncnc(N)c3N=C2)[C@H](O)[C@@H]1O)O)O)(O)O</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>These are all because the RDKit recognizes chiral phosphates and the Naomi SMILES seem not to.</p>
<p>Here are the first few molecules demonstrating this:</p>
<div id="3da091e3" class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1">ms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb59-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> d:</span>
<span id="cb59-3">    rm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(row[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb59-4">    nm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(row[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb59-5">    ms.extend((rm,nm))</span>
<span id="cb59-6">Draw.MolsToGridImage(ms[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>],molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,subImgSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="148">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-11-08-working-with-lobster-1_files/figure-html/cell-40-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>I’m going to wrap this up here. I’ll come back to the LOBSTER data set and this database again in future posts.</p>


</section>

 ]]></description>
  <category>datasets</category>
  <category>3d</category>
  <category>lwreg</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-11-08-working-with-lobster-1.html</guid>
  <pubDate>Fri, 07 Nov 2025 23:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/working-with-lobster-1.png" medium="image" type="image/png" height="110" width="144"/>
</item>
<item>
  <title>How long does it take to do common tasks in the RDKit?</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-10-31-how-long-does-it-take.html</link>
  <description><![CDATA[ 




<p>Years ago (back in the sourceforge days), I used to maintain a page with info about how long it took to do common operations in the RDKit. This was useful for both reference purposes and to track the evolution of RDKit performance over time. At some point I stopped doing this, but a <a href="https://github.com/rdkit/rdkit/pull/8865">recently merged PR</a> got me thinking about this again (<span class="citation" data-cites="Andrew">@Andrew</span>: thanks for that contribution!).</p>
<p>I’m going to use this notebook to explain and run some new benchmarks (these are different from the PR mentioned above, which is meant to run as part of the RDKit build process). The results, including historical results, are <a href="https://github.com/rdkit/rdkit/wiki/How-Long-Things-Take">tabulated in the wiki</a> I will update this post as I add more benchmarks.</p>
<p>Let me know if you have ideas for interesting and useful benchmarks I should add!</p>
<div id="e7a50bf7-c33d-418c-90e2-176747025afd" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext sql</span></code></pre></div>
</div>
<section id="get-the-smiles-we-will-be-working-with" class="level1">
<h1>Get the SMILES we will be working with:</h1>
<p>Get 10000 random compounds from ChEMBL that have a pchembl_value &gt;= 9 and don’t have multiple components.</p>
<p>This stuff doesn’t need to be run every time, so I’m not saving the cells as code.</p>
<pre><code>d = %sql postgresql://localhost/chembl_36 \
  select distinct(canonical_smiles) canonical_smiles,chembl_id from compound_structures tablesample bernoulli(20) repeatable (123892) \
    join chembl_id_lookup on (molregno=entity_id and entity_type='COMPOUND') \
    join activities using (molregno) \
    where activities.pchembl_value&gt;=9 and \
    position('.' in canonical_smiles)=0 \
    limit 10000;</code></pre>
<p>The <code>distinct(canonical_smiles)</code> query I did orders the results, so it looks like all of the compounds have isotopes specified. This is not actually the case:</p>
<p>Make sure all of those convert cleanly into molecules:</p>
<pre><code>sum(1 for x,y in d if Chem.MolFromSmiles(x) is not None)</code></pre>
<pre><code>with open('../data/chembl36_very_active.txt','w+') as outf:
    outf.write('chembl_id canonical_smiles\n')
    for smi,cid in d:
        outf.write(f'{cid} {smi}\n')</code></pre>
</section>
<section id="run-the-benchmarks" class="level1">
<h1>Run the benchmarks</h1>
<div id="54d12953-db70-4ad7-8636-3fc85302ba46" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb5-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.09.1</code></pre>
</div>
</div>
<div id="0a210106-9868-42de-9654-b4dcc8d8b72f" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'../data/chembl36_very_active.txt'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> inf:</span>
<span id="cb7-2">    ls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x.strip().split() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> inf]</span>
<span id="cb7-3">    ls.pop(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-4">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(smi,cid) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> cid,smi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ls]</span>
<span id="cb7-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(data)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>10000</code></pre>
</div>
</div>
<section id="construct-molecule-from-smiles" class="level2">
<h2 class="anchored" data-anchor-id="construct-molecule-from-smiles">Construct molecule from SMILES</h2>
<div id="ee572a1f-1a9d-432b-9018-78088adbea60" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit ms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromSmiles(smi) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smi,cid <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> data]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.2 s ± 11.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="5877125f-d8d0-479d-b9b3-a90b59b5b916" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">ms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromSmiles(smi) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smi,cid <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> data]</span></code></pre></div>
</div>
</section>
<section id="generate-canonical-smiles" class="level2">
<h2 class="anchored" data-anchor-id="generate-canonical-smiles">Generate canonical SMILES</h2>
<div id="62f06ed5-8cb8-4b28-9460-4560e2382716" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [Chem.MolToSmiles(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>658 ms ± 2.92 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="6d2249c2-1885-4c59-a9ab-43e69049b376" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdDepictor</span></code></pre></div>
</div>
</section>
<section id="generating-2d-coordinates" class="level2">
<h2 class="anchored" data-anchor-id="generating-2d-coordinates">Generating 2D coordinates</h2>
<div id="db7ade8d-87be-46b0-8af7-8b545028e796" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb15-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [rdDepictor.Compute2DCoords(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>47.4 s ± 482 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="8afc354c-9179-4c5b-a768-3b051cb718c2" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb17-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [rdDepictor.Compute2DCoords(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1min 55s ± 334 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="2b762085-5531-486e-96ce-c1a724b8c6f6" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">ms2d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.Mol(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms]</span>
<span id="cb19-2">_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rdDepictor.Compute2DCoords(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms2d]</span></code></pre></div>
</div>
</section>
<section id="writing-mol-blocks" class="level2">
<h2 class="anchored" data-anchor-id="writing-mol-blocks">Writing mol blocks</h2>
<div id="99e7d198-7447-4dea-a98f-58ca666938f2" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [Chem.MolToMolBlock(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms2d]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>877 ms ± 9.83 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="a74584f8-01d8-4a47-845e-87d84d947de7" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [Chem.MolToV3KMolBlock(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms2d]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.08 s ± 11.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="455618ca-4665-4834-87ac-5c0a7b532fdc" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">mbs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolToMolBlock(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms2d]</span>
<span id="cb24-2">mbs3k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolToV3KMolBlock(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms2d]</span></code></pre></div>
</div>
</section>
<section id="parsing-mol-blocks" class="level2">
<h2 class="anchored" data-anchor-id="parsing-mol-blocks">Parsing mol blocks</h2>
<div id="2293ae67-5313-4186-bc2d-a5b03caddf8e" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [Chem.MolFromMolBlock(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mbs]</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[08:31:09] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:11] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:12] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:14] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:16] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:17] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:19] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:21] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1.71 s ± 17.8 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="b64ac742-343d-49ed-a3f9-6a92102140c4" class="cell" data-scrolled="true" data-execution_count="74">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [Chem.MolFromMolBlock(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mbs3k]</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[08:31:23] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:24] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:26] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:28] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:30] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:32] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:34] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored
[08:31:36] Warning: ambiguous stereochemistry - zero final chiral volume - at atom 54 ignored</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1.87 s ± 16.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
</section>
<section id="addingremoving-hs" class="level2">
<h2 class="anchored" data-anchor-id="addingremoving-hs">Adding/removing Hs</h2>
<div id="d1a1dc6d-a785-4ca5-aa04-c2493d0b6835" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [Chem.AddHs(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>456 ms ± 2.34 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="ef813de2-345e-4438-8561-f17587e6435a" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">mhs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.AddHs(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms]</span></code></pre></div>
</div>
<div id="91e41d4d-beb0-49d5-a1f7-77e173b4bb74" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [Chem.RemoveHs(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mhs]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.52 s ± 5.47 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
</section>
<section id="conformer-generation" class="level2">
<h2 class="anchored" data-anchor-id="conformer-generation">Conformer generation</h2>
<div id="65138c71-ac33-4714-968c-ecd17360f6a1" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdDistGeom</span></code></pre></div>
</div>
<div id="a8de82b9-eab3-426c-96fb-0d19e965bd5a" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdDistGeom.EmbedParameters()</span>
<span id="cb37-2">ps.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span></span>
<span id="cb37-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [rdDistGeom.EmbedMolecule(m,ps) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mhs[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>]]</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[08:14:36] UFFTYPER: Unrecognized charge state for atom: 38
[08:15:19] UFFTYPER: Unrecognized charge state for atom: 38
[08:16:03] UFFTYPER: Unrecognized charge state for atom: 38
[08:16:48] UFFTYPER: Unrecognized charge state for atom: 38
[08:17:32] UFFTYPER: Unrecognized charge state for atom: 38
[08:18:16] UFFTYPER: Unrecognized charge state for atom: 38
[08:19:00] UFFTYPER: Unrecognized charge state for atom: 38
[08:19:45] UFFTYPER: Unrecognized charge state for atom: 38</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>44.1 s ± 170 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="87b892da-758a-4280-8878-84a05f65846b" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdDistGeom.ETKDGv3()</span>
<span id="cb40-2">ps.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xf00d</span></span>
<span id="cb40-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [rdDistGeom.EmbedMolecule(m,ps) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mhs[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>]]</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[08:36:46] UFFTYPER: Unrecognized charge state for atom: 38
[08:37:52] UFFTYPER: Unrecognized charge state for atom: 38
[08:38:58] UFFTYPER: Unrecognized charge state for atom: 38
[08:40:03] UFFTYPER: Unrecognized charge state for atom: 38
[08:41:09] UFFTYPER: Unrecognized charge state for atom: 38
[08:42:14] UFFTYPER: Unrecognized charge state for atom: 38
[08:43:20] UFFTYPER: Unrecognized charge state for atom: 38
[08:44:25] UFFTYPER: Unrecognized charge state for atom: 38</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1min 5s ± 245 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
</section>
<section id="generate-fingerprints" class="level2">
<h2 class="anchored" data-anchor-id="generate-fingerprints">Generate fingerprints</h2>
<div id="1924d4aa-3a57-42a1-b8bf-fca2e13cac48" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdFingerprintGenerator</span></code></pre></div>
</div>
<div id="e1999206-08cb-44b9-958a-02d4f897cd97" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">fpg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdFingerprintGenerator.GetMorganGenerator(radius<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb44-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit fpg.GetFingerprints(ms)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>497 ms ± 3.53 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="68245d3d-a8d5-4447-bd35-2030be0d0a11" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1">fpg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdFingerprintGenerator.GetMorganGenerator(radius<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb46-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit fpg.GetFingerprints(ms)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>379 ms ± 4.65 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="d572cb28-a781-4a87-babf-7605f47a9b66" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">fpg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdFingerprintGenerator.GetRDKitFPGenerator()</span>
<span id="cb48-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit fpg.GetFingerprints(ms)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>13.1 s ± 71.8 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="ebb317df-5c4b-41bb-90a0-ef595f4e7a5a" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">fpg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdFingerprintGenerator.GetRDKitFPGenerator(maxPath<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb50-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit fpg.GetFingerprints(ms)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4.48 s ± 27.7 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="3ca77027-550e-4253-85c5-1bd925ad4c8b" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1">fpg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdFingerprintGenerator.GetAtomPairGenerator()</span>
<span id="cb52-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit fpg.GetFingerprints(ms)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.65 s ± 8.14 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="c362713c-1747-4819-90e9-48b75465549e" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1">fpg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdFingerprintGenerator.GetTopologicalTorsionGenerator()</span>
<span id="cb54-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit fpg.GetFingerprints(ms)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.36 s ± 4.22 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div id="10e61299-230a-4f1b-87dc-0db07cea1d19" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit [Chem.PatternFingerprint(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2.49 s ± 39.5 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>optimization</category>
  <category>reference</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-10-31-how-long-does-it-take.html</guid>
  <pubDate>Thu, 30 Oct 2025 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Displaying atom maps and highlighting with reactions</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions.html</link>
  <description><![CDATA[ 




<p>This one was inspired by an example I did this week for the class I’m teaching: I wanted to apply an RDKit reaction to a set of reactants and then draw the reactants and the products of the reaction as a normal reaction with the mapped atoms indicated. Doing that made me realize that, with a bit more code, I could produce some other useful views of a reaction.</p>
<p>In addition to the visualizations themselves, this post has some potentially useful details about what kind of extra information is available in the products of reactions.</p>
<div id="60f925e4-4d20-4752-ad92-119e08cb19f4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdChemReactions</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb1-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.09.1</code></pre>
</div>
</div>
<p>The first example reaction, adapted from the SI for http://pubs.acs.org/doi/abs/10.1021/ci200379p. I frequently use this paper as a source of reaction SMARTS definitions for real reactions; left to my own devices I would just use amide bond formation all the time, and that gets pretty boring pretty quick.</p>
<div id="b2035753" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># adapted example from the SI for: http://pubs.acs.org/doi/abs/10.1021/ci200379p</span></span>
<span id="cb3-2">sma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[Br,I;$(*c1ccccc1)]-[c:1]:[c:2]-[OH1:3].[CH1:5]#[C;$(C-[#6]):4]&gt;&gt;[c:1]1:[c:2]-[O:3]-[C:4]=[C:5]-1'</span></span>
<span id="cb3-3">rxn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(sma)</span>
<span id="cb3-4">rxn</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>A set of reactants for the reaction:</p>
<div id="820ada2b" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">r1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1cc(I)c(O)cc1'</span>)</span>
<span id="cb4-2">r2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1CCC1C#C'</span>)</span>
<span id="cb4-3">Draw.MolsToGridImage([r1,r2],molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Run the reaction and show the product:</p>
<div id="8edfad59" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">reactants <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (r1,r2)</span>
<span id="cb5-2"></span>
<span id="cb5-3">ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rxn.RunReactants(reactants)</span>
<span id="cb5-4">ps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Look at the properties set on one of the atoms in the product that came from a mapped atom:</p>
<div id="f0543c0c" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">prod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb6-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mapped atom:'</span>,prod.GetAtomWithIdx(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).GetPropsAsDict(includePrivate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>))</span>
<span id="cb6-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'unmapped atom:'</span>,prod.GetAtomWithIdx(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>).GetPropsAsDict(includePrivate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>mapped atom: {'old_mapno': 1, 'react_atom_idx': 2, 'react_idx': 0}
unmapped atom: {'react_atom_idx': 6, 'react_idx': 0}</code></pre>
</div>
</div>
<p>Here’s what those mean: 1. <code>old_mapno</code>: the atom map number for the atom (obviously only present on mapped atoms) 2. <code>react_idx</code>: which reactant the atom came from 3. <code>react_atom_idx</code>: the index of the atom in its reactant</p>
<p>What I did for the course was set the atom map numbers on the reactants and products, combine them into a new reaction, and then display that reaction.</p>
<p>Start by setting the atom map numbers:</p>
<div id="3731b082" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># since we're going to modify things, copy them first:</span></span>
<span id="cb8-2">prod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Mol(ps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb8-3">reactants <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (Chem.Mol(r1),Chem.Mol(r2))</span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> at <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> prod.GetAtoms():</span>
<span id="cb8-6">    pd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> at.GetPropsAsDict()</span>
<span id="cb8-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'old_mapno'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pd:</span>
<span id="cb8-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb8-9">    r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reactants[pd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'react_idx'</span>]]</span>
<span id="cb8-10">    rat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r.GetAtomWithIdx(pd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'react_atom_idx'</span>])</span>
<span id="cb8-11">    rat.SetAtomMapNum(pd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'old_mapno'</span>])</span>
<span id="cb8-12">    at.SetAtomMapNum(pd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'old_mapno'</span>])</span></code></pre></div>
</div>
<p>Now create the reaction and display it:</p>
<div id="ac6d10c7" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">nrxn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ChemicalReaction()</span>
<span id="cb9-2">nrxn.AddReactantTemplate(reactants[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb9-3">nrxn.AddReactantTemplate(reactants[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb9-4">nrxn.AddProductTemplate(prod)</span>
<span id="cb9-5"></span>
<span id="cb9-6">IPythonConsole.molSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span></span>
<span id="cb9-7">nrxn</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Once the atom-mapping information is there, The reaction drawing code can also highlight the atoms based upon which reactant they came from. Unfortunately this causes the atom-mapping information to not be displayed:</p>
<div id="0b9bb8d0" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">IPythonConsole.highlightByReactant <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb10-2">nrxn</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="902579e8" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">IPythonConsole.highlightByReactant <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span></code></pre></div>
</div>
<p>At this point it makes sense to take what we know and write a function to draw the highlighted reaction. By working directly with a MolDraw2DCairo object instead of using the notebook integration we more easily control what’s going on.</p>
<div id="8ce8c947" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb12-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> drawHighlightedReaction(rxn, reacts, prods, </span>
<span id="cb12-3">                            includeAtomMaps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, highlightAllAtoms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb12-4">                            mapAllAtoms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb12-5">                            highlightColors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb12-6">                            size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">900</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>), annotationFontScale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.74</span>,</span>
<span id="cb12-7">                            drawOptions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb12-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">''' draws a specific reaction with the reactants and products highlighted</span></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns an Image object with the drawing.    </span></span>
<span id="cb12-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Arguments</span></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    rxn: the reaction object (not currently used)</span></span>
<span id="cb12-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    reacts: a sequence of molecules. The reactants used in the reaction</span></span>
<span id="cb12-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    prods: a sequence of molecules. The products from the reaction</span></span>
<span id="cb12-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    includeAtomMaps: bool. Whether or not atom map numbers should be included in the output</span></span>
<span id="cb12-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    highlightAllAtoms: bool. Whether or not to highlight all reactant/product atoms in the output. </span></span>
<span id="cb12-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                           If True, non-mapped atoms will be highlighted. </span></span>
<span id="cb12-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                           If False, only the mapped atoms will be highlighted</span></span>
<span id="cb12-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    mapAllAtoms: bool. Whether or not to include atom mapping numbers on all atoms.</span></span>
<span id="cb12-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                           If True, non-mapped atoms will have negative atom map numbers displayed</span></span>
<span id="cb12-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    highlightColors: sequence of 3-tuples. Controls the colors used for highlighting the reactants.</span></span>
<span id="cb12-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                           The values should go from 0-1. The sequence should have (at least) len(reacts) </span></span>
<span id="cb12-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                           elements.</span></span>
<span id="cb12-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    size: tuple. Controls the size of the output image.</span></span>
<span id="cb12-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    annotationFontScale: float. Controls the size of the atom map notes (if being drawn)</span></span>
<span id="cb12-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    drawOptions: a MolDraw2DOptions object. Used as the draw options for the rendering. </span></span>
<span id="cb12-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                           Overrides annotationFontScale if provided.</span></span>
<span id="cb12-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb12-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    '''</span></span>
<span id="cb12-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make copies of all the reactants and the products since we will modify them</span></span>
<span id="cb12-31">    reacts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.Mol(r) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> reacts]</span>
<span id="cb12-32">    prods <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.Mol(p) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> prods]</span>
<span id="cb12-33">    </span>
<span id="cb12-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find the largest atom map number, used to initialize the negative atom map numbers</span></span>
<span id="cb12-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  when we are doing highlightAllAtoms</span></span>
<span id="cb12-36">    negVal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mapAllAtoms:</span>
<span id="cb12-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> prod <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> prods:</span>
<span id="cb12-39">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> at <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> prod.GetAtoms():</span>
<span id="cb12-40">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> at.HasProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'old_mapno'</span>):</span>
<span id="cb12-41">                    negVal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(negVal,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> at.GetIntProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'old_mapno'</span>))</span>
<span id="cb12-42">    negVal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-43"></span>
<span id="cb12-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop over each of the products and set the atom map and note information</span></span>
<span id="cb12-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  in both the product atoms and corresponding reactant atoms.</span></span>
<span id="cb12-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> prod <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> prods:</span>
<span id="cb12-47">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> at <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> prod.GetAtoms():</span>
<span id="cb12-48">            pd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> at.GetPropsAsDict()</span>
<span id="cb12-49">            mno <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'old_mapno'</span>,negVal)</span>
<span id="cb12-50">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mno<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb12-51">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> highlightAllAtoms:</span>
<span id="cb12-52">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb12-53">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb12-54">                    negVal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-55">            </span>
<span id="cb12-56">            r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reacts[pd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'react_idx'</span>]]</span>
<span id="cb12-57">            rat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r.GetAtomWithIdx(pd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'react_atom_idx'</span>])</span>
<span id="cb12-58">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tat <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> at,rat:</span>
<span id="cb12-59">                tat.SetAtomMapNum(mno)</span>
<span id="cb12-60">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> includeAtomMaps <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> (mno<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> mapAllAtoms):</span>
<span id="cb12-61">                    tat.SetProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'atomNote'</span>,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(mno))    </span>
<span id="cb12-62">    </span>
<span id="cb12-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create the reaction we'll actually render:</span></span>
<span id="cb12-64">    nrxn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ChemicalReaction()</span>
<span id="cb12-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> react <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> reacts:</span>
<span id="cb12-66">        nrxn.AddReactantTemplate(react)</span>
<span id="cb12-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> prod <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> prods:</span>
<span id="cb12-68">        nrxn.AddProductTemplate(prod)</span>
<span id="cb12-69"></span>
<span id="cb12-70">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and draw it</span></span>
<span id="cb12-71">    d2d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Draw.MolDraw2DCairo(size[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],size[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb12-72">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> drawOptions <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb12-73">        d2d.SetDrawOptions(drawOptions)</span>
<span id="cb12-74">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb12-75">        d2d.drawOptions().annotationFontScale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>annotationFontScale</span>
<span id="cb12-76">    d2d.DrawReaction(nrxn, highlightByReactant<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, highlightColorsReactants<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>highlightColors)</span>
<span id="cb12-77">    d2d.FinishDrawing()</span>
<span id="cb12-78">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> Image(d2d.GetDrawingText())</span></code></pre></div>
</div>
<div id="38efc9b1" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">r1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1cc(I)c(O)cc1'</span>)</span>
<span id="cb13-2">r2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1CCC1C#C'</span>)</span>
<span id="cb13-3">reactants <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (r1,r2)</span>
<span id="cb13-4">ps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rxn.RunReactants(reactants)</span>
<span id="cb13-5"></span>
<span id="cb13-6">drawHighlightedReaction(rxn,reactants,ps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="a06fe58b" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">drawHighlightedReaction(rxn,reactants,ps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],highlightAllAtoms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Include negative atom map numbers for atoms that were not in the reaction definition;</p>
<div id="cb4fad50" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">drawHighlightedReaction(rxn,reactants,ps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],mapAllAtoms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8e789b8a" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">drawHighlightedReaction(rxn,reactants,ps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],includeAtomMaps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Change the highlighting</p>
<div id="74431e91" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">drawHighlightedReaction(rxn,reactants,ps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],highlightColors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>), (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Provide our own draw options. Here we play with dark mode:</p>
<div id="dc6cd568" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdDepictor</span>
<span id="cb18-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> reactants:</span>
<span id="cb18-3">    rdDepictor.Compute2DCoords(r)</span>
<span id="cb18-4">dopts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Draw.MolDrawOptions()</span>
<span id="cb18-5">Draw.SetDarkMode(dopts)</span>
<span id="cb18-6">dopts.annotationFontScale <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb18-7">drawHighlightedReaction(rxn,reactants,ps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],drawOptions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dopts,</span>
<span id="cb18-8">                       highlightColors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>), (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Do another reaction from the same paper:</p>
<div id="d634a819" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">rxn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdChemReactions.ReactionFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[c:1](-[C;$(C-c1ccccc1):2](=[OD1:3])-[OH1]):[c:4](-[NH2:5]).[N;!H0;!$(N-N);!$(N-C=N);!$(N(-C=O)-C=O):6]-[C;H1,$(C-[#6]):7]=[OD1]&gt;&gt;[c:4]2:[c:1]-[C:2](=[O:3])-[N:6]-[C:7]=[N:5]-2'</span>)</span>
<span id="cb19-2">reactants <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromSmiles(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1c(C(=O)O)c(N)ccc1'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CCC(=O)Nc1ccccc1'</span>)]</span>
<span id="cb19-3">prods <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rxn.RunReactants(reactants)</span>
<span id="cb19-4">drawHighlightedReaction(rxn,reactants,prods[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>



 ]]></description>
  <category>drawing</category>
  <category>tutorial</category>
  <category>reactions</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-10-17-displaying-atom-maps-with-reactions.html</guid>
  <pubDate>Thu, 16 Oct 2025 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/displaying-atom-maps-1.png" medium="image" type="image/png" height="32" width="144"/>
</item>
<item>
  <title>Similarity search time and thresholds</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-10-10-similarity-search-time-and-thresholds-1.html</link>
  <description><![CDATA[ 




<p>This is an updated and modified version of a <a href="https://rdkit.blogspot.com/2015/08/impact-of-threshold-on-similarity.html">post I wrote back in 2015</a>. # Impact of the threshold on similarity search times</p>
<p>A <a href="http://chembl.blogspot.ch/2015/08/lsh-based-similarity-search-in-mongodb.html">ChEMBL blog post</a> included the (to me) somewhat surprising result that similarity search times while using the RDKit cartridge did not show much of a dependency on the similarity threshold being used. I wanted to investigate this a bit more closely.</p>
<p>I’m using a local install of ChEMBL35 for these tests. Since I don’t have the patience to wait for searches to complete with 1000 molecules, I will randomly select just 10:</p>
<pre><code>chembl_35=# select * into temporary table foo from rdk.fps order by random() limit 10;
SELECT 10
chembl_35=# select molregno,m from rdk.mols join foo using (molregno);
molregno |                                                      m                                                      
----------+-------------------------------------------------------------------------------------------------------------
    4111 | C=C1CC2(CCCCCCCCC2)OC1=O
    4131 | CC1Cc2cc3c(cc2C(c2ccc(N)cc2)=NN1C=O)OCO3
    4185 | CCOC(=O)/C=C(C)/C(F)=C/C=C(C)/C=C/c1c(C)cc(OC)c(C)c1C
    4256 | CC(C)(C)c1cc(CCc2cccnc2)cc(C(C)(C)C)c1O
    4292 | O=C(CCCCCCCCCBr)CC(=O)N[C@H]1CCOC1=O
    4334 | CCCC[C@@H](C[C@@H](CCc1ccc(-c2ccc(F)cc2)cc1)C(=O)N[C@H](C(=O)Nc1ccccc1)C(C)(C)C)C(=O)O
    4335 | COc1ccc(/C=C/c2cc(C(C)(C)C)c(O)c(C(C)(C)C)c2)cc1
    4389 | Cc1ccc2c(c1)C(=O)N(CC(C)(C)C[N+](C)(C)CCCCCC[N+](C)(C)CC(C)(C)CN1C(=O)c3cccc4cccc(c34)C1=O)C2=O.[Br-].[Br-]
    4591 | O=C(NCCCn1ccnc1)c1cc2ccccc2[nH]1
    4599 | O=Cc1ccn(-c2cc3c(cc2Cl)nc(O)n2nc(C(=O)O)cc32)c1
(10 rows)</code></pre>
<p>And now look at timing results for a number of threshold values:</p>
<pre><code>chembl_35=# set rdkit.tanimoto_threshold=0.4;select count(*) from rdk.fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.202 ms
count 
-------
3431
(1 row)

Time: 2446.118 ms (00:02.446)
chembl_35=# set rdkit.tanimoto_threshold=0.5;select count(*) from rdk.fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.245 ms
count 
-------
814
(1 row)

Time: 2258.420 ms (00:02.258)
chembl_35=# set rdkit.tanimoto_threshold=0.6;select count(*) from rdk.fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.146 ms
count 
-------
261
(1 row)

Time: 2005.068 ms (00:02.005)
chembl_35=# set rdkit.tanimoto_threshold=0.7;select count(*) from rdk.fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.304 ms
count 
-------
122
(1 row)

Time: 1702.164 ms (00:01.702)
chembl_35=# set rdkit.tanimoto_threshold=0.8;select count(*) from rdk.fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.147 ms
count 
-------
    35
(1 row)

Time: 1272.436 ms (00:01.272)
chembl_35=# set rdkit.tanimoto_threshold=0.9;select count(*) from rdk.fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.207 ms
count 
-------
    21
(1 row)

Time: 645.774 ms
chembl_35=# set rdkit.tanimoto_threshold=0.95;select count(*) from rdk.fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.101 ms
count 
-------
    17
(1 row)

Time: 268.827 ms
chembl_35=# set rdkit.tanimoto_threshold=0.99;select count(*) from rdk.fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.242 ms
count 
-------
    14
(1 row)

Time: 54.065 ms</code></pre>
<p>In the previous version of the post, there were some interesting differences here. That’s no longer the case. this is probably at least partially because both Postgres and the cartridge have seen some improvements in the last ten years (for example, index-only scans are now possible). I guess the bigger part is because I’m using a more capable machine with a bunch more RAM.</p>
<section id="a-larger-test-zinc" class="level2">
<h2 class="anchored" data-anchor-id="a-larger-test-zinc">A larger test: ZINC</h2>
<p>To see if there are any trends for a larger dataset, I grabbed a copy of the <a href="http://zinc.docking.org/subsets/all-clean">ZINC All Clean set</a>. After removing the molecules that the RDKit doesn’t like (there are actually only 14 molecules in the full set that the RDKit rejected), this leaves 16.4 million molecules.</p>
<p>For the record, here’s how I built the database:</p>
<pre><code>(rdkit_build) glandrum@stoat:/scratch/RDKit_git/LocalData$ createdb zinc
(rdkit_build) glandrum@stoat:/scratch/RDKit_git/LocalData$ psql -c 'create table raw_data (id SERIAL, smiles text, zinc_id char(12))' zinc
CREATE TABLE
(rdkit_build) glandrum@stoat:/scratch/RDKit_git/LocalData$ cd Zinc
(rdkit_build) glandrum@stoat:/scratch/RDKit_git/LocalData/Zinc$ zcat zinc_all_clean.smi.gz | sed '1d; s/\\/\\\\/g' |psql -c "copy raw_data (smiles,zinc_id) from stdin with delimiter ' '" zinc
COPY 16403864
(rdkit_build) glandrum@stoat:/scratch/RDKit_git/LocalData/Zinc$ psql zinc
psql (14.19 (Ubuntu 14.19-0ubuntu0.22.04.1))
Type "help" for help.

zinc=# \timing
Timing is on.
zinc=# create extension rdkit;
CREATE EXTENSION
Time: 21.754 ms
zinc=# select * into mols from (select id,mol_from_smiles(smiles::cstring) m from raw_data) tmp where m is not null;
  ... snip ...
SELECT 16403848
Time: 945195.267 ms (15:45.195)
zinc=# select id,morganbv_fp(m) as mfp2 into fps from mols;
SELECT 16403848
Time: 155185.639 ms (02:35.186)
zinc=# create index fps_mfp2_idx on fps using gist(mfp2);
CREATE INDEX
Time: 140542.861 ms (02:20.543)
zinc=# select * into temporary table foo from fps tablesample bernoulli (1) repeatable (123456) limit 10;
SELECT 10
Time: 11.977 ms</code></pre>
<p>Here are the 10 random molecules:</p>
<pre><code>zinc=# select id,m from mols join foo using (id);
id    |                             m                             
------+-----------------------------------------------------------
12317 | CCc1nnc(NC(=O)[C@H](CC)Oc2ccccc2)s1
385   | CCOC(=O)c1ccccc1C(=O)OCC
24317 | CC(C)(C)c1ccc([C@@]23OC(=O)C(C)(C)[C@@H]2OC(=O)C3(C)C)cc1
48    | CC(C)(C)[NH2+]C[C@H](O)COc1cc(Cl)ccc1Cl
225   | CC[C@@]1(CO)CCC[NH+]2CCc3c([nH]c4ccccc34)[C@@H]21
90    | C[NH2+]C[C@@H](OC)c1cccc(C(F)(F)F)c1
24406 | CCOC1(OCC)[NH+]=C(N)[C@@]2(C#N)C3(CCCCC3)[C@@]12C#N
24738 | Cc1ccc(S(=O)(=O)Nc2ccccc2C#N)cc1
356   | CCc1c(O)c(=O)ccn1CC
8     | O=C([O-])[C@@H](O)c1ccccc1
(10 rows)

Time: 5167.539 ms (00:05.168)</code></pre>
<p>Now the searches:</p>
<pre><code>zinc=# set rdkit.tanimoto_threshold=0.4; select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.133 ms
count 
-------
55762
(1 row)

Time: 15931.816 ms (00:15.932)
zinc=# set rdkit.tanimoto_threshold=0.5; select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.183 ms
count 
-------
4486
(1 row)

Time: 13616.273 ms (00:13.616)
zinc=# set rdkit.tanimoto_threshold=0.6; select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.205 ms
count 
-------
623
(1 row)

Time: 11555.706 ms (00:11.556)
zinc=# set rdkit.tanimoto_threshold=0.7; select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.213 ms
count 
-------
165
(1 row)

Time: 8509.171 ms (00:08.509)
zinc=# set rdkit.tanimoto_threshold=0.8; select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.097 ms
count 
-------
    50
(1 row)

Time: 4717.467 ms (00:04.717)
zinc=# set rdkit.tanimoto_threshold=0.9; select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.097 ms
count 
-------
    20
(1 row)

Time: 1026.567 ms (00:01.027)
zinc=# set rdkit.tanimoto_threshold=0.95; select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.103 ms
count 
-------
    20
(1 row)

Time: 195.971 ms
zinc=# set rdkit.tanimoto_threshold=0.99; select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
SET
Time: 0.096 ms
count 
-------
    20
(1 row)

Time: 34.866 ms</code></pre>
<p>I’m going to look at two interesting steps in this data: from a threshold of 0.4 to 0.6, and from 0.6 to 0.99. In the first case, the number of hits goes from 55762 to 623, while the time goes from 15.9s to 11.6s. In the second case, the number of hits goes from 623 to 20, while the time goes from 11.6s to 34.9ms. In the first case the number if hits drops by almost two orders of magnitude while the time only drops by about 25%. In the second case, the number of hits drops by a factor of 30, while the time drops by a factor of almost 39.</p>
<p>Look at the output from <code>EXPLAIN ANALYZE</code> for these queries to see if we can figure out what’s going on:</p>
<pre><code>zinc=# set rdkit.tanimoto_threshold=0.4;
SET
Time: 0.152 ms
zinc=# explain (analyze on, buffers on) select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
                                                                    QUERY PLAN                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------
Aggregate  (cost=1376580.94..1376580.95 rows=1 width=8) (actual time=16239.641..16239.642 rows=1 loops=1)
Buffers: shared hit=9573 read=2374633, local hit=1
-&gt;  Nested Loop  (cost=0.42..1324498.62 rows=20832924 width=0) (actual time=8.908..16236.122 rows=55762 loops=1)
        Buffers: shared hit=9573 read=2374633, local hit=1
        -&gt;  Seq Scan on foo  (cost=0.00..22.70 rows=1270 width=32) (actual time=0.004..0.016 rows=10 loops=1)
            Buffers: local hit=1
        -&gt;  Index Only Scan using fps_mfp2_idx on fps fps1  (cost=0.42..878.85 rows=16404 width=65) (actual time=6.231..1622.310 rows=5576 loops=10)
            Index Cond: (mfp2 % foo.mfp2)
            Heap Fetches: 0
            Buffers: shared hit=9573 read=2374633
Planning Time: 0.052 ms
JIT:
Functions: 5
Options: Inlining true, Optimization true, Expressions true, Deforming true
Timing: Generation 0.126 ms, Inlining 1.992 ms, Optimization 3.165 ms, Emission 3.565 ms, Total 8.848 ms
Execution Time: 16239.872 ms
(16 rows)

Time: 16240.250 ms (00:16.240)
zinc=# set rdkit.tanimoto_threshold=0.6;
SET
Time: 0.114 ms
zinc=# explain (analyze on, buffers on) select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
                                                                    QUERY PLAN                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------
Aggregate  (cost=1376580.94..1376580.95 rows=1 width=8) (actual time=13299.969..13299.970 rows=1 loops=1)
Buffers: shared hit=4685 read=1995775, local hit=1
-&gt;  Nested Loop  (cost=0.42..1324498.62 rows=20832924 width=0) (actual time=112.152..13299.772 rows=758 loops=1)
        Buffers: shared hit=4685 read=1995775, local hit=1
        -&gt;  Seq Scan on foo  (cost=0.00..22.70 rows=1270 width=32) (actual time=0.004..0.013 rows=10 loops=1)
            Buffers: local hit=1
        -&gt;  Index Only Scan using fps_mfp2_idx on fps fps1  (cost=0.42..878.85 rows=16404 width=65) (actual time=112.027..1329.058 rows=76 loops=10)
            Index Cond: (mfp2 % foo.mfp2)
            Heap Fetches: 0
            Buffers: shared hit=4685 read=1995775
Planning Time: 0.052 ms
JIT:
Functions: 5
Options: Inlining true, Optimization true, Expressions true, Deforming true
Timing: Generation 0.126 ms, Inlining 2.130 ms, Optimization 3.170 ms, Emission 3.601 ms, Total 9.027 ms
Execution Time: 13300.146 ms
(16 rows)

Time: 13300.681 ms (00:13.301)
zinc=# set rdkit.tanimoto_threshold=0.99;
SET
Time: 0.253 ms
zinc=# explain (analyze on, buffers on) select count(*) from fps fps1 cross join foo where fps1.mfp2%foo.mfp2;
                                                                QUERY PLAN                                                                   
------------------------------------------------------------------------------------------------------------------------------------------------
Aggregate  (cost=1376580.94..1376580.95 rows=1 width=8) (actual time=50.800..50.801 rows=1 loops=1)
Buffers: shared hit=14558 read=5872, local hit=1
-&gt;  Nested Loop  (cost=0.42..1324498.62 rows=20832924 width=0) (actual time=11.722..50.787 rows=12 loops=1)
        Buffers: shared hit=14558 read=5872, local hit=1
        -&gt;  Seq Scan on foo  (cost=0.00..22.70 rows=1270 width=32) (actual time=0.003..0.010 rows=10 loops=1)
            Buffers: local hit=1
        -&gt;  Index Only Scan using fps_mfp2_idx on fps fps1  (cost=0.42..878.85 rows=16404 width=65) (actual time=2.392..4.188 rows=1 loops=10)
            Index Cond: (mfp2 % foo.mfp2)
            Heap Fetches: 0
            Buffers: shared hit=14558 read=5872
Planning Time: 0.052 ms
JIT:
Functions: 5
Options: Inlining true, Optimization true, Expressions true, Deforming true
Timing: Generation 0.123 ms, Inlining 2.134 ms, Optimization 3.203 ms, Emission 3.554 ms, Total 9.014 ms
Execution Time: 50.972 ms
(16 rows)

Time: 51.323 ms</code></pre>
<p>` The big difference I see here is the number of buffers that actually need to be read when executing the queries. At the 0.4 threshold, we need to read 2.37 million buffers, at 0.7 it’s just under 2 million, and at 0.99 we only need to read 5872. This is presumably because the index is pruning so many rows at the higher thresholds. I’m definitely not an expert at interpreting this output, so if anyone has other ideas or explanations, please let me know!</p>
</section>
<section id="an-aside-chemfp-performance" class="level2">
<h2 class="anchored" data-anchor-id="an-aside-chemfp-performance">An aside: chemfp performance</h2>
<p>The previous version of this post included a performance comparison with <a href="http://chemfp.com/">chemfp</a>. Since I no longer have access to the licensed version of chemfp, I’m going to skip that here. I assume it’s dramatically quicker than the cartridge. :-)</p>


</section>

 ]]></description>
  <category>cartridge</category>
  <category>questions</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-10-10-similarity-search-time-and-thresholds-1.html</guid>
  <pubDate>Thu, 09 Oct 2025 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Rendering intramolecular H bonds in 2D</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds.html</link>
  <description><![CDATA[ 




<p>I had the idea for this short post while working on last week’s post about <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-09-26-drawing-interactions-1.html">drawing simple protein–ligand interaction diagrams</a>. It shows a quick way to force the RDKit’s 2D coordinate generator to put non-bonded atoms close to each other in a drawing. I use the examples of rendering intramolecular H bonds and chelators.</p>
<div id="c54c234f-5563-49a7-afca-db59ed7ade39" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdDepictor</span></code></pre></div>
</div>
<div id="070c2de1-feaf-4ac6-a63e-4d54108555be" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">IPythonConsole.drawOptions.addAtomIndices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb2-2">IPythonConsole.molSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">350</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span></span></code></pre></div>
</div>
<p>Let’s start with a simple molecule that forms intramolecular hydrogen bonds, malonaldehyde (I also used this as the example in the blog post on <a href="https://greglandrum.github.io/rdkit-blog/posts/2024-07-28-confgen-and-intramolecular-hbonds.html">generating 3D conformers which include intramolecular H bonds</a>).</p>
<p>The 2D coordinate generation code generates an extended 2D conformer for malonaldehyde:</p>
<div id="5b8b871e-2201-492e-9e90-08c08f7bb7d8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O=CCCO'</span>)</span>
<span id="cb3-2">m</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This type of extended conformer looks completely reasonable and is, for most molecules, almost certainly the right way to draw chains, but in this case I want to actually show the H bond.</p>
<p>To do so, I start by adding the H which will be involved in the H bond to the molecule:</p>
<div id="8a40158a-4ba9-442f-b477-3145bddb9926" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RWMol(m)</span>
<span id="cb4-2">aid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.AddAtom(Chem.Atom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb4-3">m2.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,aid,Chem.BondType.SINGLE)</span>
<span id="cb4-4">m2</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We still have an extended conformer. I can force this to change by doing something non-physical and adding a single bond between the H and O0:</p>
<div id="2bfbe7c9" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">bid1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,aid,Chem.BondType.SINGLE)</span>
<span id="cb5-2">m2</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>That has the coordinates I wanted, but having the H bond drawn as a single bond is definitely not desirable.</p>
<p>To solve this I’m going to explicitly generate the coordinates for the molecule with the single bond present (instead of relying up on the notebook code to generate a temporary set of coordinates), then remove the single bond and render the molecule:</p>
<div id="9fdad754" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">rdDepictor.Compute2DCoords(m2)</span>
<span id="cb6-2">m2.RemoveBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,aid)</span>
<span id="cb6-3">m2</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>That’s what I was looking for.</p>
<p>If I want to actually include the H bond in the drawing in a way that won’t make chemists cringe, I can add a hydrogen bond:</p>
<div id="d83d7b9a-b770-45b4-b365-8c1efd4cc325" class="cell" data-scrolled="true" data-execution_count="21">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">bid1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,aid,Chem.BondType.HYDROGEN)</span>
<span id="cb7-2">m2</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Note that simply adding the hydrogen bond to start with would not have worked since zero-order bonds are not included in the RDKit’s ring-finding code by default:</p>
<div id="91026155-f773-48ab-ad0e-2445247e0659" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">m3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RWMol(m)</span>
<span id="cb8-2">aid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m3.AddAtom(Chem.Atom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb8-3">m3.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,aid,Chem.BondType.SINGLE)</span>
<span id="cb8-4">m3.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,aid,Chem.BondType.HYDROGEN)</span>
<span id="cb8-5">m3</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here’s a more complex molecule where I want to show two intramolecular H bonds:</p>
<div id="91fe8bef-5c53-47de-809b-d5287d498519" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1cccc(C(=O)OC)c1NC(=O)C1CCCCC1(=O)'</span>)</span>
<span id="cb9-2">m</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In this case I would like to indicate H bonds between the H on N10 and O6 as well as the H on C0 and O12.</p>
<div id="4e1d8519-acef-4610-ab26-b882036cffc1" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the Hs:</span></span>
<span id="cb10-2">m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RWMol(m)</span>
<span id="cb10-3">aid1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.AddAtom(Chem.Atom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb10-4">m2.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,aid1,Chem.BondType.SINGLE)</span>
<span id="cb10-5">aid2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.AddAtom(Chem.Atom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb10-6">m2.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,aid2,Chem.BondType.SINGLE)</span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add single bonds for the intramolecular H bonds:</span></span>
<span id="cb10-9">bid1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.AddBond(aid1,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,Chem.BondType.SINGLE)</span>
<span id="cb10-10">bid2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.AddBond(aid2,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,Chem.BondType.SINGLE)</span>
<span id="cb10-11"></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate coordinates:</span></span>
<span id="cb10-13">rdDepictor.Compute2DCoords(m2)</span>
<span id="cb10-14"></span>
<span id="cb10-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert to H bonds:</span></span>
<span id="cb10-16">m2.GetBondWithIdx(bid1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).SetBondType(Chem.BondType.HYDROGEN)</span>
<span id="cb10-17">m2.GetBondWithIdx(bid2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).SetBondType(Chem.BondType.HYDROGEN)</span>
<span id="cb10-18"></span>
<span id="cb10-19">m2</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can use a similar trick to get conformers of chelators that have the chelating atoms in the expected geometry.</p>
<div id="5ebae17a" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NCCN'</span>)</span>
<span id="cb11-2">m</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This time I’m going to add an extra atom (to stand in for the atom which will eventually be chelated), form bonds to that, and then remove that atom after generating 2D coordinates:</p>
<div id="506c1ba0" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RWMol(m)</span>
<span id="cb12-2">aid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.AddAtom(Chem.Atom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb12-3">m2.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,aid,Chem.BondType.SINGLE)</span>
<span id="cb12-4">m2.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,aid,Chem.BondType.SINGLE)</span>
<span id="cb12-5">rdDepictor.Compute2DCoords(m2)</span>
<span id="cb12-6">m2.RemoveAtom(aid)</span>
<span id="cb12-7">m2</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>



 ]]></description>
  <category>drawing</category>
  <category>exploration</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-10-04-rendering-intramolecular-h-bonds.html</guid>
  <pubDate>Fri, 03 Oct 2025 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/rendering-intramolecular-h-bonds.png" medium="image" type="image/png" height="123" width="144"/>
</item>
<item>
  <title>Drawing simple protein–ligand interaction diagrams with the RDKit</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-09-26-drawing-interactions-1.html</link>
  <description><![CDATA[ 




<p>I’m a big fan of 2D protein–ligand interaction diagrams; when well done these plots can provide an information-dense view of the structure that is still easy to understand.</p>
<p>A really nice example of this is the work on <a href="https://doi.org/10.1021/ml100164p">PoseView</a> from Matthias Rarey’s group in Hamburg. Here’s an example from that publication:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://pubs.acs.org/cms/10.1021/ml100164p/asset/images/medium/ml-2010-00164p_0005.gif" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<p>Though I would love to have an RDKit implementation of PoseView, actually implementing something like that is deeply nontrivial, so I’ve never really done anything in that direction. This week I had a random idea for a way to provide basic protein–ligand interaction diagrams using existing RDKit functionality. This post is an exploration of that.</p>
<p>Here’s an example of what you get with this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-09-26-drawing-interactions-1_files/figure-html/121dfaf4-1-image-2.png" class="img-fluid figure-img"></p>
<figcaption>image-2.png</figcaption>
</figure>
</div>
<p>To be clear: I am fully aware that this is not nearly as good as what PoseView and similar tools can do, but I think it’s still quite useful. I have a few ideas for straightforward changes to the backend code to improve the plots that I’m also going to take a look at.</p>
<div id="9bb879a5-1a40-40b3-b679-56f84618d0b8" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdDepictor</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SVG</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-6">IPythonConsole.molSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span></span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb1-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.03.6</code></pre>
</div>
</div>
<section id="initial-exploration" class="level1">
<h1>Initial exploration</h1>
<p>Start with the ligand for a recent PDB structure, 8yqe:</p>
<div id="12f226e6-d0bc-4b2f-a807-30922590055d" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># from https://www.ebi.ac.uk/pdbe/entry/pdb/8yqe?activeTab=ligands</span></span>
<span id="cb3-2">lig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CCS(=O)(=O)N1CCC(CC1)NC(=O)c2c(cn[nH]2)NC(=O)c3c(ccc(c3F)C4CCOCC4)F'</span>)</span>
<span id="cb3-3">IPythonConsole.drawOptions.addAtomIndices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb3-4">lig</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-09-26-drawing-interactions-1_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The strategy to draw the interaction diagrams is to add a new dummy atom to the ligand molecule for each residue it’s interacting with and then connect that to the interacting ligand atom with a zero-order bond. The standard RDKit 2D coordinate generation code will then do something sensible with this.</p>
<p>I include <code>hbond</code> interactions that are around 3.0<img src="https://latex.codecogs.com/png.latex?%5CAA"> or less from the list of interactions on the <a href="https://www.ebi.ac.uk/pdbe/entry/pdb/8yqe?activeTab=ligands">ligand page</a></p>
<div id="a620928d-d684-4115-b786-6f934b2c4840" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">lig_with_interactions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RWMol(lig)</span>
<span id="cb4-2">leu83 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Atom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb4-3">leu83.SetProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'atomLabel'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Leu 83'</span>)</span>
<span id="cb4-4">aid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lig_with_interactions.AddAtom(leu83)</span>
<span id="cb4-5">lig_with_interactions.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>,aid,Chem.BondType.ZERO)</span>
<span id="cb4-6">lig_with_interactions.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>,aid,Chem.BondType.ZERO)</span>
<span id="cb4-7"></span>
<span id="cb4-8">hoh407 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Atom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb4-9">hoh407.SetProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'atomLabel'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H2O 407'</span>)</span>
<span id="cb4-10">aid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lig_with_interactions.AddAtom(hoh407)</span>
<span id="cb4-11">lig_with_interactions.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>,aid,Chem.BondType.ZERO)</span>
<span id="cb4-12"></span>
<span id="cb4-13">hoh441 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Atom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb4-14">hoh441.SetProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'atomLabel'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H2O 441'</span>)</span>
<span id="cb4-15">aid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lig_with_interactions.AddAtom(hoh441)</span>
<span id="cb4-16">lig_with_interactions.AddBond(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>,aid,Chem.BondType.ZERO)</span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this doesn't work because the ring centroid doesn't get put in the middle of the ring</span></span>
<span id="cb4-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ring_center = Chem.Atom(0)</span></span>
<span id="cb4-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># aid = lig_with_interactions.AddAtom(ring_center)</span></span>
<span id="cb4-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for rid in (22,23,24,25,26,27):</span></span>
<span id="cb4-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     lig_with_interactions.AddBond(rid,aid,Chem.BondType.ZERO)</span></span>
<span id="cb4-23"></span>
<span id="cb4-24">lig_with_interactions</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-09-26-drawing-interactions-1_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="making-it-easier-to-use" class="level1">
<h1>Making it easier to use</h1>
<p>That doesn’t look terrible. Write a function to automate the process and include highlights around the residue pseudo-atoms:</p>
<div id="4b76011f-6f90-41c9-8bb9-dbaeda91e53a" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> draw_ligand_with_interactions(lig,lig_name,interactions,size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>)):   </span>
<span id="cb5-2">    lig_with_interactions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RWMol(lig)</span>
<span id="cb5-3">    </span>
<span id="cb5-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add pseudo-atoms (and bonds to them) for the interacting residues:</span></span>
<span id="cb5-5">    pts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb5-6">    clrs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb5-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (aname,oaids) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> interactions:</span>
<span id="cb5-8">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.Atom(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-9">        res.SetProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'atomLabel'</span>,aname)</span>
<span id="cb5-10">        aid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lig_with_interactions.AddAtom(res)</span>
<span id="cb5-11">        pts.append(aid)</span>
<span id="cb5-12">        clrs[aid] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.3</span>)</span>
<span id="cb5-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> oaid <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> oaids:</span>
<span id="cb5-14">            lig_with_interactions.AddBond(aid,oaid,Chem.BondType.ZERO)</span>
<span id="cb5-15">   </span>
<span id="cb5-16">    d2d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Draw.MolDraw2DSVG(size[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],size[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb5-17">    </span>
<span id="cb5-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the draw options so that we end up with circles under the pseudo-atoms:</span></span>
<span id="cb5-19">    d2d.drawOptions().circleAtoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb5-20">    d2d.drawOptions().fillHighlights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb5-21">    d2d.drawOptions().continuousHighlight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb5-22">    d2d.drawOptions().highlightRadius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb5-23">    </span>
<span id="cb5-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># now draw and return the result</span></span>
<span id="cb5-25">    d2d.DrawMolecule(lig_with_interactions,legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lig_name,</span>
<span id="cb5-26">                     highlightAtoms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pts,highlightAtomColors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>clrs)</span>
<span id="cb5-27">    d2d.FinishDrawing()</span>
<span id="cb5-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> SVG(d2d.GetDrawingText())</span>
<span id="cb5-29"></span>
<span id="cb5-30"></span></code></pre></div>
</div>
<div id="3ef3c749-22a9-4e5d-a9a8-a7175a3513cd" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># from https://www.ebi.ac.uk/pdbe/entry/pdb/8yqe?activeTab=ligands</span></span>
<span id="cb6-2">lig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CCS(=O)(=O)N1CCC(CC1)NC(=O)c2c(cn[nH]2)NC(=O)c3c(ccc(c3F)C4CCOCC4)F'</span>)</span>
<span id="cb6-3">interactions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb6-4">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LYS 89'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,)),</span>
<span id="cb6-5">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ASP 86'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,)),</span>
<span id="cb6-6">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'HOH 444'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,)),</span>
<span id="cb6-7">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'HOH 441'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>,)),</span>
<span id="cb6-8">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'HOH 407'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>,)),</span>
<span id="cb6-9">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LEU 83'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)),</span>
<span id="cb6-10">)</span>
<span id="cb6-11">draw_ligand_with_interactions(lig,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A1D60 from 8yqe'</span>,interactions)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-09-26-drawing-interactions-1_files/figure-html/cell-6-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Do a couple more examples using other recent PDB structures:</p>
<div id="88709c52" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># from: https://www.ebi.ac.uk/pdbe/entry/pdb/9uhc?activeTab=ligands</span></span>
<span id="cb7-2">lig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CCC(=O)Nc1ccc2c(c1)n(cc2c3c[nH]c4c3nc(cn4)c5cnn(c5)CCN6CCOCC6)C'</span>)</span>
<span id="cb7-3">interactions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb7-4">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ALA 564'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22</span>,)),</span>
<span id="cb7-5">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GLU 562'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,)),</span>
<span id="cb7-6">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ASP 641'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,)),</span>
<span id="cb7-7">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CYS 488'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,)),</span>
<span id="cb7-8">)</span>
<span id="cb7-9">draw_ligand_with_interactions(lig,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A1EPE from 9uhc'</span>,interactions)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-09-26-drawing-interactions-1_files/figure-html/cell-7-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8bc287f8" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># from https://www.ebi.ac.uk/pdbe/entry/pdb/9vci?activeTab=ligands</span></span>
<span id="cb8-2">lig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC(=O)NCc1cc(c(cc1F)O)Oc2ccc(cc2)N3c4c(ncnc4N(C3=O)C5CCNCC5)N'</span>)</span>
<span id="cb8-3">interactions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb8-4">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GLY 9'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,)),</span>
<span id="cb8-5">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ASP 135'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,)),</span>
<span id="cb8-6">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'THR 48'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span>,)),</span>
<span id="cb8-7">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'HOH 637'</span>,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>,)),</span>
<span id="cb8-8">)</span>
<span id="cb8-9">draw_ligand_with_interactions(lig,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A1ERR from 9vci'</span>,interactions)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-09-26-drawing-interactions-1_files/figure-html/cell-8-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>There’s clearly room for improvement here (and I have a couple of ideas already), but I think this is already useful as-is.</p>


</section>

 ]]></description>
  <category>drawing</category>
  <category>exploration</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-09-26-drawing-interactions-1.html</guid>
  <pubDate>Thu, 25 Sep 2025 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/drawing-interactions-1.png" medium="image" type="image/png" height="123" width="144"/>
</item>
<item>
  <title>2025 RDKit UGM Recap</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-09-14-UGM-recap.html</link>
  <description><![CDATA[ 




<p>The 2025 RDKit UGM took place last week (September 10-12, 2025) in Prague. This year’s installment of the meeting was organized by Martin Šícho at the University of Chemistry and Technology, Prague. From my perspective the meeting went very well: the logistics were smooth, the technology mostly worked - we had some problems with sound on the first day, but got past those (why is it always sound?), and the program had a good balance of talks and breaks. Many thanks to Martin and the Prague group for putting together a great meeting and to the companies that sponsored the meeting (listed in the <a href="https://github.com/rdkit/UGM_2025">github repo</a>) for enabling us to continue to run the meeting without having to charge registration fees.</p>
<p>We had 120 registered attendees; as usual we were at capacity (the limiting factor was the size of the lecture hall). This year we only had a couple of no-shows (a common problem with free meetings). We had the usual good mix of academic and industrial attendees and of people in different stages of their careers. The meeting was live streamed over zoom and there were typically 40-60 people watching the talks remotely and participating via the discord server.</p>
<p>There were 19 standard talks (we did a mix of 20- and 30-minute slots this year and I think that worked pretty well), 10 lightning talks, and 20 posters. On Friday we had the hackathon and three workshops. I haven’t heard much feedback about the workshops yet, but there were a number of pull requests submitted to the RDKit repo during the hackathon and in the next couple of days, so it looks like that was productive.</p>
<p>The github repo is here: <a href="https://github.com/rdkit/UGM_2025">https://github.com/rdkit/UGM_2025</a>. The slides from the presentations will show up in the repo as speakers send them to me or submit PRs themselves. I will be uploading the videos of the talks to <a href="https://www.youtube.com/playlist?list=PLugOo5eIVY3GDYcuR5kKIXwHIKKP8Vj0B">the YouTube playlist</a> over the next few weeks as I have time to process them.</p>
<p>I, unsurprisingly, really enjoyed the meeting. I was exhausted at the end of each day, and totally wiped out on Friday, but that’s 100 percent expected. Some personal thoughts/impressions:</p>
<ul>
<li>I had never been to Prague before and very much enjoyed the bits of it I saw. The UGM itself kept me busy during the days, but the area around the campus was quite lively and I did get to see some other parts while running (pro tip: don’t try and run along the river in the afternoon… there are way too many people out and about! Early mornings were a lot more runnable).</li>
<li>As always, it was great to see old friends and meet new people. My tendency, particularly during meetings like this, is to spend most of my time talking to people I already know, but I think I did a decent job this year of tempering that.</li>
<li>It was really nice to have all four RDKit maintainers (Brian, Paolo, Ricardo, and myself) together in one place. I’m not sure when the last time that happened was.</li>
<li>The quality of the talks was good. We had a couple that were more marketing-heavy than I would of liked, but they were definitely the exception. As usual, there was a nice mix of academic and industrial, method-development and application, deeply technical and high-level.</li>
<li>One recurring theme this year was the handling of sequence-based entities and/or polymers. There were several talks that touched on this topic from different angles and I’m really curious to see how this will evolve in the RDKit. This is an area where I don’t have a lot of personal experience, so it’s going to be fun for me to see how the RDKit community tackles this.</li>
</ul>
<p>I came back from the meeting with a long list of things I want to work on in the RDKit, and that’s a really good sign. I hope that other attendees came away similarly inspired!</p>
<p>I will announce the dates and locations of the 2026 European UGM as soon as they are finalized. If you are interested in hosting a future UGM, please get in touch with me.</p>



 ]]></description>
  <category>general</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-09-14-UGM-recap.html</guid>
  <pubDate>Sat, 13 Sep 2025 22:00:00 GMT</pubDate>
</item>
<item>
  <title>The 2025 RDKit UGM is next week</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-09-07-UGM-upcoming.html</link>
  <description><![CDATA[ 




<p>The 2025 RDKit UGM takes place next week (September 10-12, 2025) in Prague. The github repo is here: <a href="https://github.com/rdkit/UGM_2025">https://github.com/rdkit/UGM_2025</a>.</p>
<p>The UGM is “sold out”, so we can’t accept any last-minute registrations, but we will be live streaming it over zoom. I will be posting the links to the zoom sessions in the repo as well as in the <a href="https://discord.gg/5cAr6x66Ug">UGM discord server</a>.</p>
<p>The upcoming meeting is my official excuse for why there is no real blog post this week (I also took a few days off to run an ultra-marathon, but I’m not allowed to use that as an excuse for skipping a blog post. ;-)). Hopefully I’ll manage to put something real together next week after the UGM.</p>



 ]]></description>
  <category>general</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-09-07-UGM-upcoming.html</guid>
  <pubDate>Sat, 06 Sep 2025 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Scaling conformer generation</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-08-30-confgen-scaling.html</link>
  <description><![CDATA[ 




<p>This week the question came up in the lab of how well the conformer generation code scales with the number of threads used. Since generating conformers is embarassingly parallel - the conformers don’t depend on each other (this isn’t quite true if you are doing RMS pruning) - in a perfect world you’d expect more or less linear scaling. So theoretically using 4 times as many threads should take 1/4 as much time as long as the number of threads is less than the number of conformers being generated. In reality, things don’t quite work out this way since the individual conformers can take different amounts of time to generate due to the stochastic nature of the RDKit’s distance-geometry-based algorithm.</p>
<p>I decided to do a quick test to see how well things scale on my machine.</p>
<blockquote class="blockquote">
<p>Aside: this post is looking at runtimes of conformer generation for individual molecules. We can further increase the speed of conformer generation for large sets of molecules by splitting the work across multiple machines. That’s a topic for a different post</p>
</blockquote>
<div id="2f30cd5b" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gzip</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdDistGeom</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span>
<span id="cb1-10">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tableau-colorblind10'</span>)</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb1-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.03.5</code></pre>
</div>
</div>
<p>Start by loading some molecules. This is a set of 370 molecules that are present in both the <a href="https://www.crystallography.net/cod/">COD</a> and <a href="https://www.ebi.ac.uk/chembl/">ChEMBL</a>. I use these (as well as some other COD subsets) a lot for confgen testing:</p>
<div id="44b269e5" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">ms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> Chem.ForwardSDMolSupplier(gzip.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'../data/COD_2025Jan13.organic.chembl_selected.sdf.gz'</span>),</span>
<span id="cb3-2">                                          removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb3-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ms)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>370</code></pre>
</div>
</div>
<p>For the purposes of this post we’ll just use 100 of the COD molecules. Add Hs to the mols and create the subset:</p>
<div id="7e2cac99" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">ms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.AddHs(m) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ms]</span>
<span id="cb5-2">ms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ms[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]</span></code></pre></div>
</div>
<p>My linux box has 8 performance cores (each of which can run two hyperthreads) and 8 “efficient” cores, so python thinks I have 24 CPUs available:</p>
<div id="6aec1e72" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> multiprocessing</span>
<span id="cb6-2">multiprocessing.cpu_count()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>24</code></pre>
</div>
</div>
<p>I will try thread counts up to 10 to check scaling; a bit beyond the number of physical performance cores on my machine.</p>
<p>Now try generating both 100 conformer and 400 conformer sets for each molecule using different thread counts and track how long it takes:</p>
<div id="3ab047dd" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">threadCounts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span>
<span id="cb8-2"></span>
<span id="cb8-3">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdDistGeom.ETKDGv3()</span>
<span id="cb8-4">params.randomSeed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xa100f</span></span>
<span id="cb8-5"></span>
<span id="cb8-6">tgtConfs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>)</span>
<span id="cb8-7">accum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb8-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tgt <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tgtConfs:</span>
<span id="cb8-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Doing </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tgt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> conformers"</span>)</span>
<span id="cb8-10">    accum[tgt] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb8-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> threadCounts:</span>
<span id="cb8-12">        params.numThreads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tc</span>
<span id="cb8-13">        accum[tgt][tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb8-14">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Doing </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> threads"</span>)</span>
<span id="cb8-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(ms):</span>
<span id="cb8-16">            t1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time()</span>
<span id="cb8-17">            rdDistGeom.EmbedMultipleConfs(m,tgt,params)</span>
<span id="cb8-18">            t2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time()</span>
<span id="cb8-19">            accum[tgt][tc].append(t2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>t1)</span>
<span id="cb8-20">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(accum[tgt][tc])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Doing 100 conformers
Doing 1 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [02:25&lt;00:28,  1.65s/it][16:37:31] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [02:37&lt;00:00,  2.19it/s][16:37:43] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [02:39&lt;00:00,  1.59s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    159.0
Doing 2 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [01:17&lt;00:14,  1.15it/s][16:39:02] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [01:24&lt;00:00,  3.86it/s][16:39:08] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [01:25&lt;00:00,  1.18it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    85.0
Doing 4 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [00:42&lt;00:08,  2.12it/s][16:39:51] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [00:45&lt;00:00,  6.30it/s][16:39:55] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [00:46&lt;00:00,  2.17it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    46.1
Doing 6 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [00:29&lt;00:05,  2.93it/s][16:40:25] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [00:32&lt;00:00,  9.02it/s][16:40:27] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [00:32&lt;00:00,  3.09it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    32.3
Doing 8 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [00:24&lt;00:04,  3.57it/s][16:40:52] UFFTYPER: Unrecognized charge state for atom: 0
 96%|██████████████████████████████████████████████████████████████████████████████████████████████    | 96/100 [00:26&lt;00:00,  8.34it/s][16:40:54] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [00:26&lt;00:00,  3.74it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    26.7
Doing 10 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [00:25&lt;00:04,  3.44it/s][16:41:19] UFFTYPER: Unrecognized charge state for atom: 0
 96%|██████████████████████████████████████████████████████████████████████████████████████████████    | 96/100 [00:26&lt;00:00,  7.85it/s][16:41:21] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [00:27&lt;00:00,  3.67it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    27.2
Doing 400 conformers
Doing 1 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [09:37&lt;01:48,  6.40s/it][16:50:59] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [10:25&lt;00:03,  1.82s/it][16:51:47] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [10:29&lt;00:00,  6.30s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    629.9
Doing 2 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [05:04&lt;00:57,  3.37s/it][16:56:56] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [05:29&lt;00:01,  1.04it/s][16:57:21] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [05:32&lt;00:00,  3.32s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    332.1
Doing 4 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [02:38&lt;00:29,  1.76s/it][17:00:02] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [02:51&lt;00:00,  2.01it/s][17:00:15] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [02:52&lt;00:00,  1.72s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    172.4
Doing 6 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [01:48&lt;00:20,  1.22s/it][17:02:04] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [01:57&lt;00:00,  2.87it/s][17:02:14] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [01:58&lt;00:00,  1.18s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    118.4
Doing 8 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [01:30&lt;00:17,  1.01s/it][17:03:44] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [01:37&lt;00:00,  3.39it/s][17:03:52] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [01:38&lt;00:00,  1.02it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    98.1
Doing 10 threads</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 83%|█████████████████████████████████████████████████████████████████████████████████▎                | 83/100 [01:36&lt;00:18,  1.10s/it][17:05:29] UFFTYPER: Unrecognized charge state for atom: 0
 98%|████████████████████████████████████████████████████████████████████████████████████████████████  | 98/100 [01:44&lt;00:00,  3.17it/s][17:05:37] UFFTYPER: Unrecognized charge state for atom: 8
100%|█████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [01:45&lt;00:00,  1.05s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    105.4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<p>Calculate the relative runtime for each molecule with each threadcount. If everything is scaling perfectly, we’d expect doubling the number of threads to cut the runtime in half.</p>
<div id="89efa499" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb35-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> nc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> accum:</span>
<span id="cb35-3">    factors[nc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb35-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> accum[nc]:</span>
<span id="cb35-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> tc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb35-6">            factors[nc][tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ms)</span>
<span id="cb35-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb35-8">            factors[nc][tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb35-9">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(ms):</span>
<span id="cb35-10">                factors[nc][tc].append(accum[nc][tc][i]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>accum[nc][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>][i])</span>
<span id="cb35-11">            </span></code></pre></div>
</div>
<p>Now plot the results.</p>
<div id="f66fba4d" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb36-2">xp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(threadCounts))]</span>
<span id="cb36-3">widths <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(threadCounts))]</span>
<span id="cb36-4">plt.boxplot([factors[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>][tc] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> threadCounts],positions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>xp,widths<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>widths,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'100 conformers'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb36-5">xp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(threadCounts))]</span>
<span id="cb36-6">plt.boxplot([factors[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>][tc] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> threadCounts],positions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>xp,widths<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>widths,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'400 conformers'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb36-7">plt.xticks(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(threadCounts) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> threadCounts])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb36-8">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'number of threads'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb36-9">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'scaling factor'</span>)</span>
<span id="cb36-10">plt.plot((<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.7</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.3</span>),(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k--'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb36-11">plt.plot((<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.7</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span>),(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k--'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb36-12">plt.plot((<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.7</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.3</span>),(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k--'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb36-13">plt.plot((<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.7</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.3</span>),(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k--'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb36-14">plt.plot((<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.7</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.3</span>),(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k--'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-30-confgen-scaling_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The left-hand boxplot in each column is the results for 100 conformers, the right-hand boxplot is for 400 conformers. The dashed line in each column shows what you would expect for perfect scaling.</p>
<p>We can see that on my machine with these molecules the scaling is pretty good up to about 6 threads but that by the time we get to 10 threads we’re deviating pretty strongly from perfect scaling. In fact, the runtime for 10 threads isn’t massively better than it is for 8 (the number of physical performance cores in my machine). Unsurprisingly, the scaling is better for 400 conformers than it is for 100, but even with 400 conformers it’s not really worth increasing from 8 to 10 threads on my machine.</p>
<p>Based on this analysis, I’d probably go with using either 6 or 8 threads for future confgen work on this machine.</p>



 ]]></description>
  <category>conformers</category>
  <category>questions</category>
  <category>technical</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-08-30-confgen-scaling.html</guid>
  <pubDate>Fri, 29 Aug 2025 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/confgen-scaling-1.png" medium="image" type="image/png" height="76" width="144"/>
</item>
<item>
  <title>How the 2D/3D flag in Mol blocks is used</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-08-22-interpreting-the-2d3d-flag.html</link>
  <description><![CDATA[ 




<p>[This is an expanded version of a section which will be added to the RDKit documentation to clarify an important detail about the way Mol and SD files are parsed.]</p>
<section id="background" class="level1">
<h1>Background</h1>
<p>Mol blocks, Mol files, and SD files can describe 2D or 3D molecules and include a flag (called “dimensional code” in the spec) to indicate whether the coordinates are 2D or 3D. The flag shows up in the second line of the Mol block, and is present in both V2000:</p>
<pre><code>nitrogen
     RDKit          2D

  2  1  0  0  0  0  0  0  0  0999 V2000
    0.0000    0.0000    0.0000 N   0  0  0  0  0  0  0  0  0  0  0  0
   -0.0000   -1.5000    0.0000 N   0  0  0  0  0  0  0  0  0  0  0  0
  1  2  3  0
M  END</code></pre>
<p>and V3000 mol blocks:</p>
<pre><code>nitrogen
     RDKit          2D

  0  0  0  0  0  0  0  0  0  0999 V3000
M  V30 BEGIN CTAB
M  V30 COUNTS 2 1 0 0 0
M  V30 BEGIN ATOM
M  V30 1 N 0.000000 0.000000 0.000000 0
M  V30 2 N -0.000000 -1.500000 0.000000 0
M  V30 END ATOM
M  V30 BEGIN BOND
M  V30 1 3 1 2
M  V30 END BOND
M  V30 END CTAB
M  END</code></pre>
<p>The CTFile specification says the following about this flag: &gt; The “dimensional code” is maintained explicitly. Thus “3D” really means 3D, &gt; although “2D” will be interpreted as 3D if any non-zero Z-coordinates are &gt; found</p>
<p>That’s simple (and logical) enough, but of course in the real world things are more complicated. Files found “in the wild” include every possible combination of 2D/3D flag and 2D/3D coordinates, so we need to decide how to interpret these combinations. Things are made more complicated by the possible presence of wedged bonds in the Mol block. Wedged bonds are typically a signal that something is known about the stereochemistry of the molecule; how do we combine this information with the coordinates?</p>
<blockquote class="blockquote">
<p><em>Aside on 2D vs 3D coordinates</em>: in Mol blocks X, Y, and Z coordinates are always provided (if any of them are missing, they are set to zero). It’s also possible to have 3D coordinates for planar molecules. For the purposes of this discussion, “2D” coordinates means that all Z coordinates are zero, and a “2D” RDKit molecule is one where the (default) conformer is marked as being 2D (i.e.&nbsp;the conformer’s <code>Is3D()</code> method returns <code>False</code>).</p>
</blockquote>
</section>
<section id="what-the-rdkit-does" class="level1">
<h1>What the RDKit does</h1>
<p>The following table describes how the RDKit interprets all possible combinations of dimensionality flag, coordinate dimensionality, and the presence or absence of wedged bonds:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>flag</th>
<th>coords</th>
<th>wedging</th>
<th>result</th>
<th>notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2D</td>
<td>2D</td>
<td>no</td>
<td>2D</td>
<td>no chirality</td>
</tr>
<tr class="even">
<td>3D</td>
<td>2D</td>
<td>no</td>
<td>3D</td>
<td>no chirality</td>
</tr>
<tr class="odd">
<td>3D</td>
<td>3D</td>
<td>no</td>
<td>3D</td>
<td>chirality from coords</td>
</tr>
<tr class="even">
<td>2D</td>
<td>3D</td>
<td>no</td>
<td>3D</td>
<td>chirality from coords</td>
</tr>
<tr class="odd">
<td>2D</td>
<td>2D</td>
<td>yes</td>
<td>2D</td>
<td>chirality from wedging</td>
</tr>
<tr class="even">
<td>3D</td>
<td>2D</td>
<td>yes</td>
<td>2D</td>
<td>chirality from wedging</td>
</tr>
<tr class="odd">
<td>3D</td>
<td>3D</td>
<td>yes</td>
<td>3D</td>
<td>chirality from coords</td>
</tr>
<tr class="even">
<td>2D</td>
<td>3D</td>
<td>yes</td>
<td>3D</td>
<td>chirality from coords</td>
</tr>
</tbody>
</table>
<p>This is consistent with what the specification says except for the case where the 3D flag is set for 2D coordinates and a wedge is present, in which case we ignore the 3D flag, mark the conformer as 2D, and set the stereochemistry based on the wedging.</p>
<p>In cases where no 2D/3D flag is provided, the default value of the flag is 2D.</p>
<p>In a 2D structure, wedging is interpreted as a signal to indicate that stereochemistry is present and to indicate what the stereochemistry is (i.e.&nbsp;the stereochemistry is determined based on the 2D coordinates and the direction of the wedge).</p>
<p>When 3D coordinates are provided, stereochemistry is perceived from the coordinates themselves. If wedging is also present it will be ignored; the 3D signal is “stronger” than the wedging signal. The exception to this rule is <a href="https://www.rdkit.org/docs/RDKit_Book.html#atropisomeric-bonds">atropisomeric bonds</a>, where the wedged bond indicates that atropisomerism should be perceived, but the direction of the wedge is ignored.</p>


</section>

 ]]></description>
  <category>documentation</category>
  <category>technical</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-08-22-interpreting-the-2d3d-flag.html</guid>
  <pubDate>Thu, 21 Aug 2025 22:00:00 GMT</pubDate>
</item>
<item>
  <title>A BRICS tutorial</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial.html</link>
  <description><![CDATA[ 




<p>This post is a short tutorial on using the RDKit’s BRICS implementation, expanding a bit on <a href="https://www.rdkit.org/docs/GettingStartedInPython.html#brics-implementation">what’s in the documentation</a>.</p>
<p>BRICS is a method for fragmenting molecules into smaller pieces along bonds which are likely to be synthetically accessible. The original paper describing the method is:</p>
<blockquote class="blockquote">
<p>Degen, J.; Wegscheid-Gerlach, C.; Zaliani, A.; Rarey, M. On the Art of Compiling and Using “Drug-Like” Chemical Fragment Spaces. ChemMedChem 2008, 3 (10), 1503–1507. https://chemistry-europe.onlinelibrary.wiley.com/doi/full/10.1002/cmdc.200800178</p>
</blockquote>
<div id="e84077fe" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdDepictor</span>
<span id="cb1-3">rdDepictor.SetPreferCoordGen(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BRICS</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb1-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.03.5</code></pre>
</div>
</div>
<section id="brics-basics" class="level1">
<h1>BRICS basics</h1>
<div id="3c89a385" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">esomeprazole <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(OC)c3C)nc2c1'</span>)</span>
<span id="cb3-2">rdDepictor.Compute2DCoords(esomeprazole)</span>
<span id="cb3-3">esomeprazole</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="0aa07efd" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">pieces <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BRICS.BRICSDecompose(esomeprazole)</span>
<span id="cb4-2">pieces</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>{'[14*]c1ncc(C)c([16*])c1C',
 '[3*]OC',
 '[8*]C[S+]([O-])c1nc2cc([16*])ccc2[nH]1'}</code></pre>
</div>
</div>
<div id="2a2071ea" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">Draw.MolsToGridImage([Chem.MolFromSmiles(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pieces])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The atom environments and connection rules can be found in Scheme 2 of the BRICS paper:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chemistry-europe.onlinelibrary.wiley.com/cms/asset/797b1262-e8d9-42ad-b6b1-ba85878a35de/msch002.gif" class="img-fluid figure-img"></p>
<figcaption>BRICS connection rules</figcaption>
</figure>
</div>
<p>Note that the RDKit BRICS implementation does not contain a definition of L2, a three connected N with a lone pair. We incorporated that with L5 in a more general definition of amine. In the RDKit implementation L5 can connect with L1, L4, L12, L13, L14, L15, and L16. We also added a few additional connection definitions. The actual SMARTS used in the RDKit can be found in <a href="https://github.com/rdkit/rdkit-orig/blob/57058c886a49cc597b0c40641a28697ee3a57aee/Code/GraphMol/ChemTransforms/MolFragmenter.cpp#L104">MolFragmenter.cpp</a> along with the and the <a href="https://github.com/rdkit/rdkit-orig/blob/57058c886a49cc597b0c40641a28697ee3a57aee/Code/GraphMol/ChemTransforms/MolFragmenter.cpp#L205">connection rules</a>. There is also a Python version of the definitions in <a href="https://github.com/rdkit/rdkit-orig/blob/master/rdkit/Chem/BRICS.py">BRICS.py</a>, but this is no longer used and may not exactly the match the C++ implementation.</p>
<p>The RDKit’s BRICS implementation includes the ability to create new molecules by stitching fragments together according to the connection rules above. Here’s an illustration of that showing all the molecules that can be formed by combining the three fragments from esomeprazole using the BRICS connection rules with a maximum enumeration depth of 2:</p>
<div id="d872b9b6" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">piecems <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromSmiles(smi) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pieces]</span>
<span id="cb7-2">builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BRICS.BRICSBuild(piecems, maxDepth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, scrambleReagents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb7-3">ms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(builder)</span>
<span id="cb7-4">Draw.MolsToGridImage(ms)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="enumerating-a-larger-set-of-molecules" class="level1">
<h1>Enumerating a larger set of molecules</h1>
<p>Here I grab the ChEMBL molecules that were most similar to esomeprazole, fragment them together with esomeprazole, and then explore some of the resulting molecules.</p>
<section id="aside-grabbing-similar-molecules-from-chembl" class="level2">
<h2 class="anchored" data-anchor-id="aside-grabbing-similar-molecules-from-chembl">Aside: grabbing similar molecules from ChEMBL</h2>
<p>Here’s the query I executed and the results returned:</p>
<pre><code>chembl_35=# select chembl_id,m,similarity from get_mfp2_neighbors('COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(OC)c3C)nc2c1') join chembl_id_lookup on (molregno=entity_id and entity_type='COMPOUND') join molecule_hierarchy using (molregno) where molregno=parent_molregno and similarity&lt;1 order by similarity desc limit 20;
   chembl_id   |                              m                              |     similarity     
---------------+-------------------------------------------------------------+--------------------
 CHEMBL9890    | COc1c(C)cnc(C[S+]([O-])c2nc3cc(OC(F)F)ccc3[nH]2)c1C         | 0.8333333333333334
 CHEMBL5089043 | COc1c(C)cnc(C[S@@+]([O-])c2nc3cc(OC(F)F)ccc3[nH]2)c1C       | 0.8333333333333334
 CHEMBL5076667 | COc1c(C)cnc(C[S@+]([O-])c2nc3cc(OC(F)F)ccc3[nH]2)c1C        | 0.8333333333333334
 CHEMBL3527071 | COc1ccc2[nH]c([S+]([O-])Cc3ncc(CO)c(OC)c3C)nc2c1            | 0.8148148148148148
 CHEMBL4525760 | COc1ccc2[nH]c([S+]([O-])Cc3ncc(C(=O)O)c(OC)c3C)nc2c1        |                0.8
 CHEMBL10184   | COc1c(C)cnc(C[S+]([O-])c2nc3ccccc3[nH]2)c1C                 | 0.7692307692307693
 CHEMBL9430    | COc1cnc(C[S+]([O-])c2nc3cc(OC(F)F)ccc3[nH]2)c(C)c1OC        | 0.7288135593220338
 CHEMBL59068   | COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(N(C)C)c3Cl)nc2c1         | 0.7192982456140351
 CHEMBL138250  | COc1c(C)cnc(C[S+]([O-])c2nc3cscc3[nH]2)c1C                  | 0.7169811320754716
 CHEMBL5070031 | COc1ccc2[nH]c([S@@+]([O-])Cc3nccc(OC)c3C)nc2c1              | 0.7090909090909091
 CHEMBL10061   | COc1cnc(C[S+]([O-])c2nc3cc(OC(F)(F)C(F)F)ccc3[nH]2)c(C)c1OC | 0.6935483870967742
 CHEMBL1475252 | COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(OC)c3C)nc2n1             | 0.6909090909090909
 CHEMBL9992    | COc1cnc(C[S+]([O-])c2nc3cc(OCC(F)(F)F)ccc3[nH]2)c(C)c1OC    | 0.6885245901639344
 CHEMBL440676  | COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(N4CCCC4)c3Cl)nc2c1       | 0.6721311475409836
 CHEMBL20315   | COc1ccc2[nH]c([S+]([O-])Cc3c(N)cc(C)c(OC)c3C)nc2c1          | 0.6666666666666666
 CHEMBL59784   | COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(N4CCCCC4)c3Cl)nc2c1      | 0.6612903225806451
 CHEMBL144285  | COc1ccc2[nH]c([S+]([O-])Cc3nccc(OC(C)C)c3C)nc2c1            |               0.65
 CHEMBL341550  | COc1ccc(-c2scc3[nH]c([S+]([O-])Cc4ncc(C)c(OC)c4C)nc23)cc1   |               0.65
 CHEMBL1796802 | COc1cc2nc([S+]([O-])Cc3ncc(C)c(OC)c3C)[nH]c2cc1NC(C)=O      | 0.6451612903225806
 CHEMBL58833   | COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(N4CCOCC4)c3Cl)nc2c1      |           0.640625
(20 rows)
</code></pre>
<p>the very useful <code>get_mfp2_neighbors()</code> function is from <a href="https://www.rdkit.org/docs/Cartridge.html#loading-chembl">the cartridge documentation</a>.</p>
<p>Here’s the set of molecules we’ll use:</p>
<div id="cb134904" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">smis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(OC)c3C)nc2c1</span></span>
<span id="cb9-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1c(C)cnc(C[S+]([O-])c2nc3cc(OC(F)F)ccc3[nH]2)c1C</span></span>
<span id="cb9-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3ncc(CO)c(OC)c3C)nc2c1</span></span>
<span id="cb9-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3ncc(C(=O)O)c(OC)c3C)nc2c1</span></span>
<span id="cb9-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1c(C)cnc(C[S+]([O-])c2nc3ccccc3[nH]2)c1C</span></span>
<span id="cb9-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1cnc(C[S+]([O-])c2nc3cc(OC(F)F)ccc3[nH]2)c(C)c1OC</span></span>
<span id="cb9-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(N(C)C)c3Cl)nc2c1</span></span>
<span id="cb9-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1c(C)cnc(C[S+]([O-])c2nc3cscc3[nH]2)c1C</span></span>
<span id="cb9-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3nccc(OC)c3C)nc2c1</span></span>
<span id="cb9-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1cnc(C[S+]([O-])c2nc3cc(OC(F)(F)C(F)F)ccc3[nH]2)c(C)c1OC</span></span>
<span id="cb9-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(OC)c3C)nc2n1</span></span>
<span id="cb9-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1cnc(C[S+]([O-])c2nc3cc(OCC(F)(F)F)ccc3[nH]2)c(C)c1OC</span></span>
<span id="cb9-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(N4CCCC4)c3Cl)nc2c1</span></span>
<span id="cb9-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3c(N)cc(C)c(OC)c3C)nc2c1</span></span>
<span id="cb9-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(N4CCCCC4)c3Cl)nc2c1</span></span>
<span id="cb9-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3nccc(OC(C)C)c3C)nc2c1</span></span>
<span id="cb9-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc(-c2scc3[nH]c([S+]([O-])Cc4ncc(C)c(OC)c4C)nc23)cc1</span></span>
<span id="cb9-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1cc2nc([S+]([O-])Cc3ncc(C)c(OC)c3C)[nH]c2cc1NC(C)=O</span></span>
<span id="cb9-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">COc1ccc2[nH]c([S+]([O-])Cc3ncc(C)c(N4CCOCC4)c3Cl)nc2c1'''</span>.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb9-20">mols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromSmiles(smi) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smis]</span>
<span id="cb9-21">Draw.MolsToGridImage(mols,molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Fragment all the molecules and keep the unique fragments:</p>
<div id="dd009376" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">allfrags<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb10-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mols:</span>
<span id="cb10-3">    pieces <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BRICS.BRICSDecompose(m)</span>
<span id="cb10-4">    allfrags.update(pieces)</span>
<span id="cb10-5">allfrags</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>{'[1*]C(C)=O',
 '[14*]c1ncc(C)c([16*])c1C',
 '[14*]c1ncc(C)c([16*])c1Cl',
 '[14*]c1ncc([16*])c([16*])c1C',
 '[14*]c1nccc([16*])c1C',
 '[16*]c1c(C)cc(N)c([16*])c1C',
 '[16*]c1ccc([16*])cc1',
 '[3*]OC',
 '[3*]OC(F)F',
 '[3*]O[3*]',
 '[4*]C(C)C',
 '[4*]C(F)(F)C(F)F',
 '[4*]CC(F)(F)F',
 '[5*]N(C)C',
 '[5*]N1CCCC1',
 '[5*]N1CCCCC1',
 '[5*]N1CCOCC1',
 '[5*]N[5*]',
 '[6*]C(=O)O',
 '[8*]CO',
 '[8*]C[S+]([O-])c1nc2c([14*])scc2[nH]1',
 '[8*]C[S+]([O-])c1nc2cc([16*])c([16*])cc2[nH]1',
 '[8*]C[S+]([O-])c1nc2cc([16*])ccc2[nH]1',
 '[8*]C[S+]([O-])c1nc2ccccc2[nH]1',
 '[8*]C[S+]([O-])c1nc2cscc2[nH]1',
 '[8*]C[S+]([O-])c1nc2nc([14*])ccc2[nH]1'}</code></pre>
</div>
</div>
<p>We can then recombine fragments to produce new molecules using <code>BRICS.BRICSBuild</code>:</p>
<div id="477d859f" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb12-2">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>)</span>
<span id="cb12-3"></span>
<span id="cb12-4">fragms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromSmiles(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> allfrags]</span>
<span id="cb12-5">builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BRICS.BRICSBuild(fragms)</span></code></pre></div>
</div>
<p>The result is a generator:</p>
<div id="0d3da57a" class="cell" data-scrolled="true" data-execution_count="20">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">builder</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>&lt;generator object BRICSBuild at 0x785401fb8040&gt;</code></pre>
</div>
</div>
<p>Here’s what the first 16 results look like:</p>
<div id="0edec122" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">newMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(builder) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)]</span>
<span id="cb15-2">Draw.MolsToGridImage(newMols,molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s filter out the everything that doesn’t have exactly one sulfoxide:</p>
<div id="73db0750" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">qry <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmarts(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'S-O'</span>)</span>
<span id="cb16-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(gen):</span>
<span id="cb16-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> res <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> gen:</span>
<span id="cb16-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(res.GetSubstructMatches(qry)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb16-5">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">yield</span> res</span>
<span id="cb16-6"></span>
<span id="cb16-7">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>)</span>
<span id="cb16-8">builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BRICS.BRICSBuild(fragms)</span>
<span id="cb16-9">newMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(builder)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)]</span>
<span id="cb16-10">Draw.MolsToGridImage(newMols,molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)    </span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ef9652c3" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb17-2">builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BRICS.BRICSBuild(fragms)</span>
<span id="cb17-3">newMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(builder)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)]</span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># order by number of atoms;</span></span>
<span id="cb17-5">newMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [newMols[y] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (x,y) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>([(m.GetNumAtoms(),i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i,m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(newMols)])]</span>
<span id="cb17-6">Draw.MolsToGridImage(newMols[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>],molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)    </span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="providing-a-seed-to-the-enumeration" class="level2">
<h2 class="anchored" data-anchor-id="providing-a-seed-to-the-enumeration">Providing a seed to the enumeration</h2>
<p>Another option in the BRICS builder is to provide one or more seeds that must be present in every output molecule. Here’s an example of how to do that using the scaffold of esomeprazole along with a version of the scaffold where the N in the second ring is replaced by a C:</p>
<div id="cf14da7f" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">seeds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Chem.MolFromSmiles(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c19ncc(C)c([16*])c1C.C9[S+]([O-])c1nc2cc([16*])ccc2[nH]1'</span>,</span>
<span id="cb18-2">                                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c19ccc(C)c([16*])c1C.C9[S+]([O-])c1nc2cc([16*])ccc2[nH]1'</span>,)]</span>
<span id="cb18-3"></span>
<span id="cb18-4">Draw.MolsToGridImage(seeds)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now do the enumeration using those seeds:</p>
<div id="0f9a5128" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>)</span>
<span id="cb19-2">builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BRICS.BRICSBuild(fragms,seeds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seeds)</span>
<span id="cb19-3">newMols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(builder)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)]</span>
<span id="cb19-4">Draw.MolsToGridImage(newMols,molsPerRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)    </span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<figure class="figure">
<p><img src="https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Doing enumeration providing seeds that are this specific is similar in ways to doing enumeration using the <a href="https://greglandrum.github.io/rdkit-blog/posts/2022-03-14-rgd-and-molzip.html">results of R-group decomposition</a></p>


</section>
</section>

 ]]></description>
  <category>documentation</category>
  <category>tutorial</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-08-15-BRICS-tutorial.html</guid>
  <pubDate>Thu, 14 Aug 2025 22:00:00 GMT</pubDate>
  <media:content url="https://greglandrum.github.io/rdkit-blog/posts/images/blog/brics-tutorial-1.png" medium="image" type="image/png" height="115" width="144"/>
</item>
<item>
  <title>Controlling the RDKit’s logging behavior</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-08-10-controlling-logging.html</link>
  <description><![CDATA[ 




<p>One reasonably frequently asked question is how to disable (easy) or capture (a bit trickier) the log messages that the RDKit sends to the console. There are a few ways to do this, so it seemed worthwhile to do a blog post, particularl since I tend to forget how to do the part where the logs are actually captured.</p>
<p>Here are a couple of other sources of information on the topic: - Earlier blog post: <a href="https://greglandrum.github.io/rdkit-blog/posts/2024-02-23-custom-transformations-and-logging.html">https://greglandrum.github.io/rdkit-blog/posts/2024-02-23-custom-transformations-and-logging.html</a> - A discussion topic: <a href="https://github.com/rdkit/rdkit/discussions/8299">https://github.com/rdkit/rdkit/discussions/8299</a></p>
<p>There’s considerably more information on how to use Python’s logging module in the <a href="https://docs.python.org/3/howto/logging.html">Python docs</a>.</p>
<div id="61850596" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdBase</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.03.5</code></pre>
</div>
</div>
<div id="14c781ea" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CO(C)C'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[05:47:43] Explicit valence for atom # 1 O, 3, is greater than permitted</code></pre>
</div>
</div>
<p>The easiest thing to do is just disable all logging output:</p>
<div id="5b656d12" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">rdBase.DisableLog(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rdApp.*'</span>)</span>
<span id="cb5-2">Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CO(C)C'</span>)</span></code></pre></div>
</div>
<p>You can re-enable it later:</p>
<div id="9c8290a8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">rdBase.EnableLog(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rdApp.*'</span>)</span>
<span id="cb6-2">Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CO(C)C'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[05:47:43] Explicit valence for atom # 1 O, 3, is greater than permitted</code></pre>
</div>
</div>
<p>It’s easier (and perhaps safer) to disable the logging output using a context manager:</p>
<div id="144ff8df" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> rdBase.BlockLogs() <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> blk:</span>
<span id="cb8-2">    Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CO(C)C'</span>)</span></code></pre></div>
</div>
<p>Outside of the context manager, the logging is still active:</p>
<div id="db0889a8" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CO(C)C'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[05:47:43] Explicit valence for atom # 1 O, 3, is greater than permitted</code></pre>
</div>
</div>
<p>Capturing the log messages requires a bit more work, but isn’t hard.</p>
<p>We start by telling the RDKit to use Python’s logging framework:</p>
<div id="5c1df2ab" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">rdBase.LogToPythonLogger()</span></code></pre></div>
</div>
<p>And now configure the logging using standard Python logging features:</p>
<div id="d72a0e8e" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb12-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StringIO</span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Here we will capture the log output in a StringIO object</span></span>
<span id="cb12-5">sio <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StringIO()</span>
<span id="cb12-6">hdlr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logging.StreamHandler(sio)</span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and change the way the messages are formatted:</span></span>
<span id="cb12-9">fmt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logging.Formatter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%(name)s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%(levelname)s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%(message)s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb12-10">hdlr.setFormatter(fmt)</span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove any existing handlers from the RDKit logger. This is important if we are working in the notebook:</span></span>
<span id="cb12-13">rdkit.logger.handlers.clear()</span>
<span id="cb12-14">rdkit.logger.addHandler(hdlr)</span></code></pre></div>
</div>
<p>Now errors no longer go to the console:</p>
<div id="93ed700e" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CO(C)C'</span>)</span></code></pre></div>
</div>
<p>But we can access them from the StringIO object:</p>
<div id="e1e66e86" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(sio.getvalue())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>rdkit - ERROR - [05:47:43] Explicit valence for atom # 1 O, 3, is greater than permitted
</code></pre>
</div>
</div>
<p>It’s also easy to log to a file:</p>
<div id="e2acaf68" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tempfile</span>
<span id="cb16-2">tf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tempfile.NamedTemporaryFile()</span>
<span id="cb16-3">tf.close() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&lt;- close the file or we will get an error on Windows</span></span>
<span id="cb16-4"></span>
<span id="cb16-5">hdlr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logging.FileHandler(tf.name)</span>
<span id="cb16-6"></span>
<span id="cb16-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and change the way the messages are formatted:</span></span>
<span id="cb16-8">fmt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logging.Formatter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%(name)s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%(levelname)s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%(message)s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb16-9">hdlr.setFormatter(fmt)</span>
<span id="cb16-10"></span>
<span id="cb16-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove any existing handlers from the RDKit logger. This is important if we are working in the notebook:</span></span>
<span id="cb16-12">rdkit.logger.handlers.clear()</span>
<span id="cb16-13">rdkit.logger.addHandler(hdlr)</span></code></pre></div>
</div>
<div id="1ade2b3c" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CO(C)C'</span>)</span></code></pre></div>
</div>
<div id="0ff908ee" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(tf.name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> inf:</span>
<span id="cb18-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(inf.read())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>rdkit - ERROR - [05:47:43] Explicit valence for atom # 1 O, 3, is greater than permitted
</code></pre>
</div>
</div>
<p>It’s definitely worth taking a look through Python’s <a href="https://docs.python.org/3/howto/logging.html">logging HowTo</a> for more info on working with logging.</p>



 ]]></description>
  <category>documentation</category>
  <category>technical</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-08-10-controlling-logging.html</guid>
  <pubDate>Sat, 09 Aug 2025 22:00:00 GMT</pubDate>
</item>
<item>
  <title>An LLM experiment</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-07-31-an-llm-experiment-1.html</link>
  <description><![CDATA[ 




<section id="what-is-this-post" class="level1">
<h1>What is this post?</h1>
<p>On the bus to the CADD GRC, Nadine suggested that I try using Copilot to generate ideas for an RDKit blog post. It seemed like an interesting experiment and I’m heading out for a couple of weeks of vacation, so I thought I’d go ahead and give it a try. This post is the result.</p>
<p>What’s below is the result of a chat session with Copilot, using Claude Sonnet 4. The initial prompt was: <code>suggest a topic for a new RDKit blog post</code>. I made a couple of small edits at the very end, but otherwise the text is exactly as generated by the LLM. I hope to come back to this at some point in the future and dig into the code and content in detail, but right now I need to go pack my gear to head to the mountains for a couple of weeks of climbing and mountaineering.</p>
<p>The actual chat session is <a href="https://raw.githubusercontent.com/greglandrum/rdkit_blog/refs/heads/master/notebooks/results/chat_20250726.json">available here</a>.</p>
<p>I’m going to go ahead and upload this and post it sometime around July 31st (or whenever I have decent internet access). There won’t be a new blog post next week, but I will be back the week of August 11th.</p>
</section>
<section id="rdkit-and-large-language-models-chemical-structure-text-integration-in-the-ai-era" class="level1">
<h1>RDKit and Large Language Models: Chemical Structure-Text Integration in the AI Era</h1>
<p>The landscape of artificial intelligence has been dramatically transformed by the rise of large language models (LLMs), and the field of chemistry is no exception. From GPT-4’s ability to reason about molecular structures to specialized chemistry-focused models like ChemCrow and Galactica, we’re witnessing an unprecedented convergence of natural language processing and chemical informatics. This presents both exciting opportunities and unique challenges for computational chemists and cheminformatics practitioners.</p>
<p>The RDKit, as one of the most widely-used open-source cheminformatics toolkits, finds itself at a fascinating intersection in this new landscape. While LLMs excel at processing and generating text-based representations of chemical knowledge, they often struggle with the precise, structure-based reasoning that is second nature to dedicated cheminformatics tools. Conversely, traditional cheminformatics approaches excel at molecular manipulation and property calculation but have limited ability to understand and generate natural language descriptions of chemical concepts.</p>
<p>This complementary relationship suggests powerful synergies. LLMs can help democratize access to chemical knowledge by translating between technical chemical representations and human-readable explanations. Meanwhile, tools like RDKit provide the essential chemical “reality check” - validating molecular structures, calculating properties, and ensuring that AI-generated chemistry actually makes sense from a chemical perspective.</p>
<p>In this post, we’ll explore practical approaches for integrating RDKit with modern LLM workflows. We’ll cover how to:</p>
<ul>
<li>Use RDKit to validate and process chemical structures generated by LLMs</li>
<li>Convert RDKit molecular representations into rich text descriptions suitable for training or prompting LLMs</li>
<li>Build robust pipelines that combine the strengths of both approaches</li>
<li>Handle the unique challenges that arise when bridging symbolic chemical representations with statistical language models</li>
</ul>
<p>The goal is not to replace either approach, but rather to show how they can work together to create more powerful, reliable, and accessible chemical AI systems. Whether you’re building a chemical chatbot, curating training data for a chemistry-focused LLM, or simply trying to make your chemical data more searchable and interpretable, the patterns we’ll explore should provide a solid foundation.</p>
<p>Let’s start by setting up our environment and exploring some basic integration patterns.</p>
<div id="1759d6cc" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Standard RDKit imports</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw, Descriptors, rdMolDescriptors</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem.Draw <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IPythonConsole</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdBase</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"RDKit version: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rdBase<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rdkitVersion<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generated: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>asctime()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RDKit version: 2025.03.4
Generated: Sat Jul 26 09:53:54 2025</code></pre>
</div>
</div>
<div id="168a2f03" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Additional imports for LLM integration examples</span></span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List, Dict, Optional, Tuple</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb3-7">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ignore'</span>)</span></code></pre></div>
</div>
</section>
<section id="structure-validation-rdkit-as-the-chemical-reality-check" class="level1">
<h1>Structure Validation: RDKit as the Chemical Reality Check</h1>
<p>One of the most immediate and practical applications of RDKit in LLM workflows is structure validation. LLMs, while impressive at generating chemical-looking text, often produce invalid SMILES strings, impossible molecular structures, or chemically nonsensical compounds. RDKit provides robust validation capabilities that can catch these errors and provide meaningful feedback.</p>
<p>Let’s explore some common validation scenarios and how to handle them systematically.</p>
<div id="bb7a2e15" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> validate_smiles_with_details(smiles: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>]:</span>
<span id="cb4-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Comprehensive SMILES validation with detailed feedback.</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns a dictionary with validation results and diagnostic information.</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb4-6">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb4-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: smiles,</span>
<span id="cb4-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb4-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mol'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb4-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb4-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>: [],</span>
<span id="cb4-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>: [],</span>
<span id="cb4-13">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>: {}</span>
<span id="cb4-14">    }</span>
<span id="cb4-15">    </span>
<span id="cb4-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Basic parsing</span></span>
<span id="cb4-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-18">        mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb4-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb4-20">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>].append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Invalid SMILES: Could not parse structure"</span>)</span>
<span id="cb4-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result</span>
<span id="cb4-22">        </span>
<span id="cb4-23">        result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mol'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mol</span>
<span id="cb4-24">        result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb4-25">        </span>
<span id="cb4-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get canonical SMILES</span></span>
<span id="cb4-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-28">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb4-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb4-30">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>].append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Could not generate canonical SMILES"</span>)</span>
<span id="cb4-31">        </span>
<span id="cb4-32">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Basic chemical checks</span></span>
<span id="cb4-33">        num_atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mol.GetNumAtoms()</span>
<span id="cb4-34">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> num_atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb4-35">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>].append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Empty molecule"</span>)</span>
<span id="cb4-36">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb4-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> num_atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>:</span>
<span id="cb4-38">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>].append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Very large molecule (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>num_atoms<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> atoms)"</span>)</span>
<span id="cb4-39">        </span>
<span id="cb4-40">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for unusual valences</span></span>
<span id="cb4-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-42">            Chem.SanitizeMol(mol)</span>
<span id="cb4-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb4-44">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>].append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sanitization failed: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-45">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb4-46">        </span>
<span id="cb4-47">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate basic properties if valid</span></span>
<span id="cb4-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>]:</span>
<span id="cb4-49">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-50">                result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb4-51">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms'</span>: num_atoms,</span>
<span id="cb4-52">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_bonds'</span>: mol.GetNumBonds(),</span>
<span id="cb4-53">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>: Descriptors.MolWt(mol),</span>
<span id="cb4-54">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>: rdMolDescriptors.CalcNumRings(mol),</span>
<span id="cb4-55">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>: rdMolDescriptors.CalcNumAromaticRings(mol)</span>
<span id="cb4-56">                }</span>
<span id="cb4-57">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb4-58">                result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>].append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Property calculation failed: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-59">        </span>
<span id="cb4-60">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb4-61">        result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>].append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Parsing error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-62">    </span>
<span id="cb4-63">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result</span>
<span id="cb4-64"></span>
<span id="cb4-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test the function with some examples</span></span>
<span id="cb4-66">test_smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb4-67">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCO"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ethanol - valid</span></span>
<span id="cb4-68">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c1ccccc1"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># benzene - valid</span></span>
<span id="cb4-69">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C[C@H](N)C(=O)O"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># alanine - valid with stereochemistry</span></span>
<span id="cb4-70">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCO[invalid]"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># invalid SMILES</span></span>
<span id="cb4-71">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1CCC"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># invalid - unclosed ring</span></span>
<span id="cb4-72">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C(C)(C)(C)(C)C"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># carbon with too many bonds</span></span>
<span id="cb4-73">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># empty string</span></span>
<span id="cb4-74">]</span>
<span id="cb4-75"></span>
<span id="cb4-76"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SMILES Validation Examples:"</span>)</span>
<span id="cb4-77"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb4-78"></span>
<span id="cb4-79"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test_smiles:</span>
<span id="cb4-80">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> validate_smiles_with_details(smiles)</span>
<span id="cb4-81">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">SMILES: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-82">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Valid: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-83">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]:</span>
<span id="cb4-84">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Canonical: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-85">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>]:</span>
<span id="cb4-86">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Errors: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-87">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>]:</span>
<span id="cb4-88">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Warnings: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-89">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>]:</span>
<span id="cb4-90">        props <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>]</span>
<span id="cb4-91">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Properties: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>props[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> atoms, MW=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>props[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SMILES Validation Examples:
==================================================

SMILES: CCO
Valid: True
Canonical: CCO
Properties: 3 atoms, MW=46.1

SMILES: c1ccccc1
Valid: True
Canonical: c1ccccc1
Properties: 6 atoms, MW=78.1

SMILES: C[C@H](N)C(=O)O
Valid: True
Canonical: C[C@H](N)C(=O)O
Properties: 6 atoms, MW=89.1

SMILES: CCO[invalid]
Valid: False
Errors: Invalid SMILES: Could not parse structure

SMILES: C1CCC
Valid: False
Errors: Invalid SMILES: Could not parse structure

SMILES: C(C)(C)(C)(C)C
Valid: False
Errors: Invalid SMILES: Could not parse structure

SMILES: 
Valid: False
Errors: Empty molecule</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:53:54] SMILES Parse Error: syntax error while parsing: CCO[invalid]
[09:53:54] SMILES Parse Error: check for mistakes around position 5:
[09:53:54] CCO[invalid]
[09:53:54] ~~~~^
[09:53:54] SMILES Parse Error: Failed parsing SMILES 'CCO[invalid]' for input: 'CCO[invalid]'
[09:53:54] SMILES Parse Error: unclosed ring for input: 'C1CCC'
[09:53:54] Explicit valence for atom # 0 C, 5, is greater than permitted</code></pre>
</div>
</div>
<section id="batch-validation-for-llm-outputs" class="level2">
<h2 class="anchored" data-anchor-id="batch-validation-for-llm-outputs">Batch Validation for LLM Outputs</h2>
<p>When working with LLMs that generate multiple chemical structures, you’ll often need to validate batches of SMILES strings. Here’s a more robust approach that can handle large datasets efficiently:</p>
<div id="3bab073e" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> batch_validate_structures(smiles_list: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>], </span>
<span id="cb7-2">                             include_properties: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.DataFrame:</span>
<span id="cb7-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Validate a batch of SMILES strings and return results as a DataFrame.</span></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Useful for processing LLM outputs or curating chemical datasets.</span></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb7-7">    results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-8">    </span>
<span id="cb7-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(smiles_list):</span>
<span id="cb7-10">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> validate_smiles_with_details(smiles)</span>
<span id="cb7-11">        </span>
<span id="cb7-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flatten the result for DataFrame storage</span></span>
<span id="cb7-13">        row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb7-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>: i,</span>
<span id="cb7-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input_smiles'</span>: smiles,</span>
<span id="cb7-16">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>: result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>],</span>
<span id="cb7-17">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>: result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>],</span>
<span id="cb7-18">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_errors'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>]),</span>
<span id="cb7-19">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_warnings'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>]),</span>
<span id="cb7-20">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error_messages'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; '</span>.join(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb7-21">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warning_messages'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; '</span>.join(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>]) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb7-22">        }</span>
<span id="cb7-23">        </span>
<span id="cb7-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add properties if requested and available</span></span>
<span id="cb7-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> include_properties <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>]:</span>
<span id="cb7-26">            row.update(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>])</span>
<span id="cb7-27">        </span>
<span id="cb7-28">        results.append(row)</span>
<span id="cb7-29">    </span>
<span id="cb7-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pd.DataFrame(results)</span>
<span id="cb7-31"></span>
<span id="cb7-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate some LLM-generated SMILES (mix of valid and invalid)</span></span>
<span id="cb7-33">llm_generated_smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb7-34">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ibuprofen-like</span></span>
<span id="cb7-35">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1=CC=C(C=C1)C(=O)O"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># benzoic acid</span></span>
<span id="cb7-36">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"invalidsmiles123"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clearly invalid</span></span>
<span id="cb7-37">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1=CC=CC=C1"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># benzene</span></span>
<span id="cb7-38">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCO"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ethanol</span></span>
<span id="cb7-39">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C[C@H](N)C(=O)O"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># L-alanine</span></span>
<span id="cb7-40">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1CCC1C"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># methylcyclopropane</span></span>
<span id="cb7-41">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c1ccccc1c2ccccc2"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># biphenyl</span></span>
<span id="cb7-42">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCCCCCCCCCCCCCCCO"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># long-chain alcohol</span></span>
<span id="cb7-43">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1=CC=C2C(=C1)C=CC=C2"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># naphthalene</span></span>
<span id="cb7-44">]</span>
<span id="cb7-45"></span>
<span id="cb7-46"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Processing batch of LLM-generated SMILES..."</span>)</span>
<span id="cb7-47">df_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> batch_validate_structures(llm_generated_smiles)</span>
<span id="cb7-48"></span>
<span id="cb7-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display summary statistics</span></span>
<span id="cb7-50"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Batch Validation Summary:"</span>)</span>
<span id="cb7-51"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Total structures: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df_results)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-52"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Valid structures: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>df_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-53"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Invalid structures: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>df_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-54"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Structures with warnings: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>(df_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_warnings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-55"></span>
<span id="cb7-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show the results table</span></span>
<span id="cb7-57"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Detailed Results:"</span>)</span>
<span id="cb7-58">display_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input_smiles'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms'</span>]</span>
<span id="cb7-59">available_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [col <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> col <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> display_cols <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> col <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> df_results.columns]</span>
<span id="cb7-60"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(df_results[available_cols].to_string(index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>))</span>
<span id="cb7-61"></span>
<span id="cb7-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show error details for invalid structures</span></span>
<span id="cb7-63">invalid_structures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_results[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>df_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>]]</span>
<span id="cb7-64"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(invalid_structures) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb7-65">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Error Details for Invalid Structures:"</span>)</span>
<span id="cb7-66">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> invalid_structures.iterrows():</span>
<span id="cb7-67">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input_smiles'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">': </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error_messages'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processing batch of LLM-generated SMILES...

Batch Validation Summary:
Total structures: 10
Valid structures: 9
Invalid structures: 1
Structures with warnings: 0

Detailed Results:
                 input_smiles  is_valid           canonical_smiles  molecular_weight  num_atoms
CC(C)CC1=CC=C(C=C1)C(C)C(=O)O      True CC(C)Cc1ccc(C(C)C(=O)O)cc1           206.285       15.0
          C1=CC=C(C=C1)C(=O)O      True             O=C(O)c1ccccc1           122.123        9.0
             invalidsmiles123     False                       None               NaN        NaN
                  C1=CC=CC=C1      True                   c1ccccc1            78.114        6.0
                          CCO      True                        CCO            46.069        3.0
              C[C@H](N)C(=O)O      True            C[C@H](N)C(=O)O            89.094        6.0
                      C1CCC1C      True                    CC1CCC1            70.135        5.0
             c1ccccc1c2ccccc2      True        c1ccc(-c2ccccc2)cc1           154.212       12.0
            CCCCCCCCCCCCCCCCO      True          CCCCCCCCCCCCCCCCO           242.447       17.0
        C1=CC=C2C(=C1)C=CC=C2      True             c1ccc2ccccc2c1           128.174       10.0

Error Details for Invalid Structures:
'invalidsmiles123': Invalid SMILES: Could not parse structure</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:53:54] SMILES Parse Error: syntax error while parsing: invalidsmiles123
[09:53:54] SMILES Parse Error: check for mistakes around position 1:
[09:53:54] invalidsmiles123
[09:53:54] ^
[09:53:54] SMILES Parse Error: Failed parsing SMILES 'invalidsmiles123' for input: 'invalidsmiles123'</code></pre>
</div>
</div>
</section>
<section id="chemical-plausibility-checks" class="level2">
<h2 class="anchored" data-anchor-id="chemical-plausibility-checks">Chemical Plausibility Checks</h2>
<p>Beyond basic SMILES validation, we can implement more sophisticated checks to assess whether LLM-generated structures are chemically reasonable. This is particularly important because LLMs might generate syntactically valid but chemically implausible structures:</p>
<div id="deaf8036" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> assess_chemical_plausibility(mol: Chem.Mol) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>]:</span>
<span id="cb10-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Assess the chemical plausibility of a molecule beyond basic validation.</span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns flags for potential issues that might indicate AI-generated artifacts.</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb10-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plausible'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Invalid molecule'</span>]}</span>
<span id="cb10-8">    </span>
<span id="cb10-9">    issues <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb10-10">    warnings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb10-11">    </span>
<span id="cb10-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Molecular weight checks</span></span>
<span id="cb10-13">    mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Descriptors.MolWt(mol)</span>
<span id="cb10-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lighter than methane</span></span>
<span id="cb10-15">        issues.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Extremely low molecular weight: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mw<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Very large for small molecule</span></span>
<span id="cb10-17">        warnings.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Very high molecular weight: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mw<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-18">    </span>
<span id="cb10-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Atom count checks</span></span>
<span id="cb10-20">    num_atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mol.GetNumAtoms()</span>
<span id="cb10-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> num_atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unusually large for typical organic molecules</span></span>
<span id="cb10-22">        warnings.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Very large molecule: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>num_atoms<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> atoms"</span>)</span>
<span id="cb10-23">    </span>
<span id="cb10-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for unusual atom types in organic chemistry context</span></span>
<span id="cb10-25">    unusual_atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb10-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> atom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mol.GetAtoms():</span>
<span id="cb10-27">        symbol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> atom.GetSymbol()</span>
<span id="cb10-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> symbol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'S'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'P'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Cl'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Br'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'I'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H'</span>]:</span>
<span id="cb10-29">            unusual_atoms.append(symbol)</span>
<span id="cb10-30">    </span>
<span id="cb10-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> unusual_atoms:</span>
<span id="cb10-32">        warnings.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Unusual atoms present: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(unusual_atoms)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-33">    </span>
<span id="cb10-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check carbon-to-heteroatom ratio</span></span>
<span id="cb10-35">    carbon_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> atom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mol.GetAtoms() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> atom.GetSymbol() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>)</span>
<span id="cb10-36">    heteroatom_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> atom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mol.GetAtoms() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> atom.GetSymbol() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H'</span>])</span>
<span id="cb10-37">    </span>
<span id="cb10-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> heteroatom_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb10-39">        c_to_hetero_ratio <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> carbon_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> heteroatom_count</span>
<span id="cb10-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> c_to_hetero_ratio <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Too many heteroatoms</span></span>
<span id="cb10-41">            warnings.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Unusual C:heteroatom ratio: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>c_to_hetero_ratio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-42">    </span>
<span id="cb10-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for overly complex ring systems</span></span>
<span id="cb10-44">    ring_info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mol.GetRingInfo()</span>
<span id="cb10-45">    num_rings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ring_info.NumRings()</span>
<span id="cb10-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> num_rings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Many fused rings might be suspicious</span></span>
<span id="cb10-47">        warnings.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Complex ring system: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>num_rings<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> rings"</span>)</span>
<span id="cb10-48">    </span>
<span id="cb10-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for extremely high or low LogP (rough estimate)</span></span>
<span id="cb10-50">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb10-51">        logp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Descriptors.MolLogP(mol)</span>
<span id="cb10-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> logp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>:</span>
<span id="cb10-53">            warnings.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Very high LogP: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>logp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-54">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> logp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:</span>
<span id="cb10-55">            warnings.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Very low LogP: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>logp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb10-57">        warnings.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Could not calculate LogP"</span>)</span>
<span id="cb10-58">    </span>
<span id="cb10-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for drug-likeness violations (Lipinski's Rule of Five)</span></span>
<span id="cb10-60">    violations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb10-61">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>:</span>
<span id="cb10-62">        violations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MW &gt; 500"</span>)</span>
<span id="cb10-63">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> Descriptors.MolLogP(mol) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:</span>
<span id="cb10-64">        violations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LogP &gt; 5"</span>)</span>
<span id="cb10-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> Descriptors.NumHDonors(mol) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:</span>
<span id="cb10-66">        violations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"H-donors &gt; 5"</span>)</span>
<span id="cb10-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> Descriptors.NumHAcceptors(mol) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:</span>
<span id="cb10-68">        violations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"H-acceptors &gt; 10"</span>)</span>
<span id="cb10-69">    </span>
<span id="cb10-70">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(violations) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Allow one violation</span></span>
<span id="cb10-71">        warnings.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Multiple Lipinski violations: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>violations<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-72">    </span>
<span id="cb10-73">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb10-74">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plausible'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(issues) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb10-75">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>: issues,</span>
<span id="cb10-76">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>: warnings,</span>
<span id="cb10-77">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>: {</span>
<span id="cb10-78">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>: mw,</span>
<span id="cb10-79">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms'</span>: num_atoms,</span>
<span id="cb10-80">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>: num_rings,</span>
<span id="cb10-81">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>: Descriptors.MolLogP(mol) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb10-82">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(violations)</span>
<span id="cb10-83">        }</span>
<span id="cb10-84">    }</span>
<span id="cb10-85"></span>
<span id="cb10-86"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test with some examples</span></span>
<span id="cb10-87">test_molecules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-88">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCO"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Simple alcohol"</span>),</span>
<span id="cb10-89">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ibuprofen"</span>),</span>
<span id="cb10-90">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Very long alkyl chain"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unusual but valid</span></span>
<span id="cb10-91">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Long fatty acid"</span>),</span>
<span id="cb10-92">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c1ccc2c(c1)c3ccccc3c4ccccc24"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Anthracene (PAH)"</span>),</span>
<span id="cb10-93">]</span>
<span id="cb10-94"></span>
<span id="cb10-95"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chemical Plausibility Assessment:"</span>)</span>
<span id="cb10-96"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb10-97"></span>
<span id="cb10-98"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles, description <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test_molecules:</span>
<span id="cb10-99">    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb10-100">    assessment <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> assess_chemical_plausibility(mol)</span>
<span id="cb10-101">    </span>
<span id="cb10-102">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Molecule: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-103">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"SMILES: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-104">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Plausible: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>assessment[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plausible'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-105">    </span>
<span id="cb10-106">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> assessment[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>]:</span>
<span id="cb10-107">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Issues: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(assessment[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-108">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> assessment[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>]:</span>
<span id="cb10-109">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Warnings: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(assessment[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-110">    </span>
<span id="cb10-111">    props <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> assessment[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>]</span>
<span id="cb10-112">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Properties: MW=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>props[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, "</span></span>
<span id="cb10-113">          <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Rings=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>props[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, "</span></span>
<span id="cb10-114">          <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"LogP=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>props[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, "</span></span>
<span id="cb10-115">          <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Lipinski violations=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>props[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chemical Plausibility Assessment:
==================================================

Molecule: Simple alcohol
SMILES: CCO
Plausible: True
Properties: MW=46.1, Rings=0, LogP=-0.00, Lipinski violations=0

Molecule: Ibuprofen
SMILES: CC(C)CC1=CC=C(C=C1)C(C)C(=O)O
Plausible: True
Properties: MW=206.3, Rings=1, LogP=3.07, Lipinski violations=0

Molecule: Very long alkyl chain
SMILES: CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
Plausible: True
Warnings: Very high LogP: 19.75; Multiple Lipinski violations: ['MW &gt; 500', 'LogP &gt; 5']
Properties: MW=703.4, Rings=0, LogP=19.75, Lipinski violations=2

Molecule: Long fatty acid
SMILES: CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC(=O)O
Plausible: True
Warnings: Very high LogP: 11.40
Properties: MW=466.8, Rings=0, LogP=11.40, Lipinski violations=1

Molecule: Anthracene (PAH)
SMILES: c1ccc2c(c1)c3ccccc3c4ccccc24
Plausible: True
Properties: MW=228.3, Rings=4, LogP=5.15, Lipinski violations=1</code></pre>
</div>
</div>
</section>
<section id="putting-it-together-a-complete-validation-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-together-a-complete-validation-pipeline">Putting It Together: A Complete Validation Pipeline</h2>
<p>Here’s how you might integrate these validation functions into a complete pipeline for processing LLM-generated chemical structures:</p>
<div id="091dc7fa" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> LLMChemicalValidator:</span>
<span id="cb12-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A comprehensive validator for LLM-generated chemical structures.</span></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Combines SMILES validation, chemical plausibility checks, and filtering.</span></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb12-6">    </span>
<span id="cb12-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, strict_mode: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb12-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.strict_mode <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> strict_mode</span>
<span id="cb12-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.validation_stats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb12-10">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_processed'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb12-11">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'valid_smiles'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb12-12">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chemically_plausible'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb12-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passed_filters'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-14">        }</span>
<span id="cb12-15">    </span>
<span id="cb12-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> validate_structure(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, smiles: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>]:</span>
<span id="cb12-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Validate a single SMILES string with full analysis."""</span></span>
<span id="cb12-18">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> validate_smiles_with_details(smiles)</span>
<span id="cb12-19">        </span>
<span id="cb12-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mol'</span>]:</span>
<span id="cb12-21">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add plausibility assessment</span></span>
<span id="cb12-22">            plausibility <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> assess_chemical_plausibility(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mol'</span>])</span>
<span id="cb12-23">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plausibility'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plausibility</span>
<span id="cb12-24">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chemically_plausible'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plausibility[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plausible'</span>]</span>
<span id="cb12-25">            </span>
<span id="cb12-26">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply filters based on mode</span></span>
<span id="cb12-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.strict_mode:</span>
<span id="cb12-28">                result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passes_filters'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (plausibility[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plausible'</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> </span>
<span id="cb12-29">                                          <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(plausibility[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'warnings'</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb12-30">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb12-31">                result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passes_filters'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plausibility[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plausible'</span>]</span>
<span id="cb12-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb12-33">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chemically_plausible'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb12-34">            result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passes_filters'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb12-35">        </span>
<span id="cb12-36">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update stats</span></span>
<span id="cb12-37">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.validation_stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_processed'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>]:</span>
<span id="cb12-39">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.validation_stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'valid_smiles'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chemically_plausible'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb12-41">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.validation_stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chemically_plausible'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-42">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passes_filters'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb12-43">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.validation_stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passed_filters'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-44">        </span>
<span id="cb12-45">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result</span>
<span id="cb12-46">    </span>
<span id="cb12-47">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> validate_batch(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, smiles_list: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>]]:</span>
<span id="cb12-48">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Validate a batch of SMILES strings."""</span></span>
<span id="cb12-49">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.validate_structure(smiles) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles_list]</span>
<span id="cb12-50">    </span>
<span id="cb12-51">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_filtered_structures(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, smiles_list: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]:</span>
<span id="cb12-52">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Return only the structures that pass all validation checks."""</span></span>
<span id="cb12-53">        results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.validate_batch(smiles_list)</span>
<span id="cb12-54">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> results </span>
<span id="cb12-55">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passes_filters'</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> r[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]]</span>
<span id="cb12-56">    </span>
<span id="cb12-57">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_validation_report(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb12-58">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Generate a summary report of validation statistics."""</span></span>
<span id="cb12-59">        stats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.validation_stats</span>
<span id="cb12-60">        total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_processed'</span>]</span>
<span id="cb12-61">        </span>
<span id="cb12-62">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb12-63">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No structures processed yet."</span></span>
<span id="cb12-64">        </span>
<span id="cb12-65">        report <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""</span></span>
<span id="cb12-66"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Validation Report:</span></span>
<span id="cb12-67"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">==================</span></span>
<span id="cb12-68"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Total structures processed: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>total<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-69"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Valid SMILES: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'valid_smiles'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'valid_smiles'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%)</span></span>
<span id="cb12-70"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Chemically plausible: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chemically_plausible'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chemically_plausible'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%)</span></span>
<span id="cb12-71"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Passed all filters: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passed_filters'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passed_filters'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%)</span></span>
<span id="cb12-72"></span>
<span id="cb12-73"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Success rate: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stats[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passed_filters'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%</span></span>
<span id="cb12-74"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb12-75">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> report.strip()</span>
<span id="cb12-76"></span>
<span id="cb12-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Demonstration with simulated LLM output</span></span>
<span id="cb12-78"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LLM Chemical Validator Demo"</span>)</span>
<span id="cb12-79"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span>
<span id="cb12-80"></span>
<span id="cb12-81"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate a mix of good and problematic LLM-generated structures</span></span>
<span id="cb12-82">llm_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb12-83">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCO"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ethanol - should pass</span></span>
<span id="cb12-84">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ibuprofen - should pass</span></span>
<span id="cb12-85">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c1ccccc1"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># benzene - should pass</span></span>
<span id="cb12-86">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"invalidsmiles"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># invalid SMILES</span></span>
<span id="cb12-87">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># very long chain</span></span>
<span id="cb12-88">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1=CC=C(C=C1)C(=O)O"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># benzoic acid - should pass</span></span>
<span id="cb12-89">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C[C@H](N)C(=O)O"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># alanine - should pass</span></span>
<span id="cb12-90">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1CCC"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># invalid - unclosed ring</span></span>
<span id="cb12-91">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(C)(C)(C)(C)C"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># too many bonds</span></span>
<span id="cb12-92">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># extremely long</span></span>
<span id="cb12-93">]</span>
<span id="cb12-94"></span>
<span id="cb12-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test with normal mode</span></span>
<span id="cb12-96"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Testing with Normal Mode:"</span>)</span>
<span id="cb12-97">validator_normal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMChemicalValidator(strict_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb12-98">filtered_normal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> validator_normal.get_filtered_structures(llm_output)</span>
<span id="cb12-99"></span>
<span id="cb12-100"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Input structures: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(llm_output)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-101"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Structures passing validation: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(filtered_normal)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-102"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Passed structures:"</span>)</span>
<span id="cb12-103"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(filtered_normal, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb12-104">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-105"></span>
<span id="cb12-106"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(validator_normal.get_validation_report())</span>
<span id="cb12-107"></span>
<span id="cb12-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test with strict mode</span></span>
<span id="cb12-109"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span>
<span id="cb12-110"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Testing with Strict Mode:"</span>)</span>
<span id="cb12-111">validator_strict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMChemicalValidator(strict_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb12-112">filtered_strict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> validator_strict.get_filtered_structures(llm_output)</span>
<span id="cb12-113"></span>
<span id="cb12-114"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Structures passing strict validation: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(filtered_strict)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-115"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(validator_strict.get_validation_report())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>LLM Chemical Validator Demo
========================================
Testing with Normal Mode:
Input structures: 10
Structures passing validation: 7

Passed structures:
1. CCO
2. CC(C)Cc1ccc(C(C)C(=O)O)cc1
3. c1ccccc1
4. CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
5. O=C(O)c1ccccc1
6. C[C@H](N)C(=O)O
7. CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
Validation Report:
==================
Total structures processed: 10
Valid SMILES: 7 (70.0%)
Chemically plausible: 7 (70.0%)
Passed all filters: 7 (70.0%)

Success rate: 70.0%

========================================
Testing with Strict Mode:
Structures passing strict validation: 5
Validation Report:
==================
Total structures processed: 10
Valid SMILES: 7 (70.0%)
Chemically plausible: 7 (70.0%)
Passed all filters: 5 (50.0%)

Success rate: 50.0%</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:53:54] SMILES Parse Error: syntax error while parsing: invalidsmiles
[09:53:54] SMILES Parse Error: check for mistakes around position 1:
[09:53:54] invalidsmiles
[09:53:54] ^
[09:53:54] SMILES Parse Error: Failed parsing SMILES 'invalidsmiles' for input: 'invalidsmiles'
[09:53:54] SMILES Parse Error: unclosed ring for input: 'C1CCC'
[09:53:54] Explicit valence for atom # 1 C, 6, is greater than permitted
[09:53:54] SMILES Parse Error: syntax error while parsing: invalidsmiles
[09:53:54] SMILES Parse Error: check for mistakes around position 1:
[09:53:54] invalidsmiles
[09:53:54] ^
[09:53:54] SMILES Parse Error: Failed parsing SMILES 'invalidsmiles' for input: 'invalidsmiles'
[09:53:54] SMILES Parse Error: unclosed ring for input: 'C1CCC'
[09:53:54] Explicit valence for atom # 1 C, 6, is greater than permitted</code></pre>
</div>
</div>
</section>
</section>
<section id="from-molecules-to-text-generating-rich-descriptions-for-llm-training" class="level1">
<h1>From Molecules to Text: Generating Rich Descriptions for LLM Training</h1>
<p>While validation is crucial for processing LLM outputs, the reverse direction - converting molecular structures into natural language descriptions - is equally important for training chemical AI systems and creating meaningful prompts. RDKit’s rich chemical analysis capabilities make it possible to generate detailed, chemically-informed text descriptions of molecules.</p>
<p>This approach is valuable for: - Creating training data for chemistry-focused LLMs - Building chemical chatbots with rich molecular knowledge - Making chemical databases more searchable with natural language - Generating explanatory text for chemical education applications</p>
<div id="75bff299" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> extract_molecular_features(mol: Chem.Mol) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>]:</span>
<span id="cb15-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Extract comprehensive molecular features suitable for text generation.</span></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This creates a rich feature dictionary that can be converted to natural language.</span></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb15-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb15-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {}</span>
<span id="cb15-8">    </span>
<span id="cb15-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb15-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Basic molecular properties</span></span>
<span id="cb15-11">        features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb15-12">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: Chem.MolToSmiles(mol),</span>
<span id="cb15-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_formula'</span>: rdMolDescriptors.CalcMolFormula(mol),</span>
<span id="cb15-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(Descriptors.MolWt(mol), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb15-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms'</span>: mol.GetNumAtoms(),</span>
<span id="cb15-16">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_heavy_atoms'</span>: mol.GetNumHeavyAtoms(),</span>
<span id="cb15-17">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_bonds'</span>: mol.GetNumBonds(),</span>
<span id="cb15-18">        }</span>
<span id="cb15-19">        </span>
<span id="cb15-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ring and aromaticity information</span></span>
<span id="cb15-21">        features.update({</span>
<span id="cb15-22">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>: rdMolDescriptors.CalcNumRings(mol),</span>
<span id="cb15-23">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>: rdMolDescriptors.CalcNumAromaticRings(mol),</span>
<span id="cb15-24">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_saturated_rings'</span>: rdMolDescriptors.CalcNumSaturatedRings(mol),</span>
<span id="cb15-25">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aliphatic_rings'</span>: rdMolDescriptors.CalcNumAliphaticRings(mol),</span>
<span id="cb15-26">        })</span>
<span id="cb15-27">        </span>
<span id="cb15-28">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Physicochemical properties</span></span>
<span id="cb15-29">        features.update({</span>
<span id="cb15-30">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(Descriptors.MolLogP(mol), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb15-31">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tpsa'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(Descriptors.TPSA(mol), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb15-32">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_donors'</span>: Descriptors.NumHDonors(mol),</span>
<span id="cb15-33">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_acceptors'</span>: Descriptors.NumHAcceptors(mol),</span>
<span id="cb15-34">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rotatable_bonds'</span>: Descriptors.NumRotatableBonds(mol),</span>
<span id="cb15-35">        })</span>
<span id="cb15-36">        </span>
<span id="cb15-37">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Atom type counts</span></span>
<span id="cb15-38">        atom_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb15-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> atom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mol.GetAtoms():</span>
<span id="cb15-40">            symbol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> atom.GetSymbol()</span>
<span id="cb15-41">            atom_counts[symbol] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> atom_counts.get(symbol, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb15-42">        features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'atom_composition'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> atom_counts</span>
<span id="cb15-43">        </span>
<span id="cb15-44">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functional group analysis (simplified)</span></span>
<span id="cb15-45">        functional_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb15-46">        </span>
<span id="cb15-47">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for common functional groups using SMARTS</span></span>
<span id="cb15-48">        fg_patterns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb15-49">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'carboxylic_acid'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[CX3](=O)[OX2H1]'</span>,</span>
<span id="cb15-50">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ester'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[#6][CX3](=O)[OX2H0][#6]'</span>,</span>
<span id="cb15-51">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'amide'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[CX3](=[OX1])[NX3H2]'</span>,</span>
<span id="cb15-52">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alcohol'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[OX2H]'</span>,</span>
<span id="cb15-53">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'amine'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[NX3;H2,H1;!$(NC=O)]'</span>,</span>
<span id="cb15-54">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ketone'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[#6][CX3](=O)[#6]'</span>,</span>
<span id="cb15-55">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aldehyde'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[CX3H1](=O)[#6]'</span>,</span>
<span id="cb15-56">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ether'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[OD2]([#6])[#6]'</span>,</span>
<span id="cb15-57">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'phenol'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[OX2H][cX3]:[c]'</span>,</span>
<span id="cb15-58">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nitro'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[NX3+](=O)[O-]'</span>,</span>
<span id="cb15-59">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aromatic_ring'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1ccccc1'</span>,</span>
<span id="cb15-60">        }</span>
<span id="cb15-61">        </span>
<span id="cb15-62">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fg_name, smarts <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> fg_patterns.items():</span>
<span id="cb15-63">            pattern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmarts(smarts)</span>
<span id="cb15-64">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pattern <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> mol.HasSubstructMatch(pattern):</span>
<span id="cb15-65">                matches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mol.GetSubstructMatches(pattern)</span>
<span id="cb15-66">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> matches:</span>
<span id="cb15-67">                    functional_groups.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fg_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(matches)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb15-68">        </span>
<span id="cb15-69">        features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> functional_groups</span>
<span id="cb15-70">        </span>
<span id="cb15-71">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Drug-likeness assessment</span></span>
<span id="cb15-72">        lipinski_violations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb15-73">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>:</span>
<span id="cb15-74">            lipinski_violations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MW &gt; 500'</span>)</span>
<span id="cb15-75">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:</span>
<span id="cb15-76">            lipinski_violations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogP &gt; 5'</span>)</span>
<span id="cb15-77">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_donors'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:</span>
<span id="cb15-78">            lipinski_violations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H-donors &gt; 5'</span>)</span>
<span id="cb15-79">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_acceptors'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:</span>
<span id="cb15-80">            lipinski_violations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H-acceptors &gt; 10'</span>)</span>
<span id="cb15-81">        </span>
<span id="cb15-82">        features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lipinski_violations</span>
<span id="cb15-83">        features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drug_like'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(lipinski_violations) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb15-84">        </span>
<span id="cb15-85">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> features</span>
<span id="cb15-86">        </span>
<span id="cb15-87">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb15-88">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Feature extraction failed: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>}</span>
<span id="cb15-89"></span>
<span id="cb15-90"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test the function with some example molecules</span></span>
<span id="cb15-91">test_molecules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb15-92">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCO"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ethanol"</span>),</span>
<span id="cb15-93">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ibuprofen"</span>),</span>
<span id="cb15-94">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C1=CC=C(C=C1)C(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Benzoic acid"</span>),</span>
<span id="cb15-95">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(=O)OC1=CC=CC=C1C(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Aspirin"</span>),</span>
<span id="cb15-96">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CN1C=NC2=C1C(=O)N(C(=O)N2C)C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Caffeine"</span>),</span>
<span id="cb15-97">]</span>
<span id="cb15-98"></span>
<span id="cb15-99"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Molecular Feature Extraction Examples:"</span>)</span>
<span id="cb15-100"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb15-101"></span>
<span id="cb15-102"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles, name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test_molecules:</span>
<span id="cb15-103">    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb15-104">    features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_molecular_features(mol)</span>
<span id="cb15-105">    </span>
<span id="cb15-106">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">):"</span>)</span>
<span id="cb15-107">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Formula: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_formula'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N/A'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-108">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  MW: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N/A'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Da"</span>)</span>
<span id="cb15-109">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  LogP: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N/A'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-110">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  TPSA: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tpsa'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N/A'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Ų"</span>)</span>
<span id="cb15-111">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Rings: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (aromatic: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb15-112">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  H-bond donors/acceptors: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_donors'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_acceptors'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-113">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Functional groups: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(features.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>, [])) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'None detected'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-114">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Drug-like: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drug_like'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-115">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>):</span>
<span id="cb15-116">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Lipinski violations: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Molecular Feature Extraction Examples:
==================================================

Ethanol (CCO):
  Formula: C2H6O
  MW: 46.07 Da
  LogP: -0.0
  TPSA: 20.23 Ų
  Rings: 0 (aromatic: 0)
  H-bond donors/acceptors: 1/1
  Functional groups: alcohol(1)
  Drug-like: True

Ibuprofen (CC(C)CC1=CC=C(C=C1)C(C)C(=O)O):
  Formula: C13H18O2
  MW: 206.28 Da
  LogP: 3.07
  TPSA: 37.3 Ų
  Rings: 1 (aromatic: 1)
  H-bond donors/acceptors: 1/1
  Functional groups: carboxylic_acid(1), alcohol(1), aromatic_ring(1)
  Drug-like: True

Benzoic acid (C1=CC=C(C=C1)C(=O)O):
  Formula: C7H6O2
  MW: 122.12 Da
  LogP: 1.38
  TPSA: 37.3 Ų
  Rings: 1 (aromatic: 1)
  H-bond donors/acceptors: 1/1
  Functional groups: carboxylic_acid(1), alcohol(1), aromatic_ring(1)
  Drug-like: True

Aspirin (CC(=O)OC1=CC=CC=C1C(=O)O):
  Formula: C9H8O4
  MW: 180.16 Da
  LogP: 1.31
  TPSA: 63.6 Ų
  Rings: 1 (aromatic: 1)
  H-bond donors/acceptors: 1/3
  Functional groups: carboxylic_acid(1), ester(1), alcohol(1), ether(1), aromatic_ring(1)
  Drug-like: True

Caffeine (CN1C=NC2=C1C(=O)N(C(=O)N2C)C):
  Formula: C8H10N4O2
  MW: 194.19 Da
  LogP: -1.03
  TPSA: 61.82 Ų
  Rings: 2 (aromatic: 2)
  H-bond donors/acceptors: 0/6
  Functional groups: None detected
  Drug-like: True</code></pre>
</div>
</div>
<section id="converting-features-to-natural-language" class="level2">
<h2 class="anchored" data-anchor-id="converting-features-to-natural-language">Converting Features to Natural Language</h2>
<p>Now let’s create functions that transform these molecular features into natural language descriptions suitable for LLM training:</p>
<div id="b6d004af" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_molecular_description(mol: Chem.Mol, style: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'detailed'</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb17-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Generate natural language descriptions of molecules in different styles.</span></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb17-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        mol: RDKit molecule object</span></span>
<span id="cb17-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        style: 'detailed', 'concise', 'technical', or 'educational'</span></span>
<span id="cb17-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb17-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb17-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Natural language description of the molecule</span></span>
<span id="cb17-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb17-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb17-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Invalid molecule structure."</span></span>
<span id="cb17-14">    </span>
<span id="cb17-15">    features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_molecular_features(mol)</span>
<span id="cb17-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> features:</span>
<span id="cb17-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Could not analyze molecule: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb17-18">    </span>
<span id="cb17-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> style <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'concise'</span>:</span>
<span id="cb17-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _generate_concise_description(features)</span>
<span id="cb17-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> style <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'technical'</span>:</span>
<span id="cb17-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _generate_technical_description(features)</span>
<span id="cb17-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> style <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'educational'</span>:</span>
<span id="cb17-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _generate_educational_description(features)</span>
<span id="cb17-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># detailed</span></span>
<span id="cb17-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> _generate_detailed_description(features)</span>
<span id="cb17-27"></span>
<span id="cb17-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _generate_concise_description(features: Dict) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb17-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Generate a brief, factual description."""</span></span>
<span id="cb17-30">    desc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_formula'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with molecular weight </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Da."</span></span>
<span id="cb17-31">    </span>
<span id="cb17-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>]:</span>
<span id="cb17-33">        fg_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span>.join([fg.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'('</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fg <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>]])</span>
<span id="cb17-34">        desc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f" Contains </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fg_text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> functional groups."</span></span>
<span id="cb17-35">    </span>
<span id="cb17-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> desc</span>
<span id="cb17-37"></span>
<span id="cb17-38"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _generate_technical_description(features: Dict) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb17-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Generate a technical description with precise chemical language."""</span></span>
<span id="cb17-40">    parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb17-41">    </span>
<span id="cb17-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Basic structure</span></span>
<span id="cb17-43">    parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Molecular formula </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_formula'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (MW: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Da)"</span>)</span>
<span id="cb17-44">    </span>
<span id="cb17-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ring systems</span></span>
<span id="cb17-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-47">        ring_desc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ring(s)"</span></span>
<span id="cb17-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-49">            ring_desc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f" including </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> aromatic ring(s)"</span></span>
<span id="cb17-50">        parts.append(ring_desc)</span>
<span id="cb17-51">    </span>
<span id="cb17-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Physicochemical properties</span></span>
<span id="cb17-53">    parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"LogP: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, TPSA: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tpsa'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Ų"</span>)</span>
<span id="cb17-54">    </span>
<span id="cb17-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hydrogen bonding</span></span>
<span id="cb17-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_donors'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_acceptors'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-57">        parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"H-bond donors: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_donors'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, acceptors: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_acceptors'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb17-58">    </span>
<span id="cb17-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Drug-likeness</span></span>
<span id="cb17-60">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drug_like'</span>]:</span>
<span id="cb17-61">        parts.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Complies with Lipinski's Rule of Five"</span>)</span>
<span id="cb17-62">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>]:</span>
<span id="cb17-63">        parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Violates Lipinski's Rule: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb17-64">    </span>
<span id="cb17-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">". "</span>.join(parts) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"."</span></span>
<span id="cb17-66"></span>
<span id="cb17-67"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _generate_detailed_description(features: Dict) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb17-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Generate a comprehensive description suitable for training data."""</span></span>
<span id="cb17-69">    parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb17-70">    </span>
<span id="cb17-71">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Introduction</span></span>
<span id="cb17-72">    parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This compound has the molecular formula </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_formula'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> and a molecular weight of </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> daltons."</span>)</span>
<span id="cb17-73">    </span>
<span id="cb17-74">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Structural features</span></span>
<span id="cb17-75">    structure_parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb17-76">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_heavy_atoms'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-77">        structure_parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_heavy_atoms'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> heavy atoms"</span>)</span>
<span id="cb17-78">    </span>
<span id="cb17-79">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-80">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_saturated_rings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-81">            structure_parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> rings (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> aromatic, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_saturated_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> saturated)"</span>)</span>
<span id="cb17-82">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-83">            structure_parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> aromatic ring(s)"</span>)</span>
<span id="cb17-84">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb17-85">            structure_parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> saturated ring(s)"</span>)</span>
<span id="cb17-86">    </span>
<span id="cb17-87">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> structure_parts:</span>
<span id="cb17-88">        parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The structure contains </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(structure_parts)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb17-89">    </span>
<span id="cb17-90">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Atom composition</span></span>
<span id="cb17-91">    atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'atom_composition'</span>]</span>
<span id="cb17-92">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(atoms) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb17-93">        atom_desc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb17-94">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> atom, count <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(atoms.items()):</span>
<span id="cb17-95">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> atom <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H'</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Skip hydrogen for brevity</span></span>
<span id="cb17-96">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb17-97">                    atom_desc.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"one </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>atom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb17-98">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb17-99">                    atom_desc.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>count<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>atom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> atoms"</span>)</span>
<span id="cb17-100">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> atom_desc:</span>
<span id="cb17-101">            parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"It is composed of </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(atom_desc)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb17-102">    </span>
<span id="cb17-103">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functional groups</span></span>
<span id="cb17-104">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>]:</span>
<span id="cb17-105">        fg_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [fg.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'('</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fg <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>]]</span>
<span id="cb17-106">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(fg_names) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb17-107">            parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The molecule contains a </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fg_names[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> functional group."</span>)</span>
<span id="cb17-108">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb17-109">            parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Functional groups present include </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(fg_names[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> and </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fg_names[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb17-110">    </span>
<span id="cb17-111">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Physicochemical properties</span></span>
<span id="cb17-112">    prop_desc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb17-113">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb17-114">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:</span>
<span id="cb17-115">            prop_desc.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lipophilic character"</span>)</span>
<span id="cb17-116">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-117">            prop_desc.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hydrophilic nature"</span>)</span>
<span id="cb17-118">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb17-119">            prop_desc.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"moderate lipophilicity"</span>)</span>
<span id="cb17-120">    </span>
<span id="cb17-121">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tpsa'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>:</span>
<span id="cb17-122">        prop_desc.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"high polar surface area"</span>)</span>
<span id="cb17-123">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tpsa'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>:</span>
<span id="cb17-124">        prop_desc.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"low polar surface area"</span>)</span>
<span id="cb17-125">    </span>
<span id="cb17-126">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> prop_desc:</span>
<span id="cb17-127">        parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The compound exhibits </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' and '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(prop_desc)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb17-128">    </span>
<span id="cb17-129">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Drug-likeness assessment</span></span>
<span id="cb17-130">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drug_like'</span>]:</span>
<span id="cb17-131">        parts.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This molecule satisfies Lipinski's Rule of Five, suggesting good oral bioavailability potential."</span>)</span>
<span id="cb17-132">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>]:</span>
<span id="cb17-133">        parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The compound violates Lipinski's Rule of Five due to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, which may affect its drug-like properties."</span>)</span>
<span id="cb17-134">    </span>
<span id="cb17-135">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join(parts)</span>
<span id="cb17-136"></span>
<span id="cb17-137"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _generate_educational_description(features: Dict) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb17-138">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Generate an educational description explaining chemical concepts."""</span></span>
<span id="cb17-139">    parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb17-140">    </span>
<span id="cb17-141">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Start with basics</span></span>
<span id="cb17-142">    parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This molecule, with formula </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_formula'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, is an organic compound weighing </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> daltons."</span>)</span>
<span id="cb17-143">    </span>
<span id="cb17-144">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Explain ring systems in educational terms</span></span>
<span id="cb17-145">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-146">        parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"It contains </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_aromatic_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> aromatic ring(s), which are stable ring structures with delocalized electrons that give the molecule special stability and chemical properties."</span>)</span>
<span id="cb17-147">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-148">        parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The molecule has </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ring structure(s), which can affect its shape and biological activity."</span>)</span>
<span id="cb17-149">    </span>
<span id="cb17-150">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Explain functional groups</span></span>
<span id="cb17-151">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>]:</span>
<span id="cb17-152">        parts.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Functional groups are specific arrangements of atoms that give molecules their chemical reactivity."</span>)</span>
<span id="cb17-153">        fg_explanations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb17-154">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'carboxylic_acid'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"carboxylic acid groups (which can donate protons and are often acidic)"</span>,</span>
<span id="cb17-155">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alcohol'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alcohol groups (which can form hydrogen bonds)"</span>,</span>
<span id="cb17-156">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'amine'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"amine groups (which are basic and can accept protons)"</span>,</span>
<span id="cb17-157">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ketone'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ketone groups (which are reactive carbonyl groups)"</span>,</span>
<span id="cb17-158">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ester'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ester groups (often found in fats and can be hydrolyzed)"</span>,</span>
<span id="cb17-159">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ether'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ether groups (which are generally unreactive)"</span></span>
<span id="cb17-160">        }</span>
<span id="cb17-161">        </span>
<span id="cb17-162">        explained_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb17-163">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fg <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>]:</span>
<span id="cb17-164">            fg_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fg.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'('</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb17-165">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> fg_name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> fg_explanations:</span>
<span id="cb17-166">                explained_groups.append(fg_explanations[fg_name])</span>
<span id="cb17-167">        </span>
<span id="cb17-168">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> explained_groups:</span>
<span id="cb17-169">            parts.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This molecule contains </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(explained_groups)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb17-170">    </span>
<span id="cb17-171">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Explain drug-likeness in simple terms</span></span>
<span id="cb17-172">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drug_like'</span>]:</span>
<span id="cb17-173">        parts.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The molecule's size and properties suggest it could potentially be developed as an oral medication."</span>)</span>
<span id="cb17-174">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lipinski_violations'</span>]:</span>
<span id="cb17-175">        parts.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The molecule is quite large or has properties that might make it challenging to develop as an oral drug."</span>)</span>
<span id="cb17-176">    </span>
<span id="cb17-177">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join(parts)</span>
<span id="cb17-178"></span>
<span id="cb17-179"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test the different description styles</span></span>
<span id="cb17-180">test_molecules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb17-181">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ibuprofen"</span>),</span>
<span id="cb17-182">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(=O)OC1=CC=CC=C1C(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Aspirin"</span>),</span>
<span id="cb17-183">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CN1C=NC2=C1C(=O)N(C(=O)N2C)C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Caffeine"</span>),</span>
<span id="cb17-184">]</span>
<span id="cb17-185"></span>
<span id="cb17-186">styles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'concise'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'technical'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'detailed'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'educational'</span>]</span>
<span id="cb17-187"></span>
<span id="cb17-188"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Natural Language Description Examples:"</span>)</span>
<span id="cb17-189"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb17-190"></span>
<span id="cb17-191"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles, name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test_molecules:</span>
<span id="cb17-192">    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb17-193">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">):"</span>)</span>
<span id="cb17-194">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(name) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb17-195">    </span>
<span id="cb17-196">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> style <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> styles:</span>
<span id="cb17-197">        description <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_molecular_description(mol, style)</span>
<span id="cb17-198">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>style<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>title()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> style:"</span>)</span>
<span id="cb17-199">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(description)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Natural Language Description Examples:
============================================================

Ibuprofen (CC(C)CC1=CC=C(C=C1)C(C)C(=O)O):
------------------------------------------

Concise style:
This is C13H18O2 with molecular weight 206.28 Da. Contains carboxylic acid, alcohol, aromatic ring functional groups.

Technical style:
Molecular formula C13H18O2 (MW: 206.28 Da). 1 ring(s) including 1 aromatic ring(s). LogP: 3.07, TPSA: 37.3 Ų. H-bond donors: 1, acceptors: 1. Complies with Lipinski's Rule of Five.

Detailed style:
This compound has the molecular formula C13H18O2 and a molecular weight of 206.28 daltons. The structure contains 15 heavy atoms, 1 aromatic ring(s). It is composed of 13 C atoms, 2 O atoms. Functional groups present include carboxylic acid, alcohol and aromatic ring. The compound exhibits lipophilic character. This molecule satisfies Lipinski's Rule of Five, suggesting good oral bioavailability potential.

Educational style:
This molecule, with formula C13H18O2, is an organic compound weighing 206.28 daltons. It contains 1 aromatic ring(s), which are stable ring structures with delocalized electrons that give the molecule special stability and chemical properties. Functional groups are specific arrangements of atoms that give molecules their chemical reactivity. This molecule contains carboxylic acid groups (which can donate protons and are often acidic), alcohol groups (which can form hydrogen bonds). The molecule's size and properties suggest it could potentially be developed as an oral medication.

Aspirin (CC(=O)OC1=CC=CC=C1C(=O)O):
-----------------------------------

Concise style:
This is C9H8O4 with molecular weight 180.16 Da. Contains carboxylic acid, ester, alcohol, ether, aromatic ring functional groups.

Technical style:
Molecular formula C9H8O4 (MW: 180.16 Da). 1 ring(s) including 1 aromatic ring(s). LogP: 1.31, TPSA: 63.6 Ų. H-bond donors: 1, acceptors: 3. Complies with Lipinski's Rule of Five.

Detailed style:
This compound has the molecular formula C9H8O4 and a molecular weight of 180.16 daltons. The structure contains 13 heavy atoms, 1 aromatic ring(s). It is composed of 9 C atoms, 4 O atoms. Functional groups present include carboxylic acid, ester, alcohol, ether and aromatic ring. The compound exhibits moderate lipophilicity. This molecule satisfies Lipinski's Rule of Five, suggesting good oral bioavailability potential.

Educational style:
This molecule, with formula C9H8O4, is an organic compound weighing 180.16 daltons. It contains 1 aromatic ring(s), which are stable ring structures with delocalized electrons that give the molecule special stability and chemical properties. Functional groups are specific arrangements of atoms that give molecules their chemical reactivity. This molecule contains carboxylic acid groups (which can donate protons and are often acidic), ester groups (often found in fats and can be hydrolyzed), alcohol groups (which can form hydrogen bonds), ether groups (which are generally unreactive). The molecule's size and properties suggest it could potentially be developed as an oral medication.

Caffeine (CN1C=NC2=C1C(=O)N(C(=O)N2C)C):
----------------------------------------

Concise style:
This is C8H10N4O2 with molecular weight 194.19 Da.

Technical style:
Molecular formula C8H10N4O2 (MW: 194.19 Da). 2 ring(s) including 2 aromatic ring(s). LogP: -1.03, TPSA: 61.82 Ų. H-bond donors: 0, acceptors: 6. Complies with Lipinski's Rule of Five.

Detailed style:
This compound has the molecular formula C8H10N4O2 and a molecular weight of 194.19 daltons. The structure contains 14 heavy atoms, 2 aromatic ring(s). It is composed of 8 C atoms, 4 N atoms, 2 O atoms. The compound exhibits hydrophilic nature. This molecule satisfies Lipinski's Rule of Five, suggesting good oral bioavailability potential.

Educational style:
This molecule, with formula C8H10N4O2, is an organic compound weighing 194.19 daltons. It contains 2 aromatic ring(s), which are stable ring structures with delocalized electrons that give the molecule special stability and chemical properties. The molecule's size and properties suggest it could potentially be developed as an oral medication.</code></pre>
</div>
</div>
</section>
<section id="creating-structured-training-data" class="level2">
<h2 class="anchored" data-anchor-id="creating-structured-training-data">Creating Structured Training Data</h2>
<p>For training LLMs, you often need structured datasets that pair chemical structures with their descriptions. Here’s how to create such datasets systematically:</p>
<div id="c7546d06" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_molecule_text_dataset(smiles_list: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>], </span>
<span id="cb19-2">                                names: Optional[List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb19-3">                                include_multiple_styles: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]:</span>
<span id="cb19-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Create a structured dataset pairing molecules with text descriptions.</span></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Suitable for fine-tuning LLMs on chemical tasks.</span></span>
<span id="cb19-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        smiles_list: List of SMILES strings</span></span>
<span id="cb19-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        names: Optional list of molecule names</span></span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        include_multiple_styles: Whether to generate multiple description styles</span></span>
<span id="cb19-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb19-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb19-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        List of dictionaries with 'structure', 'description', and metadata</span></span>
<span id="cb19-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb19-16">    dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb19-17">    </span>
<span id="cb19-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(smiles_list):</span>
<span id="cb19-19">        mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb19-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb19-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Skip invalid molecules</span></span>
<span id="cb19-22">        </span>
<span id="cb19-23">        name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> names[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> names <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(names) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Compound_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb19-24">        canonical_smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb19-25">        </span>
<span id="cb19-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> include_multiple_styles:</span>
<span id="cb19-27">            styles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'concise'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'technical'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'detailed'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'educational'</span>]</span>
<span id="cb19-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb19-29">            styles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'detailed'</span>]</span>
<span id="cb19-30">        </span>
<span id="cb19-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> style <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> styles:</span>
<span id="cb19-32">            description <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_molecular_description(mol, style)</span>
<span id="cb19-33">            </span>
<span id="cb19-34">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create training example in various formats</span></span>
<span id="cb19-35">            </span>
<span id="cb19-36">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format 1: Direct description</span></span>
<span id="cb19-37">            dataset.append({</span>
<span id="cb19-38">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'task_type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecule_description'</span>,</span>
<span id="cb19-39">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'style'</span>: style,</span>
<span id="cb19-40">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input_smiles'</span>: smiles,</span>
<span id="cb19-41">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>: canonical_smiles,</span>
<span id="cb19-42">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecule_name'</span>: name,</span>
<span id="cb19-43">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: description,</span>
<span id="cb19-44">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Describe the chemical structure </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>canonical_smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>,</span>
<span id="cb19-45">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>: description</span>
<span id="cb19-46">            })</span>
<span id="cb19-47">            </span>
<span id="cb19-48">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format 2: Question-answer format</span></span>
<span id="cb19-49">            dataset.append({</span>
<span id="cb19-50">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'task_type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chemical_qa'</span>,</span>
<span id="cb19-51">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'style'</span>: style,</span>
<span id="cb19-52">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input_smiles'</span>: smiles,</span>
<span id="cb19-53">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>: canonical_smiles,</span>
<span id="cb19-54">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecule_name'</span>: name,</span>
<span id="cb19-55">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: description,</span>
<span id="cb19-56">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"What can you tell me about the molecule with SMILES </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>canonical_smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">?"</span>,</span>
<span id="cb19-57">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>: description</span>
<span id="cb19-58">            })</span>
<span id="cb19-59">            </span>
<span id="cb19-60">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format 3: Named molecule description</span></span>
<span id="cb19-61">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Compound_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>:</span>
<span id="cb19-62">                dataset.append({</span>
<span id="cb19-63">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'task_type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'named_molecule_description'</span>,</span>
<span id="cb19-64">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'style'</span>: style,</span>
<span id="cb19-65">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input_smiles'</span>: smiles,</span>
<span id="cb19-66">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>: canonical_smiles,</span>
<span id="cb19-67">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecule_name'</span>: name,</span>
<span id="cb19-68">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: description,</span>
<span id="cb19-69">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Describe the chemical structure and properties of </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>,</span>
<span id="cb19-70">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>canonical_smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) is a compound where </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>lower()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb19-71">                })</span>
<span id="cb19-72">    </span>
<span id="cb19-73">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> dataset</span>
<span id="cb19-74"></span>
<span id="cb19-75"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_property_prediction_dataset(smiles_list: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>], </span>
<span id="cb19-76">                                     target_properties: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]:</span>
<span id="cb19-77">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Create a dataset for training property prediction with natural language explanations.</span></span>
<span id="cb19-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb19-80">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> target_properties <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb19-81">        target_properties <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_donors'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_acceptors'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drug_like'</span>]</span>
<span id="cb19-82">    </span>
<span id="cb19-83">    dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb19-84">    </span>
<span id="cb19-85">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles_list:</span>
<span id="cb19-86">        mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb19-87">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb19-88">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb19-89">        </span>
<span id="cb19-90">        features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_molecular_features(mol)</span>
<span id="cb19-91">        canonical_smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb19-92">        </span>
<span id="cb19-93">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> prop <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> target_properties:</span>
<span id="cb19-94">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> prop <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> features:</span>
<span id="cb19-95">                value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> features[prop]</span>
<span id="cb19-96">                </span>
<span id="cb19-97">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create natural language explanations for properties</span></span>
<span id="cb19-98">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> prop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>:</span>
<span id="cb19-99">                    explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The molecular weight is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> daltons, which "</span></span>
<span id="cb19-100">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>:</span>
<span id="cb19-101">                        explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"indicates a relatively small molecule."</span></span>
<span id="cb19-102">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>:</span>
<span id="cb19-103">                        explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"suggests a large molecule that may have bioavailability issues."</span></span>
<span id="cb19-104">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb19-105">                        explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is in a reasonable range for drug-like compounds."</span></span>
<span id="cb19-106">                        </span>
<span id="cb19-107">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> prop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>:</span>
<span id="cb19-108">                    explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The LogP value is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, indicating "</span></span>
<span id="cb19-109">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:</span>
<span id="cb19-110">                        explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"high lipophilicity and potential membrane permeability."</span></span>
<span id="cb19-111">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb19-112">                        explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hydrophilic character and good water solubility."</span></span>
<span id="cb19-113">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb19-114">                        explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"balanced lipophilicity suitable for oral drugs."</span></span>
<span id="cb19-115">                        </span>
<span id="cb19-116">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> prop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_donors'</span>:</span>
<span id="cb19-117">                    explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This molecule has </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> hydrogen bond donor(s), which "</span></span>
<span id="cb19-118">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb19-119">                        explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"means it cannot donate hydrogen bonds."</span></span>
<span id="cb19-120">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:</span>
<span id="cb19-121">                        explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is within the acceptable range for drug-like molecules."</span></span>
<span id="cb19-122">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb19-123">                        explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"may limit its ability to cross biological membranes."</span></span>
<span id="cb19-124">                        </span>
<span id="cb19-125">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> prop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drug_like'</span>:</span>
<span id="cb19-126">                    explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This molecule </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> value <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is not'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> drug-like according to Lipinski's Rule of Five."</span></span>
<span id="cb19-127">                    </span>
<span id="cb19-128">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb19-129">                    explanation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> value is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span></span>
<span id="cb19-130">                </span>
<span id="cb19-131">                dataset.append({</span>
<span id="cb19-132">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'task_type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'property_prediction'</span>,</span>
<span id="cb19-133">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'property'</span>: prop,</span>
<span id="cb19-134">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input_smiles'</span>: smiles,</span>
<span id="cb19-135">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>: canonical_smiles,</span>
<span id="cb19-136">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'property_value'</span>: value,</span>
<span id="cb19-137">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"What is the </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> of </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>canonical_smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">?"</span>,</span>
<span id="cb19-138">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb19-139">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'explanation'</span>: explanation,</span>
<span id="cb19-140">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'detailed_response'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> of </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>canonical_smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>explanation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb19-141">                })</span>
<span id="cb19-142">    </span>
<span id="cb19-143">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> dataset</span>
<span id="cb19-144"></span>
<span id="cb19-145"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example: Create training datasets</span></span>
<span id="cb19-146">example_molecules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb19-147">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCO"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ethanol"</span>),</span>
<span id="cb19-148">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ibuprofen"</span>),</span>
<span id="cb19-149">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(=O)OC1=CC=CC=C1C(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Aspirin"</span>),</span>
<span id="cb19-150">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CN1C=NC2=C1C(=O)N(C(=O)N2C)C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Caffeine"</span>),</span>
<span id="cb19-151">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2-(4-methylphenyl)propanoic acid"</span>),</span>
<span id="cb19-152">]</span>
<span id="cb19-153"></span>
<span id="cb19-154">smiles_only <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [mol[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> example_molecules]</span>
<span id="cb19-155">names_only <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [mol[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> example_molecules]</span>
<span id="cb19-156"></span>
<span id="cb19-157"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Creating Molecule-Text Dataset..."</span>)</span>
<span id="cb19-158">mol_text_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_molecule_text_dataset(smiles_only, names_only, include_multiple_styles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb19-159"></span>
<span id="cb19-160"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generated </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(mol_text_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> training examples"</span>)</span>
<span id="cb19-161"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Example training entries:"</span>)</span>
<span id="cb19-162"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb19-163"></span>
<span id="cb19-164"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show a few examples</span></span>
<span id="cb19-165"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(mol_text_data[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]):</span>
<span id="cb19-166">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Example </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>)</span>
<span id="cb19-167">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Task: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'task_type'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-168">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Molecule: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecule_name'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-169">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Prompt: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-170">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Response: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>][:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'...'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-171"></span>
<span id="cb19-172"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb19-173"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Creating Property Prediction Dataset..."</span>)</span>
<span id="cb19-174">prop_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_property_prediction_dataset(smiles_only[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb19-175"></span>
<span id="cb19-176"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generated </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(prop_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> property prediction examples"</span>)</span>
<span id="cb19-177"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Example property prediction entries:"</span>)</span>
<span id="cb19-178"></span>
<span id="cb19-179"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(prop_data[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]):</span>
<span id="cb19-180">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Example </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>)</span>
<span id="cb19-181">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Property: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'property'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-182">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Molecule: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-183">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Prompt: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-184">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Response: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'detailed_response'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating Molecule-Text Dataset...
Generated 15 training examples

Example training entries:
==================================================

Example 1:
Task: molecule_description
Molecule: Ethanol
Prompt: Describe the chemical structure CCO:
Response: This compound has the molecular formula C2H6O and a molecular weight of 46.07 daltons. The structure...

Example 2:
Task: chemical_qa
Molecule: Ethanol
Prompt: What can you tell me about the molecule with SMILES CCO?
Response: This compound has the molecular formula C2H6O and a molecular weight of 46.07 daltons. The structure...

Example 3:
Task: named_molecule_description
Molecule: Ethanol
Prompt: Describe the chemical structure and properties of Ethanol:
Response: Ethanol (CCO) is a compound where this compound has the molecular formula c2h6o and a molecular weig...

==================================================
Creating Property Prediction Dataset...
Generated 15 property prediction examples

Example property prediction entries:

Example 1:
Property: molecular_weight
Molecule: CCO
Prompt: What is the molecular weight of CCO?
Response: The molecular weight of CCO is 46.07. The molecular weight is 46.07 daltons, which indicates a relatively small molecule.

Example 2:
Property: logp
Molecule: CCO
Prompt: What is the logp of CCO?
Response: The logp of CCO is -0.0. The LogP value is -0.0, indicating balanced lipophilicity suitable for oral drugs.

Example 3:
Property: h_bond_donors
Molecule: CCO
Prompt: What is the h bond donors of CCO?
Response: The h bond donors of CCO is 1. This molecule has 1 hydrogen bond donor(s), which is within the acceptable range for drug-like molecules.</code></pre>
</div>
</div>
</section>
<section id="exporting-data-for-different-llm-platforms" class="level2">
<h2 class="anchored" data-anchor-id="exporting-data-for-different-llm-platforms">Exporting Data for Different LLM Platforms</h2>
<p>Different LLM training platforms expect different data formats. Here are functions to export your chemical training data in common formats:</p>
<div id="9dfb0c05" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> export_for_huggingface(dataset: List[Dict], output_file: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chemical_training_data.jsonl"</span>):</span>
<span id="cb21-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Export dataset in HuggingFace datasets format (JSONL).</span></span>
<span id="cb21-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Each line is a JSON object with 'text' field for language modeling</span></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    or 'input'/'output' fields for instruction tuning.</span></span>
<span id="cb21-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb21-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(output_file, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb21-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dataset:</span>
<span id="cb21-9">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format for instruction tuning</span></span>
<span id="cb21-10">            hf_entry <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb21-11">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'instruction'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>],</span>
<span id="cb21-12">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>: entry.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>),</span>
<span id="cb21-13">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'output'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>],</span>
<span id="cb21-14">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'metadata'</span>: {</span>
<span id="cb21-15">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'task_type'</span>: entry.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'task_type'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>),</span>
<span id="cb21-16">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecule_name'</span>: entry.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecule_name'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>),</span>
<span id="cb21-17">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'style'</span>: entry.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'style'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb21-18">                }</span>
<span id="cb21-19">            }</span>
<span id="cb21-20">            f.write(json.dumps(hf_entry) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb21-21">    </span>
<span id="cb21-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Exported </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(dataset)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> entries to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output_file<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (HuggingFace format)"</span>)</span>
<span id="cb21-23"></span>
<span id="cb21-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> export_for_openai(dataset: List[Dict], output_file: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chemical_training_data_openai.jsonl"</span>):</span>
<span id="cb21-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb21-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Export dataset in OpenAI fine-tuning format.</span></span>
<span id="cb21-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Each line has 'messages' with system/user/assistant format.</span></span>
<span id="cb21-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb21-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(output_file, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb21-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dataset:</span>
<span id="cb21-31">            openai_entry <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb21-32">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'messages'</span>: [</span>
<span id="cb21-33">                    {</span>
<span id="cb21-34">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'role'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'system'</span>,</span>
<span id="cb21-35">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'content'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'You are a helpful chemistry assistant that can analyze and describe chemical structures.'</span></span>
<span id="cb21-36">                    },</span>
<span id="cb21-37">                    {</span>
<span id="cb21-38">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'role'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'user'</span>, </span>
<span id="cb21-39">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'content'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>]</span>
<span id="cb21-40">                    },</span>
<span id="cb21-41">                    {</span>
<span id="cb21-42">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'role'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assistant'</span>,</span>
<span id="cb21-43">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'content'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>]</span>
<span id="cb21-44">                    }</span>
<span id="cb21-45">                ]</span>
<span id="cb21-46">            }</span>
<span id="cb21-47">            f.write(json.dumps(openai_entry) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb21-48">    </span>
<span id="cb21-49">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Exported </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(dataset)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> entries to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output_file<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (OpenAI format)"</span>)</span>
<span id="cb21-50"></span>
<span id="cb21-51"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> export_for_llama(dataset: List[Dict], output_file: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chemical_training_data_llama.json"</span>):</span>
<span id="cb21-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb21-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Export dataset in LLaMA/Alpaca instruction format.</span></span>
<span id="cb21-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb21-55">    llama_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb21-56">    </span>
<span id="cb21-57">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dataset:</span>
<span id="cb21-58">        llama_entry <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb21-59">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'instruction'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prompt'</span>],</span>
<span id="cb21-60">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>: entry.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>),</span>
<span id="cb21-61">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'output'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>]</span>
<span id="cb21-62">        }</span>
<span id="cb21-63">        llama_data.append(llama_entry)</span>
<span id="cb21-64">    </span>
<span id="cb21-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(output_file, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb21-66">        json.dump(llama_data, f, indent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb21-67">    </span>
<span id="cb21-68">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Exported </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(dataset)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> entries to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output_file<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (LLaMA/Alpaca format)"</span>)</span>
<span id="cb21-69"></span>
<span id="cb21-70"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_conversational_dataset(smiles_list: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>], names: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict]:</span>
<span id="cb21-71">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb21-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Create a conversational dataset simulating a chemistry chatbot interaction.</span></span>
<span id="cb21-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb21-74">    conversations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb21-75">    </span>
<span id="cb21-76">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(smiles_list):</span>
<span id="cb21-77">        mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb21-78">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb21-79">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb21-80">        </span>
<span id="cb21-81">        name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> names[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> names <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(names) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Compound_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb21-82">        features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_molecular_features(mol)</span>
<span id="cb21-83">        </span>
<span id="cb21-84">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a multi-turn conversation</span></span>
<span id="cb21-85">        conversation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb21-86">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'conversation_id'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"chem_chat_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb21-87">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecule_smiles'</span>: smiles,</span>
<span id="cb21-88">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecule_name'</span>: name,</span>
<span id="cb21-89">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'turns'</span>: []</span>
<span id="cb21-90">        }</span>
<span id="cb21-91">        </span>
<span id="cb21-92">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Turn 1: Initial structure inquiry</span></span>
<span id="cb21-93">        conversation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'turns'</span>].append({</span>
<span id="cb21-94">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'user'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Can you analyze the structure </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>smiles<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">?"</span>,</span>
<span id="cb21-95">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assistant'</span>: generate_molecular_description(mol, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'detailed'</span>)</span>
<span id="cb21-96">        })</span>
<span id="cb21-97">        </span>
<span id="cb21-98">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Turn 2: Property question</span></span>
<span id="cb21-99">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>):</span>
<span id="cb21-100">            conversation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'turns'</span>].append({</span>
<span id="cb21-101">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'user'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What's its molecular weight?"</span>,</span>
<span id="cb21-102">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assistant'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The molecular weight is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> daltons."</span></span>
<span id="cb21-103">            })</span>
<span id="cb21-104">        </span>
<span id="cb21-105">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Turn 3: Drug-likeness question</span></span>
<span id="cb21-106">        conversation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'turns'</span>].append({</span>
<span id="cb21-107">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'user'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Would this be a good drug candidate?"</span>,</span>
<span id="cb21-108">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assistant'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Yes'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drug_like'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'It may face challenges'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, this molecule </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'complies with'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> features<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drug_like'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'violates'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Lipinski's Rule of Five. </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>generate_molecular_description(mol, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'educational'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>)[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span></span>
<span id="cb21-109">        })</span>
<span id="cb21-110">        </span>
<span id="cb21-111">        conversations.append(conversation)</span>
<span id="cb21-112">    </span>
<span id="cb21-113">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> conversations</span>
<span id="cb21-114"></span>
<span id="cb21-115"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Demonstrate the export functions</span></span>
<span id="cb21-116"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exporting Training Data in Different Formats:"</span>)</span>
<span id="cb21-117"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb21-118"></span>
<span id="cb21-119"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the previously created dataset</span></span>
<span id="cb21-120">sample_dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mol_text_data[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use a small sample for demonstration</span></span>
<span id="cb21-121"></span>
<span id="cb21-122"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Export in different formats</span></span>
<span id="cb21-123">export_for_huggingface(sample_dataset, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"demo_huggingface.jsonl"</span>)</span>
<span id="cb21-124">export_for_openai(sample_dataset, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"demo_openai.jsonl"</span>) </span>
<span id="cb21-125">export_for_llama(sample_dataset, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"demo_llama.json"</span>)</span>
<span id="cb21-126"></span>
<span id="cb21-127"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create and show conversational dataset</span></span>
<span id="cb21-128"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Creating Conversational Dataset:"</span>)</span>
<span id="cb21-129">conv_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_conversational_dataset(smiles_only[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], names_only[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb21-130"></span>
<span id="cb21-131"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generated </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(conv_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> conversations"</span>)</span>
<span id="cb21-132"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Example conversation:"</span>)</span>
<span id="cb21-133"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb21-134"></span>
<span id="cb21-135"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, turn <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(conv_data[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'turns'</span>]):</span>
<span id="cb21-136">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Turn </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>)</span>
<span id="cb21-137">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"User: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>turn[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'user'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb21-138">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Assistant: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>turn[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assistant'</span>][:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'...'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(turn[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assistant'</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb21-139">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb21-140"></span>
<span id="cb21-141"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show file contents (first few lines)</span></span>
<span id="cb21-142"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sample exported data:"</span>)</span>
<span id="cb21-143"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb21-144"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb21-145">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"demo_huggingface.jsonl"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb21-146">        lines <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.readlines()[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb21-147">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, line <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(lines):</span>
<span id="cb21-148">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Entry </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>line[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">..."</span>)</span>
<span id="cb21-149"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">FileNotFoundError</span>:</span>
<span id="cb21-150">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Demo files not created (running in demo mode)"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Exporting Training Data in Different Formats:
==================================================
Exported 5 entries to demo_huggingface.jsonl (HuggingFace format)
Exported 5 entries to demo_openai.jsonl (OpenAI format)
Exported 5 entries to demo_llama.json (LLaMA/Alpaca format)

Creating Conversational Dataset:
Generated 2 conversations

Example conversation:
==============================
Turn 1:
User: Can you analyze the structure CCO?
Assistant: This compound has the molecular formula C2H6O and a molecular weight of 46.07 daltons. The structure...

Turn 2:
User: What's its molecular weight?
Assistant: The molecular weight is 46.07 daltons.

Turn 3:
User: Would this be a good drug candidate?
Assistant: Yes, this molecule complies with Lipinski's Rule of Five.  The molecule's size and properties sugges...

Sample exported data:
------------------------------
Entry 1: {"instruction": "Describe the chemical structure CCO:", "input": "CCO", "output": "This compound has...
Entry 2: {"instruction": "What can you tell me about the molecule with SMILES CCO?", "input": "CCO", "output"...</code></pre>
</div>
</div>
</section>
</section>
<section id="real-world-challenges-and-solutions" class="level1">
<h1>Real-World Challenges and Solutions</h1>
<p>While the integration of RDKit and LLMs offers exciting possibilities, real-world implementations face several challenges. This section addresses common issues and provides practical solutions based on experience with production systems.</p>
<section id="challenge-1-performance-and-scalability" class="level2">
<h2 class="anchored" data-anchor-id="challenge-1-performance-and-scalability">Challenge 1: Performance and Scalability</h2>
<p>When processing large datasets or building real-time applications, performance becomes critical. Let’s explore strategies for optimization:</p>
<div id="d4ba7253" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> multiprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mp</span>
<span id="cb23-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> concurrent.futures <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ProcessPoolExecutor, ThreadPoolExecutor</span>
<span id="cb23-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb23-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> functools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> lru_cache</span>
<span id="cb23-5"></span>
<span id="cb23-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OptimizedChemicalProcessor:</span>
<span id="cb23-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb23-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    An optimized processor for handling large-scale chemical data processing</span></span>
<span id="cb23-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    with RDKit and LLM integration.</span></span>
<span id="cb23-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb23-11">    </span>
<span id="cb23-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, max_workers: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, use_caching: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb23-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_workers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> max_workers <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> mp.cpu_count()</span>
<span id="cb23-14">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.use_caching <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> use_caching</span>
<span id="cb23-15">        </span>
<span id="cb23-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-compile common SMARTS patterns for efficiency</span></span>
<span id="cb23-17">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.functional_group_patterns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb23-18">            name: Chem.MolFromSmarts(smarts) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, smarts <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> {</span>
<span id="cb23-19">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'carboxylic_acid'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[CX3](=O)[OX2H1]'</span>,</span>
<span id="cb23-20">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ester'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[#6][CX3](=O)[OX2H0][#6]'</span>,</span>
<span id="cb23-21">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alcohol'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[OX2H]'</span>,</span>
<span id="cb23-22">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'amine'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[NX3;H2,H1;!$(NC=O)]'</span>,</span>
<span id="cb23-23">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ketone'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[#6][CX3](=O)[#6]'</span>,</span>
<span id="cb23-24">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aromatic_ring'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1ccccc1'</span>,</span>
<span id="cb23-25">            }.items()</span>
<span id="cb23-26">        }</span>
<span id="cb23-27">    </span>
<span id="cb23-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@lru_cache</span>(maxsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>)</span>
<span id="cb23-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cached_mol_from_smiles(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, smiles: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb23-30">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Cached molecule parsing to avoid repeated work."""</span></span>
<span id="cb23-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb23-32">    </span>
<span id="cb23-33">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_smiles_batch_parallel(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, smiles_list: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict]:</span>
<span id="cb23-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb23-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Process a batch of SMILES in parallel for better performance.</span></span>
<span id="cb23-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb23-37">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use ProcessPoolExecutor for CPU-bound tasks</span></span>
<span id="cb23-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> ProcessPoolExecutor(max_workers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_workers) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> executor:</span>
<span id="cb23-39">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split into chunks to reduce overhead</span></span>
<span id="cb23-40">            chunk_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles_list) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.max_workers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb23-41">            chunks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [smiles_list[i:i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> chunk_size] </span>
<span id="cb23-42">                     <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles_list), chunk_size)]</span>
<span id="cb23-43">            </span>
<span id="cb23-44">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process chunks in parallel</span></span>
<span id="cb23-45">            futures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [executor.submit(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._process_chunk, chunk) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> chunks]</span>
<span id="cb23-46">            results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb23-47">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> future <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> futures:</span>
<span id="cb23-48">                results.extend(future.result())</span>
<span id="cb23-49">        </span>
<span id="cb23-50">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> results</span>
<span id="cb23-51">    </span>
<span id="cb23-52">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _process_chunk(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, smiles_chunk: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict]:</span>
<span id="cb23-53">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Process a chunk of SMILES strings."""</span></span>
<span id="cb23-54">        results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb23-55">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles_chunk:</span>
<span id="cb23-56">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb23-57">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.use_caching:</span>
<span id="cb23-58">                    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cached_mol_from_smiles(smiles)</span>
<span id="cb23-59">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb23-60">                    mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb23-61">                </span>
<span id="cb23-62">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb23-63">                    features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._extract_features_optimized(mol)</span>
<span id="cb23-64">                    features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> smiles</span>
<span id="cb23-65">                    results.append(features)</span>
<span id="cb23-66">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb23-67">                    results.append({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: smiles, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Invalid SMILES'</span>})</span>
<span id="cb23-68">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb23-69">                results.append({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: smiles, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)})</span>
<span id="cb23-70">        </span>
<span id="cb23-71">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> results</span>
<span id="cb23-72">    </span>
<span id="cb23-73">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _extract_features_optimized(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, mol: Chem.Mol) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict:</span>
<span id="cb23-74">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Optimized feature extraction focusing on essential properties."""</span></span>
<span id="cb23-75">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only calculate the most important features to save time</span></span>
<span id="cb23-76">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb23-77">            features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb23-78">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(Descriptors.MolWt(mol), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb23-79">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(Descriptors.MolLogP(mol), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb23-80">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms'</span>: mol.GetNumAtoms(),</span>
<span id="cb23-81">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>: rdMolDescriptors.CalcNumRings(mol),</span>
<span id="cb23-82">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_donors'</span>: Descriptors.NumHDonors(mol),</span>
<span id="cb23-83">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h_bond_acceptors'</span>: Descriptors.NumHAcceptors(mol),</span>
<span id="cb23-84">            }</span>
<span id="cb23-85">            </span>
<span id="cb23-86">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fast functional group detection using pre-compiled patterns</span></span>
<span id="cb23-87">            functional_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb23-88">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fg_name, pattern <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.functional_group_patterns.items():</span>
<span id="cb23-89">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol.HasSubstructMatch(pattern):</span>
<span id="cb23-90">                    functional_groups.append(fg_name)</span>
<span id="cb23-91">            </span>
<span id="cb23-92">            features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> functional_groups</span>
<span id="cb23-93">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> features</span>
<span id="cb23-94">            </span>
<span id="cb23-95">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb23-96">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Feature extraction failed: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>}</span>
<span id="cb23-97"></span>
<span id="cb23-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Performance comparison demonstration</span></span>
<span id="cb23-99"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> benchmark_processing_methods():</span>
<span id="cb23-100">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Compare different processing approaches for performance."""</span></span>
<span id="cb23-101">    </span>
<span id="cb23-102">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate test data</span></span>
<span id="cb23-103">    test_smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb23-104">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCO"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c1ccccc1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>,</span>
<span id="cb23-105">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CN1C=NC2=C1C(=O)N(C(=O)N2C)C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CC(=O)OC1=CC=CC=C1C(=O)O"</span></span>
<span id="cb23-106">    ] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1000 molecules for testing</span></span>
<span id="cb23-107">    </span>
<span id="cb23-108">    processor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OptimizedChemicalProcessor()</span>
<span id="cb23-109">    </span>
<span id="cb23-110">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Performance Benchmark:"</span>)</span>
<span id="cb23-111">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span>
<span id="cb23-112">    </span>
<span id="cb23-113">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 1: Sequential processing</span></span>
<span id="cb23-114">    start_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time()</span>
<span id="cb23-115">    sequential_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb23-116">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test_smiles:</span>
<span id="cb23-117">        mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb23-118">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb23-119">            features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_molecular_features(mol)</span>
<span id="cb23-120">            sequential_results.append(features)</span>
<span id="cb23-121">    sequential_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_time</span>
<span id="cb23-122">    </span>
<span id="cb23-123">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 2: Parallel processing</span></span>
<span id="cb23-124">    start_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time()</span>
<span id="cb23-125">    parallel_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> processor.process_smiles_batch_parallel(test_smiles)</span>
<span id="cb23-126">    parallel_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_time</span>
<span id="cb23-127">    </span>
<span id="cb23-128">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 3: Cached processing</span></span>
<span id="cb23-129">    start_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time()</span>
<span id="cb23-130">    cached_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb23-131">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test_smiles:</span>
<span id="cb23-132">        mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> processor.cached_mol_from_smiles(smiles)</span>
<span id="cb23-133">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb23-134">            features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> processor._extract_features_optimized(mol)</span>
<span id="cb23-135">            cached_results.append(features)</span>
<span id="cb23-136">    cached_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.time() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_time</span>
<span id="cb23-137">    </span>
<span id="cb23-138">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sequential processing: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sequential_time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> seconds"</span>)</span>
<span id="cb23-139">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Parallel processing: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>parallel_time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> seconds"</span>)</span>
<span id="cb23-140">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Cached processing: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>cached_time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> seconds"</span>)</span>
<span id="cb23-141">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Speedup (parallel): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sequential_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>parallel_time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">x"</span>)</span>
<span id="cb23-142">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Speedup (cached): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sequential_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>cached_time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">x"</span>)</span>
<span id="cb23-143">    </span>
<span id="cb23-144">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify results are consistent</span></span>
<span id="cb23-145">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Results consistency check:"</span>)</span>
<span id="cb23-146">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sequential results: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sequential_results)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> molecules processed"</span>)</span>
<span id="cb23-147">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Parallel results: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>([r <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> parallel_results <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> r])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> molecules processed"</span>)</span>
<span id="cb23-148">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Cached results: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(cached_results)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> molecules processed"</span>)</span>
<span id="cb23-149"></span>
<span id="cb23-150"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the benchmark</span></span>
<span id="cb23-151">benchmark_processing_methods()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Performance Benchmark:
========================================
Sequential processing: 0.32 seconds
Parallel processing: 0.09 seconds
Cached processing: 0.02 seconds
Speedup (parallel): 3.7x
Speedup (cached): 13.3x

Results consistency check:
Sequential results: 1000 molecules processed
Parallel results: 1000 molecules processed
Cached results: 1000 molecules processed</code></pre>
</div>
</div>
</section>
<section id="challenge-2-handling-inconsistent-llm-outputs" class="level2">
<h2 class="anchored" data-anchor-id="challenge-2-handling-inconsistent-llm-outputs">Challenge 2: Handling Inconsistent LLM Outputs</h2>
<p>LLMs can produce inconsistent or partially correct chemical information. Here’s how to build robust systems that handle these issues:</p>
<div id="1ca9a67b" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> RobustChemicalParser:</span>
<span id="cb25-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A parser that can handle messy, inconsistent LLM outputs and extract</span></span>
<span id="cb25-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    useful chemical information with confidence scoring.</span></span>
<span id="cb25-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb25-6">    </span>
<span id="cb25-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb25-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Common patterns for extracting chemical information from text</span></span>
<span id="cb25-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.smiles_patterns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb25-10">            <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'\b([A-Za-z0-9@+\-\[\]\(\)=#$:%\\\/\.]+)\b'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># General SMILES pattern</span></span>
<span id="cb25-11">            <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'SMILES[:\s]*([A-Za-z0-9@+\-\[\]\(\)=#$:%\\\/\.]+)'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># SMILES: prefix</span></span>
<span id="cb25-12">            <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'structure[:\s]*([A-Za-z0-9@+\-\[\]\(\)=#$:%\\\/\.]+)'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># structure: prefix</span></span>
<span id="cb25-13">        ]</span>
<span id="cb25-14">        </span>
<span id="cb25-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.molecular_weight_patterns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb25-16">            <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'molecular weight[:\s]*(\d+\.?\d*)\s*(?:Da|daltons?|g/mol)?'</span>,</span>
<span id="cb25-17">            <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'MW[:\s]*(\d+\.?\d*)'</span>,</span>
<span id="cb25-18">            <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'(\d+\.?\d*)\s*(?:Da|daltons?|g/mol)'</span>,</span>
<span id="cb25-19">        ]</span>
<span id="cb25-20">        </span>
<span id="cb25-21">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.property_patterns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb25-22">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>: [<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'LogP[:\s]*(-?\d+\.?\d*)'</span>, <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'log\s*P[:\s]*(-?\d+\.?\d*)'</span>],</span>
<span id="cb25-23">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tpsa'</span>: [<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'TPSA[:\s]*(\d+\.?\d*)'</span>, <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'polar surface area[:\s]*(\d+\.?\d*)'</span>],</span>
<span id="cb25-24">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hbd'</span>: [<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'H-bond donors?[:\s]*(\d+)'</span>, <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'hydrogen bond donors?[:\s]*(\d+)'</span>],</span>
<span id="cb25-25">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hba'</span>: [<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'H-bond acceptors?[:\s]*(\d+)'</span>, <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'hydrogen bond acceptors?[:\s]*(\d+)'</span>],</span>
<span id="cb25-26">        }</span>
<span id="cb25-27">    </span>
<span id="cb25-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> extract_chemical_entities(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>]:</span>
<span id="cb25-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb25-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Extract chemical entities from potentially messy LLM text output.</span></span>
<span id="cb25-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns results with confidence scores.</span></span>
<span id="cb25-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb25-33">        results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb25-34">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'extracted_smiles'</span>: [],</span>
<span id="cb25-35">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb25-36">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>: {},</span>
<span id="cb25-37">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence_scores'</span>: {},</span>
<span id="cb25-38">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'raw_text'</span>: text</span>
<span id="cb25-39">        }</span>
<span id="cb25-40">        </span>
<span id="cb25-41">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract SMILES candidates</span></span>
<span id="cb25-42">        smiles_candidates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._extract_smiles_candidates(text)</span>
<span id="cb25-43">        validated_smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb25-44">        </span>
<span id="cb25-45">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> candidate, confidence <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles_candidates:</span>
<span id="cb25-46">            validation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> validate_smiles_with_details(candidate)</span>
<span id="cb25-47">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> validation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>]:</span>
<span id="cb25-48">                validated_smiles.append({</span>
<span id="cb25-49">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: candidate,</span>
<span id="cb25-50">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>: validation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>],</span>
<span id="cb25-51">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence'</span>: confidence,</span>
<span id="cb25-52">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>: validation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>]</span>
<span id="cb25-53">                })</span>
<span id="cb25-54">        </span>
<span id="cb25-55">        results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'extracted_smiles'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> validated_smiles</span>
<span id="cb25-56">        </span>
<span id="cb25-57">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract molecular weight</span></span>
<span id="cb25-58">        mw_match <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._extract_molecular_weight(text)</span>
<span id="cb25-59">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mw_match:</span>
<span id="cb25-60">            results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mw_match[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>]</span>
<span id="cb25-61">            results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence_scores'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mw_match[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence'</span>]</span>
<span id="cb25-62">        </span>
<span id="cb25-63">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract other properties</span></span>
<span id="cb25-64">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> prop_name, patterns <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.property_patterns.items():</span>
<span id="cb25-65">            prop_match <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._extract_property(text, patterns)</span>
<span id="cb25-66">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> prop_match:</span>
<span id="cb25-67">                results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>][prop_name] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prop_match[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>]</span>
<span id="cb25-68">                results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence_scores'</span>][prop_name] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prop_match[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence'</span>]</span>
<span id="cb25-69">        </span>
<span id="cb25-70">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> results</span>
<span id="cb25-71">    </span>
<span id="cb25-72">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _extract_smiles_candidates(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>]]:</span>
<span id="cb25-73">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Extract SMILES candidates with confidence scores."""</span></span>
<span id="cb25-74">        candidates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb25-75">        </span>
<span id="cb25-76">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, pattern <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.smiles_patterns):</span>
<span id="cb25-77">            matches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.findall(pattern, text, re.IGNORECASE)</span>
<span id="cb25-78">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> match <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> matches:</span>
<span id="cb25-79">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Basic heuristics for SMILES likelihood</span></span>
<span id="cb25-80">                confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._calculate_smiles_confidence(match, pattern_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>i)</span>
<span id="cb25-81">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Minimum confidence threshold</span></span>
<span id="cb25-82">                    candidates.append((match, confidence))</span>
<span id="cb25-83">        </span>
<span id="cb25-84">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove duplicates and sort by confidence</span></span>
<span id="cb25-85">        seen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb25-86">        unique_candidates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb25-87">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles, conf <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(candidates, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], reverse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb25-88">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> seen:</span>
<span id="cb25-89">                seen.add(smiles)</span>
<span id="cb25-90">                unique_candidates.append((smiles, conf))</span>
<span id="cb25-91">        </span>
<span id="cb25-92">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> unique_candidates[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return top 5 candidates</span></span>
<span id="cb25-93">    </span>
<span id="cb25-94">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _calculate_smiles_confidence(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, smiles: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, pattern_index: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb25-95">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Calculate confidence score for a SMILES candidate."""</span></span>
<span id="cb25-96">        confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Base confidence</span></span>
<span id="cb25-97">        </span>
<span id="cb25-98">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pattern-based confidence adjustment</span></span>
<span id="cb25-99">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pattern_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Explicit SMILES: prefix</span></span>
<span id="cb25-100">            confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb25-101">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> pattern_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># structure: prefix</span></span>
<span id="cb25-102">            confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb25-103">        </span>
<span id="cb25-104">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Length-based heuristics</span></span>
<span id="cb25-105">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>:</span>
<span id="cb25-106">            confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb25-107">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>:</span>
<span id="cb25-108">            confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb25-109">        </span>
<span id="cb25-110">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Character composition heuristics</span></span>
<span id="cb25-111">        valid_chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CNOSPFClBrIH[]()=@+-.0123456789#</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/%$'</span>)</span>
<span id="cb25-112">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>(c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> valid_chars <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles):</span>
<span id="cb25-113">            confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb25-114">        </span>
<span id="cb25-115">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Common SMILES patterns</span></span>
<span id="cb25-116">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(pattern <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> pattern <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1ccccc1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CN'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CO'</span>]):</span>
<span id="cb25-117">            confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb25-118">        </span>
<span id="cb25-119">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, confidence))</span>
<span id="cb25-120">    </span>
<span id="cb25-121">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _extract_molecular_weight(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Optional[Dict]:</span>
<span id="cb25-122">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Extract molecular weight with confidence."""</span></span>
<span id="cb25-123">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> pattern <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.molecular_weight_patterns:</span>
<span id="cb25-124">            matches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.findall(pattern, text, re.IGNORECASE)</span>
<span id="cb25-125">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> matches:</span>
<span id="cb25-126">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb25-127">                    value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(matches[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb25-128">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reasonable MW range</span></span>
<span id="cb25-129">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb25-130">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>: value,</span>
<span id="cb25-131">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular weight'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pattern <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span></span>
<span id="cb25-132">                        }</span>
<span id="cb25-133">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>:</span>
<span id="cb25-134">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb25-135">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb25-136">    </span>
<span id="cb25-137">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _extract_property(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, patterns: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Optional[Dict]:</span>
<span id="cb25-138">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Extract a property value with confidence."""</span></span>
<span id="cb25-139">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> pattern <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> patterns:</span>
<span id="cb25-140">            matches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.findall(pattern, text, re.IGNORECASE)</span>
<span id="cb25-141">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> matches:</span>
<span id="cb25-142">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb25-143">                    value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(matches[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb25-144">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>: value, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>}</span>
<span id="cb25-145">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>:</span>
<span id="cb25-146">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb25-147">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb25-148">    </span>
<span id="cb25-149">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cross_validate_extractions(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>]:</span>
<span id="cb25-150">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb25-151"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Cross-validate extracted information against RDKit calculations.</span></span>
<span id="cb25-152"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb25-153">        extraction <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.extract_chemical_entities(text)</span>
<span id="cb25-154">        validation_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb25-155">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'extraction'</span>: extraction,</span>
<span id="cb25-156">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'validation'</span>: {},</span>
<span id="cb25-157">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'discrepancies'</span>: [],</span>
<span id="cb25-158">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'overall_confidence'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb25-159">        }</span>
<span id="cb25-160">        </span>
<span id="cb25-161">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'extracted_smiles'</span>]:</span>
<span id="cb25-162">            best_smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'extracted_smiles'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb25-163">            mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(best_smiles[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>])</span>
<span id="cb25-164">            </span>
<span id="cb25-165">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb25-166">                rdkit_props <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_molecular_features(mol)</span>
<span id="cb25-167">                </span>
<span id="cb25-168">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cross-validate molecular weight</span></span>
<span id="cb25-169">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]:</span>
<span id="cb25-170">                    rdkit_mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rdkit_props[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]</span>
<span id="cb25-171">                    extracted_mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]</span>
<span id="cb25-172">                    mw_diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(rdkit_mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> extracted_mw)</span>
<span id="cb25-173">                    </span>
<span id="cb25-174">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mw_diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>:</span>
<span id="cb25-175">                        validation_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'validation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MATCH'</span></span>
<span id="cb25-176">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> mw_diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span>:</span>
<span id="cb25-177">                        validation_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'validation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CLOSE'</span></span>
<span id="cb25-178">                        validation_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'discrepancies'</span>].append(</span>
<span id="cb25-179">                            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MW discrepancy: extracted=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>extracted_mw<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, calculated=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rdkit_mw<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb25-180">                        )</span>
<span id="cb25-181">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb25-182">                        validation_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'validation'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MISMATCH'</span></span>
<span id="cb25-183">                        validation_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'discrepancies'</span>].append(</span>
<span id="cb25-184">                            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Major MW discrepancy: extracted=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>extracted_mw<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, calculated=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rdkit_mw<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb25-185">                        )</span>
<span id="cb25-186">                </span>
<span id="cb25-187">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cross-validate other properties</span></span>
<span id="cb25-188">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> prop <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hbd'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hba'</span>]:</span>
<span id="cb25-189">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> prop <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'properties'</span>]:</span>
<span id="cb25-190">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add property validation logic here</span></span>
<span id="cb25-191">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb25-192">                </span>
<span id="cb25-193">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate overall confidence</span></span>
<span id="cb25-194">                confidence_scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence_scores'</span>].values())</span>
<span id="cb25-195">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> confidence_scores:</span>
<span id="cb25-196">                    validation_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'overall_confidence'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(confidence_scores) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(confidence_scores)</span>
<span id="cb25-197">        </span>
<span id="cb25-198">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> validation_results</span>
<span id="cb25-199"></span>
<span id="cb25-200"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Demonstration with messy LLM outputs</span></span>
<span id="cb25-201">parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RobustChemicalParser()</span>
<span id="cb25-202"></span>
<span id="cb25-203"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate various types of messy LLM outputs</span></span>
<span id="cb25-204">messy_outputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb25-205">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The compound has SMILES: CC(C)CC1=CC=C(C=C1)C(C)C(=O)O and molecular weight 206.3 Da"</span>,</span>
<span id="cb25-206">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This molecule (c1ccccc1) is benzene, MW: 78.11 g/mol, LogP: 2.13"</span>,</span>
<span id="cb25-207">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Structure: CCO, ethanol, with 2 H-bond donors and 1 H-bond acceptor"</span>,</span>
<span id="cb25-208">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The SMILES string is probably C1=CC=C(C=C1)C(=O)O but I'm not completely sure about the molecular weight being around 122"</span>,</span>
<span id="cb25-209">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Invalid SMILES: XYZ123ABC and some random text with molecular weight 999999 Da"</span>,</span>
<span id="cb25-210">]</span>
<span id="cb25-211"></span>
<span id="cb25-212"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Robust Chemical Information Extraction:"</span>)</span>
<span id="cb25-213"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb25-214"></span>
<span id="cb25-215"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, text <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(messy_outputs):</span>
<span id="cb25-216">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Example </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>)</span>
<span id="cb25-217">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Input: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-218">    </span>
<span id="cb25-219">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract and validate</span></span>
<span id="cb25-220">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser.cross_validate_extractions(text)</span>
<span id="cb25-221">    extraction <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'extraction'</span>]</span>
<span id="cb25-222">    </span>
<span id="cb25-223">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Extracted SMILES: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'extracted_smiles'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> candidates"</span>)</span>
<span id="cb25-224">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'extracted_smiles'</span>]:</span>
<span id="cb25-225">        best <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'extracted_smiles'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb25-226">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Best: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>best[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (confidence: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>best[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb25-227">    </span>
<span id="cb25-228">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]:</span>
<span id="cb25-229">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Molecular Weight: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (confidence: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>extraction[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence_scores'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb25-230">    </span>
<span id="cb25-231">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'discrepancies'</span>]:</span>
<span id="cb25-232">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Discrepancies: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'discrepancies'</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-233">    </span>
<span id="cb25-234">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Overall confidence: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'overall_confidence'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-235">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Robust Chemical Information Extraction:
==================================================

Example 1:
Input: The compound has SMILES: CC(C)CC1=CC=C(C=C1)C(C)C(=O)O and molecular weight 206.3 Da
Extracted SMILES: 1 candidates
  Best: CC(C)Cc1ccc(C(C)C(=O)O)cc1 (confidence: 1.00)
Molecular Weight: 206.3 (confidence: 0.80)
Overall confidence: 0.80
------------------------------

Example 2:
Input: This molecule (c1ccccc1) is benzene, MW: 78.11 g/mol, LogP: 2.13
Extracted SMILES: 1 candidates
  Best: c1ccccc1 (confidence: 0.80)
Molecular Weight: 78.11 (confidence: 0.60)
Overall confidence: 0.65
------------------------------

Example 3:
Input: Structure: CCO, ethanol, with 2 H-bond donors and 1 H-bond acceptor
Extracted SMILES: 1 candidates
  Best: CCO (confidence: 1.00)
Overall confidence: 0.00
------------------------------

Example 4:
Input: The SMILES string is probably C1=CC=C(C=C1)C(=O)O but I'm not completely sure about the molecular weight being around 122
Extracted SMILES: 1 candidates
  Best: O=C(O)c1ccccc1 (confidence: 1.00)
Overall confidence: 0.00
------------------------------

Example 5:
Input: Invalid SMILES: XYZ123ABC and some random text with molecular weight 999999 Da
Extracted SMILES: 0 candidates
Overall confidence: 0.00
------------------------------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:53:55] SMILES Parse Error: syntax error while parsing: 206.3
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] 206.3
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES '206.3' for input: '206.3'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'compound' for input: 'compound'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'SMILES' for input: 'SMILES'
[09:53:55] SMILES Parse Error: syntax error while parsing: molecular
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] molecular
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'molecular' for input: 'molecular'
[09:53:55] SMILES Parse Error: syntax error while parsing: 78.11
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] 78.11
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES '78.11' for input: '78.11'
[09:53:55] SMILES Parse Error: syntax error while parsing: molecule
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] molecule
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'molecule' for input: 'molecule'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'benzene' for input: 'benzene'
[09:53:55] SMILES Parse Error: syntax error while parsing: g/mol
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] g/mol
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'g/mol' for input: 'g/mol'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'Structure' for input: 'Structure'
[09:53:55] SMILES Parse Error: syntax error while parsing: ethanol
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] ethanol
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'ethanol' for input: 'ethanol'
[09:53:55] SMILES Parse Error: syntax error while parsing: H-bond
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] H-bond
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'H-bond' for input: 'H-bond'
[09:53:55] SMILES Parse Error: syntax error while parsing: donors
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] donors
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'donors' for input: 'donors'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'string' for input: 'string'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'SMILES' for input: 'SMILES'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'probably' for input: 'probably'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'completely' for input: 'completely'
[09:53:55] SMILES Parse Error: syntax error while parsing: XYZ123ABC
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] XYZ123ABC
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'XYZ123ABC' for input: 'XYZ123ABC'
[09:53:55] SMILES Parse Error: syntax error while parsing: 999999
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] 999999
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES '999999' for input: '999999'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'Invalid' for input: 'Invalid'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'SMILES' for input: 'SMILES'
[09:53:55] SMILES Parse Error: syntax error while parsing: random
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] random
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'random' for input: 'random'</code></pre>
</div>
</div>
</section>
<section id="challenge-3-data-quality-and-contamination" class="level2">
<h2 class="anchored" data-anchor-id="challenge-3-data-quality-and-contamination">Challenge 3: Data Quality and Contamination</h2>
<p>Chemical datasets often contain errors, duplicates, and inconsistencies. Here’s how to build quality control systems:</p>
<blockquote class="blockquote">
<p><strong>NOTE FROM GREG</strong>: I needed to add an import to the following block</p>
</blockquote>
<div id="fb13eead" class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># EDIT BY GREG: add missing import</span></span>
<span id="cb28-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DataStructs</span>
<span id="cb28-3"></span>
<span id="cb28-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ChemicalDataQualityController:</span>
<span id="cb28-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb28-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A comprehensive system for detecting and handling data quality issues</span></span>
<span id="cb28-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    in chemical datasets used for LLM training.</span></span>
<span id="cb28-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb28-9">    </span>
<span id="cb28-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, similarity_threshold: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.85</span>):</span>
<span id="cb28-11">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.similarity_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> similarity_threshold</span>
<span id="cb28-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.quality_stats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb28-13">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_processed'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb28-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'duplicates_found'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb28-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'invalid_structures'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb28-16">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'outliers_detected'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb28-17">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cleaned_structures'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb28-18">        }</span>
<span id="cb28-19">    </span>
<span id="cb28-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> comprehensive_quality_check(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, data: List[Dict]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>]:</span>
<span id="cb28-21">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb28-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Perform comprehensive quality checks on chemical dataset.</span></span>
<span id="cb28-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb28-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb28-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            data: List of dictionaries with 'smiles' and optional 'name', 'description' keys</span></span>
<span id="cb28-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb28-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb28-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Quality report with flagged issues and cleaned data</span></span>
<span id="cb28-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb28-30">        report <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb28-31">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_size'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(data),</span>
<span id="cb28-32">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>: {</span>
<span id="cb28-33">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'duplicates'</span>: [],</span>
<span id="cb28-34">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'invalid_smiles'</span>: [],</span>
<span id="cb28-35">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'structural_outliers'</span>: [],</span>
<span id="cb28-36">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_inconsistencies'</span>: [],</span>
<span id="cb28-37">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'suspicious_patterns'</span>: []</span>
<span id="cb28-38">            },</span>
<span id="cb28-39">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cleaned_data'</span>: [],</span>
<span id="cb28-40">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'recommendations'</span>: []</span>
<span id="cb28-41">        }</span>
<span id="cb28-42">        </span>
<span id="cb28-43">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Running comprehensive data quality checks..."</span>)</span>
<span id="cb28-44">        </span>
<span id="cb28-45">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 1: Basic validation and cleaning</span></span>
<span id="cb28-46">        valid_entries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-47">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(data):</span>
<span id="cb28-48">            smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> entry.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb28-49">            validation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> validate_smiles_with_details(smiles)</span>
<span id="cb28-50">            </span>
<span id="cb28-51">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> validation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_valid'</span>]:</span>
<span id="cb28-52">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store canonical SMILES for consistency</span></span>
<span id="cb28-53">                entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> validation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]</span>
<span id="cb28-54">                entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i</span>
<span id="cb28-55">                valid_entries.append(entry)</span>
<span id="cb28-56">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb28-57">                report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'invalid_smiles'</span>].append({</span>
<span id="cb28-58">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>: i,</span>
<span id="cb28-59">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: smiles,</span>
<span id="cb28-60">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>: validation[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'errors'</span>]</span>
<span id="cb28-61">                })</span>
<span id="cb28-62">        </span>
<span id="cb28-63">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Valid structures: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_entries)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-64">        </span>
<span id="cb28-65">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 2: Duplicate detection</span></span>
<span id="cb28-66">        duplicates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._find_duplicates(valid_entries)</span>
<span id="cb28-67">        report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'duplicates'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> duplicates</span>
<span id="cb28-68">        </span>
<span id="cb28-69">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 3: Structural outlier detection</span></span>
<span id="cb28-70">        outliers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._detect_structural_outliers(valid_entries)</span>
<span id="cb28-71">        report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'structural_outliers'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> outliers</span>
<span id="cb28-72">        </span>
<span id="cb28-73">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 4: Text-structure consistency checks</span></span>
<span id="cb28-74">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entry <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> valid_entries):</span>
<span id="cb28-75">            inconsistencies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._check_text_structure_consistency(valid_entries)</span>
<span id="cb28-76">            report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_inconsistencies'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> inconsistencies</span>
<span id="cb28-77">        </span>
<span id="cb28-78">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 5: Suspicious pattern detection</span></span>
<span id="cb28-79">        suspicious <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._detect_suspicious_patterns(valid_entries)</span>
<span id="cb28-80">        report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'suspicious_patterns'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> suspicious</span>
<span id="cb28-81">        </span>
<span id="cb28-82">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 6: Create cleaned dataset</span></span>
<span id="cb28-83">        cleaned_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._create_cleaned_dataset(valid_entries, report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>])</span>
<span id="cb28-84">        report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cleaned_data'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cleaned_data</span>
<span id="cb28-85">        report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'final_size'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(cleaned_data)</span>
<span id="cb28-86">        </span>
<span id="cb28-87">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Step 7: Generate recommendations</span></span>
<span id="cb28-88">        report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'recommendations'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._generate_recommendations(report)</span>
<span id="cb28-89">        </span>
<span id="cb28-90">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> report</span>
<span id="cb28-91">    </span>
<span id="cb28-92">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _find_duplicates(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, entries: List[Dict]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict]:</span>
<span id="cb28-93">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Find duplicate structures using canonical SMILES and similarity."""</span></span>
<span id="cb28-94">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  Checking for duplicates..."</span>)</span>
<span id="cb28-95">        </span>
<span id="cb28-96">        duplicates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-97">        seen_smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb28-98">        </span>
<span id="cb28-99">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exact duplicates (same canonical SMILES)</span></span>
<span id="cb28-100">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entries:</span>
<span id="cb28-101">            canonical <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]</span>
<span id="cb28-102">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> canonical <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> seen_smiles:</span>
<span id="cb28-103">                duplicates.append({</span>
<span id="cb28-104">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exact_duplicate'</span>,</span>
<span id="cb28-105">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'indices'</span>: [seen_smiles[canonical][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>], entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>]],</span>
<span id="cb28-106">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: canonical,</span>
<span id="cb28-107">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'names'</span>: [seen_smiles[canonical].get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Unknown'</span>), </span>
<span id="cb28-108">                             entry.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Unknown'</span>)]</span>
<span id="cb28-109">                })</span>
<span id="cb28-110">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb28-111">                seen_smiles[canonical] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> entry</span>
<span id="cb28-112">        </span>
<span id="cb28-113">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Near-duplicates (high structural similarity)</span></span>
<span id="cb28-114">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(entries) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only for smaller datasets due to O(n²) complexity</span></span>
<span id="cb28-115">            fingerprints <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-116">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entries:</span>
<span id="cb28-117">                mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>])</span>
<span id="cb28-118">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb28-119">                    fp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.RDKFingerprint(mol)</span>
<span id="cb28-120">                    fingerprints.append((entry, fp))</span>
<span id="cb28-121">            </span>
<span id="cb28-122">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, (entry1, fp1) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(fingerprints):</span>
<span id="cb28-123">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j, (entry2, fp2) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(fingerprints[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:], i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb28-124">                    similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataStructs.TanimotoSimilarity(fp1, fp2)</span>
<span id="cb28-125">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.similarity_threshold:</span>
<span id="cb28-126">                        duplicates.append({</span>
<span id="cb28-127">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'near_duplicate'</span>,</span>
<span id="cb28-128">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'similarity'</span>: similarity,</span>
<span id="cb28-129">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'indices'</span>: [entry1[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>], entry2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>]],</span>
<span id="cb28-130">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: [entry1[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>], entry2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]],</span>
<span id="cb28-131">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'names'</span>: [entry1.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Unknown'</span>), entry2.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Unknown'</span>)]</span>
<span id="cb28-132">                        })</span>
<span id="cb28-133">        </span>
<span id="cb28-134">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> duplicates</span>
<span id="cb28-135">    </span>
<span id="cb28-136">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _detect_structural_outliers(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, entries: List[Dict]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict]:</span>
<span id="cb28-137">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Detect structural outliers that might indicate data quality issues."""</span></span>
<span id="cb28-138">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  Detecting structural outliers..."</span>)</span>
<span id="cb28-139">        </span>
<span id="cb28-140">        outliers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-141">        properties <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-142">        </span>
<span id="cb28-143">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate properties for all molecules</span></span>
<span id="cb28-144">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entries:</span>
<span id="cb28-145">            mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>])</span>
<span id="cb28-146">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb28-147">                props <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb28-148">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mw'</span>: Descriptors.MolWt(mol),</span>
<span id="cb28-149">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>: Descriptors.MolLogP(mol),</span>
<span id="cb28-150">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms'</span>: mol.GetNumAtoms(),</span>
<span id="cb28-151">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>: rdMolDescriptors.CalcNumRings(mol),</span>
<span id="cb28-152">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'entry'</span>: entry</span>
<span id="cb28-153">                }</span>
<span id="cb28-154">                properties.append(props)</span>
<span id="cb28-155">        </span>
<span id="cb28-156">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> properties:</span>
<span id="cb28-157">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> outliers</span>
<span id="cb28-158">        </span>
<span id="cb28-159">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Statistical outlier detection using IQR method</span></span>
<span id="cb28-160">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> prop_name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mw'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_rings'</span>]:</span>
<span id="cb28-161">            values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [p[prop_name] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> properties]</span>
<span id="cb28-162">            q1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Series(values).quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span>
<span id="cb28-163">            q3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Series(values).quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>)</span>
<span id="cb28-164">            iqr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> q1</span>
<span id="cb28-165">            </span>
<span id="cb28-166">            lower_bound <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> iqr  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># More permissive than standard 1.5*IQR</span></span>
<span id="cb28-167">            upper_bound <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> q3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> iqr</span>
<span id="cb28-168">            </span>
<span id="cb28-169">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> props <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> properties:</span>
<span id="cb28-170">                value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> props[prop_name]</span>
<span id="cb28-171">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> lower_bound <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> upper_bound:</span>
<span id="cb28-172">                    outliers.append({</span>
<span id="cb28-173">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prop_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_outlier'</span>,</span>
<span id="cb28-174">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>: props[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'entry'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>],</span>
<span id="cb28-175">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: props[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'entry'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>],</span>
<span id="cb28-176">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'property'</span>: prop_name,</span>
<span id="cb28-177">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>: value,</span>
<span id="cb28-178">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'expected_range'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lower_bound<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>upper_bound<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb28-179">                    })</span>
<span id="cb28-180">        </span>
<span id="cb28-181">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> outliers</span>
<span id="cb28-182">    </span>
<span id="cb28-183">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _check_text_structure_consistency(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, entries: List[Dict]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict]:</span>
<span id="cb28-184">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Check consistency between text descriptions and calculated properties."""</span></span>
<span id="cb28-185">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  Checking text-structure consistency..."</span>)</span>
<span id="cb28-186">        </span>
<span id="cb28-187">        inconsistencies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-188">        </span>
<span id="cb28-189">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entries:</span>
<span id="cb28-190">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entry:</span>
<span id="cb28-191">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb28-192">            </span>
<span id="cb28-193">            description <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>].lower()</span>
<span id="cb28-194">            mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>])</span>
<span id="cb28-195">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> mol:</span>
<span id="cb28-196">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb28-197">            </span>
<span id="cb28-198">            features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extract_molecular_features(mol)</span>
<span id="cb28-199">            </span>
<span id="cb28-200">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check molecular weight consistency</span></span>
<span id="cb28-201">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular weight'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> description <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mw'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> description:</span>
<span id="cb28-202">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract numbers that might be molecular weights</span></span>
<span id="cb28-203">                mw_numbers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.findall(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'\b(\d{2,4}(?:\.\d+)?)\b'</span>, description)</span>
<span id="cb28-204">                actual_mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> features[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight'</span>]</span>
<span id="cb28-205">                </span>
<span id="cb28-206">                found_matching_mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb28-207">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> num_str <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mw_numbers:</span>
<span id="cb28-208">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb28-209">                        described_mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(num_str)</span>
<span id="cb28-210">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(described_mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> actual_mw) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 5 Da tolerance</span></span>
<span id="cb28-211">                            found_matching_mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb28-212">                            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb28-213">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>:</span>
<span id="cb28-214">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb28-215">                </span>
<span id="cb28-216">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> found_matching_mw <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> mw_numbers:</span>
<span id="cb28-217">                    inconsistencies.append({</span>
<span id="cb28-218">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'molecular_weight_mismatch'</span>,</span>
<span id="cb28-219">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>],</span>
<span id="cb28-220">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>],</span>
<span id="cb28-221">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'described_mw'</span>: mw_numbers,</span>
<span id="cb28-222">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'calculated_mw'</span>: actual_mw,</span>
<span id="cb28-223">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description_excerpt'</span>: description[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'...'</span></span>
<span id="cb28-224">                    })</span>
<span id="cb28-225">            </span>
<span id="cb28-226">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check functional group mentions</span></span>
<span id="cb28-227">            mentioned_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-228">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alcohol'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> description:</span>
<span id="cb28-229">                mentioned_groups.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alcohol'</span>)</span>
<span id="cb28-230">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'carboxylic acid'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> description <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'carboxyl'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> description:</span>
<span id="cb28-231">                mentioned_groups.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'carboxylic_acid'</span>)</span>
<span id="cb28-232">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'amine'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> description:</span>
<span id="cb28-233">                mentioned_groups.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'amine'</span>)</span>
<span id="cb28-234">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aromatic'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> description <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'benzene'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> description:</span>
<span id="cb28-235">                mentioned_groups.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aromatic'</span>)</span>
<span id="cb28-236">            </span>
<span id="cb28-237">            detected_groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [fg.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'('</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fg <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> features.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_groups'</span>, [])]</span>
<span id="cb28-238">            </span>
<span id="cb28-239">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> mentioned <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> mentioned_groups:</span>
<span id="cb28-240">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mentioned <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> detected_groups <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> mentioned <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'aromatic'</span>:</span>
<span id="cb28-241">                    inconsistencies.append({</span>
<span id="cb28-242">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'functional_group_mismatch'</span>,</span>
<span id="cb28-243">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>],</span>
<span id="cb28-244">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>],</span>
<span id="cb28-245">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mentioned_group'</span>: mentioned,</span>
<span id="cb28-246">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'detected_groups'</span>: detected_groups,</span>
<span id="cb28-247">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description_excerpt'</span>: description[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'...'</span></span>
<span id="cb28-248">                    })</span>
<span id="cb28-249">        </span>
<span id="cb28-250">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> inconsistencies</span>
<span id="cb28-251">    </span>
<span id="cb28-252">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _detect_suspicious_patterns(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, entries: List[Dict]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict]:</span>
<span id="cb28-253">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Detect suspicious patterns that might indicate synthetic or corrupted data."""</span></span>
<span id="cb28-254">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  Detecting suspicious patterns..."</span>)</span>
<span id="cb28-255">        </span>
<span id="cb28-256">        suspicious <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-257">        </span>
<span id="cb28-258">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pattern 1: Repetitive SMILES patterns</span></span>
<span id="cb28-259">        smiles_parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb28-260">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entries:</span>
<span id="cb28-261">            smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]</span>
<span id="cb28-262">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Look for repeated substrings</span></span>
<span id="cb28-263">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> length <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]:</span>
<span id="cb28-264">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb28-265">                    substring <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> smiles[i:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>length]</span>
<span id="cb28-266">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> substring.count(substring[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(substring):  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Not all same character</span></span>
<span id="cb28-267">                        smiles_parts[substring] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> smiles_parts.get(substring, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb28-268">        </span>
<span id="cb28-269">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flag SMILES with highly repetitive patterns</span></span>
<span id="cb28-270">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entries:</span>
<span id="cb28-271">            smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>]</span>
<span id="cb28-272">            repetitive_score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb28-273">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> substring, count <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles_parts.items():</span>
<span id="cb28-274">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(entries) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> substring <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Appears in &gt;10% of dataset</span></span>
<span id="cb28-275">                    repetitive_score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> count</span>
<span id="cb28-276">            </span>
<span id="cb28-277">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> repetitive_score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(entries) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>:</span>
<span id="cb28-278">                suspicious.append({</span>
<span id="cb28-279">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'repetitive_smiles_pattern'</span>,</span>
<span id="cb28-280">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>],</span>
<span id="cb28-281">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: smiles,</span>
<span id="cb28-282">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'repetitive_score'</span>: repetitive_score</span>
<span id="cb28-283">                })</span>
<span id="cb28-284">        </span>
<span id="cb28-285">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pattern 2: Unrealistic property combinations</span></span>
<span id="cb28-286">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entries:</span>
<span id="cb28-287">            mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>])</span>
<span id="cb28-288">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb28-289">                mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Descriptors.MolWt(mol)</span>
<span id="cb28-290">                num_atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mol.GetNumAtoms()</span>
<span id="cb28-291">                </span>
<span id="cb28-292">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flag extremely dense molecules (too much mass for number of atoms)</span></span>
<span id="cb28-293">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> num_atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> num_atoms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Average atomic weight &gt; 50</span></span>
<span id="cb28-294">                    suspicious.append({</span>
<span id="cb28-295">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'unrealistic_density'</span>,</span>
<span id="cb28-296">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>],</span>
<span id="cb28-297">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>],</span>
<span id="cb28-298">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mw_per_atom'</span>: mw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> num_atoms</span>
<span id="cb28-299">                    })</span>
<span id="cb28-300">        </span>
<span id="cb28-301">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> suspicious</span>
<span id="cb28-302">    </span>
<span id="cb28-303">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _create_cleaned_dataset(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, entries: List[Dict], issues: Dict) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict]:</span>
<span id="cb28-304">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Create a cleaned dataset by removing problematic entries."""</span></span>
<span id="cb28-305">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  Creating cleaned dataset..."</span>)</span>
<span id="cb28-306">        </span>
<span id="cb28-307">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Collect indices to remove</span></span>
<span id="cb28-308">        indices_to_remove <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb28-309">        </span>
<span id="cb28-310">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove exact duplicates (keep first occurrence)</span></span>
<span id="cb28-311">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> dup <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> issues[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'duplicates'</span>]:</span>
<span id="cb28-312">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> dup[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exact_duplicate'</span>:</span>
<span id="cb28-313">                indices_to_remove.add(dup[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'indices'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove second occurrence</span></span>
<span id="cb28-314">        </span>
<span id="cb28-315">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove severe outliers</span></span>
<span id="cb28-316">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> outlier <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> issues[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'structural_outliers'</span>]:</span>
<span id="cb28-317">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> outlier[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms_outlier'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mw_outlier'</span>]:</span>
<span id="cb28-318">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Only remove extreme outliers</span></span>
<span id="cb28-319">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> outlier[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms_outlier'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> outlier[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>:</span>
<span id="cb28-320">                    indices_to_remove.add(outlier[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>])</span>
<span id="cb28-321">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> outlier[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mw_outlier'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> outlier[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>:</span>
<span id="cb28-322">                    indices_to_remove.add(outlier[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>])</span>
<span id="cb28-323">        </span>
<span id="cb28-324">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove highly suspicious entries</span></span>
<span id="cb28-325">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> susp <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> issues[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'suspicious_patterns'</span>]:</span>
<span id="cb28-326">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> susp[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'unrealistic_density'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> susp[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mw_per_atom'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:</span>
<span id="cb28-327">                indices_to_remove.add(susp[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index'</span>])</span>
<span id="cb28-328">        </span>
<span id="cb28-329">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create cleaned dataset</span></span>
<span id="cb28-330">        cleaned <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-331">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> entries:</span>
<span id="cb28-332">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_index'</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> indices_to_remove:</span>
<span id="cb28-333">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clean up the entry</span></span>
<span id="cb28-334">                cleaned_entry <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb28-335">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'canonical_smiles'</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use canonical form</span></span>
<span id="cb28-336">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: entry.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>),</span>
<span id="cb28-337">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: entry.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb28-338">                }</span>
<span id="cb28-339">                cleaned.append(cleaned_entry)</span>
<span id="cb28-340">        </span>
<span id="cb28-341">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> cleaned</span>
<span id="cb28-342">    </span>
<span id="cb28-343">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _generate_recommendations(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, report: Dict) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]:</span>
<span id="cb28-344">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Generate recommendations based on quality issues found."""</span></span>
<span id="cb28-345">        recommendations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-346">        </span>
<span id="cb28-347">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Duplicate recommendations</span></span>
<span id="cb28-348">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'duplicates'</span>]:</span>
<span id="cb28-349">            exact_dups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>([d <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'duplicates'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exact_duplicate'</span>])</span>
<span id="cb28-350">            near_dups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>([d <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'duplicates'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'near_duplicate'</span>])</span>
<span id="cb28-351">            </span>
<span id="cb28-352">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> exact_dups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb28-353">                recommendations.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Remove </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>exact_dups<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> exact duplicate structures"</span>)</span>
<span id="cb28-354">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> near_dups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb28-355">                recommendations.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Review </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>near_dups<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> near-duplicate pairs (similarity &gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>similarity_threshold<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb28-356">        </span>
<span id="cb28-357">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data size recommendations</span></span>
<span id="cb28-358">        removal_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_size'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'final_size'</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_size'</span>]</span>
<span id="cb28-359">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> removal_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>:</span>
<span id="cb28-360">            recommendations.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"High removal rate (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>removal_rate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1%}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) suggests significant data quality issues"</span>)</span>
<span id="cb28-361">        </span>
<span id="cb28-362">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Outlier recommendations</span></span>
<span id="cb28-363">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'structural_outliers'</span>]:</span>
<span id="cb28-364">            recommendations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Review structural outliers - they may indicate data entry errors"</span>)</span>
<span id="cb28-365">        </span>
<span id="cb28-366">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Consistency recommendations</span></span>
<span id="cb28-367">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text_inconsistencies'</span>]:</span>
<span id="cb28-368">            recommendations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Text descriptions inconsistent with structures - consider regenerating descriptions"</span>)</span>
<span id="cb28-369">        </span>
<span id="cb28-370">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> recommendations:</span>
<span id="cb28-371">            recommendations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dataset quality looks good! No major issues detected."</span>)</span>
<span id="cb28-372">        </span>
<span id="cb28-373">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> recommendations</span>
<span id="cb28-374"></span>
<span id="cb28-375"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Demonstration with a problematic dataset</span></span>
<span id="cb28-376"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_test_dataset_with_issues():</span>
<span id="cb28-377">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Create a test dataset with various quality issues for demonstration."""</span></span>
<span id="cb28-378">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb28-379">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Good entries</span></span>
<span id="cb28-380">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CCO'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ethanol'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ethanol is an alcohol with molecular weight 46.07 Da'</span>},</span>
<span id="cb28-381">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1ccccc1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Benzene'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Benzene is an aromatic compound'</span>},</span>
<span id="cb28-382">        </span>
<span id="cb28-383">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Duplicates</span></span>
<span id="cb28-384">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CCO'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ethyl alcohol'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Another entry for ethanol'</span>},  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exact duplicate</span></span>
<span id="cb28-385">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1ccccc1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Benzene ring'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Benzene ring structure'</span>},  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exact duplicate</span></span>
<span id="cb28-386">        </span>
<span id="cb28-387">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Invalid SMILES</span></span>
<span id="cb28-388">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'INVALID123'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Bad entry'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'This is not a valid SMILES'</span>},</span>
<span id="cb28-389">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1CCC'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Unclosed ring'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Missing ring closure'</span>},</span>
<span id="cb28-390">        </span>
<span id="cb28-391">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Outliers</span></span>
<span id="cb28-392">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Very long chain'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Extremely long alkyl chain'</span>},</span>
<span id="cb28-393">        </span>
<span id="cb28-394">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Text inconsistencies</span></span>
<span id="cb28-395">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CCO'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ethanol'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'This alcohol has molecular weight 200 Da'</span>},  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Wrong MW</span></span>
<span id="cb28-396">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1ccccc1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Benzene'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Contains carboxylic acid groups'</span>},  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Wrong functional group</span></span>
<span id="cb28-397">        </span>
<span id="cb28-398">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Near duplicates</span></span>
<span id="cb28-399">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC(C)O'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Isopropanol'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Isopropyl alcohol'</span>},</span>
<span id="cb28-400">        </span>
<span id="cb28-401">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Good entries for padding</span></span>
<span id="cb28-402">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC(=O)O'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Acetic acid'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Acetic acid is a carboxylic acid'</span>},</span>
<span id="cb28-403">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CN'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Methylamine'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Simple amine compound'</span>},</span>
<span id="cb28-404">    ]</span>
<span id="cb28-405"></span>
<span id="cb28-406"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run quality control demonstration</span></span>
<span id="cb28-407"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chemical Data Quality Control Demonstration"</span>)</span>
<span id="cb28-408"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb28-409"></span>
<span id="cb28-410"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create test dataset with known issues</span></span>
<span id="cb28-411">test_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_test_dataset_with_issues()</span>
<span id="cb28-412"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Test dataset created with </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(test_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> entries"</span>)</span>
<span id="cb28-413"></span>
<span id="cb28-414"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run quality control</span></span>
<span id="cb28-415">qc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChemicalDataQualityController(similarity_threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb28-416">quality_report <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> qc.comprehensive_quality_check(test_data)</span>
<span id="cb28-417"></span>
<span id="cb28-418"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display results</span></span>
<span id="cb28-419"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Quality Control Results:"</span>)</span>
<span id="cb28-420"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Original dataset size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>quality_report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_size'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-421"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Cleaned dataset size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>quality_report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'final_size'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-422"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Removal rate: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> quality_report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'final_size'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>quality_report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'original_size'</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%"</span>)</span>
<span id="cb28-423"></span>
<span id="cb28-424"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Issues Found:"</span>)</span>
<span id="cb28-425"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> issue_type, issues <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> quality_report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'issues'</span>].items():</span>
<span id="cb28-426">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> issues:</span>
<span id="cb28-427">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>issue_type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>title()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(issues)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> cases"</span>)</span>
<span id="cb28-428"></span>
<span id="cb28-429"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Recommendations:"</span>)</span>
<span id="cb28-430"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, rec <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(quality_report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'recommendations'</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb28-431">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-432"></span>
<span id="cb28-433"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show example of cleaned data</span></span>
<span id="cb28-434"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">First 3 entries of cleaned dataset:"</span>)</span>
<span id="cb28-435"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, entry <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(quality_report[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cleaned_data'</span>][:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]):</span>
<span id="cb28-436">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>entry[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chemical Data Quality Control Demonstration
==================================================
Test dataset created with 12 entries
Running comprehensive data quality checks...
  Valid structures: 10/12
  Checking for duplicates...
  Detecting structural outliers...
  Checking text-structure consistency...
  Detecting suspicious patterns...
  Creating cleaned dataset...

Quality Control Results:
Original dataset size: 12
Cleaned dataset size: 6
Removal rate: 50.0%

Issues Found:
  Duplicates: 10 cases
  Invalid Smiles: 2 cases
  Structural Outliers: 3 cases
  Text Inconsistencies: 2 cases
  Suspicious Patterns: 6 cases

Recommendations:
  1. Remove 4 exact duplicate structures
  2. Review 6 near-duplicate pairs (similarity &gt; 0.8)
  3. High removal rate (50.0%) suggests significant data quality issues
  4. Review structural outliers - they may indicate data entry errors
  5. Text descriptions inconsistent with structures - consider regenerating descriptions

First 3 entries of cleaned dataset:
  1. Ethanol: CCO
  2. Benzene: c1ccccc1
  3. Very long chain: CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:55:35] SMILES Parse Error: Failed parsing SMILES 'INVALID123' for input: 'INVALID123'
[09:55:35] SMILES Parse Error: unclosed ring for input: 'C1CCC'</code></pre>
</div>
</div>
<section id="advanced-contamination-detection" class="level3">
<h3 class="anchored" data-anchor-id="advanced-contamination-detection">Advanced Contamination Detection</h3>
<blockquote class="blockquote">
<p><strong>NOTE FROM GREG</strong>: the following section of code does not work. I’m leaving it here as the first example of something that didn’t actually work as generated by the LLM.</p>
</blockquote>
<p>Data contamination is a critical issue when training LLMs on chemical data. Beyond basic quality checks, sophisticated contamination detection is essential:</p>
<p><strong>Cross-Dataset Leakage Detection:</strong></p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> detect_cross_dataset_leakage(train_smiles, test_smiles, validation_smiles):</span>
<span id="cb31-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Detect potential data leakage between training, test, and validation sets"""</span></span>
<span id="cb31-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Implementation would check for exact matches and high-similarity compounds</span></span>
<span id="cb31-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span></code></pre></div>
<p><strong>Temporal Contamination:</strong> Chemical databases often contain compounds discovered after certain dates. For historically-aware models, ensure temporal consistency:</p>
<p><strong>Vendor Catalog Contamination:</strong> Many “novel” compounds in datasets are actually from commercial catalogs, which can lead to unrealistic performance expectations.</p>
<p><strong>Synthetic Accessibility Bias:</strong> Datasets often over-represent easily synthesizable compounds, creating bias in LLM outputs.</p>
<div id="84b0e445" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ContaminationDetector:</span>
<span id="cb32-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb32-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Advanced contamination detection for chemical datasets used in LLM training.</span></span>
<span id="cb32-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb32-5">    </span>
<span id="cb32-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, similarity_threshold: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.85</span>):</span>
<span id="cb32-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.similarity_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> similarity_threshold</span>
<span id="cb32-8">    </span>
<span id="cb32-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> detect_cross_dataset_leakage(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, datasets: Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict:</span>
<span id="cb32-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb32-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Detect potential data leakage between multiple datasets.</span></span>
<span id="cb32-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb32-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb32-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            datasets: Dictionary with dataset names as keys and lists of SMILES as values</span></span>
<span id="cb32-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                     e.g., {'train': [...], 'test': [...], 'validation': [...]}</span></span>
<span id="cb32-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb32-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb32-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            Dictionary with contamination analysis results</span></span>
<span id="cb32-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb32-20">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Detecting cross-dataset contamination..."</span>)</span>
<span id="cb32-21">        </span>
<span id="cb32-22">        results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb32-23">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exact_overlaps'</span>: {},</span>
<span id="cb32-24">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'similarity_overlaps'</span>: {},</span>
<span id="cb32-25">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'summary'</span>: {}</span>
<span id="cb32-26">        }</span>
<span id="cb32-27">        </span>
<span id="cb32-28">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert SMILES to canonical form and create fingerprints</span></span>
<span id="cb32-29">        canonical_datasets <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb32-30">        fingerprint_datasets <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb32-31">        </span>
<span id="cb32-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, smiles_list <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> datasets.items():</span>
<span id="cb32-33">            canonical_smiles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb32-34">            fingerprints <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb32-35">            </span>
<span id="cb32-36">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles_list:</span>
<span id="cb32-37">                mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb32-38">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb32-39">                    canonical <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb32-40">                    canonical_smiles.append(canonical)</span>
<span id="cb32-41">                    fingerprints.append(Chem.RDKFingerprint(mol))</span>
<span id="cb32-42">            </span>
<span id="cb32-43">            canonical_datasets[name] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> canonical_smiles</span>
<span id="cb32-44">            fingerprint_datasets[name] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fingerprints</span>
<span id="cb32-45">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(canonical_smiles)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> valid structures"</span>)</span>
<span id="cb32-46">        </span>
<span id="cb32-47">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check exact overlaps</span></span>
<span id="cb32-48">        dataset_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(datasets.keys())</span>
<span id="cb32-49">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, name1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(dataset_names):</span>
<span id="cb32-50">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dataset_names[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]:</span>
<span id="cb32-51">                overlap_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_vs_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb32-52">                </span>
<span id="cb32-53">                set1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(canonical_datasets[name1])</span>
<span id="cb32-54">                set2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(canonical_datasets[name2])</span>
<span id="cb32-55">                exact_overlap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> set1.intersection(set2)</span>
<span id="cb32-56">                </span>
<span id="cb32-57">                results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exact_overlaps'</span>][overlap_key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb32-58">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(exact_overlap),</span>
<span id="cb32-59">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'percentage_of_first'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(exact_overlap) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(set1) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> set1 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb32-60">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'percentage_of_second'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(exact_overlap) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(set2) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> set2 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb32-61">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'overlapping_smiles'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(exact_overlap)[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First 10 examples</span></span>
<span id="cb32-62">                }</span>
<span id="cb32-63">        </span>
<span id="cb32-64">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check similarity-based overlaps (computationally expensive, limited to smaller datasets)</span></span>
<span id="cb32-65">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, name1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(dataset_names):</span>
<span id="cb32-66">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dataset_names[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]:</span>
<span id="cb32-67">                overlap_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_vs_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb32-68">                </span>
<span id="cb32-69">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(fingerprint_datasets[name1]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(fingerprint_datasets[name2]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>:</span>
<span id="cb32-70">                    similar_pairs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb32-71">                    </span>
<span id="cb32-72">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx1, fp1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(fingerprint_datasets[name1]):</span>
<span id="cb32-73">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx2, fp2 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(fingerprint_datasets[name2]):</span>
<span id="cb32-74">                            similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataStructs.TanimotoSimilarity(fp1, fp2)</span>
<span id="cb32-75">                            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> similarity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.similarity_threshold:</span>
<span id="cb32-76">                                similar_pairs.append({</span>
<span id="cb32-77">                                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles1'</span>: canonical_datasets[name1][idx1],</span>
<span id="cb32-78">                                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles2'</span>: canonical_datasets[name2][idx2],</span>
<span id="cb32-79">                                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'similarity'</span>: similarity</span>
<span id="cb32-80">                                })</span>
<span id="cb32-81">                    </span>
<span id="cb32-82">                    results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'similarity_overlaps'</span>][overlap_key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb32-83">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(similar_pairs),</span>
<span id="cb32-84">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pairs'</span>: similar_pairs[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First 5 examples</span></span>
<span id="cb32-85">                    }</span>
<span id="cb32-86">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb32-87">                    results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'similarity_overlaps'</span>][overlap_key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb32-88">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'skipped_large_dataset'</span>,</span>
<span id="cb32-89">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Dataset too large for pairwise comparison'</span></span>
<span id="cb32-90">                    }</span>
<span id="cb32-91">        </span>
<span id="cb32-92">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate summary</span></span>
<span id="cb32-93">        total_exact_overlaps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> result <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exact_overlaps'</span>].values() </span>
<span id="cb32-94">                                 <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>))</span>
<span id="cb32-95">        </span>
<span id="cb32-96">        results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'summary'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb32-97">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_exact_overlaps'</span>: total_exact_overlaps,</span>
<span id="cb32-98">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'datasets_analyzed'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(datasets),</span>
<span id="cb32-99">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'contamination_severity'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._assess_contamination_severity(results),</span>
<span id="cb32-100">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'recommendations'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._generate_contamination_recommendations(results)</span>
<span id="cb32-101">        }</span>
<span id="cb32-102">        </span>
<span id="cb32-103">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> results</span>
<span id="cb32-104">    </span>
<span id="cb32-105">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> detect_temporal_contamination(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, smiles_list: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>], </span>
<span id="cb32-106">                                    target_date: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2020-01-01"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict:</span>
<span id="cb32-107">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb32-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Detect compounds that might be from after a target date.</span></span>
<span id="cb32-109"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Note: This is a simplified version - real implementation would require</span></span>
<span id="cb32-110"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        a database of compound discovery/publication dates.</span></span>
<span id="cb32-111"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb32-112">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Checking for temporal contamination (compounds after </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>target_date<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)..."</span>)</span>
<span id="cb32-113">        </span>
<span id="cb32-114">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is a placeholder implementation</span></span>
<span id="cb32-115">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In practice, you'd need a database mapping SMILES to discovery dates</span></span>
<span id="cb32-116">        suspicious_compounds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb32-117">        </span>
<span id="cb32-118">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles_list:</span>
<span id="cb32-119">            mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb32-120">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb32-121">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example heuristic: very complex molecules might be recent</span></span>
<span id="cb32-122">                complexity_score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._calculate_molecular_complexity(mol)</span>
<span id="cb32-123">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> complexity_score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Arbitrary threshold</span></span>
<span id="cb32-124">                    suspicious_compounds.append({</span>
<span id="cb32-125">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: smiles,</span>
<span id="cb32-126">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'complexity_score'</span>: complexity_score,</span>
<span id="cb32-127">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'reason'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'high_complexity'</span></span>
<span id="cb32-128">                    })</span>
<span id="cb32-129">        </span>
<span id="cb32-130">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb32-131">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'suspicious_count'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(suspicious_compounds),</span>
<span id="cb32-132">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'suspicious_compounds'</span>: suspicious_compounds[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>],</span>
<span id="cb32-133">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'recommendation'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Manual review recommended for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(suspicious_compounds)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> complex compounds"</span></span>
<span id="cb32-134">        }</span>
<span id="cb32-135">    </span>
<span id="cb32-136">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> detect_vendor_catalog_bias(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, smiles_list: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Dict:</span>
<span id="cb32-137">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb32-138"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Detect potential bias from commercial compound catalogs.</span></span>
<span id="cb32-139"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb32-140">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Detecting vendor catalog bias..."</span>)</span>
<span id="cb32-141">        </span>
<span id="cb32-142">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Common patterns in commercial compounds</span></span>
<span id="cb32-143">        vendor_patterns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb32-144">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'simple_aromatics'</span>: <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'c1ccccc1'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simple benzene rings</span></span>
<span id="cb32-145">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'common_protecting_groups'</span>: <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'C\(=O\)OC\(C\)\(C\)C'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Boc groups</span></span>
<span id="cb32-146">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'standard_linkers'</span>: <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'OCCOCCOC'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PEG-like linkers</span></span>
<span id="cb32-147">        }</span>
<span id="cb32-148">        </span>
<span id="cb32-149">        pattern_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {pattern: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> pattern <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> vendor_patterns.keys()}</span>
<span id="cb32-150">        flagged_compounds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb32-151">        </span>
<span id="cb32-152">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> smiles <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> smiles_list:</span>
<span id="cb32-153">            mol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb32-154">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol:</span>
<span id="cb32-155">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for overly simple structures</span></span>
<span id="cb32-156">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mol.GetNumAtoms() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> mol.GetNumBonds() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:</span>
<span id="cb32-157">                    flagged_compounds.append({</span>
<span id="cb32-158">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smiles'</span>: smiles,</span>
<span id="cb32-159">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'reason'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'overly_simple'</span>,</span>
<span id="cb32-160">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_atoms'</span>: mol.GetNumAtoms()</span>
<span id="cb32-161">                    })</span>
<span id="cb32-162">                </span>
<span id="cb32-163">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for common patterns</span></span>
<span id="cb32-164">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> pattern_name, pattern <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> vendor_patterns.items():</span>
<span id="cb32-165">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> re.search(pattern, smiles):</span>
<span id="cb32-166">                        pattern_counts[pattern_name] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-167">        </span>
<span id="cb32-168">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb32-169">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pattern_counts'</span>: pattern_counts,</span>
<span id="cb32-170">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'flagged_simple'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(flagged_compounds),</span>
<span id="cb32-171">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_analyzed'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles_list),</span>
<span id="cb32-172">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bias_indicators'</span>: {</span>
<span id="cb32-173">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'high_simple_proportion'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(flagged_compounds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles_list) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,</span>
<span id="cb32-174">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pattern_dominance'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(smiles_list) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> count <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> pattern_counts.values())</span>
<span id="cb32-175">            }</span>
<span id="cb32-176">        }</span>
<span id="cb32-177">    </span>
<span id="cb32-178">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _calculate_molecular_complexity(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, mol) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb32-179">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Calculate a simple molecular complexity score."""</span></span>
<span id="cb32-180">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> mol:</span>
<span id="cb32-181">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb32-182">        </span>
<span id="cb32-183">        complexity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb32-184">        complexity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> mol.GetNumAtoms() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb32-185">        complexity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> mol.GetNumBonds() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb32-186">        complexity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> rdMolDescriptors.CalcNumRings(mol) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb32-187">        complexity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> rdMolDescriptors.CalcNumHeteroatoms(mol) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb32-188">        complexity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(rdMolDescriptors.GetUSRScore(mol)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hasattr</span>(rdMolDescriptors, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GetUSRScore'</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb32-189">        </span>
<span id="cb32-190">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> complexity</span>
<span id="cb32-191">    </span>
<span id="cb32-192">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _assess_contamination_severity(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, results: Dict) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb32-193">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Assess the overall severity of contamination."""</span></span>
<span id="cb32-194">        exact_overlaps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> result <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exact_overlaps'</span>].values() </span>
<span id="cb32-195">                           <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>))</span>
<span id="cb32-196">        </span>
<span id="cb32-197">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> exact_overlaps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb32-198">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"low"</span></span>
<span id="cb32-199">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> exact_overlaps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:</span>
<span id="cb32-200">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"moderate"</span></span>
<span id="cb32-201">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb32-202">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"high"</span></span>
<span id="cb32-203">    </span>
<span id="cb32-204">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _generate_contamination_recommendations(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, results: Dict) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]:</span>
<span id="cb32-205">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Generate recommendations based on contamination analysis."""</span></span>
<span id="cb32-206">        recommendations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb32-207">        </span>
<span id="cb32-208">        severity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._assess_contamination_severity(results)</span>
<span id="cb32-209">        </span>
<span id="cb32-210">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> severity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"high"</span>:</span>
<span id="cb32-211">            recommendations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CRITICAL: High level of contamination detected - review data splitting strategy"</span>)</span>
<span id="cb32-212">            recommendations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Consider using scaffold-based or time-based splitting instead of random splitting"</span>)</span>
<span id="cb32-213">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> severity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"moderate"</span>:</span>
<span id="cb32-214">            recommendations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Moderate contamination detected - remove overlapping compounds"</span>)</span>
<span id="cb32-215">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb32-216">            recommendations.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Low contamination level - acceptable for most applications"</span>)</span>
<span id="cb32-217">        </span>
<span id="cb32-218">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for specific issues</span></span>
<span id="cb32-219">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> overlap_key, overlap_data <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exact_overlaps'</span>].items():</span>
<span id="cb32-220">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> overlap_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb32-221">                recommendations.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Remove </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>overlap_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> overlapping compounds between </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>overlap_key<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-222">        </span>
<span id="cb32-223">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> recommendations</span>
<span id="cb32-224"></span>
<span id="cb32-225"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Demonstration of contamination detection</span></span>
<span id="cb32-226"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Contamination Detection Demonstration"</span>)</span>
<span id="cb32-227"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span>
<span id="cb32-228"></span>
<span id="cb32-229"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create example datasets with known contamination</span></span>
<span id="cb32-230">example_datasets <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb32-231">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>: [</span>
<span id="cb32-232">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CCO'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ethanol</span></span>
<span id="cb32-233">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1ccccc1'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># benzene</span></span>
<span id="cb32-234">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC(=O)O'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># acetic acid</span></span>
<span id="cb32-235">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC(C)O'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># isopropanol</span></span>
<span id="cb32-236">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CN'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># methylamine</span></span>
<span id="cb32-237">    ],</span>
<span id="cb32-238">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>: [</span>
<span id="cb32-239">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CCO'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CONTAMINATION: same as train</span></span>
<span id="cb32-240">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1ccc(O)cc1'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># phenol</span></span>
<span id="cb32-241">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC(=O)OC'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># methyl acetate</span></span>
<span id="cb32-242">    ],</span>
<span id="cb32-243">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'validation'</span>: [</span>
<span id="cb32-244">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC(=O)O'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CONTAMINATION: same as train</span></span>
<span id="cb32-245">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC(C)(C)O'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tert-butanol</span></span>
<span id="cb32-246">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c1cccnc1'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pyridine</span></span>
<span id="cb32-247">    ]</span>
<span id="cb32-248">}</span>
<span id="cb32-249"></span>
<span id="cb32-250">detector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ContaminationDetector(similarity_threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb32-251"></span>
<span id="cb32-252"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run contamination analysis</span></span>
<span id="cb32-253">contamination_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> detector.detect_cross_dataset_leakage(example_datasets)</span>
<span id="cb32-254"></span>
<span id="cb32-255"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Contamination Analysis Results:"</span>)</span>
<span id="cb32-256"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Contamination severity: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>contamination_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'summary'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'contamination_severity'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-257"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Total exact overlaps: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>contamination_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'summary'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_exact_overlaps'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-258"></span>
<span id="cb32-259"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Exact overlaps found:"</span>)</span>
<span id="cb32-260"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> overlap_key, overlap_data <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> contamination_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exact_overlaps'</span>].items():</span>
<span id="cb32-261">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> overlap_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb32-262">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>overlap_key<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>overlap_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> compounds (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>overlap_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'percentage_of_first'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% of first dataset)"</span>)</span>
<span id="cb32-263">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"    Examples: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>overlap_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'overlapping_smiles'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-264"></span>
<span id="cb32-265"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Recommendations:"</span>)</span>
<span id="cb32-266"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, rec <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(contamination_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'summary'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'recommendations'</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb32-267">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-268"></span>
<span id="cb32-269"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test temporal contamination detection</span></span>
<span id="cb32-270"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Temporal Contamination Check:"</span>)</span>
<span id="cb32-271">temporal_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> detector.detect_temporal_contamination(example_datasets[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>])</span>
<span id="cb32-272"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Suspicious compounds: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>temporal_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'suspicious_count'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-273"></span>
<span id="cb32-274"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test vendor bias detection</span></span>
<span id="cb32-275"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Vendor Catalog Bias Check:"</span>)</span>
<span id="cb32-276">bias_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> detector.detect_vendor_catalog_bias(example_datasets[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>])</span>
<span id="cb32-277"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Simple compounds flagged: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>bias_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'flagged_simple'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>bias_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'total_analyzed'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-278"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Bias indicators detected: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(bias_results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bias_indicators'</span>].values())<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Contamination Detection Demonstration
========================================
Detecting cross-dataset contamination...
  train: 5 valid structures
  test: 3 valid structures
  validation: 3 valid structures

Contamination Analysis Results:
Contamination severity: moderate
Total exact overlaps: 2

Exact overlaps found:
  train_vs_test: 1 compounds (20.0% of first dataset)
    Examples: ['CCO']
  train_vs_validation: 1 compounds (20.0% of first dataset)
    Examples: ['CC(=O)O']

Recommendations:
  1. Moderate contamination detected - remove overlapping compounds
  2. Remove 1 overlapping compounds between train_vs_test
  3. Remove 1 overlapping compounds between train_vs_validation

Temporal Contamination Check:
Checking for temporal contamination (compounds after 2020-01-01)...</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ArgumentError</span>                             Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[15], line 271</span>
<span class="ansi-green-fg ansi-bold">    269</span> <span style="font-style:italic;color:rgb(95,135,135)"># Test temporal contamination detection</span>
<span class="ansi-green-fg ansi-bold">    270</span> <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="color:rgb(175,0,0)">Temporal Contamination Check:</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg">--&gt; 271</span> temporal_results <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">detector</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">detect_temporal_contamination</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">example_datasets</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">train</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    272</span> <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Suspicious compounds: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>temporal_results[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">suspicious_count</span><span style="color:rgb(175,0,0)">'</span>]<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    274</span> <span style="font-style:italic;color:rgb(95,135,135)"># Test vendor bias detection</span>

Cell <span class="ansi-green-fg">In[15], line 122</span>, in <span class="ansi-cyan-fg">ContaminationDetector.detect_temporal_contamination</span><span class="ansi-blue-fg">(self, smiles_list, target_date)</span>
<span class="ansi-green-fg ansi-bold">    119</span> mol <span style="color:rgb(98,98,98)">=</span> Chem<span style="color:rgb(98,98,98)">.</span>MolFromSmiles(smiles)
<span class="ansi-green-fg ansi-bold">    120</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> mol:
<span class="ansi-green-fg ansi-bold">    121</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Example heuristic: very complex molecules might be recent</span>
<span class="ansi-green-fg">--&gt; 122</span>     complexity_score <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_calculate_molecular_complexity</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mol</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    123</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> complexity_score <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">20</span>:  <span style="font-style:italic;color:rgb(95,135,135)"># Arbitrary threshold</span>
<span class="ansi-green-fg ansi-bold">    124</span>         suspicious_compounds<span style="color:rgb(98,98,98)">.</span>append({
<span class="ansi-green-fg ansi-bold">    125</span>             <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">smiles</span><span style="color:rgb(175,0,0)">'</span>: smiles,
<span class="ansi-green-fg ansi-bold">    126</span>             <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">complexity_score</span><span style="color:rgb(175,0,0)">'</span>: complexity_score,
<span class="ansi-green-fg ansi-bold">    127</span>             <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">reason</span><span style="color:rgb(175,0,0)">'</span>: <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">high_complexity</span><span style="color:rgb(175,0,0)">'</span>
<span class="ansi-green-fg ansi-bold">    128</span>         })

Cell <span class="ansi-green-fg">In[15], line 188</span>, in <span class="ansi-cyan-fg">ContaminationDetector._calculate_molecular_complexity</span><span class="ansi-blue-fg">(self, mol)</span>
<span class="ansi-green-fg ansi-bold">    186</span> complexity <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> rdMolDescriptors<span style="color:rgb(98,98,98)">.</span>CalcNumRings(mol) <span style="color:rgb(98,98,98)">*</span> <span style="color:rgb(98,98,98)">2</span>
<span class="ansi-green-fg ansi-bold">    187</span> complexity <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> rdMolDescriptors<span style="color:rgb(98,98,98)">.</span>CalcNumHeteroatoms(mol) <span style="color:rgb(98,98,98)">*</span> <span style="color:rgb(98,98,98)">1.5</span>
<span class="ansi-green-fg">--&gt; 188</span> complexity <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">len</span>(<span class="ansi-yellow-bg">rdMolDescriptors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">GetUSRScore</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mol</span><span class="ansi-yellow-bg">)</span>) <span style="color:rgb(98,98,98)">*</span> <span style="color:rgb(98,98,98)">0.01</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">hasattr</span>(rdMolDescriptors, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">GetUSRScore</span><span style="color:rgb(175,0,0)">'</span>) <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(98,98,98)">0</span>
<span class="ansi-green-fg ansi-bold">    190</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> complexity

<span class="ansi-red-fg">ArgumentError</span>: Python argument types in
    rdkit.Chem.rdMolDescriptors.GetUSRScore(Mol)
did not match C++ signature:
    GetUSRScore(boost::python::api::object descriptor1, boost::python::api::object descriptor2, boost::python::api::object weights=[])</pre>
</div>
</div>
</div>


</section>
</section>
</section>

 ]]></description>
  <category>exploratoration</category>
  <category>LLMs</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-07-31-an-llm-experiment-1.html</guid>
  <pubDate>Wed, 30 Jul 2025 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Storing partial charges in SD files</title>
  <link>https://greglandrum.github.io/rdkit-blog/posts/2025-07-24-writing-partial-charges-to-sd-files.html</link>
  <description><![CDATA[ 




<p>I was chatting with Pat Walters at the CADD GRC and he brought up point 7 from his famous <a href="https://www.linkedin.com/posts/wpwalters_i-thoroughly-enjoyed-the-first-day-of-the-activity-7316447084209991682-Yuki">14 points LinkedIn post</a>. The usual justification given for using mol2 files is that they are the only file format we have that allows including partial charges. This is a widely held opinion, but it’s not really true. It’s actually quite easy to store arbitrary atom (or bond) properties in SD files and the RDKit has a simple mechanism for doing this. This post is a short tutorial on how to use this functionality.</p>
<p>The handling of atomic and bond properties in SD files is described in more detail in <a href="https://www.rdkit.org/docs/RDKit_Book.html#atom-properties-and-sdf-files">the docs</a>.</p>
<p>Rather than doing the usual thing and generating Gasteiger-Marsilli charges, here I’m going to use the DASH-props tree that we developed in the Riniker lab to rapidly generate approximate AM1BCC charges. DASH uses a hierarchical tree of substructures to compute high-quality estimates of AM1BCC charges for a molecule. Because it’s based on substructures, the method is fast and conformation independent. If want to learn more about the algorithm, take a look at <a href="https://pubs.aip.org/aip/jcp/article/161/7/074103/3308079/DASH-properties-Estimating-atomic-and-molecular">the open-access paper</a>.</p>
<p>If you want to run the code in this notebook, you’ll need to install DASH props. This requires adding some packages to your conda environment. There’s an <a href="https://github.com/rinikerlab/DASH-tree/blob/main/tree_only_env.yml">environment file</a> in the DASH-tree repo that you can use, but if you already have a working RDKit environment, I think this is sufficient:</p>
<pre><code>% conda install -c conda-forge pytables tqdm</code></pre>
<p>and then pip installing the DASH tree package:</p>
<pre><code>% python -m pip install git+https://github.com/rinikerlab/DASH-tree</code></pre>
<blockquote class="blockquote">
<p>An aside: the way these properties are stored in the SD file is very easy to parse (The format is actually the result of some discussions I had with a couple of cheminformatics software vendors back in 2019; I think I ended up being the only one to implement what we had discussed), so adding support for this format to other software or toolkits that can already read SD files wouldn’t be much of a lift. If you’re a developer and have questions, please just ask.</p>
</blockquote>
<div id="51317896" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chem</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> rdkit.Chem <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Draw</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rdkit</span>
<span id="cb3-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rdkit.__version__)</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import the required stuff from DASH:</span></span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> serenityff.charge.tree.dash_tree <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DASHTree, TreeType</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> serenityff.charge.data <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dash_props_tree_path</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.03.4</code></pre>
</div>
</div>
<div id="9fe0e6db" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the property tree.</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Note, that the files will be automatically downloaded the first time the tree is loaded from the ETHZ Research Collection.</span></span>
<span id="cb5-3">tree <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DASHTree(tree_folder_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dash_props_tree_path, tree_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>TreeType.FULL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading DASH tree data
Loaded 122 trees and data</code></pre>
</div>
</div>
<p>Construct a sample molecule and compute the charges:</p>
<div id="a98ba683" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">esomeprazole <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.MolFromSmiles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC1=C(C(=C(C=C1)N)C(=O)N)C(=O)N'</span>)</span>
<span id="cb7-2">esomep_h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.AddHs(esomeprazole)</span>
<span id="cb7-3"></span>
<span id="cb7-4">charges <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tree.get_molecules_partial_charges(esomep_h, chg_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AM1BCC"</span>, chg_std_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AM1BCC_std"</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"charges"</span>]</span></code></pre></div>
</div>
<p>Set the charges as atomic properties:</p>
<div id="40ba7fcf" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> atom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> esomep_h.GetAtoms():</span>
<span id="cb8-2">    atom.SetDoubleProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DASH_AM1BCC_CHARGES"</span>, charges[atom.GetIdx()])</span></code></pre></div>
</div>
<div id="77259b55" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"></span>
<span id="cb9-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this is the one extra call you have to make in order to </span></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert the atom properties to a molecule property which will </span></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># be written to the SD file:</span></span>
<span id="cb9-5">Chem.CreateAtomDoublePropertyList(esomep_h,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DASH_AM1BCC_CHARGES'</span>)</span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the SD data to a string so that we can look at it:</span></span>
<span id="cb9-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StringIO</span>
<span id="cb9-9">sio <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StringIO()</span>
<span id="cb9-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> Chem.SDWriter(sio) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> w:</span>
<span id="cb9-11">    w.write(esomep_h)</span>
<span id="cb9-12"></span>
<span id="cb9-13">sdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sio.getvalue()</span>
<span id="cb9-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(sdf)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     RDKit          2D

 25 25  0  0  0  0  0  0  0  0999 V2000
    3.0000    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
    1.5000    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
    0.7500   -1.2990    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
   -0.7500   -1.2990    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
   -1.5000    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
   -0.7500    1.2990    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
    0.7500    1.2990    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
   -3.0000    0.0000    0.0000 N   0  0  0  0  0  0  0  0  0  0  0  0
   -1.5000   -2.5981    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
   -1.1155   -3.5040    0.0000 O   0  0  0  0  0  0  0  0  0  0  0  0
   -3.0000   -2.5981    0.0000 N   0  0  0  0  0  0  0  0  0  0  0  0
    1.5000   -2.5981    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
    3.0000   -2.5981    0.0000 O   0  0  0  0  0  0  0  0  0  0  0  0
    0.7500   -3.8971    0.0000 N   0  0  0  0  0  0  0  0  0  0  0  0
    4.5000    0.0000    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
    3.0000   -1.5000    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
    3.0000    1.5000    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
   -1.5000    2.5981    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
    1.5000    2.5981    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
   -3.7500    1.2990    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
   -3.5923   -0.7860    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
   -3.7500   -3.8971    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
   -3.5923   -1.8121    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
    1.5000   -5.1962    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
   -0.2268   -4.0171    0.0000 H   0  0  0  0  0  0  0  0  0  0  0  0
  1  2  1  0
  2  3  2  0
  3  4  1  0
  4  5  2  0
  5  6  1  0
  6  7  2  0
  5  8  1  0
  4  9  1  0
  9 10  2  0
  9 11  1  0
  3 12  1  0
 12 13  2  0
 12 14  1  0
  7  2  1  0
  1 15  1  0
  1 16  1  0
  1 17  1  0
  6 18  1  0
  7 19  1  0
  8 20  1  0
  8 21  1  0
 11 22  1  0
 11 23  1  0
 14 24  1  0
 14 25  1  0
M  END
&gt;  &lt;atom.dprop.DASH_AM1BCC_CHARGES&gt;  (1) 
-0.057020346264131966 -0.05498106388730991 -0.1417576117737365 -0.24649839652124084 0.19183992335343653 -0.14084077400735293 -0.13325346021838766 -0.85373148869180315 0.69066109221699112
-0.61948158338060078 -0.63810034626413192 0.6751982937456793 -0.58508759253159914 -0.67224362594143339 0.054944129070337355 0.054944129070337355 0.054944129070337355 0.1595973470895479
0.1595973470895479 0.41622965373586801 0.41622965373586801 0.31563710234748005 0.31563710234748005 0.31876819330440859 0.31876819330440859

$$$$
</code></pre>
</div>
</div>
<p>You can see that the property <code>atom.dprop.DASH_AM1BCC_CHARGES</code> has been added to the SD string. Also that we’re writing way too many sig figs… it’s probably worth adding an option to control that.</p>
<p>When that SD string is parsed, the atom properties are extracted automatically and assigned to the atoms:</p>
<div id="89ae23e1" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">suppl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chem.SDMolSupplier()</span>
<span id="cb11-2">suppl.SetData(sdf,removeHs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb11-3"></span>
<span id="cb11-4">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(suppl)</span>
<span id="cb11-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> atom <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> m.GetAtoms():</span>
<span id="cb11-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(atom.GetIdx(), atom.GetDoubleProp(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DASH_AM1BCC_CHARGES"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0 -0.057020346264131966
1 -0.05498106388730991
2 -0.1417576117737365
3 -0.24649839652124084
4 0.19183992335343653
5 -0.14084077400735293
6 -0.13325346021838766
7 -0.8537314886918032
8 0.6906610922169911
9 -0.6194815833806008
10 -0.6381003462641319
11 0.6751982937456793
12 -0.5850875925315991
13 -0.6722436259414334
14 0.054944129070337355
15 0.054944129070337355
16 0.054944129070337355
17 0.1595973470895479
18 0.1595973470895479
19 0.416229653735868
20 0.416229653735868
21 0.31563710234748005
22 0.31563710234748005
23 0.3187681933044086
24 0.3187681933044086</code></pre>
</div>
</div>
<p>That’s it… hopefully it is useful</p>



 ]]></description>
  <category>tutorial</category>
  <category>3d</category>
  <guid>https://greglandrum.github.io/rdkit-blog/posts/2025-07-24-writing-partial-charges-to-sd-files.html</guid>
  <pubDate>Wed, 23 Jul 2025 22:00:00 GMT</pubDate>
</item>
</channel>
</rss>
