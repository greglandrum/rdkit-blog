<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-11-30">
<meta name="description" content="What is noise in 3D?">

<title>Thresholds for “random” with 3D similarity methods – RDKit blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../posts/icons/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-4379b0ccadffce622b03caf4c46266b3.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-40840319e1d09552a0f54992bf705f97.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-f86ed83de42dc3a6349cec1bcdefd5d4.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">RDKit blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">RDKit experiments, tips, and tutorials</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rdkit/rdkit"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://bsky.app/profile/rdkit.bsky.social"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/groups/8192558/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro">Intro</a>
  <ul class="collapse">
  <li><a href="#alignment-based-approaches" id="toc-alignment-based-approaches" class="nav-link" data-scroll-target="#alignment-based-approaches">Alignment based approaches</a>
  <ul class="collapse">
  <li><a href="#lobster-set" id="toc-lobster-set" class="nav-link" data-scroll-target="#lobster-set">LOBSTER Set</a></li>
  <li><a href="#chembl-set" id="toc-chembl-set" class="nav-link" data-scroll-target="#chembl-set">ChEMBL Set</a></li>
  </ul></li>
  <li><a href="#non-alignment-based-approaches" id="toc-non-alignment-based-approaches" class="nav-link" data-scroll-target="#non-alignment-based-approaches">Non-alignment based approaches</a>
  <ul class="collapse">
  <li><a href="#lobster-set-1" id="toc-lobster-set-1" class="nav-link" data-scroll-target="#lobster-set-1">LOBSTER Set</a></li>
  <li><a href="#chembl-set-1" id="toc-chembl-set-1" class="nav-link" data-scroll-target="#chembl-set-1">ChEMBL Set</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting started</a></li>
  <li><a href="#random-pairs-from-lobster" id="toc-random-pairs-from-lobster" class="nav-link" data-scroll-target="#random-pairs-from-lobster">Random pairs from LOBSTER</a>
  <ul class="collapse">
  <li><a href="#shape-based-alignment" id="toc-shape-based-alignment" class="nav-link" data-scroll-target="#shape-based-alignment">Shape-based alignment</a></li>
  <li><a href="#open3dalign" id="toc-open3dalign" class="nav-link" data-scroll-target="#open3dalign">Open3DAlign</a></li>
  <li><a href="#baseline-canonical-alignment" id="toc-baseline-canonical-alignment" class="nav-link" data-scroll-target="#baseline-canonical-alignment">Baseline: canonical alignment</a></li>
  <li><a href="#baseline-tanimoto-shape-score-in-the-canonical-alignment" id="toc-baseline-tanimoto-shape-score-in-the-canonical-alignment" class="nav-link" data-scroll-target="#baseline-tanimoto-shape-score-in-the-canonical-alignment">Baseline: tanimoto shape score in the canonical alignment</a></li>
  <li><a href="#non-alignment-methods" id="toc-non-alignment-methods" class="nav-link" data-scroll-target="#non-alignment-methods">Non-alignment methods</a></li>
  </ul></li>
  <li><a href="#random-chembl-molecules" id="toc-random-chembl-molecules" class="nav-link" data-scroll-target="#random-chembl-molecules">Random ChEMBL molecules</a></li>
  <li><a href="#summary-stats" id="toc-summary-stats" class="nav-link" data-scroll-target="#summary-stats">Summary stats</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Thresholds for “random” with 3D similarity methods</h1>
  <div class="quarto-categories">
    <div class="quarto-category">datasets</div>
    <div class="quarto-category">3d</div>
    <div class="quarto-category">reference</div>
  </div>
  </div>

<div>
  <div class="description">
    What is noise in 3D?
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 30, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="intro" class="level1">
<h1>Intro</h1>
<p>In this one I’m generating some reference data for 3D similarity approaches. The idea is inspired by <a href="https://greglandrum.github.io/rdkit-blog/posts/2021-05-18-fingerprint-thresholds1.html">this blog post</a>, where I figured out noise thresholds for similarity calculations with a bunch of 2D fingerprints. Here I do basically the same thing: calculating a number of different 3D similarity (or distance) metrics on random pairs of molecules in order to establish noise thresholds for those metrics.</p>
<p>I compare results from two different data sets for this: 1. 25000 random pairs of molecules with crystal structures from the LOBSTER data set. The <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-11-08-working-with-lobster-1.html">last</a> <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-11-16-working-with-lobster-2.html">three</a> <a href="https://greglandrum.github.io/rdkit-blog/posts/2025-11-23-working-with-lobster-3.html">blog posts</a> have looked at LOBSTER. I used the crystal structures from the LOBSTER data set for these molecules. 2. 50000 random pairs of molecules from the ChEMBL set I used in the <a href="https://greglandrum.github.io/rdkit-blog/posts/2021-05-18-fingerprint-thresholds1.html">fingerprint thresholds post</a>. I used ETKDGv3 conformers for these molecules.</p>
<p>The first data set is considerably less diverse, the pairs are formed from only 3583 unique molecules, but the 3D structures are from crystals so I think it’s worth considering (even though we know that ETKDG does generally produce reasonable structures). For cases where the values disagree, I think it’s probably better to use the ChEMBL results since they come from a larger data set.</p>
<p>Here’s the summary of the results.</p>
<section id="alignment-based-approaches" class="level2">
<h2 class="anchored" data-anchor-id="alignment-based-approaches">Alignment based approaches</h2>
<p>Here some of the metrics are similarity based, where the thresholds are lower bounds, and some are distance based, where the thresholds are upper bounds. Rather than transform the distance into similarity, I think it’s more useful to report the values that actually come from the RDKit function. If this turns out to be wrong, I will update the blog post.</p>
<p>For example, if you do a shape-based alignment of two molecules to each other and get a shape Tanimoto score of 0.80, the LOBSTER data would say that the value is larger than 95% of the random pairs while the ChEMBL data says it’s larger (more significant) than 99% of the random pairs. Similarly, if the shape-based alignment produces a shape Tanimoto distance of 0.30, both data sets would say that the distance is smaller (more significant) than 99% of the random pairs.</p>
<section id="lobster-set" class="level3">
<h3 class="anchored" data-anchor-id="lobster-set">LOBSTER Set</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>metric</th>
<th>70%</th>
<th>80%</th>
<th>90%</th>
<th>95%</th>
<th>99%</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>baseline_ShapeTanimoto</td>
<td>&gt;0.49</td>
<td>&gt;0.54</td>
<td>&gt;0.62</td>
<td>&gt;0.69</td>
<td>&gt;0.81</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>shape_align_ShapeTanimoto</td>
<td>&gt;0.62</td>
<td>&gt;0.66</td>
<td>&gt;0.71</td>
<td>&gt;0.76</td>
<td>&gt;0.85</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>baseline_TanimotoDist</td>
<td>&lt;0.61</td>
<td>&lt;0.57</td>
<td>&lt;0.52</td>
<td>&lt;0.48</td>
<td>&lt;0.39</td>
<td>DISTANCE</td>
</tr>
<tr class="even">
<td>shape_align_TanimotoDist</td>
<td>&lt;0.53</td>
<td>&lt;0.50</td>
<td>&lt;0.46</td>
<td>&lt;0.42</td>
<td>&lt;0.34</td>
<td>DISTANCE</td>
</tr>
<tr class="odd">
<td>shape_align_noc_TanimotoDist</td>
<td>&lt;0.52</td>
<td>&lt;0.49</td>
<td>&lt;0.45</td>
<td>&lt;0.42</td>
<td>&lt;0.34</td>
<td>DISTANCE</td>
</tr>
<tr class="even">
<td>o3a_align_TanimotoDist</td>
<td>&lt;0.58</td>
<td>&lt;0.55</td>
<td>&lt;0.51</td>
<td>&lt;0.46</td>
<td>&lt;0.36</td>
<td>DISTANCE</td>
</tr>
<tr class="odd">
<td>crippeno3a_align_TanimotoDist</td>
<td>&lt;0.59</td>
<td>&lt;0.56</td>
<td>&lt;0.51</td>
<td>&lt;0.47</td>
<td>&lt;0.37</td>
<td>DISTANCE</td>
</tr>
</tbody>
</table>
</section>
<section id="chembl-set" class="level3">
<h3 class="anchored" data-anchor-id="chembl-set">ChEMBL Set</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>metric</th>
<th>70%</th>
<th>80%</th>
<th>90%</th>
<th>95%</th>
<th>99%</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>baseline_ShapeTanimoto</td>
<td>&gt;0.44</td>
<td>&gt;0.48</td>
<td>&gt;0.54</td>
<td>&gt;0.59</td>
<td>&gt;0.69</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>shape_align_ShapeTanimoto</td>
<td>&gt;0.58</td>
<td>&gt;0.61</td>
<td>&gt;0.65</td>
<td>&gt;0.69</td>
<td>&gt;0.76</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>baseline_TanimotoDist</td>
<td>&lt;0.64</td>
<td>&lt;0.61</td>
<td>&lt;0.57</td>
<td>&lt;0.54</td>
<td>&lt;0.47</td>
<td>DISTANCE</td>
</tr>
<tr class="even">
<td>shape_align_TanimotoDist</td>
<td>&lt;0.55</td>
<td>&lt;0.53</td>
<td>&lt;0.50</td>
<td>&lt;0.47</td>
<td>&lt;0.42</td>
<td>DISTANCE</td>
</tr>
<tr class="odd">
<td>shape_align_noc_TanimotoDist</td>
<td>&lt;0.55</td>
<td>&lt;0.53</td>
<td>&lt;0.50</td>
<td>&lt;0.47</td>
<td>&lt;0.41</td>
<td>DISTANCE</td>
</tr>
<tr class="even">
<td>o3a_align_TanimotoDist</td>
<td>&lt;0.61</td>
<td>&lt;0.59</td>
<td>&lt;0.55</td>
<td>&lt;0.52</td>
<td>&lt;0.46</td>
<td>DISTANCE</td>
</tr>
<tr class="odd">
<td>crippeno3a_align_TanimotoDist</td>
<td>&lt;0.61</td>
<td>&lt;0.59</td>
<td>&lt;0.55</td>
<td>&lt;0.52</td>
<td>&lt;0.46</td>
<td>DISTANCE</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="non-alignment-based-approaches" class="level2">
<h2 class="anchored" data-anchor-id="non-alignment-based-approaches">Non-alignment based approaches</h2>
<section id="lobster-set-1" class="level3">
<h3 class="anchored" data-anchor-id="lobster-set-1">LOBSTER Set</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>metric</th>
<th>70%</th>
<th>80%</th>
<th>90%</th>
<th>95%</th>
<th>99%</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>USR_score</td>
<td>&gt;0.66</td>
<td>&gt;0.71</td>
<td>&gt;0.76</td>
<td>&gt;0.80</td>
<td>&gt;0.87</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_USR_score</td>
<td>&gt;0.66</td>
<td>&gt;0.71</td>
<td>&gt;0.76</td>
<td>&gt;0.80</td>
<td>&gt;0.86</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>AP3D_DiceSimilarity</td>
<td>&gt;0.49</td>
<td>&gt;0.54</td>
<td>&gt;0.60</td>
<td>&gt;0.63</td>
<td>&gt;0.70</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_AP3D_DiceSimilarity</td>
<td>&gt;0.29</td>
<td>&gt;0.33</td>
<td>&gt;0.38</td>
<td>&gt;0.43</td>
<td>&gt;0.51</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>E3FP_DiceSimilarity</td>
<td>&gt;0.28</td>
<td>&gt;0.31</td>
<td>&gt;0.34</td>
<td>&gt;0.37</td>
<td>&gt;0.43</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_E3FP_DiceSimilarity</td>
<td>&gt;0.23</td>
<td>&gt;0.26</td>
<td>&gt;0.29</td>
<td>&gt;0.32</td>
<td>&gt;0.38</td>
<td>SIMILARITY</td>
</tr>
</tbody>
</table>
</section>
<section id="chembl-set-1" class="level3">
<h3 class="anchored" data-anchor-id="chembl-set-1">ChEMBL Set</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>metric</th>
<th>70%</th>
<th>80%</th>
<th>90%</th>
<th>95%</th>
<th>99%</th>
<th>type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>USR_score</td>
<td>&gt;0.65</td>
<td>&gt;0.69</td>
<td>&gt;0.74</td>
<td>&gt;0.78</td>
<td>&gt;0.84</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_USR_score</td>
<td>&gt;0.65</td>
<td>&gt;0.69</td>
<td>&gt;0.74</td>
<td>&gt;0.78</td>
<td>&gt;0.84</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>AP3D_DiceSimilarity</td>
<td>&gt;0.57</td>
<td>&gt;0.60</td>
<td>&gt;0.65</td>
<td>&gt;0.68</td>
<td>&gt;0.73</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_AP3D_DiceSimilarity</td>
<td>&gt;0.34</td>
<td>&gt;0.37</td>
<td>&gt;0.42</td>
<td>&gt;0.45</td>
<td>&gt;0.51</td>
<td>SIMILARITY</td>
</tr>
<tr class="odd">
<td>E3FP_DiceSimilarity</td>
<td>&gt;0.30</td>
<td>&gt;0.33</td>
<td>&gt;0.35</td>
<td>&gt;0.38</td>
<td>&gt;0.42</td>
<td>SIMILARITY</td>
</tr>
<tr class="even">
<td>noh_E3FP_DiceSimilarity</td>
<td>&gt;0.26</td>
<td>&gt;0.28</td>
<td>&gt;0.30</td>
<td>&gt;0.32</td>
<td>&gt;0.36</td>
<td>SIMILARITY</td>
</tr>
</tbody>
</table>
<div id="209d81ae" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> Chem</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> Draw</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem.Draw <span class="im">import</span> IPythonConsole</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>IPythonConsole.ipython_3d <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'tableau-colorblind10'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'font.size'</span>] <span class="op">=</span> <span class="st">'16'</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext sql</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config SqlMagic.feedback<span class="op">=</span><span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f3d421d6" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rdkit</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rdkit.__version__)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2025.09.3</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="getting-started" class="level1">
<h1>Getting started</h1>
<div id="dc28d683" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lwreg</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lwreg <span class="im">import</span> utils</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Load our lwreg configuration from the database we created before:</p>
<div id="e184d2ce" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> utils.configure_from_database(dbname<span class="op">=</span><span class="st">'lobster_112024'</span>,dbtype<span class="op">=</span><span class="st">'postgresql'</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>lwreg.set_default_config(config)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>config</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{'dbname': 'lobster_112024',
 'dbtype': 'postgresql',
 'cacheConnection': True,
 'standardization': 'none',
 'removeHs': 1,
 'useTautomerHashv2': 0,
 'registerConformers': 1,
 'numConformerDigits': 3,
 'lwregSchema': ''}</code></pre>
</div>
</div>
</section>
<section id="random-pairs-from-lobster" class="level1">
<h1>Random pairs from LOBSTER</h1>
<p>Get a map from (nm,pdb) tuples to (molregno,confid,molblock):</p>
<div id="8ff64590" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> <span class="op">%</span>sql postgresql:<span class="op">//</span>localhost<span class="op">/</span>lobster_112024 <span class="op">\</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    select ligname,pdb,molregno,conf_id,molblock <span class="op">\</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> lobster_data.all_ligands join conformers using (molregno,conf_id)<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>ligs <span class="op">=</span> {}</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> nm,pdb,mrn,cid,mb <span class="kw">in</span> d:</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    mol <span class="op">=</span> Chem.MolFromMolBlock(mb,removeHs<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    mol_noh <span class="op">=</span> Chem.MolFromMolBlock(mb)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    ligs[(mrn,cid)] <span class="op">=</span> (nm,pdb,mb,mol,mol_noh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a bunch of random pairs:</p>
<div id="5aab111d" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="bn">0xa100f</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>ks <span class="op">=</span> <span class="bu">list</span>(ligs.keys())</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> []</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="bu">len</span>(base)<span class="op">&lt;</span><span class="dv">25000</span>:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> ks[:]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    random.shuffle(t)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    base.extend(t)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>tbase <span class="op">=</span> base[:]</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>random.shuffle(tbase)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>pairs <span class="op">=</span> <span class="bu">set</span>((<span class="bu">min</span>(x,y),<span class="bu">max</span>(x,y)) <span class="cf">for</span> x,y <span class="kw">in</span> <span class="bu">zip</span>(base,tbase) <span class="cf">if</span> x<span class="op">!=</span>y)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(pairs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>25029</code></pre>
</div>
</div>
<div id="41f0b1a6" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>pairs <span class="op">=</span> <span class="bu">list</span>(pairs)[:<span class="dv">25000</span>]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>pairs[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>[((453, 453), (925, 925)),
 ((1574, 1574), (2733, 2733)),
 ((175, 175), (3247, 3247)),
 ((1719, 1719), (3118, 3118)),
 ((3054, 3054), (3458, 3458))]</code></pre>
</div>
</div>
<section id="shape-based-alignment" class="level2">
<h2 class="anchored" data-anchor-id="shape-based-alignment">Shape-based alignment</h2>
<p>Let’s see what we get when we perform shape-based alignment using the crystal conformers.</p>
<p>Start by aligning the crystal conformers.</p>
<div id="d2cc720a" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gzip,pickle</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>res_accum <span class="op">=</span> pickle.load(<span class="bu">open</span>(<span class="st">'./results/3d_random_distances.pkl'</span>,<span class="st">'rb'</span>))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdShapeAlign</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdShapeHelpers</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdMolTransforms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7f4e759e" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>res_accum <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="571327f7" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdShapeAlign</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdShapeHelpers</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdMolTransforms</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c1,c2 <span class="kw">in</span> tqdm(pairs):</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">3</span>])</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">3</span>])</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    st,ct <span class="op">=</span> rdShapeAlign.AlignMol(m1,m2,opt_param<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'shape_align_ShapeTanimoto'</span>].append(st)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'shape_align_ColorTanimoto'</span>].append(ct)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'shape_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    st,ct <span class="op">=</span> rdShapeAlign.AlignMol(m1,m2,opt_param<span class="op">=</span><span class="fl">1.0</span>,useColors<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'shape_align_noc_ShapeTanimoto'</span>].append(st)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'shape_align_noc_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████| 25000/25000 [00:47&lt;00:00, 530.84it/s]</code></pre>
</div>
</div>
</section>
<section id="open3dalign" class="level2">
<h2 class="anchored" data-anchor-id="open3dalign">Open3DAlign</h2>
<p>What about an alternative 3D alignment algorithm? Let’s try aligning with Paolo Tosco’s <a href="https://link.springer.com/article/10.1007/s10822-011-9462-9">Open3DAlign</a>:</p>
<div id="e6ecccef" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdMolAlign</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c1,c2 <span class="kw">in</span> tqdm(pairs):</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">3</span>])</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">3</span>])</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        o3a <span class="op">=</span> rdMolAlign.GetO3A(m2,m1)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        rmsd <span class="op">=</span> o3a.Align()</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> o3a.Score()</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        res_accum[<span class="st">'o3a_align_rmsd'</span>].append(rmsd)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        res_accum[<span class="st">'o3a_align_scpre'</span>].append(score)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        res_accum[<span class="st">'o3a_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████| 25000/25000 [02:06&lt;00:00, 198.35it/s]</code></pre>
</div>
</div>
<p>The RDKit has a variation on Open3DAlign that uses atomic contributions to the MolLogP value instead of MMFF94 atom types</p>
<div id="6e9ee47e" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdMolAlign</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c1,c2 <span class="kw">in</span> tqdm(pairs):</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">3</span>])</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">3</span>])</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        o3a <span class="op">=</span> rdMolAlign.GetCrippenO3A(m2,m1)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        rmsd <span class="op">=</span> o3a.Align()</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> o3a.Score()</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        res_accum[<span class="st">'crippeno3a_align_rmsd'</span>].append(rmsd)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        res_accum[<span class="st">'crippeno3a_align_scpre'</span>].append(score)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        res_accum[<span class="st">'crippeno3a_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████| 25000/25000 [01:08&lt;00:00, 366.77it/s]</code></pre>
</div>
</div>
</section>
<section id="baseline-canonical-alignment" class="level2">
<h2 class="anchored" data-anchor-id="baseline-canonical-alignment">Baseline: canonical alignment</h2>
<p>Just put the molecules in their principle-axis frame</p>
<div id="4b2bfa9f" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>res_accum[<span class="st">'baseline_TanimotoDist'</span>] <span class="op">=</span> []</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c1,c2 <span class="kw">in</span> tqdm(pairs):</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">3</span>])</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">3</span>])</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'baseline_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████████████████████████████████| 25000/25000 [00:07&lt;00:00, 3483.93it/s]</code></pre>
</div>
</div>
</section>
<section id="baseline-tanimoto-shape-score-in-the-canonical-alignment" class="level2">
<h2 class="anchored" data-anchor-id="baseline-tanimoto-shape-score-in-the-canonical-alignment">Baseline: tanimoto shape score in the canonical alignment</h2>
<p>In the v2025.09.3 RDKit release (released the day before I wrote this post), Dave Cosgrove added a function allowing two molecules to be scored using the Pubchem shape alignment code without doing the alignment first. This gives a score that is directly comparable to what you get when you do an alignment.</p>
<div id="c3454219" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>res_accum[<span class="st">'baseline_ShapeTanimoto'</span>] <span class="op">=</span> []</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c1,c2 <span class="kw">in</span> tqdm(pairs):</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">3</span>])</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">3</span>])</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    opts <span class="op">=</span> rdShapeAlign.ShapeInputOptions()</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'baseline_ShapeTanimoto'</span>].append(rdShapeAlign.ScoreMol(m1,m2,opts,opts))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████████████████████████████████| 25000/25000 [00:05&lt;00:00, 4227.54it/s]</code></pre>
</div>
</div>
<div id="252a2d60" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>pickle.dump(res_accum,<span class="bu">open</span>(<span class="st">'./results/3d_random_distances.pkl'</span>,<span class="st">'wb+'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2c65c817" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>plt.hist([[x[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> res_accum[<span class="st">'baseline_ShapeTanimoto'</span>]],res_accum[<span class="st">'shape_align_ShapeTanimoto'</span>]],</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>         bins<span class="op">=</span><span class="dv">20</span>,label<span class="op">=</span>[<span class="st">'baseline'</span>,<span class="st">'aligned'</span>])</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'shape tanimoto score'</span>)<span class="op">;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2025-11-30-thresholds-for-random-3d_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="d915aac5" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>plt.hist([res_accum[<span class="st">'baseline_TanimotoDist'</span>],],bins<span class="op">=</span><span class="dv">20</span>,label<span class="op">=</span>[<span class="st">'baseline'</span>,])</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'shape tanimoto distance'</span>)<span class="op">;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2025-11-30-thresholds-for-random-3d_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b32d77cc" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>plt.hist([res_accum[<span class="st">'baseline_TanimotoDist'</span>],res_accum[<span class="st">'shape_align_TanimotoDist'</span>],res_accum[<span class="st">'shape_align_noc_TanimotoDist'</span>]],bins<span class="op">=</span><span class="dv">20</span>,label<span class="op">=</span>[<span class="st">'baseline'</span>,<span class="st">'color'</span>,<span class="st">'no color'</span>])</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'shape tanimoto distance'</span>)<span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2025-11-30-thresholds-for-random-3d_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="97253f37" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>plt.hist([res_accum[<span class="st">'baseline_TanimotoDist'</span>],res_accum[<span class="st">'o3a_align_TanimotoDist'</span>],res_accum[<span class="st">'crippeno3a_align_TanimotoDist'</span>]],</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>         bins<span class="op">=</span><span class="dv">20</span>,label<span class="op">=</span>[<span class="st">'baseline'</span>,<span class="st">'O3A'</span>,<span class="st">'CrippenO3A'</span>])</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'shape tanimoto distance'</span>)<span class="op">;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2025-11-30-thresholds-for-random-3d_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="non-alignment-methods" class="level2">
<h2 class="anchored" data-anchor-id="non-alignment-methods">Non-alignment methods</h2>
<div id="9264b870" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdMolDescriptors</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>res_accum[<span class="st">'USR_score'</span>] <span class="op">=</span> []</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>res_accum[<span class="st">'noh_USR_score'</span>] <span class="op">=</span> []</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c1,c2 <span class="kw">in</span> tqdm(pairs):</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">3</span>])</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">3</span>])</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    usr1 <span class="op">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    usr2 <span class="op">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'USR_score'</span>].append(rdMolDescriptors.GetUSRScore(usr1,usr2))</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">4</span>])</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">4</span>])</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    usr1 <span class="op">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    usr2 <span class="op">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'noh_USR_score'</span>].append(rdMolDescriptors.GetUSRScore(usr1,usr2))</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████████████████████████████████| 25000/25000 [00:03&lt;00:00, 6754.96it/s]</code></pre>
</div>
</div>
<div id="89177da4" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fpg <span class="op">=</span> rdFingerprintGenerator.GetAtomPairGenerator(use2D<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>res_accum[<span class="st">'AP3D_DiceSimilarity'</span>] <span class="op">=</span> []</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>res_accum[<span class="st">'noh_AP3D_DiceSimilarity'</span>] <span class="op">=</span> []</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c1,c2 <span class="kw">in</span> tqdm(pairs):</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">3</span>])</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">3</span>])</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> m1.GetNumConformers() <span class="kw">or</span> <span class="kw">not</span> m2.GetNumConformers():</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    fp1 <span class="op">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    fp2 <span class="op">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'AP3D_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">4</span>])</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">4</span>])</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    fp1 <span class="op">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    fp2 <span class="op">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'noh_AP3D_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████████████████████████████████| 25000/25000 [00:21&lt;00:00, 1148.58it/s]</code></pre>
</div>
</div>
<div id="73fd7228" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> e3fp.pipeline <span class="im">import</span> fprints_from_mol</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>logging.disable(logging.INFO)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_fp(m):</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    fp <span class="op">=</span> fprints_from_mol(m,fprint_params<span class="op">=</span>{<span class="st">'counts'</span>:<span class="va">True</span>})[<span class="dv">0</span>]</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    rdkfp <span class="op">=</span> DataStructs.ULongSparseIntVect(<span class="dv">2</span><span class="op">**</span><span class="dv">32</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k,v <span class="kw">in</span> fp.counts.items():</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        rdkfp[<span class="bu">int</span>(k)] <span class="op">=</span> v </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rdkfp</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>res_accum[<span class="st">'E3FP_DiceSimilarity'</span>] <span class="op">=</span> []</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>res_accum[<span class="st">'noh_E3FP_DiceSimilarity'</span>] <span class="op">=</span> []</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c1,c2 <span class="kw">in</span> tqdm(pairs):</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">3</span>])</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">3</span>])</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    fp1 <span class="op">=</span> get_fp(m1)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    fp2 <span class="op">=</span> get_fp(m2)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'E3FP_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(ligs[c1][<span class="dv">4</span>])</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(ligs[c2][<span class="dv">4</span>])</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    fp1 <span class="op">=</span> get_fp(m1)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    fp2 <span class="op">=</span> get_fp(m2)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    res_accum[<span class="st">'noh_E3FP_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|████████████████████████████████████████████████████████████████████████| 25000/25000 [39:01&lt;00:00, 10.68it/s]</code></pre>
</div>
</div>
<div id="08bd0098" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>pickle.dump(res_accum,<span class="bu">open</span>(<span class="st">'./results/3d_random_distances.pkl'</span>,<span class="st">'wb+'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="random-chembl-molecules" class="level1">
<h1>Random ChEMBL molecules</h1>
<p>Using the pairs of random molecules I used for the <a href="https://greglandrum.github.io/rdkit-blog/posts/2021-05-18-fingerprint-thresholds1.html">fingerprint thresholds post</a> and other blog posts about similarity.</p>
<div id="15a5f21b" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gzip</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>ind <span class="op">=</span> [x.split(<span class="st">b'</span><span class="ch">\t</span><span class="st">'</span>) <span class="cf">for</span> x <span class="kw">in</span> gzip.<span class="bu">open</span>(<span class="st">'../data/chembl35_50K.mfp0.pairs.txt.gz'</span>)]</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>ms1 <span class="op">=</span> []</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>ms2 <span class="op">=</span> []</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,row <span class="kw">in</span> <span class="bu">enumerate</span>(ind):</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.AddHs(Chem.MolFromSmiles(row[<span class="dv">1</span>]))</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    ms1.append(m1)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.AddHs(Chem.MolFromSmiles(row[<span class="dv">3</span>]))</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    ms2.append(m2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3ddc180e" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">23</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>random.shuffle(ms2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e6b792b6" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(ms1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>50000</code></pre>
</div>
</div>
<div id="97814a24" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> ipyparallel <span class="im">as</span> ipp</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    rc <span class="op">=</span> ipp.Client()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    dview <span class="op">=</span> rc[:]</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'from rdkit import Chem'</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'from rdkit.Chem import rdDistGeom'</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'from rdkit.Chem import rdMolAlign'</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'from rdkit.Chem import rdMolTransforms'</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'from rdkit.Chem import rdShapeHelpers'</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'from rdkit.Chem import rdShapeAlign'</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'from rdkit.Chem import rdFingerprintGenerator'</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'from rdkit import DataStructs'</span>)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'from e3fp.pipeline import fprints_from_mol'</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    dview.execute(<span class="st">'import logging;logging.disable(logging.INFO)'</span>)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"could not use ipyparallel"</span>)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    dview <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Generate one ETKDGv3 conformer per molecule:</p>
<div id="09612e14" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdDistGeom</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>ms1c <span class="op">=</span> dview.map_sync(<span class="kw">lambda</span> x:(rdDistGeom.EmbedMolecule(x,randomSeed<span class="op">=</span><span class="bn">0xf00d</span>),x), ms1)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>ms2c <span class="op">=</span> dview.map_sync(<span class="kw">lambda</span> x:(rdDistGeom.EmbedMolecule(x,randomSeed<span class="op">=</span><span class="bn">0xf00d</span>),x), ms2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="480e2214" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gzip</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>pickle.dump((ms1c,ms2c),gzip.<span class="bu">open</span>(<span class="st">'./results/random_pairs_confs.pkl.gz'</span>,<span class="st">'wb+'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a2eaed5b" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>res_accum2 <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m1,m2 <span class="kw">in</span> tqdm(<span class="bu">zip</span>(ms1c,ms2c)):</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(m1[<span class="dv">1</span>])</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(m2[<span class="dv">1</span>])</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> m1.GetNumConformers() <span class="kw">or</span> <span class="kw">not</span> m2.GetNumConformers():</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'baseline_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    st,ct <span class="op">=</span> rdShapeAlign.AlignMol(m1,m2,opt_param<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'shape_align_ShapeTanimoto'</span>].append(st)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'shape_align_ColorTanimoto'</span>].append(ct)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'shape_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    st,ct <span class="op">=</span> rdShapeAlign.AlignMol(m1,m2,opt_param<span class="op">=</span><span class="fl">1.0</span>,useColors<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'shape_align_noc_ShapeTanimoto'</span>].append(st)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'shape_align_noc_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="889e9ec8" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>res_accum2 <span class="op">=</span> pickle.load(<span class="bu">open</span>(<span class="st">'./results/3d_random_distances2.pkl'</span>,<span class="st">'rb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="69359a87" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>res_accum2[<span class="st">'baseline_ShapeTanimoto'</span>] <span class="op">=</span> []</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m1,m2 <span class="kw">in</span> tqdm(<span class="bu">zip</span>(ms1c,ms2c)):</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(m1[<span class="dv">1</span>])</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(m2[<span class="dv">1</span>])</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> m1.GetNumConformers() <span class="kw">or</span> <span class="kw">not</span> m2.GetNumConformers():</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m1.GetConformer())</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    rdMolTransforms.CanonicalizeConformer(m2.GetConformer())</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    opts <span class="op">=</span> rdShapeAlign.ShapeInputOptions()</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'baseline_ShapeTanimoto'</span>].append(rdShapeAlign.ScoreMol(m1,m2,opts,opts))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [00:12, 3934.62it/s]</code></pre>
</div>
</div>
<div id="867c11c6" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m1,m2 <span class="kw">in</span> tqdm(<span class="bu">zip</span>(ms1c,ms2c)):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(m1[<span class="dv">1</span>])</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(m2[<span class="dv">1</span>])</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> m1.GetNumConformers() <span class="kw">or</span> <span class="kw">not</span> m2.GetNumConformers():</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        o3a <span class="op">=</span> rdMolAlign.GetO3A(m2,m1)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        rmsd <span class="op">=</span> o3a.Align()</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> o3a.Score()</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        res_accum2[<span class="st">'o3a_align_rmsd'</span>].append(rmsd)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        res_accum2[<span class="st">'o3a_align_scpre'</span>].append(score)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        res_accum2[<span class="st">'o3a_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [07:06, 117.30it/s]</code></pre>
</div>
</div>
<div id="8f4235e4" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m1,m2 <span class="kw">in</span> tqdm(<span class="bu">zip</span>(ms1c,ms2c)):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(m1[<span class="dv">1</span>])</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(m2[<span class="dv">1</span>])</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> m1.GetNumConformers() <span class="kw">or</span> <span class="kw">not</span> m2.GetNumConformers():</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        o3a <span class="op">=</span> rdMolAlign.GetCrippenO3A(m2,m1)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>        rmsd <span class="op">=</span> o3a.Align()</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> o3a.Score()</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        res_accum2[<span class="st">'crippeno3a_align_rmsd'</span>].append(rmsd)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        res_accum2[<span class="st">'crippeno3a_align_scpre'</span>].append(score)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>        res_accum2[<span class="st">'crippeno3a_align_TanimotoDist'</span>].append(rdShapeHelpers.ShapeTanimotoDist(m1,m2))   </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [03:43, 223.62it/s]</code></pre>
</div>
</div>
<div id="3dfabd2e" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdMolDescriptors</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>res_accum2[<span class="st">'USR_score'</span>] <span class="op">=</span> []</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>res_accum2[<span class="st">'noh_USR_score'</span>] <span class="op">=</span> []</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m1,m2 <span class="kw">in</span> tqdm(<span class="bu">zip</span>(ms1c,ms2c)):</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(m1[<span class="dv">1</span>])</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(m2[<span class="dv">1</span>])</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> m1.GetNumConformers() <span class="kw">or</span> <span class="kw">not</span> m2.GetNumConformers():</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    usr1 <span class="op">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    usr2 <span class="op">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'USR_score'</span>].append(rdMolDescriptors.GetUSRScore(usr1,usr2))</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.RemoveHs(m1)</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.RemoveHs(m2)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    usr1 <span class="op">=</span> rdMolDescriptors.GetUSR(m1)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    usr2 <span class="op">=</span> rdMolDescriptors.GetUSR(m2)</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'noh_USR_score'</span>].append(rdMolDescriptors.GetUSRScore(usr1,usr2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [00:18, 2744.31it/s]</code></pre>
</div>
</div>
<div id="bbcda974" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>fpg <span class="op">=</span> rdFingerprintGenerator.GetAtomPairGenerator(use2D<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>res_accum2[<span class="st">'AP3D_DiceSimilarity'</span>] <span class="op">=</span> []</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>res_accum2[<span class="st">'noh_AP3D_DiceSimilarity'</span>] <span class="op">=</span> []</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m1,m2 <span class="kw">in</span> tqdm(<span class="bu">zip</span>(ms1c,ms2c)):</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(m1[<span class="dv">1</span>])</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(m2[<span class="dv">1</span>])</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> m1.GetNumConformers() <span class="kw">or</span> <span class="kw">not</span> m2.GetNumConformers():</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    fp1 <span class="op">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    fp2 <span class="op">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'AP3D_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.RemoveHs(m1)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.RemoveHs(m2)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    fp1 <span class="op">=</span> fpg.GetCountFingerprint(m1)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    fp2 <span class="op">=</span> fpg.GetCountFingerprint(m2)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'noh_AP3D_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [01:12, 688.09it/s]</code></pre>
</div>
</div>
<div id="d5b1beec" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>res_accum2[<span class="st">'E3FP_DiceSimilarity'</span>] <span class="op">=</span> []</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>res_accum2[<span class="st">'noh_E3FP_DiceSimilarity'</span>] <span class="op">=</span> []</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m1,m2 <span class="kw">in</span> tqdm(<span class="bu">zip</span>(ms1c,ms2c)):</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.Mol(m1[<span class="dv">1</span>])</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.Mol(m2[<span class="dv">1</span>])</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> m1.GetNumConformers() <span class="kw">or</span> <span class="kw">not</span> m2.GetNumConformers():</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    fp1 <span class="op">=</span> get_fp(m1)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    fp2 <span class="op">=</span> get_fp(m2)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'E3FP_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> Chem.RemoveHs(m1)</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> Chem.RemoveHs(m2)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    fp1 <span class="op">=</span> get_fp(m1)</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    fp2 <span class="op">=</span> get_fp(m2)</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    res_accum2[<span class="st">'noh_E3FP_DiceSimilarity'</span>].append(DataStructs.DiceSimilarity(fp1,fp2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>50000it [1:49:13,  7.63it/s]</code></pre>
</div>
</div>
<div id="05eb636b" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>pickle.dump(res_accum2,<span class="bu">open</span>(<span class="st">'./results/3d_random_distances2.pkl'</span>,<span class="st">'wb+'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0118af31" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>plt.hist([[x[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> res_accum2[<span class="st">'baseline_ShapeTanimoto'</span>]],res_accum2[<span class="st">'shape_align_ShapeTanimoto'</span>]],</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>         bins<span class="op">=</span><span class="dv">20</span>,label<span class="op">=</span>[<span class="st">'baseline'</span>,<span class="st">'aligned'</span>])</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'shape tanimoto score'</span>)<span class="op">;</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2025-11-30-thresholds-for-random-3d_files/figure-html/cell-40-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="bacc03dc" class="cell" data-scrolled="false" data-execution_count="99">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>plt.hist([res_accum2[<span class="st">'baseline_TanimotoDist'</span>],res_accum2[<span class="st">'shape_align_TanimotoDist'</span>],res_accum2[<span class="st">'shape_align_noc_TanimotoDist'</span>]],bins<span class="op">=</span><span class="dv">20</span>,label<span class="op">=</span>[<span class="st">'baseline'</span>,<span class="st">'color'</span>,<span class="st">'no color'</span>])</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'shape tanimoto distance'</span>)<span class="op">;</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2025-11-30-thresholds-for-random-3d_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="87d00871" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>plt.hist([res_accum2[<span class="st">'baseline_TanimotoDist'</span>],res_accum2[<span class="st">'o3a_align_TanimotoDist'</span>],res_accum2[<span class="st">'crippeno3a_align_TanimotoDist'</span>]],</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>         bins<span class="op">=</span><span class="dv">20</span>,label<span class="op">=</span>[<span class="st">'baseline'</span>,<span class="st">'O3A'</span>,<span class="st">'CrippenO3A'</span>])</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'shape tanimoto distance'</span>)<span class="op">;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2025-11-30-thresholds-for-random-3d_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b1724537" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>res_accum2.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>dict_keys(['baseline_TanimotoDist', 'shape_align_ShapeTanimoto', 'shape_align_ColorTanimoto', 'shape_align_TanimotoDist', 'shape_align_noc_ShapeTanimoto', 'shape_align_noc_TanimotoDist', 'o3a_align_rmsd', 'o3a_align_scpre', 'o3a_align_TanimotoDist', 'crippeno3a_align_rmsd', 'crippeno3a_align_scpre', 'crippeno3a_align_TanimotoDist', 'USR_score', 'noh_USR_score', 'AP3D_DiceSimilarity', 'noh_AP3D_DiceSimilarity', 'E3FP_DiceSimilarity', 'noh_E3FP_DiceSimilarity', 'baseline_ShapeTanimoto'])</code></pre>
</div>
</div>
<div id="24eda1e0" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>plt.hist([res_accum2[<span class="st">'o3a_align_scpre'</span>],res_accum2[<span class="st">'crippeno3a_align_scpre'</span>],],</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>         bins<span class="op">=</span><span class="dv">20</span>,label<span class="op">=</span>[<span class="st">'O3A'</span>,<span class="st">'CrippenO3A'</span>])</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'alignment score'</span>)<span class="op">;</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>plt.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="2025-11-30-thresholds-for-random-3d_files/figure-html/cell-44-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="summary-stats" class="level1">
<h1>Summary stats</h1>
<div id="bbf8c974" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b1863315" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'****   LOBSTER Set ****'</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'| baseline_ShapeTanimoto</span><span class="ch">\t</span><span class="st">|'</span>,</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">' | '</span>.join([<span class="st">"&gt;</span><span class="sc">%.2f</span><span class="st">"</span><span class="op">%</span>x <span class="cf">for</span> x <span class="kw">in</span> np.quantile([x[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> res_accum[<span class="st">'baseline_ShapeTanimoto'</span>]],[<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>])]),</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>     <span class="st">'</span><span class="ch">\t</span><span class="st">| SIMILARITY |'</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'| shape_align_ShapeTanimoto</span><span class="ch">\t</span><span class="st">|'</span>,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">' | '</span>.join([<span class="st">"&gt;</span><span class="sc">%.2f</span><span class="st">"</span><span class="op">%</span>x <span class="cf">for</span> x <span class="kw">in</span> np.quantile([x <span class="cf">for</span> x <span class="kw">in</span> res_accum[<span class="st">'shape_align_ShapeTanimoto'</span>]],[<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>])]),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>     <span class="st">'</span><span class="ch">\t</span><span class="st">| SIMILARITY |'</span>)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'baseline_TanimotoDist'</span>,<span class="st">'shape_align_TanimotoDist'</span>,<span class="st">'shape_align_noc_TanimotoDist'</span>,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>         <span class="st">'o3a_align_TanimotoDist'</span>,<span class="st">'crippeno3a_align_TanimotoDist'</span>]:</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'| </span><span class="sc">{</span>k<span class="sc">}</span><span class="ch">\t</span><span class="ss">|'</span>,<span class="st">' | '</span>.join([<span class="st">"&lt;</span><span class="sc">%.2f</span><span class="st">"</span><span class="op">%</span>x <span class="cf">for</span> x <span class="kw">in</span> np.quantile(res_accum[k],[<span class="fl">0.3</span>,<span class="fl">0.2</span>,<span class="fl">0.1</span>,<span class="fl">0.05</span>,<span class="fl">0.01</span>])]),</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>         <span class="st">'</span><span class="ch">\t</span><span class="st">| DISTANCE |'</span>)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'****   ChEMBL Set ****'</span>)</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'| baseline_ShapeTanimoto</span><span class="ch">\t</span><span class="st">|'</span>,</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">' | '</span>.join([<span class="st">"&gt;</span><span class="sc">%.2f</span><span class="st">"</span><span class="op">%</span>x <span class="cf">for</span> x <span class="kw">in</span> np.quantile([x[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> res_accum2[<span class="st">'baseline_ShapeTanimoto'</span>]],[<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>])]),</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>     <span class="st">'</span><span class="ch">\t</span><span class="st">| SIMILARITY |'</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'| shape_align_ShapeTanimoto</span><span class="ch">\t</span><span class="st">|'</span>,</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">' | '</span>.join([<span class="st">"&gt;</span><span class="sc">%.2f</span><span class="st">"</span><span class="op">%</span>x <span class="cf">for</span> x <span class="kw">in</span> np.quantile([x <span class="cf">for</span> x <span class="kw">in</span> res_accum2[<span class="st">'shape_align_ShapeTanimoto'</span>]],[<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>])]),</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>     <span class="st">'</span><span class="ch">\t</span><span class="st">| SIMILARITY |'</span>)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'baseline_TanimotoDist'</span>,<span class="st">'shape_align_TanimotoDist'</span>,<span class="st">'shape_align_noc_TanimotoDist'</span>,</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>         <span class="st">'o3a_align_TanimotoDist'</span>,<span class="st">'crippeno3a_align_TanimotoDist'</span>]:</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'| </span><span class="sc">{</span>k<span class="sc">}</span><span class="ch">\t</span><span class="ss">|'</span>,<span class="st">' | '</span>.join([<span class="st">"&lt;</span><span class="sc">%.2f</span><span class="st">"</span><span class="op">%</span>x <span class="cf">for</span> x <span class="kw">in</span> np.quantile(res_accum2[k],[<span class="fl">0.3</span>,<span class="fl">0.2</span>,<span class="fl">0.1</span>,<span class="fl">0.05</span>,<span class="fl">0.01</span>])]),</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>         <span class="st">'</span><span class="ch">\t</span><span class="st">| DISTANCE |'</span>)</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="ch">\n\n\n</span><span class="st"> ------------------   No alignment  --------------------'</span>)</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'****   LOBSTER Set ****'</span>)</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'USR_score'</span>,<span class="st">'noh_USR_score'</span>,<span class="st">'AP3D_DiceSimilarity'</span>,<span class="st">'noh_AP3D_DiceSimilarity'</span>,</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>          <span class="st">'E3FP_DiceSimilarity'</span>,<span class="st">'noh_E3FP_DiceSimilarity'</span>]:</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'| </span><span class="sc">{</span>k<span class="sc">}</span><span class="ch">\t</span><span class="ss">|'</span>,<span class="st">' | '</span>.join([<span class="st">"&gt;</span><span class="sc">%.2f</span><span class="st">"</span><span class="op">%</span>x <span class="cf">for</span> x <span class="kw">in</span> np.quantile(res_accum[k],[<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>])]),</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>         <span class="st">'</span><span class="ch">\t</span><span class="st">| SIMILARITY |'</span>)</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'****   ChEMBL Set ****'</span>)</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'USR_score'</span>,<span class="st">'noh_USR_score'</span>,<span class="st">'AP3D_DiceSimilarity'</span>,<span class="st">'noh_AP3D_DiceSimilarity'</span>,</span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>          <span class="st">'E3FP_DiceSimilarity'</span>,<span class="st">'noh_E3FP_DiceSimilarity'</span>]:</span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'| </span><span class="sc">{</span>k<span class="sc">}</span><span class="ch">\t</span><span class="ss">|'</span>,<span class="st">' | '</span>.join([<span class="st">"&gt;</span><span class="sc">%.2f</span><span class="st">"</span><span class="op">%</span>x <span class="cf">for</span> x <span class="kw">in</span> np.quantile(res_accum2[k],[<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>])]),</span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>         <span class="st">'</span><span class="ch">\t</span><span class="st">| SIMILARITY |'</span>)</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>****   LOBSTER Set ****
| baseline_ShapeTanimoto    | &gt;0.49 | &gt;0.54 | &gt;0.62 | &gt;0.69 | &gt;0.81     | SIMILARITY |
| shape_align_ShapeTanimoto | &gt;0.62 | &gt;0.66 | &gt;0.71 | &gt;0.76 | &gt;0.85     | SIMILARITY |
| baseline_TanimotoDist | &lt;0.61 | &lt;0.57 | &lt;0.52 | &lt;0.48 | &lt;0.39     | DISTANCE |
| shape_align_TanimotoDist  | &lt;0.53 | &lt;0.50 | &lt;0.46 | &lt;0.42 | &lt;0.34     | DISTANCE |
| shape_align_noc_TanimotoDist  | &lt;0.52 | &lt;0.49 | &lt;0.45 | &lt;0.42 | &lt;0.34     | DISTANCE |
| o3a_align_TanimotoDist    | &lt;0.58 | &lt;0.55 | &lt;0.51 | &lt;0.46 | &lt;0.36     | DISTANCE |
| crippeno3a_align_TanimotoDist | &lt;0.59 | &lt;0.56 | &lt;0.51 | &lt;0.47 | &lt;0.37     | DISTANCE |
****   ChEMBL Set ****
| baseline_ShapeTanimoto    | &gt;0.44 | &gt;0.48 | &gt;0.54 | &gt;0.59 | &gt;0.69     | SIMILARITY |
| shape_align_ShapeTanimoto | &gt;0.58 | &gt;0.61 | &gt;0.65 | &gt;0.69 | &gt;0.76     | SIMILARITY |
| baseline_TanimotoDist | &lt;0.64 | &lt;0.61 | &lt;0.57 | &lt;0.54 | &lt;0.47     | DISTANCE |
| shape_align_TanimotoDist  | &lt;0.55 | &lt;0.53 | &lt;0.50 | &lt;0.47 | &lt;0.42     | DISTANCE |
| shape_align_noc_TanimotoDist  | &lt;0.55 | &lt;0.53 | &lt;0.50 | &lt;0.47 | &lt;0.41     | DISTANCE |
| o3a_align_TanimotoDist    | &lt;0.61 | &lt;0.59 | &lt;0.55 | &lt;0.52 | &lt;0.46     | DISTANCE |
| crippeno3a_align_TanimotoDist | &lt;0.61 | &lt;0.59 | &lt;0.55 | &lt;0.52 | &lt;0.46     | DISTANCE |



 ------------------   No alignment  --------------------
****   LOBSTER Set ****
| USR_score | &gt;0.66 | &gt;0.71 | &gt;0.76 | &gt;0.80 | &gt;0.87     | SIMILARITY |
| noh_USR_score | &gt;0.66 | &gt;0.71 | &gt;0.76 | &gt;0.80 | &gt;0.86     | SIMILARITY |
| AP3D_DiceSimilarity   | &gt;0.49 | &gt;0.54 | &gt;0.60 | &gt;0.63 | &gt;0.70     | SIMILARITY |
| noh_AP3D_DiceSimilarity   | &gt;0.29 | &gt;0.33 | &gt;0.38 | &gt;0.43 | &gt;0.51     | SIMILARITY |
| E3FP_DiceSimilarity   | &gt;0.28 | &gt;0.31 | &gt;0.34 | &gt;0.37 | &gt;0.43     | SIMILARITY |
| noh_E3FP_DiceSimilarity   | &gt;0.23 | &gt;0.26 | &gt;0.29 | &gt;0.32 | &gt;0.38     | SIMILARITY |
****   ChEMBL Set ****
| USR_score | &gt;0.65 | &gt;0.69 | &gt;0.74 | &gt;0.78 | &gt;0.84     | SIMILARITY |
| noh_USR_score | &gt;0.65 | &gt;0.69 | &gt;0.74 | &gt;0.78 | &gt;0.84     | SIMILARITY |
| AP3D_DiceSimilarity   | &gt;0.57 | &gt;0.60 | &gt;0.65 | &gt;0.68 | &gt;0.73     | SIMILARITY |
| noh_AP3D_DiceSimilarity   | &gt;0.34 | &gt;0.37 | &gt;0.42 | &gt;0.45 | &gt;0.51     | SIMILARITY |
| E3FP_DiceSimilarity   | &gt;0.30 | &gt;0.33 | &gt;0.35 | &gt;0.38 | &gt;0.42     | SIMILARITY |
| noh_E3FP_DiceSimilarity   | &gt;0.26 | &gt;0.28 | &gt;0.30 | &gt;0.32 | &gt;0.36     | SIMILARITY |</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/greglandrum\.github\.io\/rdkit-blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="greglandrum/rdkit-blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright (C) 2025 Greg Landrum</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><a href="https://www.rdkit.org"><img src="https://www.rdkit.org/logo.small.png" class="img-fluid" alt="RDKit" width="64"></a></p>
</div>
  </div>
</footer>




</body></html>