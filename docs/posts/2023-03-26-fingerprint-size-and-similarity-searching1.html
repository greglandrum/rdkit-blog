<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-03-26">
<meta name="description" content="Are very short fingerprints useful for doing similarity searches?">

<title>RDKit blog - Doing similarity searches with highly folded fingerprints</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../posts/icons/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script defer="" async="" data-host="greglandrum.github.io" src="https://liteanalytics.com/lite.js"></script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">RDKit blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">RDKit experiments, tips, and tutorials</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rdkit/rdkit"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/rdkit_org"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#impact-of-fingerprint-size-on-computed-similarity" id="toc-impact-of-fingerprint-size-on-computed-similarity" class="nav-link active" data-scroll-target="#impact-of-fingerprint-size-on-computed-similarity">Impact of fingerprint size on computed similarity</a></li>
  <li><a href="#impact-on-similarity-searching" id="toc-impact-on-similarity-searching" class="nav-link" data-scroll-target="#impact-on-similarity-searching">Impact on similarity searching</a>
  <ul class="collapse">
  <li><a href="#comparing-the-the-number-of-neighbors-retrieved" id="toc-comparing-the-the-number-of-neighbors-retrieved" class="nav-link" data-scroll-target="#comparing-the-the-number-of-neighbors-retrieved">Comparing the the number of neighbors retrieved</a></li>
  <li><a href="#how-many-hits-do-we-miss" id="toc-how-many-hits-do-we-miss" class="nav-link" data-scroll-target="#how-many-hits-do-we-miss">How many hits do we miss?</a></li>
  <li><a href="#efficiency-look-at-the-number-of-extra-hits" id="toc-efficiency-look-at-the-number-of-extra-hits" class="nav-link" data-scroll-target="#efficiency-look-at-the-number-of-extra-hits">Efficiency, look at the number of extra hits</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Doing similarity searches with highly folded fingerprints</h1>
  <div class="quarto-categories">
    <div class="quarto-category">reference</div>
    <div class="quarto-category">fingerprints</div>
  </div>
  </div>

<div>
  <div class="description">
    Are very short fingerprints useful for doing similarity searches?
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 26, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p><strong>Note</strong> this is a revised version of an <a href="https://rdkit.blogspot.com/2020/08/doing-similarity-searches-with-highly.html">earlier post</a></p>
<p>This one has been on the back burner for quite a while. When Pat Lorton was working on the initial version of <a href="https://github.com/schrodinger/gpusimilarity">gpusimilarity</a> and his presentation for the <a href="https://github.com/schrodinger/gpusimilarity/blob/master/gpusimilarity_rdkit_presentation.pdf">2018 RDKit UGM</a> he dealt with the limited amount of memory available on GPUs by loading highly folded fingerprints into the GPU, retrieving extra compounds for a TopN query, and then rescoring those compounds using full-sized fingerprints. I wanted to go back and look at the same problem again from the perspective of a threshold similarity query - i.e.&nbsp;“give me all of the results that have a similarity above my threshold” - instead of the TopN query - i.e.&nbsp;“give me the N nearest neighbors in the database” - Pat was looking at.</p>
<p>This blog post starts that. I’m going to take a more general approach and look at the impact of fingerprint size on search results and performance at various threshold levels. I’m not going to actually use gpusimilarity in this particular post, but hopefully I will get to that in the future.</p>
<p>The previous post included performance data for using the different fingerprint sizes do do similarity searches in the RDKit PostgreSQL cartridge and with <a href="https://github.com/chembl/FPSim2">FPSim2</a>. I’ve not reproduced that here, but I plan to pick that up in a followup post.</p>
<p>The TL;DR summary: When working with the RDKit’s Morgan2 fingerprint (MFP2), I think it’s reasonable to fold the fingerprints down to 128 bits, particularly when using higher similarity thresholds. This balances the number of hits missed against the number of extra hits retrieved and can result in significant performance improvements when using a specialized search tool like <a href="https://github.com/chembl/FPSim2">FPSim2</a>. The smaller fingerprints - 128 bit fingerprints are 1/16th the size of 2048 bit fingerprints - are faster to read from storage and allow us to fit considerably more fingerprints in the same amount of memory, which is particularly helpful with GPUs.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-26T13:51:58.966755Z&quot;,&quot;start_time&quot;:&quot;2023-03-26T13:51:58.921656Z&quot;}" data-execution_count="102">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> Chem</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdMolDescriptors</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdFingerprintGenerator</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem.Draw <span class="im">import</span> IPythonConsole</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> Draw</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> RDLogger</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> rdBase</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> DataStructs</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gzip</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rdBase.rdkitVersion)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(time.asctime())</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pylab inline</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'tableau-colorblind10'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2022.09.5
Sun Mar 26 15:51:58 2023
%pylab is deprecated, use %matplotlib inline and import the required libraries.
Populating the interactive namespace from numpy and matplotlib</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/glandrum/miniconda3/envs/rdkit_blog/lib/python3.10/site-packages/IPython/core/magics/pylab.py:162: UserWarning: pylab import has clobbered these variables: ['random', 'inf', 'indices']
`%matplotlib` prevents importing * from pylab and numpy
  warn("pylab import has clobbered these variables: %s"  % clobbered +</code></pre>
</div>
</div>
<section id="impact-of-fingerprint-size-on-computed-similarity" class="level1">
<h1>Impact of fingerprint size on computed similarity</h1>
<p>Start by looking at the impact of increased fingerprint folding - decreasing fingerprint size - on similarity values.</p>
<p>For this I use the <a href="https://rdkit.blogspot.com/2016/04/revisiting-similarity-comparison-set.html">similarity comparison set</a> that I put together a few years ago and recently <a href="https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Building%20a%20Similarity%20Comparison%20Set%20Revisited-2023.ipynb">updated again</a> to ChEMBL30 (no post for that one, just a notebook). I’m more interested in the impact on molecules that have a reasonable similiarty to each other, so I’m using the set of pairs that have Tanimoto similarity of at least 0.6 with the Morgan1 fingerprint.</p>
<p>Generate the similarity values for multiple bit counts:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T05:18:11.264726Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:17:57.260483Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>rows<span class="op">=</span>[]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> gzip.<span class="bu">open</span>(<span class="st">'../data/chembl30_50K.mfp1.pairs.txt.gz'</span>).readlines():</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> row.split(<span class="st">b'</span><span class="ch">\t</span><span class="st">'</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    row[<span class="dv">1</span>] <span class="op">=</span> Chem.MolFromSmiles(row[<span class="dv">1</span>])</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    row[<span class="dv">3</span>] <span class="op">=</span> Chem.MolFromSmiles(row[<span class="dv">3</span>])</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    rows.append(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T05:18:51.707145Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:18:11.266207Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>sims <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>fpg <span class="op">=</span> rdFingerprintGenerator.GetMorganGenerator(radius<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>fpgs <span class="op">=</span> {}</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bitsize <span class="kw">in</span> (<span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">256</span>, <span class="dv">512</span>,<span class="dv">1024</span>,<span class="dv">2048</span>,<span class="dv">4096</span>):</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    fpgs[bitsize]  <span class="op">=</span> rdFingerprintGenerator.GetMorganGenerator(radius<span class="op">=</span><span class="dv">2</span>,fpSize<span class="op">=</span>bitsize)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,row <span class="kw">in</span> <span class="bu">enumerate</span>(rows):</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> row[<span class="dv">1</span>]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> row[<span class="dv">3</span>]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    fp1 <span class="op">=</span> fpg.GetSparseCountFingerprint(m1)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    fp2 <span class="op">=</span> fpg.GetSparseCountFingerprint(m2)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    sims[<span class="op">-</span><span class="dv">1</span>].append(DataStructs.TanimotoSimilarity(fp1,fp2))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bitsize <span class="kw">in</span> (<span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">256</span>, <span class="dv">512</span>,<span class="dv">1024</span>,<span class="dv">2048</span>,<span class="dv">4096</span>):</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        fp1 <span class="op">=</span> fpgs[bitsize].GetFingerprint(m1)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        fp2 <span class="op">=</span> fpgs[bitsize].GetFingerprint(m2)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        sims[bitsize].append(DataStructs.TanimotoSimilarity(fp1,fp2))</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> (i<span class="op">+</span><span class="dv">1</span>)<span class="op">%</span><span class="dv">5000</span>: <span class="bu">print</span>(<span class="st">"Done:"</span>,i<span class="op">+</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done: 5000
Done: 10000
Done: 15000
Done: 20000
Done: 25000
Done: 30000
Done: 35000
Done: 40000
Done: 45000
Done: 50000</code></pre>
</div>
</div>
<p>And then plot histograms to show how much the similarity changes relatively to the 4096 bit fingerprint for the different bit counts.</p>
<p>Positive values indicate that the folded fingerprint yields a higher similarity</p>
<p>I include the histogram twice: once with a linear y axis and once with a log y axis so that the behavior at the edges is more visible.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T05:18:53.212684Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:18:51.708394Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>figsize(<span class="dv">12</span>,<span class="dv">12</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>bcounts <span class="op">=</span> (<span class="dv">2048</span>,<span class="dv">1024</span>,<span class="dv">512</span>,<span class="dv">256</span>,<span class="dv">128</span>,<span class="dv">64</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>diffs <span class="op">=</span> []</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bcount <span class="kw">in</span> bcounts:</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    diffs.append(np.array(sims[bcount])<span class="op">-</span>np.array(sims[<span class="dv">4096</span>]))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>hist(diffs,label<span class="op">=</span>[<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> bcounts],bins<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>legend()<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>title(<span class="st">'delta similarity'</span>)<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>subplot(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>hist(diffs,label<span class="op">=</span>[<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> bcounts],bins<span class="op">=</span><span class="dv">20</span>,log<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>legend()<span class="op">;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>title(<span class="st">'MFP2: delta similarity'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-03-26-fingerprint-size-and-similarity-searching1_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Clear (and generally unsurprising) conclusion from this: folding the fingerprints tends to increase computed similarity values. Going all the way down to 64bits does so dramatically.</p>
<p>It’s also worth looking at how much the folding changes the ranking of similarities. This is where I may get into trouble with people who are better at stats than I am, but I think the right metric for this is <a href="https://en.wikipedia.org/wiki/Spearman%27s_rank_correlation_coefficient">Spearman’s rank correlation coefficient</a>:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T05:18:55.455172Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:18:53.214543Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>bcounts <span class="op">=</span> (<span class="dv">2048</span>,<span class="dv">1024</span>,<span class="dv">512</span>,<span class="dv">256</span>,<span class="dv">128</span>,<span class="dv">64</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bcount <span class="kw">in</span> bcounts:</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    r,p <span class="op">=</span> stats.spearmanr(sims[bcount],sims[<span class="dv">4096</span>])</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>bcount<span class="sc">}</span><span class="ss"> bits: r=</span><span class="sc">{</span>r<span class="sc">:.3f}</span><span class="ss"> p=</span><span class="sc">{</span>p<span class="sc">:.3g}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2048 bits: r=0.997 p=0
1024 bits: r=0.992 p=0
512 bits: r=0.982 p=0
256 bits: r=0.957 p=0
128 bits: r=0.900 p=0
64 bits: r=0.775 p=0</code></pre>
</div>
</div>
<p>It’s nice to see how high these are, particularly 128 bits. Even the super-short 64 bit fingerprints maintain the ranking of these pairs reasonably well.</p>
<p>In the <a href="http://rdkit.blogspot.com/2020/08/doing-similarity-searches-with-highly.html">original version</a> of this post I showed that their higher bit density causes the performance of the RDKit fingerprint degrades much more quickly as the fingerprints get short. I won’t revisit that here.</p>
</section>
<section id="impact-on-similarity-searching" class="level1">
<h1>Impact on similarity searching</h1>
<p>Let’s move on to looking at the impact shorter fingerprints have on similarity searching, specifically the number of results retrieved for queries using different similarity cutoffs.</p>
<p>Our test database for this is the SDF from ChEMBL32. I downloaded this directly from the <a href="ftp://ftp.ebi.ac.uk/pub/databases/chembl/ChEMBLdb/latest/">ChEMBL website</a>. It’s also possible to do this automatically using Charles Hoyt’s <a href="https://github.com/cthoyt/chembl-downloader">ChEMBL Downloader</a></p>
<p>Read in that SDF and generate MFP2 fingerprints:</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T05:33:11.004200Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:20:45.287274Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle, time, gzip</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>gz <span class="op">=</span> gzip.GzipFile(<span class="st">'/home/glandrum/Downloads/chembl_32.sdf.gz'</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>suppl <span class="op">=</span> Chem.ForwardSDMolSupplier(gz)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>RDLogger.DisableLog(<span class="st">"rdApp.warning"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>t1<span class="op">=</span>time.time()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> []</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>fpg <span class="op">=</span> rdFingerprintGenerator.GetMorganGenerator(radius<span class="op">=</span><span class="dv">2</span>,fpSize<span class="op">=</span><span class="dv">4096</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,mol <span class="kw">in</span> <span class="bu">enumerate</span>(suppl):</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> ((i<span class="op">+</span><span class="dv">1</span>)<span class="op">%</span><span class="dv">50000</span>):</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processed </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> molecules in </span><span class="sc">{</span>(time.time()<span class="op">-</span>t1)<span class="sc">:.1f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mol <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> mol.GetNumAtoms()<span class="op">&gt;</span><span class="dv">70</span>:</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    fp <span class="op">=</span> fpg.GetFingerprint(mol)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    smi <span class="op">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    data.append((mol.GetProp(<span class="st">'chembl_id'</span>),smi,fp))</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>t2<span class="op">=</span>time.time()</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Processed </span><span class="sc">{</span><span class="bu">len</span>(data)<span class="sc">}</span><span class="ss"> molecules in </span><span class="sc">{</span>(t2<span class="op">-</span>t1)<span class="sc">:.1f}</span><span class="ss"> seconds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed 50000 molecules in 15.4 seconds
Processed 100000 molecules in 30.2 seconds
Processed 150000 molecules in 45.4 seconds
Processed 200000 molecules in 61.3 seconds
Processed 250000 molecules in 77.9 seconds
Processed 300000 molecules in 94.4 seconds
Processed 350000 molecules in 111.1 seconds
Processed 400000 molecules in 127.6 seconds
Processed 450000 molecules in 144.6 seconds
Processed 500000 molecules in 160.6 seconds
Processed 550000 molecules in 177.5 seconds
Processed 600000 molecules in 193.7 seconds
Processed 650000 molecules in 209.7 seconds
Processed 700000 molecules in 226.4 seconds
Processed 750000 molecules in 243.5 seconds
Processed 800000 molecules in 261.0 seconds
Processed 850000 molecules in 276.3 seconds
Processed 900000 molecules in 293.0 seconds
Processed 950000 molecules in 311.2 seconds
Processed 1000000 molecules in 325.8 seconds
Processed 1050000 molecules in 339.6 seconds
Processed 1100000 molecules in 353.7 seconds
Processed 1150000 molecules in 367.4 seconds
Processed 1200000 molecules in 382.3 seconds
Processed 1250000 molecules in 396.1 seconds
Processed 1300000 molecules in 410.0 seconds
Processed 1350000 molecules in 423.9 seconds
Processed 1400000 molecules in 438.6 seconds
Processed 1450000 molecules in 453.9 seconds
Processed 1500000 molecules in 469.3 seconds
Processed 1550000 molecules in 485.5 seconds
Processed 1600000 molecules in 501.5 seconds
Processed 1650000 molecules in 518.8 seconds
Processed 1700000 molecules in 537.4 seconds
Processed 1750000 molecules in 554.3 seconds
Processed 1800000 molecules in 571.1 seconds
Processed 1850000 molecules in 585.9 seconds
Processed 1900000 molecules in 601.6 seconds
Processed 1950000 molecules in 613.9 seconds
Processed 2000000 molecules in 629.9 seconds
Processed 2050000 molecules in 646.7 seconds
Processed 2100000 molecules in 663.5 seconds
Processed 2150000 molecules in 681.1 seconds
Processed 2200000 molecules in 699.0 seconds
Processed 2250000 molecules in 717.0 seconds
Processed 2300000 molecules in 734.8 seconds
Processed 2282078 molecules in 745.7 seconds</code></pre>
</div>
</div>
<p>Save those to disk so that we don’t have to do that work again</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T05:33:32.469673Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:33:11.010909Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'../data/chembl32_fps.pkl'</span>,<span class="st">'wb+'</span>) <span class="im">as</span> outf:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    pickle.dump(data,outf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T05:33:44.555006Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:33:32.470873Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'../data/chembl32_fps.pkl'</span>,<span class="st">'rb'</span>) <span class="im">as</span> inf:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pickle.load(inf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our queries are the set of “very active” compounds (compounds with subnanomolar measured Ki values) I <a href="https://rdkit.blogspot.com/2020/05/binary-molecules-and-cartridge.html">previously collected</a> from ChEMBL26.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T05:35:07.705752Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:34:50.334909Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>gz <span class="op">=</span> gzip.GzipFile(<span class="st">'../data/chembl26_very_active.sdf.gz'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>suppl <span class="op">=</span> Chem.ForwardSDMolSupplier(gz)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>t1<span class="op">=</span>time.time()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>queries <span class="op">=</span> []</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,mol <span class="kw">in</span> <span class="bu">enumerate</span>(suppl):</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> ((i<span class="op">+</span><span class="dv">1</span>)<span class="op">%</span><span class="dv">50000</span>):</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processed </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> molecules in </span><span class="sc">{</span>(time.time()<span class="op">-</span>t1)<span class="sc">:.1f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mol <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> mol.GetNumAtoms()<span class="op">&gt;</span><span class="dv">70</span>:</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    fp <span class="op">=</span> fpg.GetFingerprint(mol)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    smi <span class="op">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    queries.append((mol.GetProp(<span class="st">'compound_chembl_id'</span>),smi,fp))</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>t2<span class="op">=</span>time.time()</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Processed </span><span class="sc">{</span><span class="bu">len</span>(queries)<span class="sc">}</span><span class="ss"> molecules in </span><span class="sc">{</span>(t2<span class="op">-</span>t1)<span class="sc">:.1f}</span><span class="ss"> seconds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed 34348 molecules in 17.4 seconds</code></pre>
</div>
</div>
<p>Now collect the data. We’ll use 1000 randomly selected queries against the first million ChEMBL compounds.</p>
<p>We try a variety of different fingerprint sizes along with different similarity thresholds. For each threshold/size combination we keep track of the number of neighbors found for each query as well as the number of missing neighbors (neighbors found at that threshold with a 4096 bit fingerprint that were not found with the folded fingerprint).</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T05:35:12.996223Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:35:12.983134Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="bn">0xf00d</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>random.shuffle(queries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T06:43:45.818105Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T05:37:18.759041Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dsize <span class="op">=</span> <span class="dv">1000000</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>nQueries <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fold_fp(fp,sz):</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> DataStructs.FoldFingerprint(fp,fp.GetNumBits()<span class="op">//</span>sz)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>thresholds <span class="op">=</span> [<span class="fl">0.4</span>, <span class="fl">0.5</span>,<span class="fl">0.6</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>,<span class="fl">0.9</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>sizes <span class="op">=</span> [<span class="dv">64</span>,<span class="dv">128</span>,<span class="dv">256</span>,<span class="dv">512</span>,<span class="dv">1024</span>,<span class="dv">2048</span>]</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> defaultdict(<span class="kw">lambda</span>:defaultdict(<span class="bu">list</span>))</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>missed <span class="op">=</span> defaultdict(<span class="kw">lambda</span>:defaultdict(<span class="bu">list</span>))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>dbfps <span class="op">=</span> [x[<span class="op">-</span><span class="dv">1</span>] <span class="cf">for</span> x <span class="kw">in</span> data[:dsize]]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sz <span class="kw">in</span> sizes:</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Doing fp len </span><span class="sc">{</span>sz<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    tfps <span class="op">=</span> []</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'</span><span class="ch">\t</span><span class="st"> folding'</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cid,smi,fp <span class="kw">in</span> data[:dsize]:</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        tfps.append(fold_fp(fp,sz))</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'</span><span class="ch">\t</span><span class="st"> running queries'</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> qcid,qsmi,qfp <span class="kw">in</span> queries[:nQueries]:</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        nqfp <span class="op">=</span> fold_fp(qfp,sz)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        sims <span class="op">=</span> DataStructs.BulkTanimotoSimilarity(nqfp,tfps)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        osims <span class="op">=</span> DataStructs.BulkTanimotoSimilarity(qfp,dbfps)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> thresh <span class="kw">in</span> thresholds:</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>            oindices <span class="op">=</span> <span class="bu">set</span>(i <span class="cf">for</span> (i,x) <span class="kw">in</span> <span class="bu">enumerate</span>(osims) <span class="cf">if</span> x<span class="op">&gt;=</span>thresh)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> sz<span class="op">==</span>sizes[<span class="dv">0</span>]:</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>                results[<span class="dv">4096</span>][thresh].append(<span class="bu">len</span>(oindices))</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>            indices <span class="op">=</span> <span class="bu">set</span>(i <span class="cf">for</span> (i,x) <span class="kw">in</span> <span class="bu">enumerate</span>(sims) <span class="cf">if</span> x<span class="op">&gt;=</span>thresh)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>            cnt <span class="op">=</span> <span class="bu">len</span>(indices)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>            results[sz][thresh].append(cnt)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            missed[sz][thresh].append(<span class="bu">len</span>(oindices.difference(indices)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Doing fp len 64
     folding
     running queries
Doing fp len 128
     folding
     running queries
Doing fp len 256
     folding
     running queries
Doing fp len 512
     folding
     running queries
Doing fp len 1024
     folding
     running queries
Doing fp len 2048
     folding
     running queries</code></pre>
</div>
</div>
<p>that took a while to run, so save the results</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-24T06:49:30.996659Z&quot;,&quot;start_time&quot;:&quot;2023-03-24T06:49:30.677099Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dres <span class="op">=</span> {}</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> results:</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    dres[k] <span class="op">=</span> <span class="bu">dict</span>(results[k])</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>dmissed <span class="op">=</span> {}</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> missed:</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    dmissed[k] <span class="op">=</span> <span class="bu">dict</span>(missed[k])</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'../data/size_and_neighbors_results.mfp2.pkl'</span>,<span class="st">'wb+'</span>) <span class="im">as</span> outf:</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    pickle.dump((dres,dmissed),outf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'../data/size_and_neighbors_results.mfp2.pkl'</span>,<span class="st">'rb'</span>) <span class="im">as</span> inf:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    results,missed <span class="op">=</span> pickle.load(inf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="comparing-the-the-number-of-neighbors-retrieved" class="level2">
<h2 class="anchored" data-anchor-id="comparing-the-the-number-of-neighbors-retrieved">Comparing the the number of neighbors retrieved</h2>
<p>To get a sense of what the data look like, pick a couple of threshold values and do a direct comparison of the number of neighbors found at the other bit counts with the number found at 4096 bits.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-26T13:56:12.161818Z&quot;,&quot;start_time&quot;:&quot;2023-03-26T13:56:09.962672Z&quot;}" data-execution_count="104">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>sthreshs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">sorted</span>(thresholds))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>sthreshs.reverse()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>nCols <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>nRows <span class="op">=</span> <span class="bu">len</span>(sthreshs)<span class="op">//</span>nCols</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(sthreshs)<span class="op">%</span>nCols: </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    nRows<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>figsize(<span class="dv">8</span><span class="op">*</span>nCols,<span class="dv">6</span><span class="op">*</span>nRows)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>bcounts <span class="op">=</span> (<span class="dv">2048</span>,<span class="dv">1024</span>,<span class="dv">512</span>,<span class="dv">256</span>,<span class="dv">128</span>,<span class="dv">64</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,thresh <span class="kw">in</span> <span class="bu">enumerate</span>(sthreshs):</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    subplot(nRows,nCols,i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    hist([results[x][thresh] <span class="cf">for</span> x <span class="kw">in</span> bcounts],log<span class="op">=</span><span class="st">'true'</span>, label<span class="op">=</span>[<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> bcounts])<span class="op">;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    legend()<span class="op">;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    title(<span class="ss">f'number of neighbors, thresh=</span><span class="sc">{</span>thresh<span class="sc">:.1f}</span><span class="ss">'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-03-26-fingerprint-size-and-similarity-searching1_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Since that is dominated by the 64 bit results, stop showing them.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-26T14:07:20.975450Z&quot;,&quot;start_time&quot;:&quot;2023-03-26T14:07:18.947362Z&quot;}" data-execution_count="110">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>sthreshs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">sorted</span>(thresholds))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>sthreshs.reverse()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>nCols <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>nRows <span class="op">=</span> <span class="bu">len</span>(sthreshs)<span class="op">//</span>nCols</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(sthreshs)<span class="op">%</span>nCols: </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    nRows<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>figsize(<span class="dv">8</span><span class="op">*</span>nCols,<span class="dv">6</span><span class="op">*</span>nRows)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>bcounts <span class="op">=</span> (<span class="dv">2048</span>,<span class="dv">1024</span>,<span class="dv">512</span>,<span class="dv">256</span>,<span class="dv">128</span>,)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,thresh <span class="kw">in</span> <span class="bu">enumerate</span>(sthreshs):</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    subplot(nRows,nCols,i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    hist([results[x][thresh] <span class="cf">for</span> x <span class="kw">in</span> bcounts],log<span class="op">=</span><span class="st">'true'</span>, label<span class="op">=</span>[<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> bcounts])<span class="op">;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    legend()<span class="op">;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    title(<span class="ss">f'number of neighbors, thresh=</span><span class="sc">{</span>thresh<span class="sc">:.1f}</span><span class="ss">'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-03-26-fingerprint-size-and-similarity-searching1_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can see here that the more folded fingerprints tend to yield more neighors at a given threshold. This makes sense given what we saw above, which is that similarity values tend to be higher as fingerprints are folded.</p>
<p>It’s also clear, though not super surprising, that the 64 bit fingerprint isn’t going to be useful with low similarity thresholds: we just get way too many extra hits.</p>
</section>
<section id="how-many-hits-do-we-miss" class="level2">
<h2 class="anchored" data-anchor-id="how-many-hits-do-we-miss">How many hits do we miss?</h2>
<p>This does not show the overwhelming number of examples where no hits are missed.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-26T13:59:52.682574Z&quot;,&quot;start_time&quot;:&quot;2023-03-26T13:59:50.710074Z&quot;}" data-execution_count="107">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sthreshs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">sorted</span>(thresholds))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>sthreshs.reverse()</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>nCols <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>nRows <span class="op">=</span> <span class="bu">len</span>(sthreshs)<span class="op">//</span>nCols</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(sthreshs)<span class="op">%</span>nCols: </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    nRows<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>figsize(<span class="dv">8</span><span class="op">*</span>nCols,<span class="dv">6</span><span class="op">*</span>nRows)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>bcounts <span class="op">=</span> (<span class="dv">2048</span>,<span class="dv">1024</span>,<span class="dv">512</span>,<span class="dv">256</span>,<span class="dv">128</span>,<span class="dv">64</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,thresh <span class="kw">in</span> <span class="bu">enumerate</span>(sthreshs):</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    subplot(nRows,nCols,i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    hist([[y <span class="cf">for</span> y <span class="kw">in</span> missed[x][thresh] <span class="cf">if</span> y<span class="op">&gt;</span><span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> bcounts],log<span class="op">=</span><span class="st">'true'</span>, label<span class="op">=</span>[<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> bcounts])<span class="op">;</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    legend()<span class="op">;</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    title(<span class="ss">f'number of neighbors missed, thresh=</span><span class="sc">{</span>thresh<span class="sc">:.1f}</span><span class="ss">'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-03-26-fingerprint-size-and-similarity-searching1_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="efficiency-look-at-the-number-of-extra-hits" class="level2">
<h2 class="anchored" data-anchor-id="efficiency-look-at-the-number-of-extra-hits">Efficiency, look at the number of extra hits</h2>
<p>We don’t bother including 64 bits in here since it’s clear that from the above that too many results are returned.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-03-26T14:11:18.899826Z&quot;,&quot;start_time&quot;:&quot;2023-03-26T14:11:16.861466Z&quot;}" data-execution_count="114">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>sthreshs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">sorted</span>(thresholds))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>sthreshs.reverse()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>nCols <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>nRows <span class="op">=</span> <span class="bu">len</span>(sthreshs)<span class="op">//</span>nCols</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(sthreshs)<span class="op">%</span>nCols: </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    nRows<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>figsize(<span class="dv">8</span><span class="op">*</span>nCols,<span class="dv">6</span><span class="op">*</span>nRows)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>bcounts <span class="op">=</span> (<span class="dv">2048</span>,<span class="dv">1024</span>,<span class="dv">512</span>,<span class="dv">256</span>,<span class="dv">128</span>,)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,thresh <span class="kw">in</span> <span class="bu">enumerate</span>(sthreshs):</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    subplot(nRows,nCols,i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    hist([[y<span class="op">-</span>results[<span class="dv">4096</span>][thresh][i] <span class="cf">for</span> i,y <span class="kw">in</span> <span class="bu">enumerate</span>(results[x][thresh])] <span class="cf">for</span> x <span class="kw">in</span> bcounts],log<span class="op">=</span><span class="st">'true'</span>, </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span>[<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> bcounts])<span class="op">;</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    legend()<span class="op">;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    title(<span class="ss">f'number of extra hits, thresh=</span><span class="sc">{</span>thresh<span class="sc">:.1f}</span><span class="ss">'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-03-26-fingerprint-size-and-similarity-searching1_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>There are a small number of instances at higher thresholds where we don’t find all the hits, we saw this above.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="greglandrum/rdkit-blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright (C) 2024 Greg Landrum</div>   
    <div class="nav-footer-right"><a href="https://www.rdkit.org"><img src="https://www.rdkit.org/logo.small.png" class="img-fluid" alt="RDKit" width="64"></a></div>
  </div>
</footer>



</body></html>