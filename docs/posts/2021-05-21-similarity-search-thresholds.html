<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2021-05-21">
<meta name="description" content="FOMO and similarity search">

<title>Fingerprint similarity thresholds for database searches – RDKit blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../posts/icons/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-d166b450ba5a8e9f7a0ab969bf6592c1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-a1fb93aa6af6e5138998f4139e0aef3d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-98e8d043add42333c0993713f12a6dca.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">RDKit blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">RDKit experiments, tips, and tutorials</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rdkit/rdkit"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://bsky.app/profile/rdkit.bsky.social"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/groups/8192558/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prologue" id="toc-prologue" class="nav-link active" data-scroll-target="#prologue">Prologue</a></li>
  <li><a href="#intro-results" id="toc-intro-results" class="nav-link" data-scroll-target="#intro-results">Intro / Results</a></li>
  <li><a href="#method" id="toc-method" class="nav-link" data-scroll-target="#method">Method</a>
  <ul class="collapse">
  <li><a href="#similarity-between-random-molecules" id="toc-similarity-between-random-molecules" class="nav-link" data-scroll-target="#similarity-between-random-molecules">Similarity between random molecules</a></li>
  <li><a href="#groups-of-related-compounds" id="toc-groups-of-related-compounds" class="nav-link" data-scroll-target="#groups-of-related-compounds">Groups of related compounds</a></li>
  <li><a href="#determining-background-retrieval-rates" id="toc-determining-background-retrieval-rates" class="nav-link" data-scroll-target="#determining-background-retrieval-rates">Determining background retrieval rates</a></li>
  <li><a href="#summarizing-the-data" id="toc-summarizing-the-data" class="nav-link" data-scroll-target="#summarizing-the-data">Summarizing the data</a></li>
  <li><a href="#the-notebooks" id="toc-the-notebooks" class="nav-link" data-scroll-target="#the-notebooks">The notebooks</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Fingerprint similarity thresholds for database searches</h1>
  <div class="quarto-categories">
    <div class="quarto-category">similarity</div>
    <div class="quarto-category">reference</div>
  </div>
  </div>

<div>
  <div class="description">
    FOMO and similarity search
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 21, 2021</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><strong>Updated 08.06.2021</strong> after I expanded the set of “related compounds”. The source of the previous version of the post is available <a href="https://github.com/greglandrum/rdkit-blog/blob/c5eb92294c45e7fe77b6c5658d1de5388090d7f1/_posts/2021-05-21-similarity-search-thresholds.md">in github</a></p>
<section id="prologue" class="level1">
<h1>Prologue</h1>
<p>If you’re interested in this topic and have questions, notice mistakes in my analysis, or have suggestions or ideas for improving this (particularly when it comes to the sets of “related compounds” I use), please either send me email or leave a comment.</p>
</section>
<section id="intro-results" class="level1">
<h1>Intro / Results</h1>
<p>One of the RDKit blog posts I refer back to the most is the one where I tried to establish the Tanimoto similarity value which constitutes a “noise level” for each of the fingerprints the RDKit supports by looking at the distributions of similarities between randomly chosen molecules. I periodically update the post just in case the threshold values change with RDKit versions. Here’s <a href="https://greglandrum.github.io/rdkit-blog/fingerprints/similarity/reference/2021/05/18/fingerprint-thresholds1.html">the most recent version of the post</a> and the <a href="https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Fingerprint%20Thresholds.ipynb">associated jupyter notebook</a>. I find it really useful to be able to say things like “The 95% noise level for Tanimoto similarity calculated with the the bit-based version of the RDKit’s MFP2 is 0.27.” Based on this I know that when doing similarity searches the threshold for MFP2 shouldn’t be set below 0.27 (I normally say 0.3) in most cases. But that analysis doesn’t tell me what I should set the threshold to.</p>
<p>Of course the answer to that question is “it depends”. Let’s assume that the database you’re searching contains a certain number of compounds which would actually be interesting for you and a much larger number of compounds which are not interesting (at least not for the search you’re currently running). And let’s further assume that the similarities between those interesting compounds and your query is generally above the noise level for the fingerprint you’re using. Any similarity search is going to return a mix of both interesting and non-interesting compounds and the proportions in that mix are generally going to be determined by the similarity threshould you use. Setting the similarity threshold high tends to give a larger proportion of interesting compounds at the cost of missing interesting compounds while a lower threshold will return more of the interesting compounds but a higher fraction of uninteresting compounds.</p>
<p>Basically how bad your FOMO is will determine how many results you need to look through.</p>
<p>This isn’t a big deal if you’re searching a small database and or if you’re going to be post-processing the results using some other computational tool, but if the idea is that you’re going to actually be <em>looking</em> at the results of the similarity search, then result sets with 10K or more rows are going to require a lot of patience.</p>
<p>This post is an attempt to come up with recommendations for reasonable threshold values for the common RDKit fingerprints so that you can make a more informed decision about what to use for a given search.</p>
<p>There’s a more complete description below along with links to the jupyter notebooks with the actual code, but here’s a quick summary of what I did: 1. I started with 1047 groups of related compounds (~66K compounds in all). Each group is a set of 50-100 compounds from a single ChEMBL document. 2. I calculated intra-group similarities within each of those 1047 groups using each of the fingerprint types to determine thresholds for retrieving various fractions of each group. 3. I used a randomly selected subset of 10K of those compounds to do similarity searches on 100K molecules randomly selected from ChEMBL in order to determine what fraction of the database would be retrieved for various similarity thresholds.</p>
Here are what the results look like for bit-based MFP2:
<table>
<tbody><tr>
<th>
</th>
<th>
</th>
<th colspan="2">
0.95 of related compounds
</th>
<th colspan="2">
0.9 of related compounds
</th>
<th colspan="2">
0.8 of related compounds
</th>
<th colspan="2">
0.5 of related compounds
</th>
</tr>
<tr>
<th>
Fingerprint
</th>
<th>
0.95 noise level
</th>
<th>
threshold
</th>
<th>
db fraction / count per million
</th>
<th>
threshold
</th>
<th>
db fraction / count per million
</th>
<th>
threshold
</th>
<th>
db fraction / count per million
</th>
<th>
threshold
</th>
<th>
db fraction / count per million
</th>
</tr>
<tr>
<td>
<b>Morgan2 (bits)</b>
</td>
<td>
0.27
</td>
<td>
0.4
</td>
<td>
0.00019 / 190
</td>
<td>
0.4
</td>
<td>
0.00019 / 190
</td>
<td>
0.45
</td>
<td>
0.00012 / 115
</td>
<td>
0.55
</td>
<td>
2.5e-05 / 25
</td>
</tr>
</tbody></table>
<p>The 0.95 noise level (from the previous analysis) for this FP is 0.27. If I want to retrieve 95% of the related compounds I need to set the similarity threshold to 0.4. With this threshold I would retrieve ~190 compounds per million compounds in the database (0.4% of the database). Similarly, if I were willing to live with finding 50% of the related actives I could set the search threshold to 0.55, in which case I’d only retrieve ~25 rows per million compounds in the database.</p>
<p>I find this is a useful way of thinking about the thresholds: it makes the balance between recall (number of interesting compounds retrieved) and the overall result set size visible. For example, for the MFP2 results shown above, if I’m willing to live with retrieving about 90% of the interesting compounds instead of 95% I would only have to look through about 1/8th of the results from the database.</p>
With that explained, here’s the full results table:
<table>
<tbody><tr>
<th>
</th>
<th>
</th>
<th colspan="2">
0.95 of related compounds
</th>
<th colspan="2">
0.9 of related compounds
</th>
<th colspan="2">
0.8 of related compounds
</th>
<th colspan="2">
0.5 of related compounds
</th>
</tr>
<tr>
<th>
Fingerprint
</th>
<th>
0.95 noise level
</th>
<th>
threshold
</th>
<th>
db fraction / count per million
</th>
<th>
threshold
</th>
<th>
db fraction / count per million
</th>
<th>
threshold
</th>
<th>
db fraction / count per million
</th>
<th>
threshold
</th>
<th>
db fraction / count per million
</th>
</tr>
<tr>
<td>
<b>MACCS</b>
</td>
<td>
0.57
</td>
<td>
0.65
</td>
<td>
0.016 / 15820
</td>
<td>
0.65
</td>
<td>
0.016 / 15820
</td>
<td>
0.7
</td>
<td>
0.0019 / 1880
</td>
<td>
0.8
</td>
<td>
8e-05 / 80
</td>
</tr>
<tr>
<td>
<b>Morgan0 (counts)</b>
</td>
<td>
0.57
</td>
<td>
0.6
</td>
<td>
0.017 / 16990
</td>
<td>
0.6
</td>
<td>
0.017 / 16990
</td>
<td>
0.65
</td>
<td>
0.009 / 9040
</td>
<td>
0.75
</td>
<td>
0.00057 / 565
</td>
</tr>
<tr>
<td>
<b>Morgan1 (counts)</b>
</td>
<td>
0.36
</td>
<td>
0.5
</td>
<td>
0.0003 / 300
</td>
<td>
0.5
</td>
<td>
0.0003 / 300
</td>
<td>
0.55
</td>
<td>
0.00017 / 170
</td>
<td>
0.65
</td>
<td>
2.5e-05 / 25
</td>
</tr>
<tr>
<td>
<b>Morgan2 (counts)</b>
</td>
<td>
0.25
</td>
<td>
0.4
</td>
<td>
0.00014 / 140
</td>
<td>
0.4
</td>
<td>
0.00014 / 140
</td>
<td>
0.45
</td>
<td>
8.5e-05 / 84
</td>
<td>
0.55
</td>
<td>
2e-05 / 20
</td>
</tr>
<tr>
<td>
<b>Morgan3 (counts)</b>
</td>
<td>
0.20
</td>
<td>
0.3
</td>
<td>
0.00026 / 260
</td>
<td>
0.35
</td>
<td>
0.00015 / 154
</td>
<td>
0.35
</td>
<td>
0.00015 / 154
</td>
<td>
0.45
</td>
<td>
3.5e-05 / 35
</td>
</tr>
<tr>
<td>
<b>Morgan0 (bits)</b>
</td>
<td>
0.57
</td>
<td>
0.6
</td>
<td>
0.019 / 18550
</td>
<td>
0.6
</td>
<td>
0.019 / 18550
</td>
<td>
0.65
</td>
<td>
0.0099 / 9880
</td>
<td>
0.75
</td>
<td>
0.00063 / 629
</td>
</tr>
<tr>
<td>
<b>Morgan1 (bits)</b>
</td>
<td>
0.37
</td>
<td>
0.5
</td>
<td>
0.00036 / 360
</td>
<td>
0.5
</td>
<td>
0.00036 / 360
</td>
<td>
0.55
</td>
<td>
0.0002 / 200
</td>
<td>
0.65
</td>
<td>
2.5e-05 / 25
</td>
</tr>
<tr>
<td>
<b>Morgan2 (bits)</b>
</td>
<td>
0.27
</td>
<td>
0.4
</td>
<td>
0.00019 / 190
</td>
<td>
0.4
</td>
<td>
0.00019 / 190
</td>
<td>
0.45
</td>
<td>
0.00012 / 115
</td>
<td>
0.55
</td>
<td>
2.5e-05 / 25
</td>
</tr>
<tr>
<td>
<b>Morgan3 (bits)</b>
</td>
<td>
0.22
</td>
<td>
0.3
</td>
<td>
0.00057 / 570
</td>
<td>
0.35
</td>
<td>
0.00031 / 309
</td>
<td>
0.4
</td>
<td>
5e-05 / 50
</td>
<td>
0.5
</td>
<td>
2e-05 / 20
</td>
</tr>
<tr>
<td>
<b>FeatMorgan0 (counts)</b>
</td>
<td>
0.74
</td>
<td>
0.65
</td>
<td>
0.17 / 165672
</td>
<td>
0.7
</td>
<td>
0.073 / 72975
</td>
<td>
0.7
</td>
<td>
0.073 / 72975
</td>
<td>
0.8
</td>
<td>
0.0086 / 8620
</td>
</tr>
<tr>
<td>
<b>FeatMorgan1 (counts)</b>
</td>
<td>
0.51
</td>
<td>
0.55
</td>
<td>
0.021 / 21000
</td>
<td>
0.6
</td>
<td>
0.0024 / 2360
</td>
<td>
0.65
</td>
<td>
0.0012 / 1235
</td>
<td>
0.7
</td>
<td>
0.00011 / 110
</td>
</tr>
<tr>
<td>
<b>FeatMorgan2 (counts)</b>
</td>
<td>
0.36
</td>
<td>
0.45
</td>
<td>
0.0038 / 3782
</td>
<td>
0.5
</td>
<td>
0.00023 / 230
</td>
<td>
0.55
</td>
<td>
0.00014 / 135
</td>
<td>
0.65
</td>
<td>
2.5e-05 / 25
</td>
</tr>
<tr>
<td>
<b>FeatMorgan3 (counts)</b>
</td>
<td>
0.28
</td>
<td>
0.4
</td>
<td>
0.00022 / 220
</td>
<td>
0.4
</td>
<td>
0.00022 / 220
</td>
<td>
0.45
</td>
<td>
0.00013 / 130
</td>
<td>
0.55
</td>
<td>
3e-05 / 30
</td>
</tr>
<tr>
<td>
<b>FeatMorgan0 (bits)</b>
</td>
<td>
0.74
</td>
<td>
0.65
</td>
<td>
0.17 / 165672
</td>
<td>
0.7
</td>
<td>
0.073 / 72975
</td>
<td>
0.7
</td>
<td>
0.073 / 72975
</td>
<td>
0.8
</td>
<td>
0.0086 / 8620
</td>
</tr>
<tr>
<td>
<b>FeatMorgan1 (bits)</b>
</td>
<td>
0.51
</td>
<td>
0.55
</td>
<td>
0.023 / 22962
</td>
<td>
0.6
</td>
<td>
0.0027 / 2660
</td>
<td>
0.65
</td>
<td>
0.0014 / 1390
</td>
<td>
0.7
</td>
<td>
0.00012 / 120
</td>
</tr>
<tr>
<td>
<b>FeatMorgan2 (bits)</b>
</td>
<td>
0.38
</td>
<td>
0.45
</td>
<td>
0.006 / 6007
</td>
<td>
0.5
</td>
<td>
0.00031 / 310
</td>
<td>
0.55
</td>
<td>
0.00018 / 175
</td>
<td>
0.65
</td>
<td>
2.5e-05 / 25
</td>
</tr>
<tr>
<td>
<b>FeatMorgan3 (bits)</b>
</td>
<td>
0.30
</td>
<td>
0.4
</td>
<td>
0.00037 / 370
</td>
<td>
0.45
</td>
<td>
0.00021 / 210
</td>
<td>
0.45
</td>
<td>
0.00021 / 210
</td>
<td>
0.55
</td>
<td>
3.5e-05 / 35
</td>
</tr>
<tr>
<td>
<b>RDKit 4 (bits)</b>
</td>
<td>
0.33
</td>
<td>
0.5
</td>
<td>
0.00069 / 690
</td>
<td>
0.55
</td>
<td>
0.0004 / 400
</td>
<td>
0.6
</td>
<td>
0.00011 / 110
</td>
<td>
0.7
</td>
<td>
4e-05 / 40
</td>
</tr>
<tr>
<td>
<b>RDKit 5 (bits)</b>
</td>
<td>
0.29
</td>
<td>
0.5
</td>
<td>
0.00025 / 250
</td>
<td>
0.55
</td>
<td>
0.00016 / 155
</td>
<td>
0.6
</td>
<td>
6e-05 / 60
</td>
<td>
0.7
</td>
<td>
3e-05 / 30
</td>
</tr>
<tr>
<td>
<b>RDKit 6 (bits)</b>
</td>
<td>
0.31
</td>
<td>
0.5
</td>
<td>
0.00021 / 210
</td>
<td>
0.55
</td>
<td>
0.00014 / 135
</td>
<td>
0.6
</td>
<td>
6e-05 / 60
</td>
<td>
0.7
</td>
<td>
3e-05 / 30
</td>
</tr>
<tr>
<td>
<b>RDKit 7 (bits)</b>
</td>
<td>
0.43
</td>
<td>
0.55
</td>
<td>
0.00051 / 510
</td>
<td>
0.6
</td>
<td>
8e-05 / 80
</td>
<td>
0.6
</td>
<td>
8e-05 / 80
</td>
<td>
0.7
</td>
<td>
3e-05 / 30
</td>
</tr>
<tr>
<td>
<b>linear RDKit 4 (bits)</b>
</td>
<td>
0.35
</td>
<td>
0.5
</td>
<td>
0.0015 / 1470
</td>
<td>
0.55
</td>
<td>
0.00083 / 830
</td>
<td>
0.6
</td>
<td>
0.00019 / 190
</td>
<td>
0.7
</td>
<td>
5e-05 / 50
</td>
</tr>
<tr>
<td>
<b>linear RDKit 5 (bits)</b>
</td>
<td>
0.31
</td>
<td>
0.5
</td>
<td>
0.00046 / 455
</td>
<td>
0.55
</td>
<td>
0.00027 / 272
</td>
<td>
0.6
</td>
<td>
9e-05 / 90
</td>
<td>
0.7
</td>
<td>
3e-05 / 30
</td>
</tr>
<tr>
<td>
<b>linear RDKit 6 (bits)</b>
</td>
<td>
0.28
</td>
<td>
0.5
</td>
<td>
0.00022 / 220
</td>
<td>
0.5
</td>
<td>
0.00022 / 220
</td>
<td>
0.55
</td>
<td>
0.00014 / 140
</td>
<td>
0.7
</td>
<td>
3e-05 / 30
</td>
</tr>
<tr>
<td>
<b>linear RDKit 7 (bits)</b>
</td>
<td>
0.26
</td>
<td>
0.45
</td>
<td>
0.00053 / 535
</td>
<td>
0.5
</td>
<td>
0.00013 / 130
</td>
<td>
0.55
</td>
<td>
9e-05 / 90
</td>
<td>
0.65
</td>
<td>
3.5e-05 / 35
</td>
</tr>
<tr>
<td>
<b>Atom Pairs (counts)</b>
</td>
<td>
0.27
</td>
<td>
0.35
</td>
<td>
0.0037 / 3724
</td>
<td>
0.35
</td>
<td>
0.0037 / 3724
</td>
<td>
0.4
</td>
<td>
0.00016 / 160
</td>
<td>
0.5
</td>
<td>
3e-05 / 30
</td>
</tr>
<tr>
<td>
<b>Topological Torsions (counts)</b>
</td>
<td>
0.19
</td>
<td>
0.35
</td>
<td>
0.00049 / 489
</td>
<td>
0.4
</td>
<td>
0.00011 / 110
</td>
<td>
0.45
</td>
<td>
7.5e-05 / 75
</td>
<td>
0.55
</td>
<td>
2.5e-05 / 25
</td>
</tr>
<tr>
<td>
<b>Atom Pairs (bits)</b>
</td>
<td>
0.36
</td>
<td>
0.4
</td>
<td>
0.01 / 10380
</td>
<td>
0.45
</td>
<td>
0.0053 / 5250
</td>
<td>
0.5
</td>
<td>
0.00012 / 120
</td>
<td>
0.55
</td>
<td>
7e-05 / 70
</td>
</tr>
<tr>
<td>
<b>Topological Torsions (bits)</b>
</td>
<td>
0.22
</td>
<td>
0.4
</td>
<td>
0.00016 / 160
</td>
<td>
0.4
</td>
<td>
0.00016 / 160
</td>
<td>
0.45
</td>
<td>
0.00011 / 105
</td>
<td>
0.55
</td>
<td>
3.5e-05 / 35
</td>
</tr>
<tr>
<td>
<b>Avalon 512 (bits)</b>
</td>
<td>
0.51
</td>
<td>
0.65
</td>
<td>
0.0004 / 400
</td>
<td>
0.65
</td>
<td>
0.0004 / 400
</td>
<td>
0.7
</td>
<td>
8e-05 / 80
</td>
<td>
0.8
</td>
<td>
2e-05 / 20
</td>
</tr>
<tr>
<td>
<b>Avalon 1024 (bits)</b>
</td>
<td>
0.37
</td>
<td>
0.55
</td>
<td>
0.00075 / 750
</td>
<td>
0.6
</td>
<td>
0.00014 / 140
</td>
<td>
0.65
</td>
<td>
9e-05 / 90
</td>
<td>
0.75
</td>
<td>
2.5e-05 / 25
</td>
</tr>
<tr>
<td>
<b>Avalon 512 (counts)</b>
</td>
<td>
0.42
</td>
<td>
0.55
</td>
<td>
0.0028 / 2785
</td>
<td>
0.6
</td>
<td>
0.00028 / 280
</td>
<td>
0.65
</td>
<td>
0.00016 / 160
</td>
<td>
0.75
</td>
<td>
2.5e-05 / 25
</td>
</tr>
<tr>
<td>
<b>Avalon 1024 (counts)</b>
</td>
<td>
0.38
</td>
<td>
0.55
</td>
<td>
0.0012 / 1192
</td>
<td>
0.6
</td>
<td>
0.00017 / 170
</td>
<td>
0.6
</td>
<td>
0.00017 / 170
</td>
<td>
0.7
</td>
<td>
4e-05 / 40
</td>
</tr>
</tbody></table>
<p>The threshold values are rounded to the nearest 0.05.</p>
</section>
<section id="method" class="level1">
<h1>Method</h1>
<p>I won’t get into heavy detail here, the actual notebooks are linked below.</p>
<section id="similarity-between-random-molecules" class="level2">
<h2 class="anchored" data-anchor-id="similarity-between-random-molecules">Similarity between random molecules</h2>
<p>The workflow and dataset for this is described in a <a href="https://greglandrum.github.io/rdkit-blog/fingerprints/similarity/reference/2021/05/18/fingerprint-thresholds1.html">blog post</a>. The very quick summary is that I generated statistics for the similarity distribution of 25K random pairs of reasonable sized (MW&lt;600) molecules exported from ChEMBL.</p>
</section>
<section id="groups-of-related-compounds" class="level2">
<h2 class="anchored" data-anchor-id="groups-of-related-compounds">Groups of related compounds</h2>
<p>This is really the central pillar of the post: how do we pick sets of compounds we can use to quantify similarity search performance?</p>
<p>One obvious possibility is to just take groups of molecules which are known to be active against the same targets. This is the classic similarity-based virtual screening use case and it’s one which has been done a lot in the literature. That’s an interesting (and important) use case and it’s something which I may come back to in a future post, but it requires a connection between chemical similarity and biological activity. That connection (or lack thereof) makes analysis of the threshold results more complex and introduces a significant amount of variability.</p>
<p>Here I want to look at a different use case: searching a database and retrieving compounds which are chemically similar to each other. For this I need to pick groups of chemically similar compounds without actually using a traditional approach to chemical similarity. The approach I used is to assume that the typical medicinal chemistry SAR paper includes a bunch of compounds which come from a small number of chemical series (typically one). These compounds are definitely related to each other and it’s not unreasonable to expect that a similarity search for one should return the others as results.</p>
<p>This led me back to an earlier <a href="http://rdkit.blogspot.com/2015/05/a-set-of-scaffolds-from-chembl-papers.html">blog post looking at identifying scaffolds from ChEMBL compounds tested in the same assay</a> (given the structure of ChEMBL, this implies that the compounds are from the same paper). That post includes some pre-filtering of the results to try and get only SAR papers by only keeping assays (papers) where 50-100 compounds were measured. For this post I re-ran that analysis against ChEMBL28 and expanded my search criteria to include IC50 data as well as the Ki data used in the original set. The analysis produced results for 1396 groups (a group is the compounds tested in one assay); for this analysis I further filtered these down to the 1047 groups (70026 compounds in total) where the number of atoms in the scaffold is at least 50% of the average number of atoms for compounds in the group. I further filtered each group to only include compounds which have a substructure match to the fuzzy MCS which was found for the full set. The hope here is that this will limit us to only consider the compounds which are part of the chemical series being reported. This lowers the total number of compounds to 66577 across the 1047 groups.</p>
<p>So given these 1047 groups of chemically related compounds I was ready to start doing some searches.</p>
</section>
<section id="determining-background-retrieval-rates" class="level2">
<h2 class="anchored" data-anchor-id="determining-background-retrieval-rates">Determining background retrieval rates</h2>
<p>In order to get a sense of how many compounds would be retrieved from a database when using the related compounds, I randomly picked 100K molecules from ChEMBL28 to use as a background. I wanted a representative sample, so I didn’t apply MW filters when doing this selection.</p>
<p>I then queried the background compounds with each molecule in a random subset of the 66K members of the “related compounds” set, counted the number of results each returned for each fingerprint/similarity threshold combination, and did statistics based on those results.</p>
</section>
<section id="summarizing-the-data" class="level2">
<h2 class="anchored" data-anchor-id="summarizing-the-data">Summarizing the data</h2>
<p>Here’s an example of a graphical summary of the results presented in the final notebook listed below:</p>
<p><img src="{{ site.baseurl }}/images/blog/similarity-search-threshold1-img1.png" class="img-fluid"></p>
<p>The violin plots show the distribution of similarity values required to match 50% of the related compound pairs for each of the fingerprints. The dark gray boxes show the noise level for the fingerprints. The red line shows the median fraction of the 100K ChEMBL compounds retrieved when using the median value from the violin plots as a similarity threshold.</p>
</section>
<section id="the-notebooks" class="level2">
<h2 class="anchored" data-anchor-id="the-notebooks">The notebooks</h2>
<p>Here are the github links for the notebooks I used: - Similarity between random molecules (this is the previous analysis): <a href="https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Fingerprint%20Thresholds.ipynb">https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Fingerprint%20Thresholds.ipynb</a> - Finding scaffolds for ChEMBL documents with Ki values (also a previous analysis): <a href="https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Finding%20Scaffolds%20Revisited%20again.ipynb">https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Finding%20Scaffolds%20Revisited%20again.ipynb</a> - Similarity distributions for related compounds: <a href="https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Fingerprint%20Thresholds%20Scaffolds.ipynb">https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Fingerprint%20Thresholds%20Scaffolds.ipynb</a> Note that this is a new one and I’m still working on cleaning it up and adding more text/explanation - Fraction of the database retrieved when searching (this one also has the calculation of the summary results presented here): <a href="https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Fingerprint%20Thresholds%20Database%20Fraction.ipynb">https://github.com/greglandrum/rdkit_blog/blob/master/notebooks/Fingerprint%20Thresholds%20Database%20Fraction.ipynb</a> Note that this is a new one and I’m still working on cleaning it up and adding more text/explanation</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/greglandrum\.github\.io\/rdkit-blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="greglandrum/rdkit-blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright (C) 2025 Greg Landrum</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><a href="https://www.rdkit.org"><img src="https://www.rdkit.org/logo.small.png" class="img-fluid" alt="RDKit" width="64"></a></p>
</div>
  </div>
</footer>




</body></html>