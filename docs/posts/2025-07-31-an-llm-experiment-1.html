<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-07-31">
<meta name="description" content="What happens if you ask an LLM to generate an RDKit blog post?">

<title>An LLM experiment – RDKit blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../posts/icons/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-4379b0ccadffce622b03caf4c46266b3.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-40840319e1d09552a0f54992bf705f97.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-f86ed83de42dc3a6349cec1bcdefd5d4.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">RDKit blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">RDKit experiments, tips, and tutorials</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rdkit/rdkit"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://bsky.app/profile/rdkit.bsky.social"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/groups/8192558/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-this-post" id="toc-what-is-this-post" class="nav-link active" data-scroll-target="#what-is-this-post">What is this post?</a></li>
  <li><a href="#rdkit-and-large-language-models-chemical-structure-text-integration-in-the-ai-era" id="toc-rdkit-and-large-language-models-chemical-structure-text-integration-in-the-ai-era" class="nav-link" data-scroll-target="#rdkit-and-large-language-models-chemical-structure-text-integration-in-the-ai-era">RDKit and Large Language Models: Chemical Structure-Text Integration in the AI Era</a></li>
  <li><a href="#structure-validation-rdkit-as-the-chemical-reality-check" id="toc-structure-validation-rdkit-as-the-chemical-reality-check" class="nav-link" data-scroll-target="#structure-validation-rdkit-as-the-chemical-reality-check">Structure Validation: RDKit as the Chemical Reality Check</a>
  <ul class="collapse">
  <li><a href="#batch-validation-for-llm-outputs" id="toc-batch-validation-for-llm-outputs" class="nav-link" data-scroll-target="#batch-validation-for-llm-outputs">Batch Validation for LLM Outputs</a></li>
  <li><a href="#chemical-plausibility-checks" id="toc-chemical-plausibility-checks" class="nav-link" data-scroll-target="#chemical-plausibility-checks">Chemical Plausibility Checks</a></li>
  <li><a href="#putting-it-together-a-complete-validation-pipeline" id="toc-putting-it-together-a-complete-validation-pipeline" class="nav-link" data-scroll-target="#putting-it-together-a-complete-validation-pipeline">Putting It Together: A Complete Validation Pipeline</a></li>
  </ul></li>
  <li><a href="#from-molecules-to-text-generating-rich-descriptions-for-llm-training" id="toc-from-molecules-to-text-generating-rich-descriptions-for-llm-training" class="nav-link" data-scroll-target="#from-molecules-to-text-generating-rich-descriptions-for-llm-training">From Molecules to Text: Generating Rich Descriptions for LLM Training</a>
  <ul class="collapse">
  <li><a href="#converting-features-to-natural-language" id="toc-converting-features-to-natural-language" class="nav-link" data-scroll-target="#converting-features-to-natural-language">Converting Features to Natural Language</a></li>
  <li><a href="#creating-structured-training-data" id="toc-creating-structured-training-data" class="nav-link" data-scroll-target="#creating-structured-training-data">Creating Structured Training Data</a></li>
  <li><a href="#exporting-data-for-different-llm-platforms" id="toc-exporting-data-for-different-llm-platforms" class="nav-link" data-scroll-target="#exporting-data-for-different-llm-platforms">Exporting Data for Different LLM Platforms</a></li>
  </ul></li>
  <li><a href="#real-world-challenges-and-solutions" id="toc-real-world-challenges-and-solutions" class="nav-link" data-scroll-target="#real-world-challenges-and-solutions">Real-World Challenges and Solutions</a>
  <ul class="collapse">
  <li><a href="#challenge-1-performance-and-scalability" id="toc-challenge-1-performance-and-scalability" class="nav-link" data-scroll-target="#challenge-1-performance-and-scalability">Challenge 1: Performance and Scalability</a></li>
  <li><a href="#challenge-2-handling-inconsistent-llm-outputs" id="toc-challenge-2-handling-inconsistent-llm-outputs" class="nav-link" data-scroll-target="#challenge-2-handling-inconsistent-llm-outputs">Challenge 2: Handling Inconsistent LLM Outputs</a></li>
  <li><a href="#challenge-3-data-quality-and-contamination" id="toc-challenge-3-data-quality-and-contamination" class="nav-link" data-scroll-target="#challenge-3-data-quality-and-contamination">Challenge 3: Data Quality and Contamination</a>
  <ul class="collapse">
  <li><a href="#advanced-contamination-detection" id="toc-advanced-contamination-detection" class="nav-link" data-scroll-target="#advanced-contamination-detection">Advanced Contamination Detection</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">An LLM experiment</h1>
  <div class="quarto-categories">
    <div class="quarto-category">exploratoration</div>
    <div class="quarto-category">LLMs</div>
  </div>
  </div>

<div>
  <div class="description">
    What happens if you ask an LLM to generate an RDKit blog post?
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 31, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="what-is-this-post" class="level1">
<h1>What is this post?</h1>
<p>On the bus to the CADD GRC, Nadine suggested that I try using Copilot to generate ideas for an RDKit blog post. It seemed like an interesting experiment and I’m heading out for a couple of weeks of vacation, so I thought I’d go ahead and give it a try. This post is the result.</p>
<p>What’s below is the result of a chat session with Copilot, using Claude Sonnet 4. The initial prompt was: <code>suggest a topic for a new RDKit blog post</code>. I made a couple of small edits at the very end, but otherwise the text is exactly as generated by the LLM. I hope to come back to this at some point in the future and dig into the code and content in detail, but right now I need to go pack my gear to head to the mountains for a couple of weeks of climbing and mountaineering.</p>
<p>The actual chat session is <a href="https://raw.githubusercontent.com/greglandrum/rdkit_blog/refs/heads/master/notebooks/results/chat_20250726.json">available here</a>.</p>
<p>I’m going to go ahead and upload this and post it sometime around July 31st (or whenever I have decent internet access). There won’t be a new blog post next week, but I will be back the week of August 11th.</p>
</section>
<section id="rdkit-and-large-language-models-chemical-structure-text-integration-in-the-ai-era" class="level1">
<h1>RDKit and Large Language Models: Chemical Structure-Text Integration in the AI Era</h1>
<p>The landscape of artificial intelligence has been dramatically transformed by the rise of large language models (LLMs), and the field of chemistry is no exception. From GPT-4’s ability to reason about molecular structures to specialized chemistry-focused models like ChemCrow and Galactica, we’re witnessing an unprecedented convergence of natural language processing and chemical informatics. This presents both exciting opportunities and unique challenges for computational chemists and cheminformatics practitioners.</p>
<p>The RDKit, as one of the most widely-used open-source cheminformatics toolkits, finds itself at a fascinating intersection in this new landscape. While LLMs excel at processing and generating text-based representations of chemical knowledge, they often struggle with the precise, structure-based reasoning that is second nature to dedicated cheminformatics tools. Conversely, traditional cheminformatics approaches excel at molecular manipulation and property calculation but have limited ability to understand and generate natural language descriptions of chemical concepts.</p>
<p>This complementary relationship suggests powerful synergies. LLMs can help democratize access to chemical knowledge by translating between technical chemical representations and human-readable explanations. Meanwhile, tools like RDKit provide the essential chemical “reality check” - validating molecular structures, calculating properties, and ensuring that AI-generated chemistry actually makes sense from a chemical perspective.</p>
<p>In this post, we’ll explore practical approaches for integrating RDKit with modern LLM workflows. We’ll cover how to:</p>
<ul>
<li>Use RDKit to validate and process chemical structures generated by LLMs</li>
<li>Convert RDKit molecular representations into rich text descriptions suitable for training or prompting LLMs</li>
<li>Build robust pipelines that combine the strengths of both approaches</li>
<li>Handle the unique challenges that arise when bridging symbolic chemical representations with statistical language models</li>
</ul>
<p>The goal is not to replace either approach, but rather to show how they can work together to create more powerful, reliable, and accessible chemical AI systems. Whether you’re building a chemical chatbot, curating training data for a chemistry-focused LLM, or simply trying to make your chemical data more searchable and interpretable, the patterns we’ll explore should provide a solid foundation.</p>
<p>Let’s start by setting up our environment and exploring some basic integration patterns.</p>
<div id="1759d6cc" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard RDKit imports</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> Chem</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> Draw, Descriptors, rdMolDescriptors</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem.Draw <span class="im">import</span> IPythonConsole</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> rdBase</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"RDKit version: </span><span class="sc">{</span>rdBase<span class="sc">.</span>rdkitVersion<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Generated: </span><span class="sc">{</span>time<span class="sc">.</span>asctime()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RDKit version: 2025.03.4
Generated: Sat Jul 26 09:53:54 2025</code></pre>
</div>
</div>
<div id="168a2f03" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional imports for LLM integration examples</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Optional, Tuple</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="structure-validation-rdkit-as-the-chemical-reality-check" class="level1">
<h1>Structure Validation: RDKit as the Chemical Reality Check</h1>
<p>One of the most immediate and practical applications of RDKit in LLM workflows is structure validation. LLMs, while impressive at generating chemical-looking text, often produce invalid SMILES strings, impossible molecular structures, or chemically nonsensical compounds. RDKit provides robust validation capabilities that can catch these errors and provide meaningful feedback.</p>
<p>Let’s explore some common validation scenarios and how to handle them systematically.</p>
<div id="bb7a2e15" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_smiles_with_details(smiles: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">any</span>]:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Comprehensive SMILES validation with detailed feedback.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a dictionary with validation results and diagnostic information.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> {</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'smiles'</span>: smiles,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_valid'</span>: <span class="va">False</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mol'</span>: <span class="va">None</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'canonical_smiles'</span>: <span class="va">None</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'errors'</span>: [],</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'warnings'</span>: [],</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'properties'</span>: {}</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic parsing</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mol <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'errors'</span>].append(<span class="st">"Invalid SMILES: Could not parse structure"</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        result[<span class="st">'mol'</span>] <span class="op">=</span> mol</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        result[<span class="st">'is_valid'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get canonical SMILES</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'canonical_smiles'</span>] <span class="op">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'warnings'</span>].append(<span class="st">"Could not generate canonical SMILES"</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Basic chemical checks</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        num_atoms <span class="op">=</span> mol.GetNumAtoms()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_atoms <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'errors'</span>].append(<span class="st">"Empty molecule"</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'is_valid'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> num_atoms <span class="op">&gt;</span> <span class="dv">200</span>:</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'warnings'</span>].append(<span class="ss">f"Very large molecule (</span><span class="sc">{</span>num_atoms<span class="sc">}</span><span class="ss"> atoms)"</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for unusual valences</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>            Chem.SanitizeMol(mol)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'errors'</span>].append(<span class="ss">f"Sanitization failed: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'is_valid'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate basic properties if valid</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result[<span class="st">'is_valid'</span>]:</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>                result[<span class="st">'properties'</span>] <span class="op">=</span> {</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'num_atoms'</span>: num_atoms,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'num_bonds'</span>: mol.GetNumBonds(),</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'molecular_weight'</span>: Descriptors.MolWt(mol),</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'num_rings'</span>: rdMolDescriptors.CalcNumRings(mol),</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'num_aromatic_rings'</span>: rdMolDescriptors.CalcNumAromaticRings(mol)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>                result[<span class="st">'warnings'</span>].append(<span class="ss">f"Property calculation failed: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        result[<span class="st">'errors'</span>].append(<span class="ss">f"Parsing error: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the function with some examples</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>test_smiles <span class="op">=</span> [</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CCO"</span>,  <span class="co"># ethanol - valid</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"c1ccccc1"</span>,  <span class="co"># benzene - valid</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C[C@H](N)C(=O)O"</span>,  <span class="co"># alanine - valid with stereochemistry</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CCO[invalid]"</span>,  <span class="co"># invalid SMILES</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C1CCC"</span>,  <span class="co"># invalid - unclosed ring</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C(C)(C)(C)(C)C"</span>,  <span class="co"># carbon with too many bonds</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,  <span class="co"># empty string</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SMILES Validation Examples:"</span>)</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> smiles <span class="kw">in</span> test_smiles:</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> validate_smiles_with_details(smiles)</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">SMILES: </span><span class="sc">{</span>smiles<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Valid: </span><span class="sc">{</span>result[<span class="st">'is_valid'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result[<span class="st">'canonical_smiles'</span>]:</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Canonical: </span><span class="sc">{</span>result[<span class="st">'canonical_smiles'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result[<span class="st">'errors'</span>]:</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Errors: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(result[<span class="st">'errors'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result[<span class="st">'warnings'</span>]:</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Warnings: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(result[<span class="st">'warnings'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result[<span class="st">'properties'</span>]:</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        props <span class="op">=</span> result[<span class="st">'properties'</span>]</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Properties: </span><span class="sc">{</span>props[<span class="st">'num_atoms'</span>]<span class="sc">}</span><span class="ss"> atoms, MW=</span><span class="sc">{</span>props[<span class="st">'molecular_weight'</span>]<span class="sc">:.1f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SMILES Validation Examples:
==================================================

SMILES: CCO
Valid: True
Canonical: CCO
Properties: 3 atoms, MW=46.1

SMILES: c1ccccc1
Valid: True
Canonical: c1ccccc1
Properties: 6 atoms, MW=78.1

SMILES: C[C@H](N)C(=O)O
Valid: True
Canonical: C[C@H](N)C(=O)O
Properties: 6 atoms, MW=89.1

SMILES: CCO[invalid]
Valid: False
Errors: Invalid SMILES: Could not parse structure

SMILES: C1CCC
Valid: False
Errors: Invalid SMILES: Could not parse structure

SMILES: C(C)(C)(C)(C)C
Valid: False
Errors: Invalid SMILES: Could not parse structure

SMILES: 
Valid: False
Errors: Empty molecule</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:53:54] SMILES Parse Error: syntax error while parsing: CCO[invalid]
[09:53:54] SMILES Parse Error: check for mistakes around position 5:
[09:53:54] CCO[invalid]
[09:53:54] ~~~~^
[09:53:54] SMILES Parse Error: Failed parsing SMILES 'CCO[invalid]' for input: 'CCO[invalid]'
[09:53:54] SMILES Parse Error: unclosed ring for input: 'C1CCC'
[09:53:54] Explicit valence for atom # 0 C, 5, is greater than permitted</code></pre>
</div>
</div>
<section id="batch-validation-for-llm-outputs" class="level2">
<h2 class="anchored" data-anchor-id="batch-validation-for-llm-outputs">Batch Validation for LLM Outputs</h2>
<p>When working with LLMs that generate multiple chemical structures, you’ll often need to validate batches of SMILES strings. Here’s a more robust approach that can handle large datasets efficiently:</p>
<div id="3bab073e" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> batch_validate_structures(smiles_list: List[<span class="bu">str</span>], </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                             include_properties: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Validate a batch of SMILES strings and return results as a DataFrame.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Useful for processing LLM outputs or curating chemical datasets.</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, smiles <span class="kw">in</span> <span class="bu">enumerate</span>(smiles_list):</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> validate_smiles_with_details(smiles)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Flatten the result for DataFrame storage</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> {</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">'index'</span>: i,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'input_smiles'</span>: smiles,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'is_valid'</span>: result[<span class="st">'is_valid'</span>],</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'canonical_smiles'</span>: result[<span class="st">'canonical_smiles'</span>],</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_errors'</span>: <span class="bu">len</span>(result[<span class="st">'errors'</span>]),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_warnings'</span>: <span class="bu">len</span>(result[<span class="st">'warnings'</span>]),</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">'error_messages'</span>: <span class="st">'; '</span>.join(result[<span class="st">'errors'</span>]) <span class="cf">if</span> result[<span class="st">'errors'</span>] <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">'warning_messages'</span>: <span class="st">'; '</span>.join(result[<span class="st">'warnings'</span>]) <span class="cf">if</span> result[<span class="st">'warnings'</span>] <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add properties if requested and available</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> include_properties <span class="kw">and</span> result[<span class="st">'properties'</span>]:</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            row.update(result[<span class="st">'properties'</span>])</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        results.append(row)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate some LLM-generated SMILES (mix of valid and invalid)</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>llm_generated_smiles <span class="op">=</span> [</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>,  <span class="co"># ibuprofen-like</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C1=CC=C(C=C1)C(=O)O"</span>,  <span class="co"># benzoic acid</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"invalidsmiles123"</span>,  <span class="co"># clearly invalid</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C1=CC=CC=C1"</span>,  <span class="co"># benzene</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CCO"</span>,  <span class="co"># ethanol</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C[C@H](N)C(=O)O"</span>,  <span class="co"># L-alanine</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C1CCC1C"</span>,  <span class="co"># methylcyclopropane</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"c1ccccc1c2ccccc2"</span>,  <span class="co"># biphenyl</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CCCCCCCCCCCCCCCCO"</span>,  <span class="co"># long-chain alcohol</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C1=CC=C2C(=C1)C=CC=C2"</span>,  <span class="co"># naphthalene</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Processing batch of LLM-generated SMILES..."</span>)</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>df_results <span class="op">=</span> batch_validate_structures(llm_generated_smiles)</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Display summary statistics</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Batch Validation Summary:"</span>)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total structures: </span><span class="sc">{</span><span class="bu">len</span>(df_results)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Valid structures: </span><span class="sc">{</span>df_results[<span class="st">'is_valid'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Invalid structures: </span><span class="sc">{</span>(<span class="op">~</span>df_results[<span class="st">'is_valid'</span>])<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Structures with warnings: </span><span class="sc">{</span>(df_results[<span class="st">'num_warnings'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the results table</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Detailed Results:"</span>)</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>display_cols <span class="op">=</span> [<span class="st">'input_smiles'</span>, <span class="st">'is_valid'</span>, <span class="st">'canonical_smiles'</span>, <span class="st">'molecular_weight'</span>, <span class="st">'num_atoms'</span>]</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>available_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> display_cols <span class="cf">if</span> col <span class="kw">in</span> df_results.columns]</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_results[available_cols].to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Show error details for invalid structures</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>invalid_structures <span class="op">=</span> df_results[<span class="op">~</span>df_results[<span class="st">'is_valid'</span>]]</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(invalid_structures) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Error Details for Invalid Structures:"</span>)</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> invalid_structures.iterrows():</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"'</span><span class="sc">{</span>row[<span class="st">'input_smiles'</span>]<span class="sc">}</span><span class="ss">': </span><span class="sc">{</span>row[<span class="st">'error_messages'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processing batch of LLM-generated SMILES...

Batch Validation Summary:
Total structures: 10
Valid structures: 9
Invalid structures: 1
Structures with warnings: 0

Detailed Results:
                 input_smiles  is_valid           canonical_smiles  molecular_weight  num_atoms
CC(C)CC1=CC=C(C=C1)C(C)C(=O)O      True CC(C)Cc1ccc(C(C)C(=O)O)cc1           206.285       15.0
          C1=CC=C(C=C1)C(=O)O      True             O=C(O)c1ccccc1           122.123        9.0
             invalidsmiles123     False                       None               NaN        NaN
                  C1=CC=CC=C1      True                   c1ccccc1            78.114        6.0
                          CCO      True                        CCO            46.069        3.0
              C[C@H](N)C(=O)O      True            C[C@H](N)C(=O)O            89.094        6.0
                      C1CCC1C      True                    CC1CCC1            70.135        5.0
             c1ccccc1c2ccccc2      True        c1ccc(-c2ccccc2)cc1           154.212       12.0
            CCCCCCCCCCCCCCCCO      True          CCCCCCCCCCCCCCCCO           242.447       17.0
        C1=CC=C2C(=C1)C=CC=C2      True             c1ccc2ccccc2c1           128.174       10.0

Error Details for Invalid Structures:
'invalidsmiles123': Invalid SMILES: Could not parse structure</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:53:54] SMILES Parse Error: syntax error while parsing: invalidsmiles123
[09:53:54] SMILES Parse Error: check for mistakes around position 1:
[09:53:54] invalidsmiles123
[09:53:54] ^
[09:53:54] SMILES Parse Error: Failed parsing SMILES 'invalidsmiles123' for input: 'invalidsmiles123'</code></pre>
</div>
</div>
</section>
<section id="chemical-plausibility-checks" class="level2">
<h2 class="anchored" data-anchor-id="chemical-plausibility-checks">Chemical Plausibility Checks</h2>
<p>Beyond basic SMILES validation, we can implement more sophisticated checks to assess whether LLM-generated structures are chemically reasonable. This is particularly important because LLMs might generate syntactically valid but chemically implausible structures:</p>
<div id="deaf8036" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assess_chemical_plausibility(mol: Chem.Mol) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">any</span>]:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Assess the chemical plausibility of a molecule beyond basic validation.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns flags for potential issues that might indicate AI-generated artifacts.</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mol <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'plausible'</span>: <span class="va">False</span>, <span class="st">'issues'</span>: [<span class="st">'Invalid molecule'</span>]}</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    issues <span class="op">=</span> []</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    warnings <span class="op">=</span> []</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Molecular weight checks</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    mw <span class="op">=</span> Descriptors.MolWt(mol)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mw <span class="op">&lt;</span> <span class="dv">16</span>:  <span class="co"># Lighter than methane</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        issues.append(<span class="ss">f"Extremely low molecular weight: </span><span class="sc">{</span>mw<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mw <span class="op">&gt;</span> <span class="dv">2000</span>:  <span class="co"># Very large for small molecule</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        warnings.append(<span class="ss">f"Very high molecular weight: </span><span class="sc">{</span>mw<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Atom count checks</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    num_atoms <span class="op">=</span> mol.GetNumAtoms()</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> num_atoms <span class="op">&gt;</span> <span class="dv">150</span>:  <span class="co"># Unusually large for typical organic molecules</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        warnings.append(<span class="ss">f"Very large molecule: </span><span class="sc">{</span>num_atoms<span class="sc">}</span><span class="ss"> atoms"</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for unusual atom types in organic chemistry context</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    unusual_atoms <span class="op">=</span> []</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> atom <span class="kw">in</span> mol.GetAtoms():</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        symbol <span class="op">=</span> atom.GetSymbol()</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> symbol <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'C'</span>, <span class="st">'N'</span>, <span class="st">'O'</span>, <span class="st">'S'</span>, <span class="st">'P'</span>, <span class="st">'F'</span>, <span class="st">'Cl'</span>, <span class="st">'Br'</span>, <span class="st">'I'</span>, <span class="st">'H'</span>]:</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            unusual_atoms.append(symbol)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unusual_atoms:</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        warnings.append(<span class="ss">f"Unusual atoms present: </span><span class="sc">{</span><span class="bu">set</span>(unusual_atoms)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check carbon-to-heteroatom ratio</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    carbon_count <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> atom <span class="kw">in</span> mol.GetAtoms() <span class="cf">if</span> atom.GetSymbol() <span class="op">==</span> <span class="st">'C'</span>)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    heteroatom_count <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> atom <span class="kw">in</span> mol.GetAtoms() <span class="cf">if</span> atom.GetSymbol() <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'C'</span>, <span class="st">'H'</span>])</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> heteroatom_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        c_to_hetero_ratio <span class="op">=</span> carbon_count <span class="op">/</span> heteroatom_count</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> c_to_hetero_ratio <span class="op">&lt;</span> <span class="fl">0.1</span>:  <span class="co"># Too many heteroatoms</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            warnings.append(<span class="ss">f"Unusual C:heteroatom ratio: </span><span class="sc">{</span>c_to_hetero_ratio<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for overly complex ring systems</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    ring_info <span class="op">=</span> mol.GetRingInfo()</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    num_rings <span class="op">=</span> ring_info.NumRings()</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> num_rings <span class="op">&gt;</span> <span class="dv">10</span>:  <span class="co"># Many fused rings might be suspicious</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        warnings.append(<span class="ss">f"Complex ring system: </span><span class="sc">{</span>num_rings<span class="sc">}</span><span class="ss"> rings"</span>)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for extremely high or low LogP (rough estimate)</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        logp <span class="op">=</span> Descriptors.MolLogP(mol)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> logp <span class="op">&gt;</span> <span class="dv">8</span>:</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            warnings.append(<span class="ss">f"Very high LogP: </span><span class="sc">{</span>logp<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> logp <span class="op">&lt;</span> <span class="op">-</span><span class="dv">5</span>:</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>            warnings.append(<span class="ss">f"Very low LogP: </span><span class="sc">{</span>logp<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        warnings.append(<span class="st">"Could not calculate LogP"</span>)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for drug-likeness violations (Lipinski's Rule of Five)</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>    violations <span class="op">=</span> []</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mw <span class="op">&gt;</span> <span class="dv">500</span>:</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>        violations.append(<span class="st">"MW &gt; 500"</span>)</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> Descriptors.MolLogP(mol) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>        violations.append(<span class="st">"LogP &gt; 5"</span>)</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> Descriptors.NumHDonors(mol) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>        violations.append(<span class="st">"H-donors &gt; 5"</span>)</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> Descriptors.NumHAcceptors(mol) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>        violations.append(<span class="st">"H-acceptors &gt; 10"</span>)</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(violations) <span class="op">&gt;=</span> <span class="dv">2</span>:  <span class="co"># Allow one violation</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>        warnings.append(<span class="ss">f"Multiple Lipinski violations: </span><span class="sc">{</span>violations<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">'plausible'</span>: <span class="bu">len</span>(issues) <span class="op">==</span> <span class="dv">0</span>,</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">'issues'</span>: issues,</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">'warnings'</span>: warnings,</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">'properties'</span>: {</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>            <span class="st">'molecular_weight'</span>: mw,</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_atoms'</span>: num_atoms,</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_rings'</span>: num_rings,</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">'logp'</span>: Descriptors.MolLogP(mol) <span class="cf">if</span> mol <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lipinski_violations'</span>: <span class="bu">len</span>(violations)</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with some examples</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>test_molecules <span class="op">=</span> [</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CCO"</span>, <span class="st">"Simple alcohol"</span>),</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st">"Ibuprofen"</span>),</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"C"</span> <span class="op">*</span> <span class="dv">50</span>, <span class="st">"Very long alkyl chain"</span>),  <span class="co"># Unusual but valid</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC(=O)O"</span>, <span class="st">"Long fatty acid"</span>),</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"c1ccc2c(c1)c3ccccc3c4ccccc24"</span>, <span class="st">"Anthracene (PAH)"</span>),</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Chemical Plausibility Assessment:"</span>)</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> smiles, description <span class="kw">in</span> test_molecules:</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>    mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>    assessment <span class="op">=</span> assess_chemical_plausibility(mol)</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Molecule: </span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"SMILES: </span><span class="sc">{</span>smiles<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Plausible: </span><span class="sc">{</span>assessment[<span class="st">'plausible'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> assessment[<span class="st">'issues'</span>]:</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Issues: </span><span class="sc">{</span><span class="st">'; '</span><span class="sc">.</span>join(assessment[<span class="st">'issues'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> assessment[<span class="st">'warnings'</span>]:</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Warnings: </span><span class="sc">{</span><span class="st">'; '</span><span class="sc">.</span>join(assessment[<span class="st">'warnings'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>    props <span class="op">=</span> assessment[<span class="st">'properties'</span>]</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Properties: MW=</span><span class="sc">{</span>props[<span class="st">'molecular_weight'</span>]<span class="sc">:.1f}</span><span class="ss">, "</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Rings=</span><span class="sc">{</span>props[<span class="st">'num_rings'</span>]<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"LogP=</span><span class="sc">{</span>props[<span class="st">'logp'</span>]<span class="sc">:.2f}</span><span class="ss">, "</span></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Lipinski violations=</span><span class="sc">{</span>props[<span class="st">'lipinski_violations'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chemical Plausibility Assessment:
==================================================

Molecule: Simple alcohol
SMILES: CCO
Plausible: True
Properties: MW=46.1, Rings=0, LogP=-0.00, Lipinski violations=0

Molecule: Ibuprofen
SMILES: CC(C)CC1=CC=C(C=C1)C(C)C(=O)O
Plausible: True
Properties: MW=206.3, Rings=1, LogP=3.07, Lipinski violations=0

Molecule: Very long alkyl chain
SMILES: CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
Plausible: True
Warnings: Very high LogP: 19.75; Multiple Lipinski violations: ['MW &gt; 500', 'LogP &gt; 5']
Properties: MW=703.4, Rings=0, LogP=19.75, Lipinski violations=2

Molecule: Long fatty acid
SMILES: CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC(=O)O
Plausible: True
Warnings: Very high LogP: 11.40
Properties: MW=466.8, Rings=0, LogP=11.40, Lipinski violations=1

Molecule: Anthracene (PAH)
SMILES: c1ccc2c(c1)c3ccccc3c4ccccc24
Plausible: True
Properties: MW=228.3, Rings=4, LogP=5.15, Lipinski violations=1</code></pre>
</div>
</div>
</section>
<section id="putting-it-together-a-complete-validation-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-together-a-complete-validation-pipeline">Putting It Together: A Complete Validation Pipeline</h2>
<p>Here’s how you might integrate these validation functions into a complete pipeline for processing LLM-generated chemical structures:</p>
<div id="091dc7fa" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LLMChemicalValidator:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    A comprehensive validator for LLM-generated chemical structures.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Combines SMILES validation, chemical plausibility checks, and filtering.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, strict_mode: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.strict_mode <span class="op">=</span> strict_mode</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.validation_stats <span class="op">=</span> {</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_processed'</span>: <span class="dv">0</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'valid_smiles'</span>: <span class="dv">0</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">'chemically_plausible'</span>: <span class="dv">0</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'passed_filters'</span>: <span class="dv">0</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validate_structure(<span class="va">self</span>, smiles: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">any</span>]:</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Validate a single SMILES string with full analysis."""</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> validate_smiles_with_details(smiles)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result[<span class="st">'is_valid'</span>] <span class="kw">and</span> result[<span class="st">'mol'</span>]:</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add plausibility assessment</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>            plausibility <span class="op">=</span> assess_chemical_plausibility(result[<span class="st">'mol'</span>])</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'plausibility'</span>] <span class="op">=</span> plausibility</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'chemically_plausible'</span>] <span class="op">=</span> plausibility[<span class="st">'plausible'</span>]</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply filters based on mode</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.strict_mode:</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                result[<span class="st">'passes_filters'</span>] <span class="op">=</span> (plausibility[<span class="st">'plausible'</span>] <span class="kw">and</span> </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>                                          <span class="bu">len</span>(plausibility[<span class="st">'warnings'</span>]) <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>                result[<span class="st">'passes_filters'</span>] <span class="op">=</span> plausibility[<span class="st">'plausible'</span>]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'chemically_plausible'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'passes_filters'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update stats</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.validation_stats[<span class="st">'total_processed'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result[<span class="st">'is_valid'</span>]:</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.validation_stats[<span class="st">'valid_smiles'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result.get(<span class="st">'chemically_plausible'</span>, <span class="va">False</span>):</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.validation_stats[<span class="st">'chemically_plausible'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result.get(<span class="st">'passes_filters'</span>, <span class="va">False</span>):</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.validation_stats[<span class="st">'passed_filters'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validate_batch(<span class="va">self</span>, smiles_list: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[Dict[<span class="bu">str</span>, <span class="bu">any</span>]]:</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Validate a batch of SMILES strings."""</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="va">self</span>.validate_structure(smiles) <span class="cf">for</span> smiles <span class="kw">in</span> smiles_list]</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_filtered_structures(<span class="va">self</span>, smiles_list: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Return only the structures that pass all validation checks."""</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="va">self</span>.validate_batch(smiles_list)</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [r[<span class="st">'canonical_smiles'</span>] <span class="cf">for</span> r <span class="kw">in</span> results </span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> r[<span class="st">'passes_filters'</span>] <span class="kw">and</span> r[<span class="st">'canonical_smiles'</span>]]</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_validation_report(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generate a summary report of validation statistics."""</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> <span class="va">self</span>.validation_stats</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> stats[<span class="st">'total_processed'</span>]</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"No structures processed yet."</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>        report <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="ss">Validation Report:</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a><span class="ss">==================</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a><span class="ss">Total structures processed: </span><span class="sc">{</span>total<span class="sc">}</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="ss">Valid SMILES: </span><span class="sc">{</span>stats[<span class="st">'valid_smiles'</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>stats[<span class="st">'valid_smiles'</span>]<span class="op">/</span>total<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a><span class="ss">Chemically plausible: </span><span class="sc">{</span>stats[<span class="st">'chemically_plausible'</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>stats[<span class="st">'chemically_plausible'</span>]<span class="op">/</span>total<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)</span></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a><span class="ss">Passed all filters: </span><span class="sc">{</span>stats[<span class="st">'passed_filters'</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>stats[<span class="st">'passed_filters'</span>]<span class="op">/</span>total<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a><span class="ss">Success rate: </span><span class="sc">{</span>stats[<span class="st">'passed_filters'</span>]<span class="op">/</span>total<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> report.strip()</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstration with simulated LLM output</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"LLM Chemical Validator Demo"</span>)</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate a mix of good and problematic LLM-generated structures</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>llm_output <span class="op">=</span> [</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CCO"</span>,  <span class="co"># ethanol - should pass</span></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>,  <span class="co"># ibuprofen - should pass</span></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">"c1ccccc1"</span>,  <span class="co"># benzene - should pass</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">"invalidsmiles"</span>,  <span class="co"># invalid SMILES</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC"</span>,  <span class="co"># very long chain</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C1=CC=C(C=C1)C(=O)O"</span>,  <span class="co"># benzoic acid - should pass</span></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C[C@H](N)C(=O)O"</span>,  <span class="co"># alanine - should pass</span></span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C1CCC"</span>,  <span class="co"># invalid - unclosed ring</span></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CC(C)(C)(C)(C)C"</span>,  <span class="co"># too many bonds</span></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC"</span>,  <span class="co"># extremely long</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with normal mode</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing with Normal Mode:"</span>)</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>validator_normal <span class="op">=</span> LLMChemicalValidator(strict_mode<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>filtered_normal <span class="op">=</span> validator_normal.get_filtered_structures(llm_output)</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Input structures: </span><span class="sc">{</span><span class="bu">len</span>(llm_output)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Structures passing validation: </span><span class="sc">{</span><span class="bu">len</span>(filtered_normal)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Passed structures:"</span>)</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, smiles <span class="kw">in</span> <span class="bu">enumerate</span>(filtered_normal, <span class="dv">1</span>):</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">. </span><span class="sc">{</span>smiles<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(validator_normal.get_validation_report())</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with strict mode</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">40</span>)</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Testing with Strict Mode:"</span>)</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>validator_strict <span class="op">=</span> LLMChemicalValidator(strict_mode<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>filtered_strict <span class="op">=</span> validator_strict.get_filtered_structures(llm_output)</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Structures passing strict validation: </span><span class="sc">{</span><span class="bu">len</span>(filtered_strict)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(validator_strict.get_validation_report())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>LLM Chemical Validator Demo
========================================
Testing with Normal Mode:
Input structures: 10
Structures passing validation: 7

Passed structures:
1. CCO
2. CC(C)Cc1ccc(C(C)C(=O)O)cc1
3. c1ccccc1
4. CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
5. O=C(O)c1ccccc1
6. C[C@H](N)C(=O)O
7. CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
Validation Report:
==================
Total structures processed: 10
Valid SMILES: 7 (70.0%)
Chemically plausible: 7 (70.0%)
Passed all filters: 7 (70.0%)

Success rate: 70.0%

========================================
Testing with Strict Mode:
Structures passing strict validation: 5
Validation Report:
==================
Total structures processed: 10
Valid SMILES: 7 (70.0%)
Chemically plausible: 7 (70.0%)
Passed all filters: 5 (50.0%)

Success rate: 50.0%</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:53:54] SMILES Parse Error: syntax error while parsing: invalidsmiles
[09:53:54] SMILES Parse Error: check for mistakes around position 1:
[09:53:54] invalidsmiles
[09:53:54] ^
[09:53:54] SMILES Parse Error: Failed parsing SMILES 'invalidsmiles' for input: 'invalidsmiles'
[09:53:54] SMILES Parse Error: unclosed ring for input: 'C1CCC'
[09:53:54] Explicit valence for atom # 1 C, 6, is greater than permitted
[09:53:54] SMILES Parse Error: syntax error while parsing: invalidsmiles
[09:53:54] SMILES Parse Error: check for mistakes around position 1:
[09:53:54] invalidsmiles
[09:53:54] ^
[09:53:54] SMILES Parse Error: Failed parsing SMILES 'invalidsmiles' for input: 'invalidsmiles'
[09:53:54] SMILES Parse Error: unclosed ring for input: 'C1CCC'
[09:53:54] Explicit valence for atom # 1 C, 6, is greater than permitted</code></pre>
</div>
</div>
</section>
</section>
<section id="from-molecules-to-text-generating-rich-descriptions-for-llm-training" class="level1">
<h1>From Molecules to Text: Generating Rich Descriptions for LLM Training</h1>
<p>While validation is crucial for processing LLM outputs, the reverse direction - converting molecular structures into natural language descriptions - is equally important for training chemical AI systems and creating meaningful prompts. RDKit’s rich chemical analysis capabilities make it possible to generate detailed, chemically-informed text descriptions of molecules.</p>
<p>This approach is valuable for: - Creating training data for chemistry-focused LLMs - Building chemical chatbots with rich molecular knowledge - Making chemical databases more searchable with natural language - Generating explanatory text for chemical education applications</p>
<div id="75bff299" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_molecular_features(mol: Chem.Mol) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">any</span>]:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract comprehensive molecular features suitable for text generation.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This creates a rich feature dictionary that can be converted to natural language.</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mol <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {}</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Basic molecular properties</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> {</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">'smiles'</span>: Chem.MolToSmiles(mol),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'molecular_formula'</span>: rdMolDescriptors.CalcMolFormula(mol),</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">'molecular_weight'</span>: <span class="bu">round</span>(Descriptors.MolWt(mol), <span class="dv">2</span>),</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_atoms'</span>: mol.GetNumAtoms(),</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_heavy_atoms'</span>: mol.GetNumHeavyAtoms(),</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_bonds'</span>: mol.GetNumBonds(),</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ring and aromaticity information</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        features.update({</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_rings'</span>: rdMolDescriptors.CalcNumRings(mol),</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_aromatic_rings'</span>: rdMolDescriptors.CalcNumAromaticRings(mol),</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_saturated_rings'</span>: rdMolDescriptors.CalcNumSaturatedRings(mol),</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_aliphatic_rings'</span>: rdMolDescriptors.CalcNumAliphaticRings(mol),</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Physicochemical properties</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>        features.update({</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">'logp'</span>: <span class="bu">round</span>(Descriptors.MolLogP(mol), <span class="dv">2</span>),</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">'tpsa'</span>: <span class="bu">round</span>(Descriptors.TPSA(mol), <span class="dv">2</span>),</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">'h_bond_donors'</span>: Descriptors.NumHDonors(mol),</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">'h_bond_acceptors'</span>: Descriptors.NumHAcceptors(mol),</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rotatable_bonds'</span>: Descriptors.NumRotatableBonds(mol),</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Atom type counts</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        atom_counts <span class="op">=</span> {}</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> atom <span class="kw">in</span> mol.GetAtoms():</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>            symbol <span class="op">=</span> atom.GetSymbol()</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>            atom_counts[symbol] <span class="op">=</span> atom_counts.get(symbol, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        features[<span class="st">'atom_composition'</span>] <span class="op">=</span> atom_counts</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Functional group analysis (simplified)</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>        functional_groups <span class="op">=</span> []</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for common functional groups using SMARTS</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        fg_patterns <span class="op">=</span> {</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">'carboxylic_acid'</span>: <span class="st">'[CX3](=O)[OX2H1]'</span>,</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ester'</span>: <span class="st">'[#6][CX3](=O)[OX2H0][#6]'</span>,</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">'amide'</span>: <span class="st">'[CX3](=[OX1])[NX3H2]'</span>,</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">'alcohol'</span>: <span class="st">'[OX2H]'</span>,</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">'amine'</span>: <span class="st">'[NX3;H2,H1;!$(NC=O)]'</span>,</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ketone'</span>: <span class="st">'[#6][CX3](=O)[#6]'</span>,</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">'aldehyde'</span>: <span class="st">'[CX3H1](=O)[#6]'</span>,</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ether'</span>: <span class="st">'[OD2]([#6])[#6]'</span>,</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">'phenol'</span>: <span class="st">'[OX2H][cX3]:[c]'</span>,</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">'nitro'</span>: <span class="st">'[NX3+](=O)[O-]'</span>,</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">'aromatic_ring'</span>: <span class="st">'c1ccccc1'</span>,</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> fg_name, smarts <span class="kw">in</span> fg_patterns.items():</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>            pattern <span class="op">=</span> Chem.MolFromSmarts(smarts)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pattern <span class="kw">and</span> mol.HasSubstructMatch(pattern):</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>                matches <span class="op">=</span> mol.GetSubstructMatches(pattern)</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> matches:</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>                    functional_groups.append(<span class="ss">f"</span><span class="sc">{</span>fg_name<span class="sc">}</span><span class="ss">(</span><span class="sc">{</span><span class="bu">len</span>(matches)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>        features[<span class="st">'functional_groups'</span>] <span class="op">=</span> functional_groups</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Drug-likeness assessment</span></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>        lipinski_violations <span class="op">=</span> []</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> features[<span class="st">'molecular_weight'</span>] <span class="op">&gt;</span> <span class="dv">500</span>:</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>            lipinski_violations.append(<span class="st">'MW &gt; 500'</span>)</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> features[<span class="st">'logp'</span>] <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>            lipinski_violations.append(<span class="st">'LogP &gt; 5'</span>)</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> features[<span class="st">'h_bond_donors'</span>] <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>            lipinski_violations.append(<span class="st">'H-donors &gt; 5'</span>)</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> features[<span class="st">'h_bond_acceptors'</span>] <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>            lipinski_violations.append(<span class="st">'H-acceptors &gt; 10'</span>)</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>        features[<span class="st">'lipinski_violations'</span>] <span class="op">=</span> lipinski_violations</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>        features[<span class="st">'drug_like'</span>] <span class="op">=</span> <span class="bu">len</span>(lipinski_violations) <span class="op">&lt;=</span> <span class="dv">1</span></span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> features</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'error'</span>: <span class="ss">f"Feature extraction failed: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>}</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the function with some example molecules</span></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>test_molecules <span class="op">=</span> [</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CCO"</span>, <span class="st">"Ethanol"</span>),</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st">"Ibuprofen"</span>),</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"C1=CC=C(C=C1)C(=O)O"</span>, <span class="st">"Benzoic acid"</span>),</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CC(=O)OC1=CC=CC=C1C(=O)O"</span>, <span class="st">"Aspirin"</span>),</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CN1C=NC2=C1C(=O)N(C(=O)N2C)C"</span>, <span class="st">"Caffeine"</span>),</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Molecular Feature Extraction Examples:"</span>)</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> smiles, name <span class="kw">in</span> test_molecules:</span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>    mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> extract_molecular_features(mol)</span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>smiles<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Formula: </span><span class="sc">{</span>features<span class="sc">.</span>get(<span class="st">'molecular_formula'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MW: </span><span class="sc">{</span>features<span class="sc">.</span>get(<span class="st">'molecular_weight'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss"> Da"</span>)</span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  LogP: </span><span class="sc">{</span>features<span class="sc">.</span>get(<span class="st">'logp'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  TPSA: </span><span class="sc">{</span>features<span class="sc">.</span>get(<span class="st">'tpsa'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss"> Ų"</span>)</span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Rings: </span><span class="sc">{</span>features<span class="sc">.</span>get(<span class="st">'num_rings'</span>, <span class="dv">0</span>)<span class="sc">}</span><span class="ss"> (aromatic: </span><span class="sc">{</span>features<span class="sc">.</span>get(<span class="st">'num_aromatic_rings'</span>, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  H-bond donors/acceptors: </span><span class="sc">{</span>features<span class="sc">.</span>get(<span class="st">'h_bond_donors'</span>, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>features<span class="sc">.</span>get(<span class="st">'h_bond_acceptors'</span>, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Functional groups: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(features.get(<span class="st">'functional_groups'</span>, [])) <span class="kw">or</span> <span class="st">'None detected'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Drug-like: </span><span class="sc">{</span>features<span class="sc">.</span>get(<span class="st">'drug_like'</span>, <span class="va">False</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features.get(<span class="st">'lipinski_violations'</span>):</span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Lipinski violations: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(features[<span class="st">'lipinski_violations'</span>])<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Molecular Feature Extraction Examples:
==================================================

Ethanol (CCO):
  Formula: C2H6O
  MW: 46.07 Da
  LogP: -0.0
  TPSA: 20.23 Ų
  Rings: 0 (aromatic: 0)
  H-bond donors/acceptors: 1/1
  Functional groups: alcohol(1)
  Drug-like: True

Ibuprofen (CC(C)CC1=CC=C(C=C1)C(C)C(=O)O):
  Formula: C13H18O2
  MW: 206.28 Da
  LogP: 3.07
  TPSA: 37.3 Ų
  Rings: 1 (aromatic: 1)
  H-bond donors/acceptors: 1/1
  Functional groups: carboxylic_acid(1), alcohol(1), aromatic_ring(1)
  Drug-like: True

Benzoic acid (C1=CC=C(C=C1)C(=O)O):
  Formula: C7H6O2
  MW: 122.12 Da
  LogP: 1.38
  TPSA: 37.3 Ų
  Rings: 1 (aromatic: 1)
  H-bond donors/acceptors: 1/1
  Functional groups: carboxylic_acid(1), alcohol(1), aromatic_ring(1)
  Drug-like: True

Aspirin (CC(=O)OC1=CC=CC=C1C(=O)O):
  Formula: C9H8O4
  MW: 180.16 Da
  LogP: 1.31
  TPSA: 63.6 Ų
  Rings: 1 (aromatic: 1)
  H-bond donors/acceptors: 1/3
  Functional groups: carboxylic_acid(1), ester(1), alcohol(1), ether(1), aromatic_ring(1)
  Drug-like: True

Caffeine (CN1C=NC2=C1C(=O)N(C(=O)N2C)C):
  Formula: C8H10N4O2
  MW: 194.19 Da
  LogP: -1.03
  TPSA: 61.82 Ų
  Rings: 2 (aromatic: 2)
  H-bond donors/acceptors: 0/6
  Functional groups: None detected
  Drug-like: True</code></pre>
</div>
</div>
<section id="converting-features-to-natural-language" class="level2">
<h2 class="anchored" data-anchor-id="converting-features-to-natural-language">Converting Features to Natural Language</h2>
<p>Now let’s create functions that transform these molecular features into natural language descriptions suitable for LLM training:</p>
<div id="b6d004af" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_molecular_description(mol: Chem.Mol, style: <span class="bu">str</span> <span class="op">=</span> <span class="st">'detailed'</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate natural language descriptions of molecules in different styles.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">        mol: RDKit molecule object</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">        style: 'detailed', 'concise', 'technical', or 'educational'</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Natural language description of the molecule</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mol <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"Invalid molecule structure."</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> extract_molecular_features(mol)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'error'</span> <span class="kw">in</span> features:</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"Could not analyze molecule: </span><span class="sc">{</span>features[<span class="st">'error'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> style <span class="op">==</span> <span class="st">'concise'</span>:</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> _generate_concise_description(features)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> style <span class="op">==</span> <span class="st">'technical'</span>:</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> _generate_technical_description(features)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> style <span class="op">==</span> <span class="st">'educational'</span>:</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> _generate_educational_description(features)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># detailed</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> _generate_detailed_description(features)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _generate_concise_description(features: Dict) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate a brief, factual description."""</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    desc <span class="op">=</span> <span class="ss">f"This is </span><span class="sc">{</span>features[<span class="st">'molecular_formula'</span>]<span class="sc">}</span><span class="ss"> with molecular weight </span><span class="sc">{</span>features[<span class="st">'molecular_weight'</span>]<span class="sc">}</span><span class="ss"> Da."</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'functional_groups'</span>]:</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        fg_text <span class="op">=</span> <span class="st">', '</span>.join([fg.split(<span class="st">'('</span>)[<span class="dv">0</span>].replace(<span class="st">'_'</span>, <span class="st">' '</span>) <span class="cf">for</span> fg <span class="kw">in</span> features[<span class="st">'functional_groups'</span>]])</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        desc <span class="op">+=</span> <span class="ss">f" Contains </span><span class="sc">{</span>fg_text<span class="sc">}</span><span class="ss"> functional groups."</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> desc</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _generate_technical_description(features: Dict) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate a technical description with precise chemical language."""</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> []</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic structure</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    parts.append(<span class="ss">f"Molecular formula </span><span class="sc">{</span>features[<span class="st">'molecular_formula'</span>]<span class="sc">}</span><span class="ss"> (MW: </span><span class="sc">{</span>features[<span class="st">'molecular_weight'</span>]<span class="sc">}</span><span class="ss"> Da)"</span>)</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ring systems</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'num_rings'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>        ring_desc <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>features[<span class="st">'num_rings'</span>]<span class="sc">}</span><span class="ss"> ring(s)"</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> features[<span class="st">'num_aromatic_rings'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>            ring_desc <span class="op">+=</span> <span class="ss">f" including </span><span class="sc">{</span>features[<span class="st">'num_aromatic_rings'</span>]<span class="sc">}</span><span class="ss"> aromatic ring(s)"</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>        parts.append(ring_desc)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Physicochemical properties</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    parts.append(<span class="ss">f"LogP: </span><span class="sc">{</span>features[<span class="st">'logp'</span>]<span class="sc">}</span><span class="ss">, TPSA: </span><span class="sc">{</span>features[<span class="st">'tpsa'</span>]<span class="sc">}</span><span class="ss"> Ų"</span>)</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hydrogen bonding</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'h_bond_donors'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">or</span> features[<span class="st">'h_bond_acceptors'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="ss">f"H-bond donors: </span><span class="sc">{</span>features[<span class="st">'h_bond_donors'</span>]<span class="sc">}</span><span class="ss">, acceptors: </span><span class="sc">{</span>features[<span class="st">'h_bond_acceptors'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drug-likeness</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'drug_like'</span>]:</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="st">"Complies with Lipinski's Rule of Five"</span>)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> features[<span class="st">'lipinski_violations'</span>]:</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="ss">f"Violates Lipinski's Rule: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(features[<span class="st">'lipinski_violations'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">". "</span>.join(parts) <span class="op">+</span> <span class="st">"."</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _generate_detailed_description(features: Dict) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate a comprehensive description suitable for training data."""</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> []</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Introduction</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    parts.append(<span class="ss">f"This compound has the molecular formula </span><span class="sc">{</span>features[<span class="st">'molecular_formula'</span>]<span class="sc">}</span><span class="ss"> and a molecular weight of </span><span class="sc">{</span>features[<span class="st">'molecular_weight'</span>]<span class="sc">}</span><span class="ss"> daltons."</span>)</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Structural features</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>    structure_parts <span class="op">=</span> []</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'num_heavy_atoms'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>        structure_parts.append(<span class="ss">f"</span><span class="sc">{</span>features[<span class="st">'num_heavy_atoms'</span>]<span class="sc">}</span><span class="ss"> heavy atoms"</span>)</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'num_rings'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> features[<span class="st">'num_aromatic_rings'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> features[<span class="st">'num_saturated_rings'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>            structure_parts.append(<span class="ss">f"</span><span class="sc">{</span>features[<span class="st">'num_rings'</span>]<span class="sc">}</span><span class="ss"> rings (</span><span class="sc">{</span>features[<span class="st">'num_aromatic_rings'</span>]<span class="sc">}</span><span class="ss"> aromatic, </span><span class="sc">{</span>features[<span class="st">'num_saturated_rings'</span>]<span class="sc">}</span><span class="ss"> saturated)"</span>)</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> features[<span class="st">'num_aromatic_rings'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>            structure_parts.append(<span class="ss">f"</span><span class="sc">{</span>features[<span class="st">'num_aromatic_rings'</span>]<span class="sc">}</span><span class="ss"> aromatic ring(s)"</span>)</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>            structure_parts.append(<span class="ss">f"</span><span class="sc">{</span>features[<span class="st">'num_rings'</span>]<span class="sc">}</span><span class="ss"> saturated ring(s)"</span>)</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> structure_parts:</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="ss">f"The structure contains </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(structure_parts)<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Atom composition</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>    atoms <span class="op">=</span> features[<span class="st">'atom_composition'</span>]</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(atoms) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>        atom_desc <span class="op">=</span> []</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> atom, count <span class="kw">in</span> <span class="bu">sorted</span>(atoms.items()):</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> atom <span class="op">!=</span> <span class="st">'H'</span>:  <span class="co"># Skip hydrogen for brevity</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> count <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>                    atom_desc.append(<span class="ss">f"one </span><span class="sc">{</span>atom<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>                    atom_desc.append(<span class="ss">f"</span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>atom<span class="sc">}</span><span class="ss"> atoms"</span>)</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> atom_desc:</span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>            parts.append(<span class="ss">f"It is composed of </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(atom_desc)<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Functional groups</span></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'functional_groups'</span>]:</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>        fg_names <span class="op">=</span> [fg.split(<span class="st">'('</span>)[<span class="dv">0</span>].replace(<span class="st">'_'</span>, <span class="st">' '</span>) <span class="cf">for</span> fg <span class="kw">in</span> features[<span class="st">'functional_groups'</span>]]</span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(fg_names) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>            parts.append(<span class="ss">f"The molecule contains a </span><span class="sc">{</span>fg_names[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> functional group."</span>)</span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>            parts.append(<span class="ss">f"Functional groups present include </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(fg_names[:<span class="op">-</span><span class="dv">1</span>])<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>fg_names[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Physicochemical properties</span></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>    prop_desc <span class="op">=</span> []</span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'logp'</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> features[<span class="st">'logp'</span>] <span class="op">&gt;</span> <span class="dv">3</span>:</span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>            prop_desc.append(<span class="st">"lipophilic character"</span>)</span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> features[<span class="st">'logp'</span>] <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>            prop_desc.append(<span class="st">"hydrophilic nature"</span>)</span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>            prop_desc.append(<span class="st">"moderate lipophilicity"</span>)</span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'tpsa'</span>] <span class="op">&gt;</span> <span class="dv">90</span>:</span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>        prop_desc.append(<span class="st">"high polar surface area"</span>)</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> features[<span class="st">'tpsa'</span>] <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>        prop_desc.append(<span class="st">"low polar surface area"</span>)</span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prop_desc:</span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="ss">f"The compound exhibits </span><span class="sc">{</span><span class="st">' and '</span><span class="sc">.</span>join(prop_desc)<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drug-likeness assessment</span></span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'drug_like'</span>]:</span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="st">"This molecule satisfies Lipinski's Rule of Five, suggesting good oral bioavailability potential."</span>)</span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> features[<span class="st">'lipinski_violations'</span>]:</span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="ss">f"The compound violates Lipinski's Rule of Five due to </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(features[<span class="st">'lipinski_violations'</span>])<span class="sc">}</span><span class="ss">, which may affect its drug-like properties."</span>)</span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">" "</span>.join(parts)</span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _generate_educational_description(features: Dict) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate an educational description explaining chemical concepts."""</span></span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> []</span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start with basics</span></span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>    parts.append(<span class="ss">f"This molecule, with formula </span><span class="sc">{</span>features[<span class="st">'molecular_formula'</span>]<span class="sc">}</span><span class="ss">, is an organic compound weighing </span><span class="sc">{</span>features[<span class="st">'molecular_weight'</span>]<span class="sc">}</span><span class="ss"> daltons."</span>)</span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Explain ring systems in educational terms</span></span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'num_aromatic_rings'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="ss">f"It contains </span><span class="sc">{</span>features[<span class="st">'num_aromatic_rings'</span>]<span class="sc">}</span><span class="ss"> aromatic ring(s), which are stable ring structures with delocalized electrons that give the molecule special stability and chemical properties."</span>)</span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> features[<span class="st">'num_rings'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="ss">f"The molecule has </span><span class="sc">{</span>features[<span class="st">'num_rings'</span>]<span class="sc">}</span><span class="ss"> ring structure(s), which can affect its shape and biological activity."</span>)</span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Explain functional groups</span></span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'functional_groups'</span>]:</span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="st">"Functional groups are specific arrangements of atoms that give molecules their chemical reactivity."</span>)</span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a>        fg_explanations <span class="op">=</span> {</span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a>            <span class="st">'carboxylic_acid'</span>: <span class="st">"carboxylic acid groups (which can donate protons and are often acidic)"</span>,</span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>            <span class="st">'alcohol'</span>: <span class="st">"alcohol groups (which can form hydrogen bonds)"</span>,</span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a>            <span class="st">'amine'</span>: <span class="st">"amine groups (which are basic and can accept protons)"</span>,</span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ketone'</span>: <span class="st">"ketone groups (which are reactive carbonyl groups)"</span>,</span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ester'</span>: <span class="st">"ester groups (often found in fats and can be hydrolyzed)"</span>,</span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ether'</span>: <span class="st">"ether groups (which are generally unreactive)"</span></span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a>        explained_groups <span class="op">=</span> []</span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> fg <span class="kw">in</span> features[<span class="st">'functional_groups'</span>]:</span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a>            fg_name <span class="op">=</span> fg.split(<span class="st">'('</span>)[<span class="dv">0</span>]</span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> fg_name <span class="kw">in</span> fg_explanations:</span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a>                explained_groups.append(fg_explanations[fg_name])</span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> explained_groups:</span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a>            parts.append(<span class="ss">f"This molecule contains </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(explained_groups)<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Explain drug-likeness in simple terms</span></span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'drug_like'</span>]:</span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="st">"The molecule's size and properties suggest it could potentially be developed as an oral medication."</span>)</span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> features[<span class="st">'lipinski_violations'</span>]:</span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a>        parts.append(<span class="st">"The molecule is quite large or has properties that might make it challenging to develop as an oral drug."</span>)</span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">" "</span>.join(parts)</span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the different description styles</span></span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a>test_molecules <span class="op">=</span> [</span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st">"Ibuprofen"</span>),</span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CC(=O)OC1=CC=CC=C1C(=O)O"</span>, <span class="st">"Aspirin"</span>),</span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CN1C=NC2=C1C(=O)N(C(=O)N2C)C"</span>, <span class="st">"Caffeine"</span>),</span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a>styles <span class="op">=</span> [<span class="st">'concise'</span>, <span class="st">'technical'</span>, <span class="st">'detailed'</span>, <span class="st">'educational'</span>]</span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Natural Language Description Examples:"</span>)</span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> smiles, name <span class="kw">in</span> test_molecules:</span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a>    mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>smiles<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> (<span class="bu">len</span>(name) <span class="op">+</span> <span class="bu">len</span>(smiles) <span class="op">+</span> <span class="dv">4</span>))</span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> style <span class="kw">in</span> styles:</span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> generate_molecular_description(mol, style)</span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>style<span class="sc">.</span>title()<span class="sc">}</span><span class="ss"> style:"</span>)</span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(description)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Natural Language Description Examples:
============================================================

Ibuprofen (CC(C)CC1=CC=C(C=C1)C(C)C(=O)O):
------------------------------------------

Concise style:
This is C13H18O2 with molecular weight 206.28 Da. Contains carboxylic acid, alcohol, aromatic ring functional groups.

Technical style:
Molecular formula C13H18O2 (MW: 206.28 Da). 1 ring(s) including 1 aromatic ring(s). LogP: 3.07, TPSA: 37.3 Ų. H-bond donors: 1, acceptors: 1. Complies with Lipinski's Rule of Five.

Detailed style:
This compound has the molecular formula C13H18O2 and a molecular weight of 206.28 daltons. The structure contains 15 heavy atoms, 1 aromatic ring(s). It is composed of 13 C atoms, 2 O atoms. Functional groups present include carboxylic acid, alcohol and aromatic ring. The compound exhibits lipophilic character. This molecule satisfies Lipinski's Rule of Five, suggesting good oral bioavailability potential.

Educational style:
This molecule, with formula C13H18O2, is an organic compound weighing 206.28 daltons. It contains 1 aromatic ring(s), which are stable ring structures with delocalized electrons that give the molecule special stability and chemical properties. Functional groups are specific arrangements of atoms that give molecules their chemical reactivity. This molecule contains carboxylic acid groups (which can donate protons and are often acidic), alcohol groups (which can form hydrogen bonds). The molecule's size and properties suggest it could potentially be developed as an oral medication.

Aspirin (CC(=O)OC1=CC=CC=C1C(=O)O):
-----------------------------------

Concise style:
This is C9H8O4 with molecular weight 180.16 Da. Contains carboxylic acid, ester, alcohol, ether, aromatic ring functional groups.

Technical style:
Molecular formula C9H8O4 (MW: 180.16 Da). 1 ring(s) including 1 aromatic ring(s). LogP: 1.31, TPSA: 63.6 Ų. H-bond donors: 1, acceptors: 3. Complies with Lipinski's Rule of Five.

Detailed style:
This compound has the molecular formula C9H8O4 and a molecular weight of 180.16 daltons. The structure contains 13 heavy atoms, 1 aromatic ring(s). It is composed of 9 C atoms, 4 O atoms. Functional groups present include carboxylic acid, ester, alcohol, ether and aromatic ring. The compound exhibits moderate lipophilicity. This molecule satisfies Lipinski's Rule of Five, suggesting good oral bioavailability potential.

Educational style:
This molecule, with formula C9H8O4, is an organic compound weighing 180.16 daltons. It contains 1 aromatic ring(s), which are stable ring structures with delocalized electrons that give the molecule special stability and chemical properties. Functional groups are specific arrangements of atoms that give molecules their chemical reactivity. This molecule contains carboxylic acid groups (which can donate protons and are often acidic), ester groups (often found in fats and can be hydrolyzed), alcohol groups (which can form hydrogen bonds), ether groups (which are generally unreactive). The molecule's size and properties suggest it could potentially be developed as an oral medication.

Caffeine (CN1C=NC2=C1C(=O)N(C(=O)N2C)C):
----------------------------------------

Concise style:
This is C8H10N4O2 with molecular weight 194.19 Da.

Technical style:
Molecular formula C8H10N4O2 (MW: 194.19 Da). 2 ring(s) including 2 aromatic ring(s). LogP: -1.03, TPSA: 61.82 Ų. H-bond donors: 0, acceptors: 6. Complies with Lipinski's Rule of Five.

Detailed style:
This compound has the molecular formula C8H10N4O2 and a molecular weight of 194.19 daltons. The structure contains 14 heavy atoms, 2 aromatic ring(s). It is composed of 8 C atoms, 4 N atoms, 2 O atoms. The compound exhibits hydrophilic nature. This molecule satisfies Lipinski's Rule of Five, suggesting good oral bioavailability potential.

Educational style:
This molecule, with formula C8H10N4O2, is an organic compound weighing 194.19 daltons. It contains 2 aromatic ring(s), which are stable ring structures with delocalized electrons that give the molecule special stability and chemical properties. The molecule's size and properties suggest it could potentially be developed as an oral medication.</code></pre>
</div>
</div>
</section>
<section id="creating-structured-training-data" class="level2">
<h2 class="anchored" data-anchor-id="creating-structured-training-data">Creating Structured Training Data</h2>
<p>For training LLMs, you often need structured datasets that pair chemical structures with their descriptions. Here’s how to create such datasets systematically:</p>
<div id="c7546d06" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_molecule_text_dataset(smiles_list: List[<span class="bu">str</span>], </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                                names: Optional[List[<span class="bu">str</span>]] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                include_multiple_styles: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> List[Dict[<span class="bu">str</span>, <span class="bu">str</span>]]:</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a structured dataset pairing molecules with text descriptions.</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Suitable for fine-tuning LLMs on chemical tasks.</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">        smiles_list: List of SMILES strings</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">        names: Optional list of molecule names</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">        include_multiple_styles: Whether to generate multiple description styles</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">        List of dictionaries with 'structure', 'description', and metadata</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> []</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, smiles <span class="kw">in</span> <span class="bu">enumerate</span>(smiles_list):</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mol <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span>  <span class="co"># Skip invalid molecules</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> names[i] <span class="cf">if</span> names <span class="kw">and</span> i <span class="op">&lt;</span> <span class="bu">len</span>(names) <span class="cf">else</span> <span class="ss">f"Compound_</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        canonical_smiles <span class="op">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> include_multiple_styles:</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>            styles <span class="op">=</span> [<span class="st">'concise'</span>, <span class="st">'technical'</span>, <span class="st">'detailed'</span>, <span class="st">'educational'</span>]</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>            styles <span class="op">=</span> [<span class="st">'detailed'</span>]</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> style <span class="kw">in</span> styles:</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>            description <span class="op">=</span> generate_molecular_description(mol, style)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create training example in various formats</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Format 1: Direct description</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            dataset.append({</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">'task_type'</span>: <span class="st">'molecule_description'</span>,</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">'style'</span>: style,</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">'input_smiles'</span>: smiles,</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">'canonical_smiles'</span>: canonical_smiles,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">'molecule_name'</span>: name,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">'description'</span>: description,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">'prompt'</span>: <span class="ss">f"Describe the chemical structure </span><span class="sc">{</span>canonical_smiles<span class="sc">}</span><span class="ss">:"</span>,</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">'response'</span>: description</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Format 2: Question-answer format</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>            dataset.append({</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>                <span class="st">'task_type'</span>: <span class="st">'chemical_qa'</span>,</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>                <span class="st">'style'</span>: style,</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">'input_smiles'</span>: smiles,</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">'canonical_smiles'</span>: canonical_smiles,</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">'molecule_name'</span>: name,</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>                <span class="st">'description'</span>: description,</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>                <span class="st">'prompt'</span>: <span class="ss">f"What can you tell me about the molecule with SMILES </span><span class="sc">{</span>canonical_smiles<span class="sc">}</span><span class="ss">?"</span>,</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>                <span class="st">'response'</span>: description</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Format 3: Named molecule description</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> name <span class="op">!=</span> <span class="ss">f"Compound_</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>:</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>                dataset.append({</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'task_type'</span>: <span class="st">'named_molecule_description'</span>,</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'style'</span>: style,</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'input_smiles'</span>: smiles,</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'canonical_smiles'</span>: canonical_smiles,</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'molecule_name'</span>: name,</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'description'</span>: description,</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'prompt'</span>: <span class="ss">f"Describe the chemical structure and properties of </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">:"</span>,</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'response'</span>: <span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>canonical_smiles<span class="sc">}</span><span class="ss">) is a compound where </span><span class="sc">{</span>description<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataset</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_property_prediction_dataset(smiles_list: List[<span class="bu">str</span>], </span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>                                     target_properties: List[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> List[Dict[<span class="bu">str</span>, <span class="bu">str</span>]]:</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a dataset for training property prediction with natural language explanations.</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> target_properties <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>        target_properties <span class="op">=</span> [<span class="st">'molecular_weight'</span>, <span class="st">'logp'</span>, <span class="st">'h_bond_donors'</span>, <span class="st">'h_bond_acceptors'</span>, <span class="st">'drug_like'</span>]</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> []</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> smiles <span class="kw">in</span> smiles_list:</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>        mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mol <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> extract_molecular_features(mol)</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>        canonical_smiles <span class="op">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> prop <span class="kw">in</span> target_properties:</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prop <span class="kw">in</span> features:</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>                value <span class="op">=</span> features[prop]</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create natural language explanations for properties</span></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> prop <span class="op">==</span> <span class="st">'molecular_weight'</span>:</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>                    explanation <span class="op">=</span> <span class="ss">f"The molecular weight is </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss"> daltons, which "</span></span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> value <span class="op">&lt;</span> <span class="dv">200</span>:</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>                        explanation <span class="op">+=</span> <span class="st">"indicates a relatively small molecule."</span></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> value <span class="op">&gt;</span> <span class="dv">500</span>:</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>                        explanation <span class="op">+=</span> <span class="st">"suggests a large molecule that may have bioavailability issues."</span></span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>                        explanation <span class="op">+=</span> <span class="st">"is in a reasonable range for drug-like compounds."</span></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> prop <span class="op">==</span> <span class="st">'logp'</span>:</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>                    explanation <span class="op">=</span> <span class="ss">f"The LogP value is </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">, indicating "</span></span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> value <span class="op">&gt;</span> <span class="dv">3</span>:</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>                        explanation <span class="op">+=</span> <span class="st">"high lipophilicity and potential membrane permeability."</span></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> value <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>                        explanation <span class="op">+=</span> <span class="st">"hydrophilic character and good water solubility."</span></span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>                        explanation <span class="op">+=</span> <span class="st">"balanced lipophilicity suitable for oral drugs."</span></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> prop <span class="op">==</span> <span class="st">'h_bond_donors'</span>:</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>                    explanation <span class="op">=</span> <span class="ss">f"This molecule has </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss"> hydrogen bond donor(s), which "</span></span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> value <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>                        explanation <span class="op">+=</span> <span class="st">"means it cannot donate hydrogen bonds."</span></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> value <span class="op">&lt;=</span> <span class="dv">5</span>:</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>                        explanation <span class="op">+=</span> <span class="st">"is within the acceptable range for drug-like molecules."</span></span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>                        explanation <span class="op">+=</span> <span class="st">"may limit its ability to cross biological membranes."</span></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> prop <span class="op">==</span> <span class="st">'drug_like'</span>:</span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a>                    explanation <span class="op">=</span> <span class="ss">f"This molecule </span><span class="sc">{</span><span class="st">'is'</span> <span class="cf">if</span> value <span class="cf">else</span> <span class="st">'is not'</span><span class="sc">}</span><span class="ss"> drug-like according to Lipinski's Rule of Five."</span></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>                    explanation <span class="op">=</span> <span class="ss">f"The </span><span class="sc">{</span>prop<span class="sc">.</span>replace(<span class="st">'_'</span>, <span class="st">' '</span>)<span class="sc">}</span><span class="ss"> value is </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>                dataset.append({</span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'task_type'</span>: <span class="st">'property_prediction'</span>,</span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'property'</span>: prop,</span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'input_smiles'</span>: smiles,</span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'canonical_smiles'</span>: canonical_smiles,</span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'property_value'</span>: value,</span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'prompt'</span>: <span class="ss">f"What is the </span><span class="sc">{</span>prop<span class="sc">.</span>replace(<span class="st">'_'</span>, <span class="st">' '</span>)<span class="sc">}</span><span class="ss"> of </span><span class="sc">{</span>canonical_smiles<span class="sc">}</span><span class="ss">?"</span>,</span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'response'</span>: <span class="ss">f"</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'explanation'</span>: explanation,</span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'detailed_response'</span>: <span class="ss">f"The </span><span class="sc">{</span>prop<span class="sc">.</span>replace(<span class="st">'_'</span>, <span class="st">' '</span>)<span class="sc">}</span><span class="ss"> of </span><span class="sc">{</span>canonical_smiles<span class="sc">}</span><span class="ss"> is </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">. </span><span class="sc">{</span>explanation<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataset</span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Create training datasets</span></span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>example_molecules <span class="op">=</span> [</span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CCO"</span>, <span class="st">"Ethanol"</span>),</span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st">"Ibuprofen"</span>),</span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CC(=O)OC1=CC=CC=C1C(=O)O"</span>, <span class="st">"Aspirin"</span>),</span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CN1C=NC2=C1C(=O)N(C(=O)N2C)C"</span>, <span class="st">"Caffeine"</span>),</span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"CC1=CC=C(C=C1)C(C)C(=O)O"</span>, <span class="st">"2-(4-methylphenyl)propanoic acid"</span>),</span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a>smiles_only <span class="op">=</span> [mol[<span class="dv">0</span>] <span class="cf">for</span> mol <span class="kw">in</span> example_molecules]</span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a>names_only <span class="op">=</span> [mol[<span class="dv">1</span>] <span class="cf">for</span> mol <span class="kw">in</span> example_molecules]</span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Creating Molecule-Text Dataset..."</span>)</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a>mol_text_data <span class="op">=</span> create_molecule_text_dataset(smiles_only, names_only, include_multiple_styles<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Generated </span><span class="sc">{</span><span class="bu">len</span>(mol_text_data)<span class="sc">}</span><span class="ss"> training examples"</span>)</span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Example training entries:"</span>)</span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Show a few examples</span></span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, entry <span class="kw">in</span> <span class="bu">enumerate</span>(mol_text_data[:<span class="dv">3</span>]):</span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Example </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Task: </span><span class="sc">{</span>entry[<span class="st">'task_type'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Molecule: </span><span class="sc">{</span>entry[<span class="st">'molecule_name'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Prompt: </span><span class="sc">{</span>entry[<span class="st">'prompt'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Response: </span><span class="sc">{</span>entry[<span class="st">'response'</span>][:<span class="dv">100</span>]<span class="sc">}{</span><span class="st">'...'</span> <span class="cf">if</span> <span class="bu">len</span>(entry[<span class="st">'response'</span>]) <span class="op">&gt;</span> <span class="dv">100</span> <span class="cf">else</span> <span class="st">''</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Creating Property Prediction Dataset..."</span>)</span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a>prop_data <span class="op">=</span> create_property_prediction_dataset(smiles_only[:<span class="dv">3</span>])</span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Generated </span><span class="sc">{</span><span class="bu">len</span>(prop_data)<span class="sc">}</span><span class="ss"> property prediction examples"</span>)</span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Example property prediction entries:"</span>)</span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, entry <span class="kw">in</span> <span class="bu">enumerate</span>(prop_data[:<span class="dv">3</span>]):</span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Example </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Property: </span><span class="sc">{</span>entry[<span class="st">'property'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Molecule: </span><span class="sc">{</span>entry[<span class="st">'canonical_smiles'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Prompt: </span><span class="sc">{</span>entry[<span class="st">'prompt'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Response: </span><span class="sc">{</span>entry[<span class="st">'detailed_response'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating Molecule-Text Dataset...
Generated 15 training examples

Example training entries:
==================================================

Example 1:
Task: molecule_description
Molecule: Ethanol
Prompt: Describe the chemical structure CCO:
Response: This compound has the molecular formula C2H6O and a molecular weight of 46.07 daltons. The structure...

Example 2:
Task: chemical_qa
Molecule: Ethanol
Prompt: What can you tell me about the molecule with SMILES CCO?
Response: This compound has the molecular formula C2H6O and a molecular weight of 46.07 daltons. The structure...

Example 3:
Task: named_molecule_description
Molecule: Ethanol
Prompt: Describe the chemical structure and properties of Ethanol:
Response: Ethanol (CCO) is a compound where this compound has the molecular formula c2h6o and a molecular weig...

==================================================
Creating Property Prediction Dataset...
Generated 15 property prediction examples

Example property prediction entries:

Example 1:
Property: molecular_weight
Molecule: CCO
Prompt: What is the molecular weight of CCO?
Response: The molecular weight of CCO is 46.07. The molecular weight is 46.07 daltons, which indicates a relatively small molecule.

Example 2:
Property: logp
Molecule: CCO
Prompt: What is the logp of CCO?
Response: The logp of CCO is -0.0. The LogP value is -0.0, indicating balanced lipophilicity suitable for oral drugs.

Example 3:
Property: h_bond_donors
Molecule: CCO
Prompt: What is the h bond donors of CCO?
Response: The h bond donors of CCO is 1. This molecule has 1 hydrogen bond donor(s), which is within the acceptable range for drug-like molecules.</code></pre>
</div>
</div>
</section>
<section id="exporting-data-for-different-llm-platforms" class="level2">
<h2 class="anchored" data-anchor-id="exporting-data-for-different-llm-platforms">Exporting Data for Different LLM Platforms</h2>
<p>Different LLM training platforms expect different data formats. Here are functions to export your chemical training data in common formats:</p>
<div id="9dfb0c05" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> export_for_huggingface(dataset: List[Dict], output_file: <span class="bu">str</span> <span class="op">=</span> <span class="st">"chemical_training_data.jsonl"</span>):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Export dataset in HuggingFace datasets format (JSONL).</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Each line is a JSON object with 'text' field for language modeling</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">    or 'input'/'output' fields for instruction tuning.</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_file, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> dataset:</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Format for instruction tuning</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>            hf_entry <span class="op">=</span> {</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">'instruction'</span>: entry[<span class="st">'prompt'</span>],</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">'input'</span>: entry.get(<span class="st">'canonical_smiles'</span>, <span class="st">''</span>),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">'output'</span>: entry[<span class="st">'response'</span>],</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">'metadata'</span>: {</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'task_type'</span>: entry.get(<span class="st">'task_type'</span>, <span class="st">''</span>),</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'molecule_name'</span>: entry.get(<span class="st">'molecule_name'</span>, <span class="st">''</span>),</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'style'</span>: entry.get(<span class="st">'style'</span>, <span class="st">''</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>            f.write(json.dumps(hf_entry) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Exported </span><span class="sc">{</span><span class="bu">len</span>(dataset)<span class="sc">}</span><span class="ss"> entries to </span><span class="sc">{</span>output_file<span class="sc">}</span><span class="ss"> (HuggingFace format)"</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> export_for_openai(dataset: List[Dict], output_file: <span class="bu">str</span> <span class="op">=</span> <span class="st">"chemical_training_data_openai.jsonl"</span>):</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Export dataset in OpenAI fine-tuning format.</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Each line has 'messages' with system/user/assistant format.</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_file, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> dataset:</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>            openai_entry <span class="op">=</span> {</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">'messages'</span>: [</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>                    {</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'role'</span>: <span class="st">'system'</span>,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'content'</span>: <span class="st">'You are a helpful chemistry assistant that can analyze and describe chemical structures.'</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>                    },</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>                    {</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'role'</span>: <span class="st">'user'</span>, </span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'content'</span>: entry[<span class="st">'prompt'</span>]</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>                    },</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>                    {</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'role'</span>: <span class="st">'assistant'</span>,</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'content'</span>: entry[<span class="st">'response'</span>]</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>            f.write(json.dumps(openai_entry) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Exported </span><span class="sc">{</span><span class="bu">len</span>(dataset)<span class="sc">}</span><span class="ss"> entries to </span><span class="sc">{</span>output_file<span class="sc">}</span><span class="ss"> (OpenAI format)"</span>)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> export_for_llama(dataset: List[Dict], output_file: <span class="bu">str</span> <span class="op">=</span> <span class="st">"chemical_training_data_llama.json"</span>):</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a><span class="co">    Export dataset in LLaMA/Alpaca instruction format.</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    llama_data <span class="op">=</span> []</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entry <span class="kw">in</span> dataset:</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>        llama_entry <span class="op">=</span> {</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">'instruction'</span>: entry[<span class="st">'prompt'</span>],</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">'input'</span>: entry.get(<span class="st">'canonical_smiles'</span>, <span class="st">''</span>),</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">'output'</span>: entry[<span class="st">'response'</span>]</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>        llama_data.append(llama_entry)</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_file, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>        json.dump(llama_data, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Exported </span><span class="sc">{</span><span class="bu">len</span>(dataset)<span class="sc">}</span><span class="ss"> entries to </span><span class="sc">{</span>output_file<span class="sc">}</span><span class="ss"> (LLaMA/Alpaca format)"</span>)</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_conversational_dataset(smiles_list: List[<span class="bu">str</span>], names: List[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a conversational dataset simulating a chemistry chatbot interaction.</span></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>    conversations <span class="op">=</span> []</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, smiles <span class="kw">in</span> <span class="bu">enumerate</span>(smiles_list):</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>        mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mol <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> names[i] <span class="cf">if</span> names <span class="kw">and</span> i <span class="op">&lt;</span> <span class="bu">len</span>(names) <span class="cf">else</span> <span class="ss">f"Compound_</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> extract_molecular_features(mol)</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a multi-turn conversation</span></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>        conversation <span class="op">=</span> {</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">'conversation_id'</span>: <span class="ss">f"chem_chat_</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">'molecule_smiles'</span>: smiles,</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>            <span class="st">'molecule_name'</span>: name,</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>            <span class="st">'turns'</span>: []</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Turn 1: Initial structure inquiry</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>        conversation[<span class="st">'turns'</span>].append({</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>            <span class="st">'user'</span>: <span class="ss">f"Can you analyze the structure </span><span class="sc">{</span>smiles<span class="sc">}</span><span class="ss">?"</span>,</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>            <span class="st">'assistant'</span>: generate_molecular_description(mol, <span class="st">'detailed'</span>)</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Turn 2: Property question</span></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> features.get(<span class="st">'molecular_weight'</span>):</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>            conversation[<span class="st">'turns'</span>].append({</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>                <span class="st">'user'</span>: <span class="st">"What's its molecular weight?"</span>,</span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>                <span class="st">'assistant'</span>: <span class="ss">f"The molecular weight is </span><span class="sc">{</span>features[<span class="st">'molecular_weight'</span>]<span class="sc">}</span><span class="ss"> daltons."</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Turn 3: Drug-likeness question</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>        conversation[<span class="st">'turns'</span>].append({</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>            <span class="st">'user'</span>: <span class="st">"Would this be a good drug candidate?"</span>,</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>            <span class="st">'assistant'</span>: <span class="ss">f"</span><span class="sc">{</span><span class="st">'Yes'</span> <span class="cf">if</span> features<span class="sc">.</span>get(<span class="st">'drug_like'</span>) <span class="cf">else</span> <span class="st">'It may face challenges'</span><span class="sc">}</span><span class="ss">, this molecule </span><span class="sc">{</span><span class="st">'complies with'</span> <span class="cf">if</span> features<span class="sc">.</span>get(<span class="st">'drug_like'</span>) <span class="cf">else</span> <span class="st">'violates'</span><span class="sc">}</span><span class="ss"> Lipinski's Rule of Five. </span><span class="sc">{</span>generate_molecular_description(mol, <span class="st">'educational'</span>)<span class="sc">.</span>split(<span class="st">'.'</span>)[<span class="op">-</span><span class="dv">2</span>]<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>        conversations.append(conversation)</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> conversations</span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate the export functions</span></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Exporting Training Data in Different Formats:"</span>)</span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the previously created dataset</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>sample_dataset <span class="op">=</span> mol_text_data[:<span class="dv">5</span>]  <span class="co"># Use a small sample for demonstration</span></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Export in different formats</span></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>export_for_huggingface(sample_dataset, <span class="st">"demo_huggingface.jsonl"</span>)</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>export_for_openai(sample_dataset, <span class="st">"demo_openai.jsonl"</span>) </span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>export_for_llama(sample_dataset, <span class="st">"demo_llama.json"</span>)</span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and show conversational dataset</span></span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Creating Conversational Dataset:"</span>)</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>conv_data <span class="op">=</span> create_conversational_dataset(smiles_only[:<span class="dv">2</span>], names_only[:<span class="dv">2</span>])</span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Generated </span><span class="sc">{</span><span class="bu">len</span>(conv_data)<span class="sc">}</span><span class="ss"> conversations"</span>)</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Example conversation:"</span>)</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">30</span>)</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, turn <span class="kw">in</span> <span class="bu">enumerate</span>(conv_data[<span class="dv">0</span>][<span class="st">'turns'</span>]):</span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Turn </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"User: </span><span class="sc">{</span>turn[<span class="st">'user'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Assistant: </span><span class="sc">{</span>turn[<span class="st">'assistant'</span>][:<span class="dv">100</span>]<span class="sc">}{</span><span class="st">'...'</span> <span class="cf">if</span> <span class="bu">len</span>(turn[<span class="st">'assistant'</span>]) <span class="op">&gt;</span> <span class="dv">100</span> <span class="cf">else</span> <span class="st">''</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Show file contents (first few lines)</span></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sample exported data:"</span>)</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">30</span>)</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"demo_huggingface.jsonl"</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>        lines <span class="op">=</span> f.readlines()[:<span class="dv">2</span>]</span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, line <span class="kw">in</span> <span class="bu">enumerate</span>(lines):</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Entry </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>line[:<span class="dv">100</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Demo files not created (running in demo mode)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Exporting Training Data in Different Formats:
==================================================
Exported 5 entries to demo_huggingface.jsonl (HuggingFace format)
Exported 5 entries to demo_openai.jsonl (OpenAI format)
Exported 5 entries to demo_llama.json (LLaMA/Alpaca format)

Creating Conversational Dataset:
Generated 2 conversations

Example conversation:
==============================
Turn 1:
User: Can you analyze the structure CCO?
Assistant: This compound has the molecular formula C2H6O and a molecular weight of 46.07 daltons. The structure...

Turn 2:
User: What's its molecular weight?
Assistant: The molecular weight is 46.07 daltons.

Turn 3:
User: Would this be a good drug candidate?
Assistant: Yes, this molecule complies with Lipinski's Rule of Five.  The molecule's size and properties sugges...

Sample exported data:
------------------------------
Entry 1: {"instruction": "Describe the chemical structure CCO:", "input": "CCO", "output": "This compound has...
Entry 2: {"instruction": "What can you tell me about the molecule with SMILES CCO?", "input": "CCO", "output"...</code></pre>
</div>
</div>
</section>
</section>
<section id="real-world-challenges-and-solutions" class="level1">
<h1>Real-World Challenges and Solutions</h1>
<p>While the integration of RDKit and LLMs offers exciting possibilities, real-world implementations face several challenges. This section addresses common issues and provides practical solutions based on experience with production systems.</p>
<section id="challenge-1-performance-and-scalability" class="level2">
<h2 class="anchored" data-anchor-id="challenge-1-performance-and-scalability">Challenge 1: Performance and Scalability</h2>
<p>When processing large datasets or building real-time applications, performance becomes critical. Let’s explore strategies for optimization:</p>
<div id="d4ba7253" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing <span class="im">as</span> mp</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ProcessPoolExecutor, ThreadPoolExecutor</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> lru_cache</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OptimizedChemicalProcessor:</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">    An optimized processor for handling large-scale chemical data processing</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">    with RDKit and LLM integration.</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, max_workers: <span class="bu">int</span> <span class="op">=</span> <span class="va">None</span>, use_caching: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_workers <span class="op">=</span> max_workers <span class="kw">or</span> mp.cpu_count()</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_caching <span class="op">=</span> use_caching</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pre-compile common SMARTS patterns for efficiency</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.functional_group_patterns <span class="op">=</span> {</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>            name: Chem.MolFromSmarts(smarts) <span class="cf">for</span> name, smarts <span class="kw">in</span> {</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">'carboxylic_acid'</span>: <span class="st">'[CX3](=O)[OX2H1]'</span>,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ester'</span>: <span class="st">'[#6][CX3](=O)[OX2H0][#6]'</span>,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">'alcohol'</span>: <span class="st">'[OX2H]'</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">'amine'</span>: <span class="st">'[NX3;H2,H1;!$(NC=O)]'</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ketone'</span>: <span class="st">'[#6][CX3](=O)[#6]'</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">'aromatic_ring'</span>: <span class="st">'c1ccccc1'</span>,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>            }.items()</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@lru_cache</span>(maxsize<span class="op">=</span><span class="dv">10000</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cached_mol_from_smiles(<span class="va">self</span>, smiles: <span class="bu">str</span>):</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Cached molecule parsing to avoid repeated work."""</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_smiles_batch_parallel(<span class="va">self</span>, smiles_list: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="co">        Process a batch of SMILES in parallel for better performance.</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use ProcessPoolExecutor for CPU-bound tasks</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> ProcessPoolExecutor(max_workers<span class="op">=</span><span class="va">self</span>.max_workers) <span class="im">as</span> executor:</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Split into chunks to reduce overhead</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>            chunk_size <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(smiles_list) <span class="op">//</span> (<span class="va">self</span>.max_workers <span class="op">*</span> <span class="dv">4</span>))</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>            chunks <span class="op">=</span> [smiles_list[i:i <span class="op">+</span> chunk_size] </span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(smiles_list), chunk_size)]</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process chunks in parallel</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>            futures <span class="op">=</span> [executor.submit(<span class="va">self</span>._process_chunk, chunk) <span class="cf">for</span> chunk <span class="kw">in</span> chunks]</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>            results <span class="op">=</span> []</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> future <span class="kw">in</span> futures:</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>                results.extend(future.result())</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _process_chunk(<span class="va">self</span>, smiles_chunk: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Process a chunk of SMILES strings."""</span></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> smiles <span class="kw">in</span> smiles_chunk:</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.use_caching:</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>                    mol <span class="op">=</span> <span class="va">self</span>.cached_mol_from_smiles(smiles)</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>                    mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> mol:</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>                    features <span class="op">=</span> <span class="va">self</span>._extract_features_optimized(mol)</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>                    features[<span class="st">'smiles'</span>] <span class="op">=</span> smiles</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>                    results.append(features)</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>                    results.append({<span class="st">'smiles'</span>: smiles, <span class="st">'error'</span>: <span class="st">'Invalid SMILES'</span>})</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>                results.append({<span class="st">'smiles'</span>: smiles, <span class="st">'error'</span>: <span class="bu">str</span>(e)})</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _extract_features_optimized(<span class="va">self</span>, mol: Chem.Mol) <span class="op">-&gt;</span> Dict:</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Optimized feature extraction focusing on essential properties."""</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only calculate the most important features to save time</span></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>            features <span class="op">=</span> {</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>                <span class="st">'molecular_weight'</span>: <span class="bu">round</span>(Descriptors.MolWt(mol), <span class="dv">2</span>),</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>                <span class="st">'logp'</span>: <span class="bu">round</span>(Descriptors.MolLogP(mol), <span class="dv">2</span>),</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>                <span class="st">'num_atoms'</span>: mol.GetNumAtoms(),</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>                <span class="st">'num_rings'</span>: rdMolDescriptors.CalcNumRings(mol),</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>                <span class="st">'h_bond_donors'</span>: Descriptors.NumHDonors(mol),</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>                <span class="st">'h_bond_acceptors'</span>: Descriptors.NumHAcceptors(mol),</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fast functional group detection using pre-compiled patterns</span></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>            functional_groups <span class="op">=</span> []</span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> fg_name, pattern <span class="kw">in</span> <span class="va">self</span>.functional_group_patterns.items():</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> mol.HasSubstructMatch(pattern):</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>                    functional_groups.append(fg_name)</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>            features[<span class="st">'functional_groups'</span>] <span class="op">=</span> functional_groups</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> features</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">'error'</span>: <span class="ss">f'Feature extraction failed: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Performance comparison demonstration</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> benchmark_processing_methods():</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compare different processing approaches for performance."""</span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate test data</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>    test_smiles <span class="op">=</span> [</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CCO"</span>, <span class="st">"c1ccccc1"</span>, <span class="st">"CC(C)CC1=CC=C(C=C1)C(C)C(=O)O"</span>,</span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CN1C=NC2=C1C(=O)N(C(=O)N2C)C"</span>, <span class="st">"CC(=O)OC1=CC=CC=C1C(=O)O"</span></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>    ] <span class="op">*</span> <span class="dv">200</span>  <span class="co"># 1000 molecules for testing</span></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>    processor <span class="op">=</span> OptimizedChemicalProcessor()</span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Performance Benchmark:"</span>)</span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 1: Sequential processing</span></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>    sequential_results <span class="op">=</span> []</span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> smiles <span class="kw">in</span> test_smiles:</span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a>        mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mol:</span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>            features <span class="op">=</span> extract_molecular_features(mol)</span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>            sequential_results.append(features)</span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>    sequential_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 2: Parallel processing</span></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>    parallel_results <span class="op">=</span> processor.process_smiles_batch_parallel(test_smiles)</span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>    parallel_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 3: Cached processing</span></span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>    cached_results <span class="op">=</span> []</span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> smiles <span class="kw">in</span> test_smiles:</span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>        mol <span class="op">=</span> processor.cached_mol_from_smiles(smiles)</span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mol:</span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a>            features <span class="op">=</span> processor._extract_features_optimized(mol)</span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a>            cached_results.append(features)</span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a>    cached_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Sequential processing: </span><span class="sc">{</span>sequential_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Parallel processing: </span><span class="sc">{</span>parallel_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cached processing: </span><span class="sc">{</span>cached_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Speedup (parallel): </span><span class="sc">{</span>sequential_time<span class="op">/</span>parallel_time<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Speedup (cached): </span><span class="sc">{</span>sequential_time<span class="op">/</span>cached_time<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify results are consistent</span></span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Results consistency check:"</span>)</span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Sequential results: </span><span class="sc">{</span><span class="bu">len</span>(sequential_results)<span class="sc">}</span><span class="ss"> molecules processed"</span>)</span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Parallel results: </span><span class="sc">{</span><span class="bu">len</span>([r <span class="cf">for</span> r <span class="kw">in</span> parallel_results <span class="cf">if</span> <span class="st">'error'</span> <span class="kw">not</span> <span class="kw">in</span> r])<span class="sc">}</span><span class="ss"> molecules processed"</span>)</span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cached results: </span><span class="sc">{</span><span class="bu">len</span>(cached_results)<span class="sc">}</span><span class="ss"> molecules processed"</span>)</span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the benchmark</span></span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a>benchmark_processing_methods()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Performance Benchmark:
========================================
Sequential processing: 0.32 seconds
Parallel processing: 0.09 seconds
Cached processing: 0.02 seconds
Speedup (parallel): 3.7x
Speedup (cached): 13.3x

Results consistency check:
Sequential results: 1000 molecules processed
Parallel results: 1000 molecules processed
Cached results: 1000 molecules processed</code></pre>
</div>
</div>
</section>
<section id="challenge-2-handling-inconsistent-llm-outputs" class="level2">
<h2 class="anchored" data-anchor-id="challenge-2-handling-inconsistent-llm-outputs">Challenge 2: Handling Inconsistent LLM Outputs</h2>
<p>LLMs can produce inconsistent or partially correct chemical information. Here’s how to build robust systems that handle these issues:</p>
<div id="1ca9a67b" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RobustChemicalParser:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">    A parser that can handle messy, inconsistent LLM outputs and extract</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">    useful chemical information with confidence scoring.</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Common patterns for extracting chemical information from text</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.smiles_patterns <span class="op">=</span> [</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'\b([A-Za-z0-9@+\-\[\]\(\)=#$:%\\\/\.]+)\b'</span>,  <span class="co"># General SMILES pattern</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'SMILES[:\s]*([A-Za-z0-9@+\-\[\]\(\)=#$:%\\\/\.]+)'</span>,  <span class="co"># SMILES: prefix</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'structure[:\s]*([A-Za-z0-9@+\-\[\]\(\)=#$:%\\\/\.]+)'</span>,  <span class="co"># structure: prefix</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.molecular_weight_patterns <span class="op">=</span> [</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'molecular weight[:\s]*(\d+\.?\d*)\s*(?:Da|daltons?|g/mol)?'</span>,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'MW[:\s]*(\d+\.?\d*)'</span>,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r'(\d+\.?\d*)\s*(?:Da|daltons?|g/mol)'</span>,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.property_patterns <span class="op">=</span> {</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">'logp'</span>: [<span class="vs">r'LogP[:\s]*(-?\d+\.?\d*)'</span>, <span class="vs">r'log\s*P[:\s]*(-?\d+\.?\d*)'</span>],</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'tpsa'</span>: [<span class="vs">r'TPSA[:\s]*(\d+\.?\d*)'</span>, <span class="vs">r'polar surface area[:\s]*(\d+\.?\d*)'</span>],</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hbd'</span>: [<span class="vs">r'H-bond donors?[:\s]*(\d+)'</span>, <span class="vs">r'hydrogen bond donors?[:\s]*(\d+)'</span>],</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hba'</span>: [<span class="vs">r'H-bond acceptors?[:\s]*(\d+)'</span>, <span class="vs">r'hydrogen bond acceptors?[:\s]*(\d+)'</span>],</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> extract_chemical_entities(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">any</span>]:</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Extract chemical entities from potentially messy LLM text output.</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns results with confidence scores.</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> {</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">'extracted_smiles'</span>: [],</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">'molecular_weight'</span>: <span class="va">None</span>,</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">'properties'</span>: {},</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">'confidence_scores'</span>: {},</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">'raw_text'</span>: text</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract SMILES candidates</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>        smiles_candidates <span class="op">=</span> <span class="va">self</span>._extract_smiles_candidates(text)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>        validated_smiles <span class="op">=</span> []</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> candidate, confidence <span class="kw">in</span> smiles_candidates:</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>            validation <span class="op">=</span> validate_smiles_with_details(candidate)</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> validation[<span class="st">'is_valid'</span>]:</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>                validated_smiles.append({</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'smiles'</span>: candidate,</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'canonical_smiles'</span>: validation[<span class="st">'canonical_smiles'</span>],</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'confidence'</span>: confidence,</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'properties'</span>: validation[<span class="st">'properties'</span>]</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'extracted_smiles'</span>] <span class="op">=</span> validated_smiles</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract molecular weight</span></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>        mw_match <span class="op">=</span> <span class="va">self</span>._extract_molecular_weight(text)</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mw_match:</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>            results[<span class="st">'molecular_weight'</span>] <span class="op">=</span> mw_match[<span class="st">'value'</span>]</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>            results[<span class="st">'confidence_scores'</span>][<span class="st">'molecular_weight'</span>] <span class="op">=</span> mw_match[<span class="st">'confidence'</span>]</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract other properties</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> prop_name, patterns <span class="kw">in</span> <span class="va">self</span>.property_patterns.items():</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>            prop_match <span class="op">=</span> <span class="va">self</span>._extract_property(text, patterns)</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prop_match:</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>                results[<span class="st">'properties'</span>][prop_name] <span class="op">=</span> prop_match[<span class="st">'value'</span>]</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>                results[<span class="st">'confidence_scores'</span>][prop_name] <span class="op">=</span> prop_match[<span class="st">'confidence'</span>]</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _extract_smiles_candidates(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[Tuple[<span class="bu">str</span>, <span class="bu">float</span>]]:</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Extract SMILES candidates with confidence scores."""</span></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>        candidates <span class="op">=</span> []</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, pattern <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.smiles_patterns):</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>            matches <span class="op">=</span> re.findall(pattern, text, re.IGNORECASE)</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> match <span class="kw">in</span> matches:</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Basic heuristics for SMILES likelihood</span></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>                confidence <span class="op">=</span> <span class="va">self</span>._calculate_smiles_confidence(match, pattern_index<span class="op">=</span>i)</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> confidence <span class="op">&gt;</span> <span class="fl">0.3</span>:  <span class="co"># Minimum confidence threshold</span></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>                    candidates.append((match, confidence))</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove duplicates and sort by confidence</span></span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>        seen <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>        unique_candidates <span class="op">=</span> []</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> smiles, conf <span class="kw">in</span> <span class="bu">sorted</span>(candidates, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> smiles <span class="kw">not</span> <span class="kw">in</span> seen:</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>                seen.add(smiles)</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>                unique_candidates.append((smiles, conf))</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> unique_candidates[:<span class="dv">5</span>]  <span class="co"># Return top 5 candidates</span></span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _calculate_smiles_confidence(<span class="va">self</span>, smiles: <span class="bu">str</span>, pattern_index: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate confidence score for a SMILES candidate."""</span></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>        confidence <span class="op">=</span> <span class="fl">0.5</span>  <span class="co"># Base confidence</span></span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pattern-based confidence adjustment</span></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pattern_index <span class="op">==</span> <span class="dv">1</span>:  <span class="co"># Explicit SMILES: prefix</span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>            confidence <span class="op">+=</span> <span class="fl">0.3</span></span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> pattern_index <span class="op">==</span> <span class="dv">2</span>:  <span class="co"># structure: prefix</span></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>            confidence <span class="op">+=</span> <span class="fl">0.2</span></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Length-based heuristics</span></span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="dv">5</span> <span class="op">&lt;=</span> <span class="bu">len</span>(smiles) <span class="op">&lt;=</span> <span class="dv">200</span>:</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>            confidence <span class="op">+=</span> <span class="fl">0.2</span></span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">len</span>(smiles) <span class="op">&lt;</span> <span class="dv">3</span> <span class="kw">or</span> <span class="bu">len</span>(smiles) <span class="op">&gt;</span> <span class="dv">500</span>:</span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>            confidence <span class="op">-=</span> <span class="fl">0.3</span></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Character composition heuristics</span></span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>        valid_chars <span class="op">=</span> <span class="bu">set</span>(<span class="st">'CNOSPFClBrIH[]()=@+-.0123456789#</span><span class="ch">\\</span><span class="st">/%$'</span>)</span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">all</span>(c <span class="kw">in</span> valid_chars <span class="cf">for</span> c <span class="kw">in</span> smiles):</span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>            confidence <span class="op">+=</span> <span class="fl">0.2</span></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Common SMILES patterns</span></span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(pattern <span class="kw">in</span> smiles <span class="cf">for</span> pattern <span class="kw">in</span> [<span class="st">'c1ccccc1'</span>, <span class="st">'CC'</span>, <span class="st">'CN'</span>, <span class="st">'CO'</span>]):</span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a>            confidence <span class="op">+=</span> <span class="fl">0.1</span></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">min</span>(<span class="fl">1.0</span>, <span class="bu">max</span>(<span class="fl">0.0</span>, confidence))</span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _extract_molecular_weight(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> Optional[Dict]:</span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Extract molecular weight with confidence."""</span></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pattern <span class="kw">in</span> <span class="va">self</span>.molecular_weight_patterns:</span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a>            matches <span class="op">=</span> re.findall(pattern, text, re.IGNORECASE)</span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> matches:</span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a>                    value <span class="op">=</span> <span class="bu">float</span>(matches[<span class="dv">0</span>])</span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="dv">10</span> <span class="op">&lt;=</span> value <span class="op">&lt;=</span> <span class="dv">5000</span>:  <span class="co"># Reasonable MW range</span></span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> {</span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'value'</span>: value,</span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'confidence'</span>: <span class="fl">0.8</span> <span class="cf">if</span> <span class="st">'molecular weight'</span> <span class="kw">in</span> pattern <span class="cf">else</span> <span class="fl">0.6</span></span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _extract_property(<span class="va">self</span>, text: <span class="bu">str</span>, patterns: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> Optional[Dict]:</span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Extract a property value with confidence."""</span></span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pattern <span class="kw">in</span> patterns:</span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a>            matches <span class="op">=</span> re.findall(pattern, text, re.IGNORECASE)</span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> matches:</span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a>                    value <span class="op">=</span> <span class="bu">float</span>(matches[<span class="dv">0</span>])</span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> {<span class="st">'value'</span>: value, <span class="st">'confidence'</span>: <span class="fl">0.7</span>}</span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cross_validate_extractions(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">any</span>]:</span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a><span class="co">        Cross-validate extracted information against RDKit calculations.</span></span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a>        extraction <span class="op">=</span> <span class="va">self</span>.extract_chemical_entities(text)</span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a>        validation_results <span class="op">=</span> {</span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a>            <span class="st">'extraction'</span>: extraction,</span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a>            <span class="st">'validation'</span>: {},</span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a>            <span class="st">'discrepancies'</span>: [],</span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a>            <span class="st">'overall_confidence'</span>: <span class="fl">0.0</span></span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> extraction[<span class="st">'extracted_smiles'</span>]:</span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a>            best_smiles <span class="op">=</span> extraction[<span class="st">'extracted_smiles'</span>][<span class="dv">0</span>]</span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a>            mol <span class="op">=</span> Chem.MolFromSmiles(best_smiles[<span class="st">'canonical_smiles'</span>])</span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mol:</span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a>                rdkit_props <span class="op">=</span> extract_molecular_features(mol)</span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Cross-validate molecular weight</span></span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> extraction[<span class="st">'molecular_weight'</span>]:</span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a>                    rdkit_mw <span class="op">=</span> rdkit_props[<span class="st">'molecular_weight'</span>]</span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a>                    extracted_mw <span class="op">=</span> extraction[<span class="st">'molecular_weight'</span>]</span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a>                    mw_diff <span class="op">=</span> <span class="bu">abs</span>(rdkit_mw <span class="op">-</span> extracted_mw)</span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> mw_diff <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a>                        validation_results[<span class="st">'validation'</span>][<span class="st">'molecular_weight'</span>] <span class="op">=</span> <span class="st">'MATCH'</span></span>
<span id="cb25-176"><a href="#cb25-176" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> mw_diff <span class="op">&lt;</span> <span class="fl">10.0</span>:</span>
<span id="cb25-177"><a href="#cb25-177" aria-hidden="true" tabindex="-1"></a>                        validation_results[<span class="st">'validation'</span>][<span class="st">'molecular_weight'</span>] <span class="op">=</span> <span class="st">'CLOSE'</span></span>
<span id="cb25-178"><a href="#cb25-178" aria-hidden="true" tabindex="-1"></a>                        validation_results[<span class="st">'discrepancies'</span>].append(</span>
<span id="cb25-179"><a href="#cb25-179" aria-hidden="true" tabindex="-1"></a>                            <span class="ss">f"MW discrepancy: extracted=</span><span class="sc">{</span>extracted_mw<span class="sc">}</span><span class="ss">, calculated=</span><span class="sc">{</span>rdkit_mw<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb25-180"><a href="#cb25-180" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb25-181"><a href="#cb25-181" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb25-182"><a href="#cb25-182" aria-hidden="true" tabindex="-1"></a>                        validation_results[<span class="st">'validation'</span>][<span class="st">'molecular_weight'</span>] <span class="op">=</span> <span class="st">'MISMATCH'</span></span>
<span id="cb25-183"><a href="#cb25-183" aria-hidden="true" tabindex="-1"></a>                        validation_results[<span class="st">'discrepancies'</span>].append(</span>
<span id="cb25-184"><a href="#cb25-184" aria-hidden="true" tabindex="-1"></a>                            <span class="ss">f"Major MW discrepancy: extracted=</span><span class="sc">{</span>extracted_mw<span class="sc">}</span><span class="ss">, calculated=</span><span class="sc">{</span>rdkit_mw<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb25-185"><a href="#cb25-185" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb25-186"><a href="#cb25-186" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb25-187"><a href="#cb25-187" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Cross-validate other properties</span></span>
<span id="cb25-188"><a href="#cb25-188" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> prop <span class="kw">in</span> [<span class="st">'logp'</span>, <span class="st">'hbd'</span>, <span class="st">'hba'</span>]:</span>
<span id="cb25-189"><a href="#cb25-189" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> prop <span class="kw">in</span> extraction[<span class="st">'properties'</span>]:</span>
<span id="cb25-190"><a href="#cb25-190" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Add property validation logic here</span></span>
<span id="cb25-191"><a href="#cb25-191" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">pass</span></span>
<span id="cb25-192"><a href="#cb25-192" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb25-193"><a href="#cb25-193" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Calculate overall confidence</span></span>
<span id="cb25-194"><a href="#cb25-194" aria-hidden="true" tabindex="-1"></a>                confidence_scores <span class="op">=</span> <span class="bu">list</span>(extraction[<span class="st">'confidence_scores'</span>].values())</span>
<span id="cb25-195"><a href="#cb25-195" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> confidence_scores:</span>
<span id="cb25-196"><a href="#cb25-196" aria-hidden="true" tabindex="-1"></a>                    validation_results[<span class="st">'overall_confidence'</span>] <span class="op">=</span> <span class="bu">sum</span>(confidence_scores) <span class="op">/</span> <span class="bu">len</span>(confidence_scores)</span>
<span id="cb25-197"><a href="#cb25-197" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-198"><a href="#cb25-198" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> validation_results</span>
<span id="cb25-199"><a href="#cb25-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-200"><a href="#cb25-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstration with messy LLM outputs</span></span>
<span id="cb25-201"><a href="#cb25-201" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> RobustChemicalParser()</span>
<span id="cb25-202"><a href="#cb25-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-203"><a href="#cb25-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate various types of messy LLM outputs</span></span>
<span id="cb25-204"><a href="#cb25-204" aria-hidden="true" tabindex="-1"></a>messy_outputs <span class="op">=</span> [</span>
<span id="cb25-205"><a href="#cb25-205" aria-hidden="true" tabindex="-1"></a>    <span class="st">"The compound has SMILES: CC(C)CC1=CC=C(C=C1)C(C)C(=O)O and molecular weight 206.3 Da"</span>,</span>
<span id="cb25-206"><a href="#cb25-206" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This molecule (c1ccccc1) is benzene, MW: 78.11 g/mol, LogP: 2.13"</span>,</span>
<span id="cb25-207"><a href="#cb25-207" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Structure: CCO, ethanol, with 2 H-bond donors and 1 H-bond acceptor"</span>,</span>
<span id="cb25-208"><a href="#cb25-208" aria-hidden="true" tabindex="-1"></a>    <span class="st">"The SMILES string is probably C1=CC=C(C=C1)C(=O)O but I'm not completely sure about the molecular weight being around 122"</span>,</span>
<span id="cb25-209"><a href="#cb25-209" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Invalid SMILES: XYZ123ABC and some random text with molecular weight 999999 Da"</span>,</span>
<span id="cb25-210"><a href="#cb25-210" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb25-211"><a href="#cb25-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-212"><a href="#cb25-212" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Robust Chemical Information Extraction:"</span>)</span>
<span id="cb25-213"><a href="#cb25-213" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb25-214"><a href="#cb25-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-215"><a href="#cb25-215" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, text <span class="kw">in</span> <span class="bu">enumerate</span>(messy_outputs):</span>
<span id="cb25-216"><a href="#cb25-216" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Example </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb25-217"><a href="#cb25-217" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Input: </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-218"><a href="#cb25-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-219"><a href="#cb25-219" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract and validate</span></span>
<span id="cb25-220"><a href="#cb25-220" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> parser.cross_validate_extractions(text)</span>
<span id="cb25-221"><a href="#cb25-221" aria-hidden="true" tabindex="-1"></a>    extraction <span class="op">=</span> result[<span class="st">'extraction'</span>]</span>
<span id="cb25-222"><a href="#cb25-222" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-223"><a href="#cb25-223" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Extracted SMILES: </span><span class="sc">{</span><span class="bu">len</span>(extraction[<span class="st">'extracted_smiles'</span>])<span class="sc">}</span><span class="ss"> candidates"</span>)</span>
<span id="cb25-224"><a href="#cb25-224" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> extraction[<span class="st">'extracted_smiles'</span>]:</span>
<span id="cb25-225"><a href="#cb25-225" aria-hidden="true" tabindex="-1"></a>        best <span class="op">=</span> extraction[<span class="st">'extracted_smiles'</span>][<span class="dv">0</span>]</span>
<span id="cb25-226"><a href="#cb25-226" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Best: </span><span class="sc">{</span>best[<span class="st">'canonical_smiles'</span>]<span class="sc">}</span><span class="ss"> (confidence: </span><span class="sc">{</span>best[<span class="st">'confidence'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb25-227"><a href="#cb25-227" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-228"><a href="#cb25-228" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> extraction[<span class="st">'molecular_weight'</span>]:</span>
<span id="cb25-229"><a href="#cb25-229" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Molecular Weight: </span><span class="sc">{</span>extraction[<span class="st">'molecular_weight'</span>]<span class="sc">}</span><span class="ss"> (confidence: </span><span class="sc">{</span>extraction[<span class="st">'confidence_scores'</span>]<span class="sc">.</span>get(<span class="st">'molecular_weight'</span>, <span class="dv">0</span>)<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb25-230"><a href="#cb25-230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-231"><a href="#cb25-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result[<span class="st">'discrepancies'</span>]:</span>
<span id="cb25-232"><a href="#cb25-232" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Discrepancies: </span><span class="sc">{</span><span class="st">'; '</span><span class="sc">.</span>join(result[<span class="st">'discrepancies'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-233"><a href="#cb25-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-234"><a href="#cb25-234" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Overall confidence: </span><span class="sc">{</span>result[<span class="st">'overall_confidence'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb25-235"><a href="#cb25-235" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Robust Chemical Information Extraction:
==================================================

Example 1:
Input: The compound has SMILES: CC(C)CC1=CC=C(C=C1)C(C)C(=O)O and molecular weight 206.3 Da
Extracted SMILES: 1 candidates
  Best: CC(C)Cc1ccc(C(C)C(=O)O)cc1 (confidence: 1.00)
Molecular Weight: 206.3 (confidence: 0.80)
Overall confidence: 0.80
------------------------------

Example 2:
Input: This molecule (c1ccccc1) is benzene, MW: 78.11 g/mol, LogP: 2.13
Extracted SMILES: 1 candidates
  Best: c1ccccc1 (confidence: 0.80)
Molecular Weight: 78.11 (confidence: 0.60)
Overall confidence: 0.65
------------------------------

Example 3:
Input: Structure: CCO, ethanol, with 2 H-bond donors and 1 H-bond acceptor
Extracted SMILES: 1 candidates
  Best: CCO (confidence: 1.00)
Overall confidence: 0.00
------------------------------

Example 4:
Input: The SMILES string is probably C1=CC=C(C=C1)C(=O)O but I'm not completely sure about the molecular weight being around 122
Extracted SMILES: 1 candidates
  Best: O=C(O)c1ccccc1 (confidence: 1.00)
Overall confidence: 0.00
------------------------------

Example 5:
Input: Invalid SMILES: XYZ123ABC and some random text with molecular weight 999999 Da
Extracted SMILES: 0 candidates
Overall confidence: 0.00
------------------------------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:53:55] SMILES Parse Error: syntax error while parsing: 206.3
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] 206.3
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES '206.3' for input: '206.3'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'compound' for input: 'compound'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'SMILES' for input: 'SMILES'
[09:53:55] SMILES Parse Error: syntax error while parsing: molecular
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] molecular
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'molecular' for input: 'molecular'
[09:53:55] SMILES Parse Error: syntax error while parsing: 78.11
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] 78.11
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES '78.11' for input: '78.11'
[09:53:55] SMILES Parse Error: syntax error while parsing: molecule
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] molecule
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'molecule' for input: 'molecule'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'benzene' for input: 'benzene'
[09:53:55] SMILES Parse Error: syntax error while parsing: g/mol
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] g/mol
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'g/mol' for input: 'g/mol'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'Structure' for input: 'Structure'
[09:53:55] SMILES Parse Error: syntax error while parsing: ethanol
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] ethanol
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'ethanol' for input: 'ethanol'
[09:53:55] SMILES Parse Error: syntax error while parsing: H-bond
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] H-bond
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'H-bond' for input: 'H-bond'
[09:53:55] SMILES Parse Error: syntax error while parsing: donors
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] donors
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'donors' for input: 'donors'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'string' for input: 'string'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'SMILES' for input: 'SMILES'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'probably' for input: 'probably'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'completely' for input: 'completely'
[09:53:55] SMILES Parse Error: syntax error while parsing: XYZ123ABC
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] XYZ123ABC
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'XYZ123ABC' for input: 'XYZ123ABC'
[09:53:55] SMILES Parse Error: syntax error while parsing: 999999
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] 999999
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES '999999' for input: '999999'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'Invalid' for input: 'Invalid'
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'SMILES' for input: 'SMILES'
[09:53:55] SMILES Parse Error: syntax error while parsing: random
[09:53:55] SMILES Parse Error: check for mistakes around position 1:
[09:53:55] random
[09:53:55] ^
[09:53:55] SMILES Parse Error: Failed parsing SMILES 'random' for input: 'random'</code></pre>
</div>
</div>
</section>
<section id="challenge-3-data-quality-and-contamination" class="level2">
<h2 class="anchored" data-anchor-id="challenge-3-data-quality-and-contamination">Challenge 3: Data Quality and Contamination</h2>
<p>Chemical datasets often contain errors, duplicates, and inconsistencies. Here’s how to build quality control systems:</p>
<blockquote class="blockquote">
<p><strong>NOTE FROM GREG</strong>: I needed to add an import to the following block</p>
</blockquote>
<div id="fb13eead" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># EDIT BY GREG: add missing import</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> DataStructs</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ChemicalDataQualityController:</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">    A comprehensive system for detecting and handling data quality issues</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">    in chemical datasets used for LLM training.</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, similarity_threshold: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.85</span>):</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.similarity_threshold <span class="op">=</span> similarity_threshold</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.quality_stats <span class="op">=</span> {</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_processed'</span>: <span class="dv">0</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">'duplicates_found'</span>: <span class="dv">0</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'invalid_structures'</span>: <span class="dv">0</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'outliers_detected'</span>: <span class="dv">0</span>,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cleaned_structures'</span>: <span class="dv">0</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> comprehensive_quality_check(<span class="va">self</span>, data: List[Dict]) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">any</span>]:</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Perform comprehensive quality checks on chemical dataset.</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co">            data: List of dictionaries with 'smiles' and optional 'name', 'description' keys</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co">            Quality report with flagged issues and cleaned data</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        report <span class="op">=</span> {</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">'original_size'</span>: <span class="bu">len</span>(data),</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">'issues'</span>: {</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">'duplicates'</span>: [],</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">'invalid_smiles'</span>: [],</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">'structural_outliers'</span>: [],</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">'text_inconsistencies'</span>: [],</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">'suspicious_patterns'</span>: []</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cleaned_data'</span>: [],</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recommendations'</span>: []</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Running comprehensive data quality checks..."</span>)</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 1: Basic validation and cleaning</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>        valid_entries <span class="op">=</span> []</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, entry <span class="kw">in</span> <span class="bu">enumerate</span>(data):</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>            smiles <span class="op">=</span> entry.get(<span class="st">'smiles'</span>, <span class="st">''</span>)</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>            validation <span class="op">=</span> validate_smiles_with_details(smiles)</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> validation[<span class="st">'is_valid'</span>]:</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Store canonical SMILES for consistency</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>                entry[<span class="st">'canonical_smiles'</span>] <span class="op">=</span> validation[<span class="st">'canonical_smiles'</span>]</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>                entry[<span class="st">'original_index'</span>] <span class="op">=</span> i</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>                valid_entries.append(entry)</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>                report[<span class="st">'issues'</span>][<span class="st">'invalid_smiles'</span>].append({</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'index'</span>: i,</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'smiles'</span>: smiles,</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'errors'</span>: validation[<span class="st">'errors'</span>]</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Valid structures: </span><span class="sc">{</span><span class="bu">len</span>(valid_entries)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 2: Duplicate detection</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>        duplicates <span class="op">=</span> <span class="va">self</span>._find_duplicates(valid_entries)</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>        report[<span class="st">'issues'</span>][<span class="st">'duplicates'</span>] <span class="op">=</span> duplicates</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 3: Structural outlier detection</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>        outliers <span class="op">=</span> <span class="va">self</span>._detect_structural_outliers(valid_entries)</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>        report[<span class="st">'issues'</span>][<span class="st">'structural_outliers'</span>] <span class="op">=</span> outliers</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 4: Text-structure consistency checks</span></span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(<span class="st">'description'</span> <span class="kw">in</span> entry <span class="cf">for</span> entry <span class="kw">in</span> valid_entries):</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>            inconsistencies <span class="op">=</span> <span class="va">self</span>._check_text_structure_consistency(valid_entries)</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>            report[<span class="st">'issues'</span>][<span class="st">'text_inconsistencies'</span>] <span class="op">=</span> inconsistencies</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 5: Suspicious pattern detection</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>        suspicious <span class="op">=</span> <span class="va">self</span>._detect_suspicious_patterns(valid_entries)</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>        report[<span class="st">'issues'</span>][<span class="st">'suspicious_patterns'</span>] <span class="op">=</span> suspicious</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 6: Create cleaned dataset</span></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>        cleaned_data <span class="op">=</span> <span class="va">self</span>._create_cleaned_dataset(valid_entries, report[<span class="st">'issues'</span>])</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>        report[<span class="st">'cleaned_data'</span>] <span class="op">=</span> cleaned_data</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>        report[<span class="st">'final_size'</span>] <span class="op">=</span> <span class="bu">len</span>(cleaned_data)</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 7: Generate recommendations</span></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>        report[<span class="st">'recommendations'</span>] <span class="op">=</span> <span class="va">self</span>._generate_recommendations(report)</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> report</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _find_duplicates(<span class="va">self</span>, entries: List[Dict]) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Find duplicate structures using canonical SMILES and similarity."""</span></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Checking for duplicates..."</span>)</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>        duplicates <span class="op">=</span> []</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>        seen_smiles <span class="op">=</span> {}</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Exact duplicates (same canonical SMILES)</span></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> entries:</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>            canonical <span class="op">=</span> entry[<span class="st">'canonical_smiles'</span>]</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> canonical <span class="kw">in</span> seen_smiles:</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>                duplicates.append({</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'type'</span>: <span class="st">'exact_duplicate'</span>,</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'indices'</span>: [seen_smiles[canonical][<span class="st">'original_index'</span>], entry[<span class="st">'original_index'</span>]],</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'smiles'</span>: canonical,</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'names'</span>: [seen_smiles[canonical].get(<span class="st">'name'</span>, <span class="st">'Unknown'</span>), </span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>                             entry.get(<span class="st">'name'</span>, <span class="st">'Unknown'</span>)]</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>                seen_smiles[canonical] <span class="op">=</span> entry</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Near-duplicates (high structural similarity)</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(entries) <span class="op">&lt;</span> <span class="dv">1000</span>:  <span class="co"># Only for smaller datasets due to O(n²) complexity</span></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>            fingerprints <span class="op">=</span> []</span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> entry <span class="kw">in</span> entries:</span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>                mol <span class="op">=</span> Chem.MolFromSmiles(entry[<span class="st">'canonical_smiles'</span>])</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> mol:</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>                    fp <span class="op">=</span> Chem.RDKFingerprint(mol)</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>                    fingerprints.append((entry, fp))</span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, (entry1, fp1) <span class="kw">in</span> <span class="bu">enumerate</span>(fingerprints):</span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> j, (entry2, fp2) <span class="kw">in</span> <span class="bu">enumerate</span>(fingerprints[i<span class="op">+</span><span class="dv">1</span>:], i<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>                    similarity <span class="op">=</span> DataStructs.TanimotoSimilarity(fp1, fp2)</span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> similarity <span class="op">&gt;</span> <span class="va">self</span>.similarity_threshold:</span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>                        duplicates.append({</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'type'</span>: <span class="st">'near_duplicate'</span>,</span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'similarity'</span>: similarity,</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'indices'</span>: [entry1[<span class="st">'original_index'</span>], entry2[<span class="st">'original_index'</span>]],</span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'smiles'</span>: [entry1[<span class="st">'canonical_smiles'</span>], entry2[<span class="st">'canonical_smiles'</span>]],</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'names'</span>: [entry1.get(<span class="st">'name'</span>, <span class="st">'Unknown'</span>), entry2.get(<span class="st">'name'</span>, <span class="st">'Unknown'</span>)]</span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a>                        })</span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> duplicates</span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _detect_structural_outliers(<span class="va">self</span>, entries: List[Dict]) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Detect structural outliers that might indicate data quality issues."""</span></span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Detecting structural outliers..."</span>)</span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a>        outliers <span class="op">=</span> []</span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a>        properties <span class="op">=</span> []</span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate properties for all molecules</span></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> entries:</span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>            mol <span class="op">=</span> Chem.MolFromSmiles(entry[<span class="st">'canonical_smiles'</span>])</span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mol:</span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a>                props <span class="op">=</span> {</span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'mw'</span>: Descriptors.MolWt(mol),</span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'logp'</span>: Descriptors.MolLogP(mol),</span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'num_atoms'</span>: mol.GetNumAtoms(),</span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'num_rings'</span>: rdMolDescriptors.CalcNumRings(mol),</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'entry'</span>: entry</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>                properties.append(props)</span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> properties:</span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> outliers</span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Statistical outlier detection using IQR method</span></span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> prop_name <span class="kw">in</span> [<span class="st">'mw'</span>, <span class="st">'logp'</span>, <span class="st">'num_atoms'</span>, <span class="st">'num_rings'</span>]:</span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a>            values <span class="op">=</span> [p[prop_name] <span class="cf">for</span> p <span class="kw">in</span> properties]</span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a>            q1 <span class="op">=</span> pd.Series(values).quantile(<span class="fl">0.25</span>)</span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a>            q3 <span class="op">=</span> pd.Series(values).quantile(<span class="fl">0.75</span>)</span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a>            iqr <span class="op">=</span> q3 <span class="op">-</span> q1</span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a>            lower_bound <span class="op">=</span> q1 <span class="op">-</span> <span class="dv">3</span> <span class="op">*</span> iqr  <span class="co"># More permissive than standard 1.5*IQR</span></span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a>            upper_bound <span class="op">=</span> q3 <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> iqr</span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> props <span class="kw">in</span> properties:</span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a>                value <span class="op">=</span> props[prop_name]</span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> value <span class="op">&lt;</span> lower_bound <span class="kw">or</span> value <span class="op">&gt;</span> upper_bound:</span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a>                    outliers.append({</span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'type'</span>: <span class="ss">f'</span><span class="sc">{</span>prop_name<span class="sc">}</span><span class="ss">_outlier'</span>,</span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'index'</span>: props[<span class="st">'entry'</span>][<span class="st">'original_index'</span>],</span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'smiles'</span>: props[<span class="st">'entry'</span>][<span class="st">'canonical_smiles'</span>],</span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'property'</span>: prop_name,</span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'value'</span>: value,</span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'expected_range'</span>: <span class="ss">f'</span><span class="sc">{</span>lower_bound<span class="sc">:.1f}</span><span class="ss"> - </span><span class="sc">{</span>upper_bound<span class="sc">:.1f}</span><span class="ss">'</span></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> outliers</span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _check_text_structure_consistency(<span class="va">self</span>, entries: List[Dict]) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Check consistency between text descriptions and calculated properties."""</span></span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Checking text-structure consistency..."</span>)</span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a>        inconsistencies <span class="op">=</span> []</span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> entries:</span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'description'</span> <span class="kw">not</span> <span class="kw">in</span> entry:</span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a>            description <span class="op">=</span> entry[<span class="st">'description'</span>].lower()</span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a>            mol <span class="op">=</span> Chem.MolFromSmiles(entry[<span class="st">'canonical_smiles'</span>])</span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> mol:</span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a>            features <span class="op">=</span> extract_molecular_features(mol)</span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check molecular weight consistency</span></span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'molecular weight'</span> <span class="kw">in</span> description <span class="kw">or</span> <span class="st">'mw'</span> <span class="kw">in</span> description:</span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Extract numbers that might be molecular weights</span></span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a>                mw_numbers <span class="op">=</span> re.findall(<span class="vs">r'\b(\d{2,4}(?:\.\d+)?)\b'</span>, description)</span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a>                actual_mw <span class="op">=</span> features[<span class="st">'molecular_weight'</span>]</span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a>                found_matching_mw <span class="op">=</span> <span class="va">False</span></span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> num_str <span class="kw">in</span> mw_numbers:</span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a>                        described_mw <span class="op">=</span> <span class="bu">float</span>(num_str)</span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">abs</span>(described_mw <span class="op">-</span> actual_mw) <span class="op">&lt;</span> <span class="dv">5</span>:  <span class="co"># 5 Da tolerance</span></span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a>                            found_matching_mw <span class="op">=</span> <span class="va">True</span></span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span></span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> found_matching_mw <span class="kw">and</span> mw_numbers:</span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a>                    inconsistencies.append({</span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'type'</span>: <span class="st">'molecular_weight_mismatch'</span>,</span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'index'</span>: entry[<span class="st">'original_index'</span>],</span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'smiles'</span>: entry[<span class="st">'canonical_smiles'</span>],</span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'described_mw'</span>: mw_numbers,</span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'calculated_mw'</span>: actual_mw,</span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'description_excerpt'</span>: description[:<span class="dv">100</span>] <span class="op">+</span> <span class="st">'...'</span></span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check functional group mentions</span></span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>            mentioned_groups <span class="op">=</span> []</span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'alcohol'</span> <span class="kw">in</span> description:</span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a>                mentioned_groups.append(<span class="st">'alcohol'</span>)</span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'carboxylic acid'</span> <span class="kw">in</span> description <span class="kw">or</span> <span class="st">'carboxyl'</span> <span class="kw">in</span> description:</span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>                mentioned_groups.append(<span class="st">'carboxylic_acid'</span>)</span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'amine'</span> <span class="kw">in</span> description:</span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>                mentioned_groups.append(<span class="st">'amine'</span>)</span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'aromatic'</span> <span class="kw">in</span> description <span class="kw">or</span> <span class="st">'benzene'</span> <span class="kw">in</span> description:</span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a>                mentioned_groups.append(<span class="st">'aromatic'</span>)</span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a>            detected_groups <span class="op">=</span> [fg.split(<span class="st">'('</span>)[<span class="dv">0</span>] <span class="cf">for</span> fg <span class="kw">in</span> features.get(<span class="st">'functional_groups'</span>, [])]</span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> mentioned <span class="kw">in</span> mentioned_groups:</span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> mentioned <span class="kw">not</span> <span class="kw">in</span> detected_groups <span class="kw">and</span> mentioned <span class="op">!=</span> <span class="st">'aromatic'</span>:</span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a>                    inconsistencies.append({</span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'type'</span>: <span class="st">'functional_group_mismatch'</span>,</span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'index'</span>: entry[<span class="st">'original_index'</span>],</span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'smiles'</span>: entry[<span class="st">'canonical_smiles'</span>],</span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'mentioned_group'</span>: mentioned,</span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'detected_groups'</span>: detected_groups,</span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'description_excerpt'</span>: description[:<span class="dv">100</span>] <span class="op">+</span> <span class="st">'...'</span></span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> inconsistencies</span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _detect_suspicious_patterns(<span class="va">self</span>, entries: List[Dict]) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Detect suspicious patterns that might indicate synthetic or corrupted data."""</span></span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Detecting suspicious patterns..."</span>)</span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a>        suspicious <span class="op">=</span> []</span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pattern 1: Repetitive SMILES patterns</span></span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a>        smiles_parts <span class="op">=</span> {}</span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> entries:</span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a>            smiles <span class="op">=</span> entry[<span class="st">'canonical_smiles'</span>]</span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Look for repeated substrings</span></span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> length <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]:</span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(smiles) <span class="op">-</span> length <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a>                    substring <span class="op">=</span> smiles[i:i<span class="op">+</span>length]</span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> substring.count(substring[<span class="dv">0</span>]) <span class="op">!=</span> <span class="bu">len</span>(substring):  <span class="co"># Not all same character</span></span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a>                        smiles_parts[substring] <span class="op">=</span> smiles_parts.get(substring, <span class="dv">0</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Flag SMILES with highly repetitive patterns</span></span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> entries:</span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a>            smiles <span class="op">=</span> entry[<span class="st">'canonical_smiles'</span>]</span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a>            repetitive_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> substring, count <span class="kw">in</span> smiles_parts.items():</span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> count <span class="op">&gt;</span> <span class="bu">len</span>(entries) <span class="op">*</span> <span class="fl">0.1</span> <span class="kw">and</span> substring <span class="kw">in</span> smiles:  <span class="co"># Appears in &gt;10% of dataset</span></span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a>                    repetitive_score <span class="op">+=</span> count</span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> repetitive_score <span class="op">&gt;</span> <span class="bu">len</span>(entries) <span class="op">*</span> <span class="fl">0.2</span>:</span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a>                suspicious.append({</span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'type'</span>: <span class="st">'repetitive_smiles_pattern'</span>,</span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'index'</span>: entry[<span class="st">'original_index'</span>],</span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'smiles'</span>: smiles,</span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'repetitive_score'</span>: repetitive_score</span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pattern 2: Unrealistic property combinations</span></span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> entries:</span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a>            mol <span class="op">=</span> Chem.MolFromSmiles(entry[<span class="st">'canonical_smiles'</span>])</span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mol:</span>
<span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a>                mw <span class="op">=</span> Descriptors.MolWt(mol)</span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a>                num_atoms <span class="op">=</span> mol.GetNumAtoms()</span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Flag extremely dense molecules (too much mass for number of atoms)</span></span>
<span id="cb28-293"><a href="#cb28-293" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> num_atoms <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> mw <span class="op">/</span> num_atoms <span class="op">&gt;</span> <span class="dv">50</span>:  <span class="co"># Average atomic weight &gt; 50</span></span>
<span id="cb28-294"><a href="#cb28-294" aria-hidden="true" tabindex="-1"></a>                    suspicious.append({</span>
<span id="cb28-295"><a href="#cb28-295" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'type'</span>: <span class="st">'unrealistic_density'</span>,</span>
<span id="cb28-296"><a href="#cb28-296" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'index'</span>: entry[<span class="st">'original_index'</span>],</span>
<span id="cb28-297"><a href="#cb28-297" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'smiles'</span>: entry[<span class="st">'canonical_smiles'</span>],</span>
<span id="cb28-298"><a href="#cb28-298" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'mw_per_atom'</span>: mw <span class="op">/</span> num_atoms</span>
<span id="cb28-299"><a href="#cb28-299" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb28-300"><a href="#cb28-300" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-301"><a href="#cb28-301" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> suspicious</span>
<span id="cb28-302"><a href="#cb28-302" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-303"><a href="#cb28-303" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _create_cleaned_dataset(<span class="va">self</span>, entries: List[Dict], issues: Dict) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb28-304"><a href="#cb28-304" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create a cleaned dataset by removing problematic entries."""</span></span>
<span id="cb28-305"><a href="#cb28-305" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Creating cleaned dataset..."</span>)</span>
<span id="cb28-306"><a href="#cb28-306" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-307"><a href="#cb28-307" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Collect indices to remove</span></span>
<span id="cb28-308"><a href="#cb28-308" aria-hidden="true" tabindex="-1"></a>        indices_to_remove <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb28-309"><a href="#cb28-309" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-310"><a href="#cb28-310" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove exact duplicates (keep first occurrence)</span></span>
<span id="cb28-311"><a href="#cb28-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> dup <span class="kw">in</span> issues[<span class="st">'duplicates'</span>]:</span>
<span id="cb28-312"><a href="#cb28-312" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> dup[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'exact_duplicate'</span>:</span>
<span id="cb28-313"><a href="#cb28-313" aria-hidden="true" tabindex="-1"></a>                indices_to_remove.add(dup[<span class="st">'indices'</span>][<span class="dv">1</span>])  <span class="co"># Remove second occurrence</span></span>
<span id="cb28-314"><a href="#cb28-314" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-315"><a href="#cb28-315" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove severe outliers</span></span>
<span id="cb28-316"><a href="#cb28-316" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> outlier <span class="kw">in</span> issues[<span class="st">'structural_outliers'</span>]:</span>
<span id="cb28-317"><a href="#cb28-317" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> outlier[<span class="st">'type'</span>] <span class="kw">in</span> [<span class="st">'num_atoms_outlier'</span>, <span class="st">'mw_outlier'</span>]:</span>
<span id="cb28-318"><a href="#cb28-318" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Only remove extreme outliers</span></span>
<span id="cb28-319"><a href="#cb28-319" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> outlier[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'num_atoms_outlier'</span> <span class="kw">and</span> outlier[<span class="st">'value'</span>] <span class="op">&gt;</span> <span class="dv">200</span>:</span>
<span id="cb28-320"><a href="#cb28-320" aria-hidden="true" tabindex="-1"></a>                    indices_to_remove.add(outlier[<span class="st">'index'</span>])</span>
<span id="cb28-321"><a href="#cb28-321" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> outlier[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'mw_outlier'</span> <span class="kw">and</span> outlier[<span class="st">'value'</span>] <span class="op">&gt;</span> <span class="dv">2000</span>:</span>
<span id="cb28-322"><a href="#cb28-322" aria-hidden="true" tabindex="-1"></a>                    indices_to_remove.add(outlier[<span class="st">'index'</span>])</span>
<span id="cb28-323"><a href="#cb28-323" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-324"><a href="#cb28-324" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove highly suspicious entries</span></span>
<span id="cb28-325"><a href="#cb28-325" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> susp <span class="kw">in</span> issues[<span class="st">'suspicious_patterns'</span>]:</span>
<span id="cb28-326"><a href="#cb28-326" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> susp[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'unrealistic_density'</span> <span class="kw">and</span> susp[<span class="st">'mw_per_atom'</span>] <span class="op">&gt;</span> <span class="dv">100</span>:</span>
<span id="cb28-327"><a href="#cb28-327" aria-hidden="true" tabindex="-1"></a>                indices_to_remove.add(susp[<span class="st">'index'</span>])</span>
<span id="cb28-328"><a href="#cb28-328" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-329"><a href="#cb28-329" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create cleaned dataset</span></span>
<span id="cb28-330"><a href="#cb28-330" aria-hidden="true" tabindex="-1"></a>        cleaned <span class="op">=</span> []</span>
<span id="cb28-331"><a href="#cb28-331" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> entries:</span>
<span id="cb28-332"><a href="#cb28-332" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> entry[<span class="st">'original_index'</span>] <span class="kw">not</span> <span class="kw">in</span> indices_to_remove:</span>
<span id="cb28-333"><a href="#cb28-333" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Clean up the entry</span></span>
<span id="cb28-334"><a href="#cb28-334" aria-hidden="true" tabindex="-1"></a>                cleaned_entry <span class="op">=</span> {</span>
<span id="cb28-335"><a href="#cb28-335" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'smiles'</span>: entry[<span class="st">'canonical_smiles'</span>],  <span class="co"># Use canonical form</span></span>
<span id="cb28-336"><a href="#cb28-336" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'name'</span>: entry.get(<span class="st">'name'</span>, <span class="st">''</span>),</span>
<span id="cb28-337"><a href="#cb28-337" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'description'</span>: entry.get(<span class="st">'description'</span>, <span class="st">''</span>)</span>
<span id="cb28-338"><a href="#cb28-338" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb28-339"><a href="#cb28-339" aria-hidden="true" tabindex="-1"></a>                cleaned.append(cleaned_entry)</span>
<span id="cb28-340"><a href="#cb28-340" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-341"><a href="#cb28-341" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cleaned</span>
<span id="cb28-342"><a href="#cb28-342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-343"><a href="#cb28-343" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _generate_recommendations(<span class="va">self</span>, report: Dict) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb28-344"><a href="#cb28-344" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generate recommendations based on quality issues found."""</span></span>
<span id="cb28-345"><a href="#cb28-345" aria-hidden="true" tabindex="-1"></a>        recommendations <span class="op">=</span> []</span>
<span id="cb28-346"><a href="#cb28-346" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-347"><a href="#cb28-347" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Duplicate recommendations</span></span>
<span id="cb28-348"><a href="#cb28-348" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> report[<span class="st">'issues'</span>][<span class="st">'duplicates'</span>]:</span>
<span id="cb28-349"><a href="#cb28-349" aria-hidden="true" tabindex="-1"></a>            exact_dups <span class="op">=</span> <span class="bu">len</span>([d <span class="cf">for</span> d <span class="kw">in</span> report[<span class="st">'issues'</span>][<span class="st">'duplicates'</span>] <span class="cf">if</span> d[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'exact_duplicate'</span>])</span>
<span id="cb28-350"><a href="#cb28-350" aria-hidden="true" tabindex="-1"></a>            near_dups <span class="op">=</span> <span class="bu">len</span>([d <span class="cf">for</span> d <span class="kw">in</span> report[<span class="st">'issues'</span>][<span class="st">'duplicates'</span>] <span class="cf">if</span> d[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'near_duplicate'</span>])</span>
<span id="cb28-351"><a href="#cb28-351" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-352"><a href="#cb28-352" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> exact_dups <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb28-353"><a href="#cb28-353" aria-hidden="true" tabindex="-1"></a>                recommendations.append(<span class="ss">f"Remove </span><span class="sc">{</span>exact_dups<span class="sc">}</span><span class="ss"> exact duplicate structures"</span>)</span>
<span id="cb28-354"><a href="#cb28-354" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> near_dups <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb28-355"><a href="#cb28-355" aria-hidden="true" tabindex="-1"></a>                recommendations.append(<span class="ss">f"Review </span><span class="sc">{</span>near_dups<span class="sc">}</span><span class="ss"> near-duplicate pairs (similarity &gt; </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>similarity_threshold<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb28-356"><a href="#cb28-356" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-357"><a href="#cb28-357" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Data size recommendations</span></span>
<span id="cb28-358"><a href="#cb28-358" aria-hidden="true" tabindex="-1"></a>        removal_rate <span class="op">=</span> (report[<span class="st">'original_size'</span>] <span class="op">-</span> report[<span class="st">'final_size'</span>]) <span class="op">/</span> report[<span class="st">'original_size'</span>]</span>
<span id="cb28-359"><a href="#cb28-359" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> removal_rate <span class="op">&gt;</span> <span class="fl">0.2</span>:</span>
<span id="cb28-360"><a href="#cb28-360" aria-hidden="true" tabindex="-1"></a>            recommendations.append(<span class="ss">f"High removal rate (</span><span class="sc">{</span>removal_rate<span class="sc">:.1%}</span><span class="ss">) suggests significant data quality issues"</span>)</span>
<span id="cb28-361"><a href="#cb28-361" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-362"><a href="#cb28-362" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Outlier recommendations</span></span>
<span id="cb28-363"><a href="#cb28-363" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> report[<span class="st">'issues'</span>][<span class="st">'structural_outliers'</span>]:</span>
<span id="cb28-364"><a href="#cb28-364" aria-hidden="true" tabindex="-1"></a>            recommendations.append(<span class="st">"Review structural outliers - they may indicate data entry errors"</span>)</span>
<span id="cb28-365"><a href="#cb28-365" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-366"><a href="#cb28-366" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Consistency recommendations</span></span>
<span id="cb28-367"><a href="#cb28-367" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> report[<span class="st">'issues'</span>][<span class="st">'text_inconsistencies'</span>]:</span>
<span id="cb28-368"><a href="#cb28-368" aria-hidden="true" tabindex="-1"></a>            recommendations.append(<span class="st">"Text descriptions inconsistent with structures - consider regenerating descriptions"</span>)</span>
<span id="cb28-369"><a href="#cb28-369" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-370"><a href="#cb28-370" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> recommendations:</span>
<span id="cb28-371"><a href="#cb28-371" aria-hidden="true" tabindex="-1"></a>            recommendations.append(<span class="st">"Dataset quality looks good! No major issues detected."</span>)</span>
<span id="cb28-372"><a href="#cb28-372" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-373"><a href="#cb28-373" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> recommendations</span>
<span id="cb28-374"><a href="#cb28-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-375"><a href="#cb28-375" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstration with a problematic dataset</span></span>
<span id="cb28-376"><a href="#cb28-376" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_test_dataset_with_issues():</span>
<span id="cb28-377"><a href="#cb28-377" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a test dataset with various quality issues for demonstration."""</span></span>
<span id="cb28-378"><a href="#cb28-378" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb28-379"><a href="#cb28-379" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Good entries</span></span>
<span id="cb28-380"><a href="#cb28-380" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'CCO'</span>, <span class="st">'name'</span>: <span class="st">'Ethanol'</span>, <span class="st">'description'</span>: <span class="st">'Ethanol is an alcohol with molecular weight 46.07 Da'</span>},</span>
<span id="cb28-381"><a href="#cb28-381" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'c1ccccc1'</span>, <span class="st">'name'</span>: <span class="st">'Benzene'</span>, <span class="st">'description'</span>: <span class="st">'Benzene is an aromatic compound'</span>},</span>
<span id="cb28-382"><a href="#cb28-382" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-383"><a href="#cb28-383" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Duplicates</span></span>
<span id="cb28-384"><a href="#cb28-384" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'CCO'</span>, <span class="st">'name'</span>: <span class="st">'Ethyl alcohol'</span>, <span class="st">'description'</span>: <span class="st">'Another entry for ethanol'</span>},  <span class="co"># Exact duplicate</span></span>
<span id="cb28-385"><a href="#cb28-385" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'c1ccccc1'</span>, <span class="st">'name'</span>: <span class="st">'Benzene ring'</span>, <span class="st">'description'</span>: <span class="st">'Benzene ring structure'</span>},  <span class="co"># Exact duplicate</span></span>
<span id="cb28-386"><a href="#cb28-386" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-387"><a href="#cb28-387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Invalid SMILES</span></span>
<span id="cb28-388"><a href="#cb28-388" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'INVALID123'</span>, <span class="st">'name'</span>: <span class="st">'Bad entry'</span>, <span class="st">'description'</span>: <span class="st">'This is not a valid SMILES'</span>},</span>
<span id="cb28-389"><a href="#cb28-389" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'C1CCC'</span>, <span class="st">'name'</span>: <span class="st">'Unclosed ring'</span>, <span class="st">'description'</span>: <span class="st">'Missing ring closure'</span>},</span>
<span id="cb28-390"><a href="#cb28-390" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-391"><a href="#cb28-391" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Outliers</span></span>
<span id="cb28-392"><a href="#cb28-392" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'C'</span> <span class="op">*</span> <span class="dv">100</span>, <span class="st">'name'</span>: <span class="st">'Very long chain'</span>, <span class="st">'description'</span>: <span class="st">'Extremely long alkyl chain'</span>},</span>
<span id="cb28-393"><a href="#cb28-393" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-394"><a href="#cb28-394" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Text inconsistencies</span></span>
<span id="cb28-395"><a href="#cb28-395" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'CCO'</span>, <span class="st">'name'</span>: <span class="st">'Ethanol'</span>, <span class="st">'description'</span>: <span class="st">'This alcohol has molecular weight 200 Da'</span>},  <span class="co"># Wrong MW</span></span>
<span id="cb28-396"><a href="#cb28-396" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'c1ccccc1'</span>, <span class="st">'name'</span>: <span class="st">'Benzene'</span>, <span class="st">'description'</span>: <span class="st">'Contains carboxylic acid groups'</span>},  <span class="co"># Wrong functional group</span></span>
<span id="cb28-397"><a href="#cb28-397" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-398"><a href="#cb28-398" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Near duplicates</span></span>
<span id="cb28-399"><a href="#cb28-399" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'CC(C)O'</span>, <span class="st">'name'</span>: <span class="st">'Isopropanol'</span>, <span class="st">'description'</span>: <span class="st">'Isopropyl alcohol'</span>},</span>
<span id="cb28-400"><a href="#cb28-400" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-401"><a href="#cb28-401" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Good entries for padding</span></span>
<span id="cb28-402"><a href="#cb28-402" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'CC(=O)O'</span>, <span class="st">'name'</span>: <span class="st">'Acetic acid'</span>, <span class="st">'description'</span>: <span class="st">'Acetic acid is a carboxylic acid'</span>},</span>
<span id="cb28-403"><a href="#cb28-403" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'smiles'</span>: <span class="st">'CN'</span>, <span class="st">'name'</span>: <span class="st">'Methylamine'</span>, <span class="st">'description'</span>: <span class="st">'Simple amine compound'</span>},</span>
<span id="cb28-404"><a href="#cb28-404" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-405"><a href="#cb28-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-406"><a href="#cb28-406" aria-hidden="true" tabindex="-1"></a><span class="co"># Run quality control demonstration</span></span>
<span id="cb28-407"><a href="#cb28-407" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Chemical Data Quality Control Demonstration"</span>)</span>
<span id="cb28-408"><a href="#cb28-408" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb28-409"><a href="#cb28-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-410"><a href="#cb28-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Create test dataset with known issues</span></span>
<span id="cb28-411"><a href="#cb28-411" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> create_test_dataset_with_issues()</span>
<span id="cb28-412"><a href="#cb28-412" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test dataset created with </span><span class="sc">{</span><span class="bu">len</span>(test_data)<span class="sc">}</span><span class="ss"> entries"</span>)</span>
<span id="cb28-413"><a href="#cb28-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-414"><a href="#cb28-414" aria-hidden="true" tabindex="-1"></a><span class="co"># Run quality control</span></span>
<span id="cb28-415"><a href="#cb28-415" aria-hidden="true" tabindex="-1"></a>qc <span class="op">=</span> ChemicalDataQualityController(similarity_threshold<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb28-416"><a href="#cb28-416" aria-hidden="true" tabindex="-1"></a>quality_report <span class="op">=</span> qc.comprehensive_quality_check(test_data)</span>
<span id="cb28-417"><a href="#cb28-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-418"><a href="#cb28-418" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb28-419"><a href="#cb28-419" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Quality Control Results:"</span>)</span>
<span id="cb28-420"><a href="#cb28-420" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Original dataset size: </span><span class="sc">{</span>quality_report[<span class="st">'original_size'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-421"><a href="#cb28-421" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cleaned dataset size: </span><span class="sc">{</span>quality_report[<span class="st">'final_size'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-422"><a href="#cb28-422" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Removal rate: </span><span class="sc">{</span>(<span class="dv">1</span> <span class="op">-</span> quality_report[<span class="st">'final_size'</span>]<span class="op">/</span>quality_report[<span class="st">'original_size'</span>])<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb28-423"><a href="#cb28-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-424"><a href="#cb28-424" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Issues Found:"</span>)</span>
<span id="cb28-425"><a href="#cb28-425" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> issue_type, issues <span class="kw">in</span> quality_report[<span class="st">'issues'</span>].items():</span>
<span id="cb28-426"><a href="#cb28-426" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> issues:</span>
<span id="cb28-427"><a href="#cb28-427" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>issue_type<span class="sc">.</span>replace(<span class="st">'_'</span>, <span class="st">' '</span>)<span class="sc">.</span>title()<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(issues)<span class="sc">}</span><span class="ss"> cases"</span>)</span>
<span id="cb28-428"><a href="#cb28-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-429"><a href="#cb28-429" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Recommendations:"</span>)</span>
<span id="cb28-430"><a href="#cb28-430" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, rec <span class="kw">in</span> <span class="bu">enumerate</span>(quality_report[<span class="st">'recommendations'</span>], <span class="dv">1</span>):</span>
<span id="cb28-431"><a href="#cb28-431" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">. </span><span class="sc">{</span>rec<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-432"><a href="#cb28-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-433"><a href="#cb28-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Show example of cleaned data</span></span>
<span id="cb28-434"><a href="#cb28-434" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">First 3 entries of cleaned dataset:"</span>)</span>
<span id="cb28-435"><a href="#cb28-435" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, entry <span class="kw">in</span> <span class="bu">enumerate</span>(quality_report[<span class="st">'cleaned_data'</span>][:<span class="dv">3</span>]):</span>
<span id="cb28-436"><a href="#cb28-436" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">. </span><span class="sc">{</span>entry[<span class="st">'name'</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>entry[<span class="st">'smiles'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chemical Data Quality Control Demonstration
==================================================
Test dataset created with 12 entries
Running comprehensive data quality checks...
  Valid structures: 10/12
  Checking for duplicates...
  Detecting structural outliers...
  Checking text-structure consistency...
  Detecting suspicious patterns...
  Creating cleaned dataset...

Quality Control Results:
Original dataset size: 12
Cleaned dataset size: 6
Removal rate: 50.0%

Issues Found:
  Duplicates: 10 cases
  Invalid Smiles: 2 cases
  Structural Outliers: 3 cases
  Text Inconsistencies: 2 cases
  Suspicious Patterns: 6 cases

Recommendations:
  1. Remove 4 exact duplicate structures
  2. Review 6 near-duplicate pairs (similarity &gt; 0.8)
  3. High removal rate (50.0%) suggests significant data quality issues
  4. Review structural outliers - they may indicate data entry errors
  5. Text descriptions inconsistent with structures - consider regenerating descriptions

First 3 entries of cleaned dataset:
  1. Ethanol: CCO
  2. Benzene: c1ccccc1
  3. Very long chain: CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[09:55:35] SMILES Parse Error: Failed parsing SMILES 'INVALID123' for input: 'INVALID123'
[09:55:35] SMILES Parse Error: unclosed ring for input: 'C1CCC'</code></pre>
</div>
</div>
<section id="advanced-contamination-detection" class="level3">
<h3 class="anchored" data-anchor-id="advanced-contamination-detection">Advanced Contamination Detection</h3>
<blockquote class="blockquote">
<p><strong>NOTE FROM GREG</strong>: the following section of code does not work. I’m leaving it here as the first example of something that didn’t actually work as generated by the LLM.</p>
</blockquote>
<p>Data contamination is a critical issue when training LLMs on chemical data. Beyond basic quality checks, sophisticated contamination detection is essential:</p>
<p><strong>Cross-Dataset Leakage Detection:</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_cross_dataset_leakage(train_smiles, test_smiles, validation_smiles):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Detect potential data leakage between training, test, and validation sets"""</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Implementation would check for exact matches and high-similarity compounds</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Temporal Contamination:</strong> Chemical databases often contain compounds discovered after certain dates. For historically-aware models, ensure temporal consistency:</p>
<p><strong>Vendor Catalog Contamination:</strong> Many “novel” compounds in datasets are actually from commercial catalogs, which can lead to unrealistic performance expectations.</p>
<p><strong>Synthetic Accessibility Bias:</strong> Datasets often over-represent easily synthesizable compounds, creating bias in LLM outputs.</p>
<div id="84b0e445" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ContaminationDetector:</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Advanced contamination detection for chemical datasets used in LLM training.</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, similarity_threshold: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.85</span>):</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.similarity_threshold <span class="op">=</span> similarity_threshold</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> detect_cross_dataset_leakage(<span class="va">self</span>, datasets: Dict[<span class="bu">str</span>, List[<span class="bu">str</span>]]) <span class="op">-&gt;</span> Dict:</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Detect potential data leakage between multiple datasets.</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">            datasets: Dictionary with dataset names as keys and lists of SMILES as values</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">                     e.g., {'train': [...], 'test': [...], 'validation': [...]}</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co">            Dictionary with contamination analysis results</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Detecting cross-dataset contamination..."</span>)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> {</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'exact_overlaps'</span>: {},</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">'similarity_overlaps'</span>: {},</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'summary'</span>: {}</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert SMILES to canonical form and create fingerprints</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        canonical_datasets <span class="op">=</span> {}</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>        fingerprint_datasets <span class="op">=</span> {}</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, smiles_list <span class="kw">in</span> datasets.items():</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>            canonical_smiles <span class="op">=</span> []</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>            fingerprints <span class="op">=</span> []</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> smiles <span class="kw">in</span> smiles_list:</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>                mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> mol:</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>                    canonical <span class="op">=</span> Chem.MolToSmiles(mol)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>                    canonical_smiles.append(canonical)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>                    fingerprints.append(Chem.RDKFingerprint(mol))</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>            canonical_datasets[name] <span class="op">=</span> canonical_smiles</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>            fingerprint_datasets[name] <span class="op">=</span> fingerprints</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(canonical_smiles)<span class="sc">}</span><span class="ss"> valid structures"</span>)</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check exact overlaps</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>        dataset_names <span class="op">=</span> <span class="bu">list</span>(datasets.keys())</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, name1 <span class="kw">in</span> <span class="bu">enumerate</span>(dataset_names):</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> name2 <span class="kw">in</span> dataset_names[i<span class="op">+</span><span class="dv">1</span>:]:</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>                overlap_key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>name1<span class="sc">}</span><span class="ss">_vs_</span><span class="sc">{</span>name2<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>                set1 <span class="op">=</span> <span class="bu">set</span>(canonical_datasets[name1])</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>                set2 <span class="op">=</span> <span class="bu">set</span>(canonical_datasets[name2])</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>                exact_overlap <span class="op">=</span> set1.intersection(set2)</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>                results[<span class="st">'exact_overlaps'</span>][overlap_key] <span class="op">=</span> {</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'count'</span>: <span class="bu">len</span>(exact_overlap),</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'percentage_of_first'</span>: <span class="bu">len</span>(exact_overlap) <span class="op">/</span> <span class="bu">len</span>(set1) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> set1 <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'percentage_of_second'</span>: <span class="bu">len</span>(exact_overlap) <span class="op">/</span> <span class="bu">len</span>(set2) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> set2 <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'overlapping_smiles'</span>: <span class="bu">list</span>(exact_overlap)[:<span class="dv">10</span>]  <span class="co"># First 10 examples</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check similarity-based overlaps (computationally expensive, limited to smaller datasets)</span></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, name1 <span class="kw">in</span> <span class="bu">enumerate</span>(dataset_names):</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> name2 <span class="kw">in</span> dataset_names[i<span class="op">+</span><span class="dv">1</span>:]:</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>                overlap_key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>name1<span class="sc">}</span><span class="ss">_vs_</span><span class="sc">{</span>name2<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(fingerprint_datasets[name1]) <span class="op">&lt;</span> <span class="dv">1000</span> <span class="kw">and</span> <span class="bu">len</span>(fingerprint_datasets[name2]) <span class="op">&lt;</span> <span class="dv">1000</span>:</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>                    similar_pairs <span class="op">=</span> []</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> idx1, fp1 <span class="kw">in</span> <span class="bu">enumerate</span>(fingerprint_datasets[name1]):</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> idx2, fp2 <span class="kw">in</span> <span class="bu">enumerate</span>(fingerprint_datasets[name2]):</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>                            similarity <span class="op">=</span> DataStructs.TanimotoSimilarity(fp1, fp2)</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> similarity <span class="op">&gt;</span> <span class="va">self</span>.similarity_threshold:</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>                                similar_pairs.append({</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">'smiles1'</span>: canonical_datasets[name1][idx1],</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">'smiles2'</span>: canonical_datasets[name2][idx2],</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">'similarity'</span>: similarity</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>                                })</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>                    results[<span class="st">'similarity_overlaps'</span>][overlap_key] <span class="op">=</span> {</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'count'</span>: <span class="bu">len</span>(similar_pairs),</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'pairs'</span>: similar_pairs[:<span class="dv">5</span>]  <span class="co"># First 5 examples</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>                    results[<span class="st">'similarity_overlaps'</span>][overlap_key] <span class="op">=</span> {</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'count'</span>: <span class="st">'skipped_large_dataset'</span>,</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'note'</span>: <span class="st">'Dataset too large for pairwise comparison'</span></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate summary</span></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>        total_exact_overlaps <span class="op">=</span> <span class="bu">sum</span>(result[<span class="st">'count'</span>] <span class="cf">for</span> result <span class="kw">in</span> results[<span class="st">'exact_overlaps'</span>].values() </span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>                                 <span class="cf">if</span> <span class="bu">isinstance</span>(result[<span class="st">'count'</span>], <span class="bu">int</span>))</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'summary'</span>] <span class="op">=</span> {</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_exact_overlaps'</span>: total_exact_overlaps,</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>            <span class="st">'datasets_analyzed'</span>: <span class="bu">len</span>(datasets),</span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">'contamination_severity'</span>: <span class="va">self</span>._assess_contamination_severity(results),</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recommendations'</span>: <span class="va">self</span>._generate_contamination_recommendations(results)</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> detect_temporal_contamination(<span class="va">self</span>, smiles_list: List[<span class="bu">str</span>], </span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a>                                    target_date: <span class="bu">str</span> <span class="op">=</span> <span class="st">"2020-01-01"</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a><span class="co">        Detect compounds that might be from after a target date.</span></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a><span class="co">        Note: This is a simplified version - real implementation would require</span></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="co">        a database of compound discovery/publication dates.</span></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Checking for temporal contamination (compounds after </span><span class="sc">{</span>target_date<span class="sc">}</span><span class="ss">)..."</span>)</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This is a placeholder implementation</span></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># In practice, you'd need a database mapping SMILES to discovery dates</span></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a>        suspicious_compounds <span class="op">=</span> []</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> smiles <span class="kw">in</span> smiles_list:</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a>            mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mol:</span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Example heuristic: very complex molecules might be recent</span></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>                complexity_score <span class="op">=</span> <span class="va">self</span>._calculate_molecular_complexity(mol)</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> complexity_score <span class="op">&gt;</span> <span class="dv">20</span>:  <span class="co"># Arbitrary threshold</span></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>                    suspicious_compounds.append({</span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'smiles'</span>: smiles,</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'complexity_score'</span>: complexity_score,</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'reason'</span>: <span class="st">'high_complexity'</span></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>            <span class="st">'suspicious_count'</span>: <span class="bu">len</span>(suspicious_compounds),</span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>            <span class="st">'suspicious_compounds'</span>: suspicious_compounds[:<span class="dv">10</span>],</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recommendation'</span>: <span class="ss">f"Manual review recommended for </span><span class="sc">{</span><span class="bu">len</span>(suspicious_compounds)<span class="sc">}</span><span class="ss"> complex compounds"</span></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> detect_vendor_catalog_bias(<span class="va">self</span>, smiles_list: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> Dict:</span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a><span class="co">        Detect potential bias from commercial compound catalogs.</span></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Detecting vendor catalog bias..."</span>)</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Common patterns in commercial compounds</span></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>        vendor_patterns <span class="op">=</span> {</span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>            <span class="st">'simple_aromatics'</span>: <span class="vs">r'c1ccccc1'</span>,  <span class="co"># Simple benzene rings</span></span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>            <span class="st">'common_protecting_groups'</span>: <span class="vs">r'C\(=O\)OC\(C\)\(C\)C'</span>,  <span class="co"># Boc groups</span></span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>            <span class="st">'standard_linkers'</span>: <span class="vs">r'OCCOCCOC'</span>,  <span class="co"># PEG-like linkers</span></span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>        pattern_counts <span class="op">=</span> {pattern: <span class="dv">0</span> <span class="cf">for</span> pattern <span class="kw">in</span> vendor_patterns.keys()}</span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>        flagged_compounds <span class="op">=</span> []</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> smiles <span class="kw">in</span> smiles_list:</span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>            mol <span class="op">=</span> Chem.MolFromSmiles(smiles)</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mol:</span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check for overly simple structures</span></span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> mol.GetNumAtoms() <span class="op">&lt;</span> <span class="dv">10</span> <span class="kw">and</span> mol.GetNumBonds() <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>                    flagged_compounds.append({</span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'smiles'</span>: smiles,</span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'reason'</span>: <span class="st">'overly_simple'</span>,</span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'num_atoms'</span>: mol.GetNumAtoms()</span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check for common patterns</span></span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> pattern_name, pattern <span class="kw">in</span> vendor_patterns.items():</span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> re.search(pattern, smiles):</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>                        pattern_counts[pattern_name] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pattern_counts'</span>: pattern_counts,</span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>            <span class="st">'flagged_simple'</span>: <span class="bu">len</span>(flagged_compounds),</span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_analyzed'</span>: <span class="bu">len</span>(smiles_list),</span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bias_indicators'</span>: {</span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>                <span class="st">'high_simple_proportion'</span>: <span class="bu">len</span>(flagged_compounds) <span class="op">/</span> <span class="bu">len</span>(smiles_list) <span class="op">&gt;</span> <span class="fl">0.3</span>,</span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a>                <span class="st">'pattern_dominance'</span>: <span class="bu">any</span>(count <span class="op">&gt;</span> <span class="bu">len</span>(smiles_list) <span class="op">*</span> <span class="fl">0.2</span> <span class="cf">for</span> count <span class="kw">in</span> pattern_counts.values())</span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _calculate_molecular_complexity(<span class="va">self</span>, mol) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Calculate a simple molecular complexity score."""</span></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> mol:</span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>        complexity <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>        complexity <span class="op">+=</span> mol.GetNumAtoms() <span class="op">*</span> <span class="fl">0.1</span></span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>        complexity <span class="op">+=</span> mol.GetNumBonds() <span class="op">*</span> <span class="fl">0.1</span></span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a>        complexity <span class="op">+=</span> rdMolDescriptors.CalcNumRings(mol) <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>        complexity <span class="op">+=</span> rdMolDescriptors.CalcNumHeteroatoms(mol) <span class="op">*</span> <span class="fl">1.5</span></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>        complexity <span class="op">+=</span> <span class="bu">len</span>(rdMolDescriptors.GetUSRScore(mol)) <span class="op">*</span> <span class="fl">0.01</span> <span class="cf">if</span> <span class="bu">hasattr</span>(rdMolDescriptors, <span class="st">'GetUSRScore'</span>) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> complexity</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _assess_contamination_severity(<span class="va">self</span>, results: Dict) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Assess the overall severity of contamination."""</span></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>        exact_overlaps <span class="op">=</span> <span class="bu">sum</span>(result[<span class="st">'count'</span>] <span class="cf">for</span> result <span class="kw">in</span> results[<span class="st">'exact_overlaps'</span>].values() </span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> <span class="bu">isinstance</span>(result[<span class="st">'count'</span>], <span class="bu">int</span>))</span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> exact_overlaps <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"low"</span></span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> exact_overlaps <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"moderate"</span></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"high"</span></span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _generate_contamination_recommendations(<span class="va">self</span>, results: Dict) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generate recommendations based on contamination analysis."""</span></span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a>        recommendations <span class="op">=</span> []</span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>        severity <span class="op">=</span> <span class="va">self</span>._assess_contamination_severity(results)</span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> severity <span class="op">==</span> <span class="st">"high"</span>:</span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a>            recommendations.append(<span class="st">"CRITICAL: High level of contamination detected - review data splitting strategy"</span>)</span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a>            recommendations.append(<span class="st">"Consider using scaffold-based or time-based splitting instead of random splitting"</span>)</span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> severity <span class="op">==</span> <span class="st">"moderate"</span>:</span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a>            recommendations.append(<span class="st">"Moderate contamination detected - remove overlapping compounds"</span>)</span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>            recommendations.append(<span class="st">"Low contamination level - acceptable for most applications"</span>)</span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for specific issues</span></span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> overlap_key, overlap_data <span class="kw">in</span> results[<span class="st">'exact_overlaps'</span>].items():</span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> overlap_data[<span class="st">'count'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a>                recommendations.append(<span class="ss">f"Remove </span><span class="sc">{</span>overlap_data[<span class="st">'count'</span>]<span class="sc">}</span><span class="ss"> overlapping compounds between </span><span class="sc">{</span>overlap_key<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> recommendations</span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstration of contamination detection</span></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Contamination Detection Demonstration"</span>)</span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Create example datasets with known contamination</span></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a>example_datasets <span class="op">=</span> {</span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a>    <span class="st">'train'</span>: [</span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>        <span class="st">'CCO'</span>,  <span class="co"># ethanol</span></span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a>        <span class="st">'c1ccccc1'</span>,  <span class="co"># benzene</span></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>        <span class="st">'CC(=O)O'</span>,  <span class="co"># acetic acid</span></span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a>        <span class="st">'CC(C)O'</span>,  <span class="co"># isopropanol</span></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a>        <span class="st">'CN'</span>,  <span class="co"># methylamine</span></span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a>    <span class="st">'test'</span>: [</span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a>        <span class="st">'CCO'</span>,  <span class="co"># CONTAMINATION: same as train</span></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a>        <span class="st">'c1ccc(O)cc1'</span>,  <span class="co"># phenol</span></span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a>        <span class="st">'CC(=O)OC'</span>,  <span class="co"># methyl acetate</span></span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a>    <span class="st">'validation'</span>: [</span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a>        <span class="st">'CC(=O)O'</span>,  <span class="co"># CONTAMINATION: same as train</span></span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>        <span class="st">'CC(C)(C)O'</span>,  <span class="co"># tert-butanol</span></span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a>        <span class="st">'c1cccnc1'</span>,  <span class="co"># pyridine</span></span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a>detector <span class="op">=</span> ContaminationDetector(similarity_threshold<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a><span class="co"># Run contamination analysis</span></span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a>contamination_results <span class="op">=</span> detector.detect_cross_dataset_leakage(example_datasets)</span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Contamination Analysis Results:"</span>)</span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Contamination severity: </span><span class="sc">{</span>contamination_results[<span class="st">'summary'</span>][<span class="st">'contamination_severity'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total exact overlaps: </span><span class="sc">{</span>contamination_results[<span class="st">'summary'</span>][<span class="st">'total_exact_overlaps'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Exact overlaps found:"</span>)</span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> overlap_key, overlap_data <span class="kw">in</span> contamination_results[<span class="st">'exact_overlaps'</span>].items():</span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> overlap_data[<span class="st">'count'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>overlap_key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>overlap_data[<span class="st">'count'</span>]<span class="sc">}</span><span class="ss"> compounds (</span><span class="sc">{</span>overlap_data[<span class="st">'percentage_of_first'</span>]<span class="sc">:.1f}</span><span class="ss">% of first dataset)"</span>)</span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    Examples: </span><span class="sc">{</span>overlap_data[<span class="st">'overlapping_smiles'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Recommendations:"</span>)</span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, rec <span class="kw">in</span> <span class="bu">enumerate</span>(contamination_results[<span class="st">'summary'</span>][<span class="st">'recommendations'</span>], <span class="dv">1</span>):</span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">. </span><span class="sc">{</span>rec<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a><span class="co"># Test temporal contamination detection</span></span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Temporal Contamination Check:"</span>)</span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a>temporal_results <span class="op">=</span> detector.detect_temporal_contamination(example_datasets[<span class="st">'train'</span>])</span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Suspicious compounds: </span><span class="sc">{</span>temporal_results[<span class="st">'suspicious_count'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Test vendor bias detection</span></span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Vendor Catalog Bias Check:"</span>)</span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a>bias_results <span class="op">=</span> detector.detect_vendor_catalog_bias(example_datasets[<span class="st">'train'</span>])</span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Simple compounds flagged: </span><span class="sc">{</span>bias_results[<span class="st">'flagged_simple'</span>]<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>bias_results[<span class="st">'total_analyzed'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Bias indicators detected: </span><span class="sc">{</span><span class="bu">any</span>(bias_results[<span class="st">'bias_indicators'</span>].values())<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Contamination Detection Demonstration
========================================
Detecting cross-dataset contamination...
  train: 5 valid structures
  test: 3 valid structures
  validation: 3 valid structures

Contamination Analysis Results:
Contamination severity: moderate
Total exact overlaps: 2

Exact overlaps found:
  train_vs_test: 1 compounds (20.0% of first dataset)
    Examples: ['CCO']
  train_vs_validation: 1 compounds (20.0% of first dataset)
    Examples: ['CC(=O)O']

Recommendations:
  1. Moderate contamination detected - remove overlapping compounds
  2. Remove 1 overlapping compounds between train_vs_test
  3. Remove 1 overlapping compounds between train_vs_validation

Temporal Contamination Check:
Checking for temporal contamination (compounds after 2020-01-01)...</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ArgumentError</span>                             Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[15], line 271</span>
<span class="ansi-green-fg ansi-bold">    269</span> <span style="font-style:italic;color:rgb(95,135,135)"># Test temporal contamination detection</span>
<span class="ansi-green-fg ansi-bold">    270</span> <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="color:rgb(175,0,0)">Temporal Contamination Check:</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg">--&gt; 271</span> temporal_results <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">detector</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">detect_temporal_contamination</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">example_datasets</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">train</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    272</span> <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Suspicious compounds: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>temporal_results[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">suspicious_count</span><span style="color:rgb(175,0,0)">'</span>]<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    274</span> <span style="font-style:italic;color:rgb(95,135,135)"># Test vendor bias detection</span>

Cell <span class="ansi-green-fg">In[15], line 122</span>, in <span class="ansi-cyan-fg">ContaminationDetector.detect_temporal_contamination</span><span class="ansi-blue-fg">(self, smiles_list, target_date)</span>
<span class="ansi-green-fg ansi-bold">    119</span> mol <span style="color:rgb(98,98,98)">=</span> Chem<span style="color:rgb(98,98,98)">.</span>MolFromSmiles(smiles)
<span class="ansi-green-fg ansi-bold">    120</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> mol:
<span class="ansi-green-fg ansi-bold">    121</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Example heuristic: very complex molecules might be recent</span>
<span class="ansi-green-fg">--&gt; 122</span>     complexity_score <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_calculate_molecular_complexity</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mol</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    123</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> complexity_score <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">20</span>:  <span style="font-style:italic;color:rgb(95,135,135)"># Arbitrary threshold</span>
<span class="ansi-green-fg ansi-bold">    124</span>         suspicious_compounds<span style="color:rgb(98,98,98)">.</span>append({
<span class="ansi-green-fg ansi-bold">    125</span>             <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">smiles</span><span style="color:rgb(175,0,0)">'</span>: smiles,
<span class="ansi-green-fg ansi-bold">    126</span>             <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">complexity_score</span><span style="color:rgb(175,0,0)">'</span>: complexity_score,
<span class="ansi-green-fg ansi-bold">    127</span>             <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">reason</span><span style="color:rgb(175,0,0)">'</span>: <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">high_complexity</span><span style="color:rgb(175,0,0)">'</span>
<span class="ansi-green-fg ansi-bold">    128</span>         })

Cell <span class="ansi-green-fg">In[15], line 188</span>, in <span class="ansi-cyan-fg">ContaminationDetector._calculate_molecular_complexity</span><span class="ansi-blue-fg">(self, mol)</span>
<span class="ansi-green-fg ansi-bold">    186</span> complexity <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> rdMolDescriptors<span style="color:rgb(98,98,98)">.</span>CalcNumRings(mol) <span style="color:rgb(98,98,98)">*</span> <span style="color:rgb(98,98,98)">2</span>
<span class="ansi-green-fg ansi-bold">    187</span> complexity <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> rdMolDescriptors<span style="color:rgb(98,98,98)">.</span>CalcNumHeteroatoms(mol) <span style="color:rgb(98,98,98)">*</span> <span style="color:rgb(98,98,98)">1.5</span>
<span class="ansi-green-fg">--&gt; 188</span> complexity <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">len</span>(<span class="ansi-yellow-bg">rdMolDescriptors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">GetUSRScore</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mol</span><span class="ansi-yellow-bg">)</span>) <span style="color:rgb(98,98,98)">*</span> <span style="color:rgb(98,98,98)">0.01</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">hasattr</span>(rdMolDescriptors, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">GetUSRScore</span><span style="color:rgb(175,0,0)">'</span>) <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(98,98,98)">0</span>
<span class="ansi-green-fg ansi-bold">    190</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> complexity

<span class="ansi-red-fg">ArgumentError</span>: Python argument types in
    rdkit.Chem.rdMolDescriptors.GetUSRScore(Mol)
did not match C++ signature:
    GetUSRScore(boost::python::api::object descriptor1, boost::python::api::object descriptor2, boost::python::api::object weights=[])</pre>
</div>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/greglandrum\.github\.io\/rdkit-blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="greglandrum/rdkit-blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright (C) 2025 Greg Landrum</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><a href="https://www.rdkit.org"><img src="https://www.rdkit.org/logo.small.png" class="img-fluid" alt="RDKit" width="64"></a></p>
</div>
  </div>
</footer>




</body></html>